// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// User model for guest information and booking history
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  firstName String?
  lastName  String?
  phone     String?
  country   String?
  city      String?
  address   String?
  zip       String?

  bookings  Booking[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
}

// Booking model - stores complete booking history without modifying Medici API
model Booking {
  id        String   @id @default(cuid())

  // Medici API Response Data (primary source of truth)
  mediciBookingId   String   @unique  // From Medici API response
  preBookId         String?           // From preBook step
  supplierReference String?           // Hotel confirmation number

  // Hotel & Room Details
  hotelId           Int
  hotelName         String
  roomName          String
  roomCode          String

  // Booking Dates
  dateFrom          DateTime
  dateTo            DateTime
  nights            Int

  // Guest Information
  userId            String?
  user              User?    @relation(fields: [userId], references: [id])

  customerEmail     String
  customerTitle     String   // MR, MRS, MS
  customerFirstName String
  customerLastName  String
  customerPhone     String
  customerCountry   String?
  customerCity      String?
  customerAddress   String?
  customerZip       String?

  // Occupancy
  adults            Int
  childrenAges      Int[]    // Array of children ages

  // Pricing (in the currency used for booking)
  currency          String   @default("EUR")
  totalPrice        Decimal  @db.Decimal(10, 2)
  pricePerNight     Decimal? @db.Decimal(10, 2)

  // Status tracking
  status            BookingStatus @default(PENDING)

  // API Source (which API was used)
  apiSource         String   @default("medici-direct") // "medici-direct" or "manus"

  // Voucher
  voucherEmail      String?
  agencyReference   String?

  // Metadata - stores complete Medici API response for audit trail
  metadata          Json?

  // Cancellation
  cancelledAt       DateTime?
  cancellationReason String?

  // Audit trail
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  auditLogs         AuditLog[]

  @@index([customerEmail])
  @@index([mediciBookingId])
  @@index([status])
  @@index([dateFrom])
  @@index([createdAt])
}

enum BookingStatus {
  PENDING       // Booking initiated but not confirmed
  CONFIRMED     // Successfully booked with Medici API
  CANCELLED     // Cancelled by user or admin
  FAILED        // Booking failed
  EXPIRED       // PreBook token expired
}

// Audit Log - tracks all booking operations for compliance
model AuditLog {
  id          String   @id @default(cuid())

  bookingId   String?
  booking     Booking? @relation(fields: [bookingId], references: [id])

  action      String   // "SEARCH", "PREBOOK", "BOOK", "CANCEL", "UPDATE_PRICE"
  status      String   // "SUCCESS", "FAILED"

  apiUsed     String   // "medici-direct" or "manus"

  // Request/Response data
  requestData Json?
  responseData Json?

  // Error tracking
  errorMessage String?
  errorCode    String?

  // User context
  userEmail   String?
  ipAddress   String?
  userAgent   String?

  createdAt   DateTime @default(now())

  @@index([bookingId])
  @@index([action])
  @@index([createdAt])
}

// Email Queue - for sending confirmation emails asynchronously
model EmailQueue {
  id          String   @id @default(cuid())

  to          String
  subject     String

  emailType   EmailType

  // Template data (booking details, voucher, etc.)
  templateData Json

  status      EmailStatus @default(PENDING)

  // Retry logic
  attempts    Int      @default(0)
  maxAttempts Int      @default(3)
  lastError   String?

  sentAt      DateTime?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([status])
  @@index([createdAt])
}

enum EmailType {
  BOOKING_CONFIRMATION
  BOOKING_VOUCHER
  CANCELLATION_CONFIRMATION
  PRICE_UPDATE_NOTIFICATION
}

enum EmailStatus {
  PENDING
  SENDING
  SENT
  FAILED
}

// ==============================================
// A/B TESTING FOR AI PROMPTS
// ==============================================

// Experiment - A/B test configuration
model Experiment {
  id          String   @id @default(cuid())
  name        String
  description String?

  active      Boolean  @default(true)
  startDate   DateTime @default(now())
  endDate     DateTime?

  variants    PromptVariant[]
  assignments ExperimentAssignment[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([active])
  @@index([startDate])
}

// PromptVariant - Different versions of AI prompts to test
model PromptVariant {
  id           String   @id @default(cuid())

  experimentId String
  experiment   Experiment @relation(fields: [experimentId], references: [id], onDelete: Cascade)

  name         String
  systemPrompt String   @db.Text
  weight       Int      @default(50) // Traffic split percentage (0-100)
  active       Boolean  @default(true)

  assignments  ExperimentAssignment[]
  results      ExperimentResult[]

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([experimentId])
  @@index([active])
}

// ExperimentAssignment - Track which variant each user sees
model ExperimentAssignment {
  id           String   @id @default(cuid())

  experimentId String
  experiment   Experiment @relation(fields: [experimentId], references: [id], onDelete: Cascade)

  variantId    String
  variant      PromptVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  sessionId    String   // Unique session identifier

  createdAt    DateTime @default(now())

  @@unique([experimentId, sessionId])
  @@index([variantId])
  @@index([sessionId])
}

// ExperimentResult - Track performance metrics for each variant
model ExperimentResult {
  id               String   @id @default(cuid())

  variantId        String
  variant          PromptVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  sessionId        String

  // Performance metrics
  conversions      Int      @default(0)
  responseTime     Int      @default(0) // in milliseconds
  userSatisfaction Float    @default(0) // 1-5 rating
  completedBooking Boolean  @default(false)

  createdAt        DateTime @default(now())

  @@index([variantId])
  @@index([sessionId])
  @@index([completedBooking])
}
