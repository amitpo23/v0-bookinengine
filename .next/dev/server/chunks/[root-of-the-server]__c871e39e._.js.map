{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 112, "column": 0}, "map": {"version":3,"sources":["file:///workspaces/v0-bookinengine/lib/api/knowaa-client.ts"],"sourcesContent":["// Knowaa Hotels API Client - Token-based Authentication\n// Handles bearer token retrieval and all hotel API calls via Knowaa credentials\n\nimport axios, { AxiosInstance } from \"axios\"\nimport type { HotelSearchResult, PreBookResponse, BookResponse } from \"./medici-types\"\nimport \"server-only\"\n\nconst MEDICI_BASE_URL = \"https://medici-backend.azurewebsites.net\"\nconst TOKEN_ENDPOINT = \"/api/auth/OnlyNightUsersTokenAPI\"\n\n// Knowaa credentials\nconst KNOWAA_CLIENT_SECRET = process.env.KNOWAA_CLIENT_SECRET || \"zlbgGGxz~|l3.Q?XXAT)uT!Lty,kJC>R?`:k?oQH$I=P7rL<R:Em:qDaM1G(jFU7\"\nconst KNOWAA_EMAIL = process.env.KNOWAA_EMAIL || \"partnerships@knowaaglobal.com\"\n\n// Token cache with expiry\ninterface TokenCache {\n  token: string\n  expiresAt: number\n}\n\nlet tokenCache: TokenCache | null = null\n\n// =====================\n// TOKEN MANAGEMENT\n// =====================\n\nasync function getKnowaaBearerToken(): Promise<string> {\n  // If env token provided, use it (testing override)\n  const ENV_TOKEN = process.env.KNOWAA_BEARER_TOKEN\n  if (ENV_TOKEN) {\n    if (!tokenCache) {\n      tokenCache = { token: ENV_TOKEN, expiresAt: Date.now() + 24 * 60 * 60 * 1000 }\n    }\n    return tokenCache.token\n  }\n\n  // Return cached token if still valid\n  if (tokenCache && tokenCache.expiresAt > Date.now()) {\n    return tokenCache.token\n  }\n\n  try {\n    console.log(\"üîê [Knowaa] Requesting bearer token...\")\n    const tokenUrl = `${MEDICI_BASE_URL}${TOKEN_ENDPOINT}`\n\n    // Build form data using URLSearchParams and convert to string\n    const formData = new URLSearchParams()\n    formData.append(\"client_secret\", KNOWAA_CLIENT_SECRET)\n    formData.append(\"email\", KNOWAA_EMAIL)\n\n    const response = await axios.post(tokenUrl, formData.toString(), {\n      headers: {\n        \"Content-Type\": \"application/x-www-form-urlencoded\",\n        \"Content-Length\": formData.toString().length.toString(),\n      },\n      timeout: 15000,\n    })\n\n    console.log(\"üîê [Knowaa] Token response status:\", response.status)\n\n    // Response format: { \"email1\": \"token1\", \"email2\": \"token2\", ... }\n    const token = response.data[KNOWAA_EMAIL] || response.data.token || response.data.access_token\n\n    if (!token) {\n      console.error(\"üîê [Knowaa] Response data:\", JSON.stringify(response.data).substring(0, 200))\n      throw new Error(\"No token received from Knowaa auth endpoint\")\n    }\n\n    // Cache token for 55 minutes (typical JWT expiry is 1 hour)\n    tokenCache = {\n      token,\n      expiresAt: Date.now() + 55 * 60 * 1000,\n    }\n\n    console.log(\"‚úÖ Knowaa Bearer Token acquired successfully\")\n    return tokenCache.token\n  } catch (error: any) {\n    console.error(\"‚ùå Failed to get Knowaa Bearer Token:\")\n    console.error(\"Error message:\", error.message)\n    if (error.response) {\n      console.error(\"Response status:\", error.response.status)\n      console.error(\"Response data:\", error.response.data)\n    }\n    throw new Error(`Authentication failed: ${error.message}`)\n  }\n}\n\n// =====================\n// API CLIENT CLASS\n// =====================\n\nexport class KnowaaMediciClient {\n  private client: AxiosInstance\n  private baseUrl: string\n\n  constructor() {\n    this.baseUrl = MEDICI_BASE_URL\n    this.client = axios.create({\n      baseURL: this.baseUrl,\n      timeout: 30000,\n    })\n  }\n\n  /**\n   * Create request with Knowaa bearer token\n   */\n  private async getAuthHeaders() {\n    const token = await getKnowaaBearerToken()\n    // WORKAROUND: Use the legacy token (UserID 11) which works via fetch\n    // The Knowaa token works with curl but returns 500 from axios/fetch for unknown reasons\n    const LEGACY_TOKEN = \"eyJhbGciOiJodHRwOi8vd3d3LnczLm9yZy8yMDAxLzA0L3htbGRzaWctbW9yZSNobWFjLXNoYTI1NiIsInR5cCI6IkpXVCJ9.eyJQZXJtaXNzaW9ucyI6IjEiLCJVc2VySWQiOiIxMSIsIm5iZiI6MTc2ODQ1NzU5NSwiZXhwIjoyMDgzOTkwMzk1LCJpc3MiOiJodHRwczovL2FkbWluLm1lZGljaWhvdGVscy5jb20vIiwiYXVkIjoiaHR0cHM6Ly9hZG1pbi5tZWRpY2lob3RlbHMuY29tLyJ9.g-CO7I75BlowE-F3J3GqlXsbIgNtG8_w2v1WMwG6djE\"\n    return {\n      Authorization: `Bearer ${token || LEGACY_TOKEN}`,\n      \"Content-Type\": \"application/json\",\n    }\n  }\n\n  /**\n   * STEP 1: Search Hotels\n   * GET /api/hotels/GetInnstantSearchPrice\n   */\n  async searchHotels(params: {\n    dateFrom: string // \"2025-02-01\"\n    dateTo: string // \"2025-02-05\"\n    hotelName?: string // Search by hotel name\n    city?: string // Search by city\n    adults?: number\n    children?: number[]\n    stars?: number | null\n    limit?: number | null\n  }): Promise<HotelSearchResult[]> {\n    try {\n      const headers = await this.getAuthHeaders()\n\n      const pax = {\n        adults: params.adults || 2,\n        children: params.children?.length || 0,\n      }\n\n      const body: any = {\n        dateFrom: params.dateFrom,\n        dateTo: params.dateTo,\n        pax,\n        stars: params.stars || null,\n        limit: params.limit || null,\n        ShowExtendedData: true, // Get images, description, facilities\n      }\n\n      if (params.hotelName) {\n        body.hotelName = params.hotelName\n      } else if (params.city) {\n        body.city = params.city\n      }\n\n      console.log(\"üîç [Knowaa] Searching hotels:\", { dateFrom: params.dateFrom, dateTo: params.dateTo, ...body })\n\n      const response = await fetch(`${this.baseUrl}/api/hotels/GetInnstantSearchPrice`, {\n        method: \"POST\",\n        headers,\n        body: JSON.stringify(body),\n      })\n\n      if (!response.ok) {\n        throw new Error(`Medici API returned ${response.status}`)\n      }\n\n      const data = await response.json()\n      const hotels = this.transformSearchResults(data)\n\n      console.log(`‚úÖ [Knowaa] Found ${hotels.length} hotels`)\n\n      return hotels.map((hotel) => ({\n        ...hotel,\n        requestJson: JSON.stringify(body),\n        responseJson: data,\n      }))\n    } catch (error) {\n      console.error(\"‚ùå [Knowaa] Search Hotels Error:\", error)\n      throw error\n    }\n  }\n\n  /**\n   * STEP 2: Pre-Book\n   * POST /api/hotels/PreBook\n   */\n  async preBook(params: { jsonRequest: string }): Promise<PreBookResponse> {\n    try {\n      const headers = await this.getAuthHeaders()\n\n      const body = {\n        jsonRequest: params.jsonRequest,\n      }\n\n      console.log(\"üìã [Knowaa] Pre-booking room...\")\n\n      const response = await this.client.post(\"/api/hotels/PreBook\", body, {\n        headers,\n      })\n\n      if (response.status === 204) {\n        return {\n          success: true,\n          preBookId: 0,\n          token: \"\",\n          status: \"done\",\n          priceConfirmed: 0,\n          currency: \"USD\",\n          requestJson: params.jsonRequest,\n          responseJson: \"\",\n        }\n      }\n\n      const token = response.data?.content?.services?.hotels?.[0]?.token || response.data?.token || \"\"\n      const preBookId = response.data?.opportunityId || response.data?.preBookId || response.data?.id || 0\n      const priceConfirmed = response.data?.content?.services?.hotels?.[0]?.price?.amount || 0\n      const currency = response.data?.content?.services?.hotels?.[0]?.price?.currency || \"USD\"\n\n      console.log(`‚úÖ [Knowaa] Pre-book successful: ID ${preBookId}`)\n\n      return {\n        success: true,\n        preBookId,\n        token,\n        status: response.data?.status || \"done\",\n        priceConfirmed,\n        currency,\n        requestJson: params.jsonRequest,\n        responseJson: response.data,\n      }\n    } catch (error) {\n      console.error(\"‚ùå [Knowaa] Pre-Book Error:\", error)\n      throw error\n    }\n  }\n\n  /**\n   * STEP 3: Book\n   * POST /api/hotels/Book\n   */\n  async book(params: { jsonRequest: string }): Promise<BookResponse> {\n    try {\n      const headers = await this.getAuthHeaders()\n\n      const body = {\n        jsonRequest: params.jsonRequest,\n      }\n\n      console.log(\"üé´ [Knowaa] Booking room...\")\n\n      const response = await this.client.post(\"/api/hotels/Book\", body, {\n        headers,\n      })\n\n      const bookingId = response.data?.content?.bookingID || response.data?.bookingId || \"\"\n      const supplierReference = response.data?.content?.services?.[0]?.supplier?.reference || \"\"\n      const status = response.data?.status || \"confirmed\"\n\n      console.log(`‚úÖ [Knowaa] Booking confirmed: ${bookingId}`)\n\n      return {\n        success: true,\n        bookingId,\n        supplierReference,\n        status,\n      }\n    } catch (error) {\n      console.error(\"‚ùå [Knowaa] Book Error:\", error)\n      throw error\n    }\n  }\n\n  /**\n   * Transform Medici API search response to HotelSearchResult[]\n   */\n  private transformSearchResults(response: any): HotelSearchResult[] {\n    const hotelMap = new Map<string, HotelSearchResult>()\n\n    const items = response?.items || []\n\n    for (const item of items) {\n      if (!item.name) continue\n\n      const hotelId = String(item.id || item.hotelId || \"0\")\n      const roomKey = `${hotelId}-${item.name}`\n\n      if (!hotelMap.has(roomKey)) {\n        hotelMap.set(roomKey, {\n          hotelId: Number(hotelId),\n          hotelName: item.items?.[0]?.hotelName || item.name || \"Unknown\",\n          city: item.city || \"Unknown\",\n          stars: item.stars || 0,\n          address: item.address || \"\",\n          description: item.description || \"\",\n          hotelImage: item.imageUrl || \"\",\n          images: item.images?.map((img: any) => img.url || \"\") || [],\n          location: item.city || \"\",\n          facilities: item.facilities?.list || [],\n          rooms: [],\n        })\n      }\n\n      const hotel = hotelMap.get(roomKey)!\n\n      // Add rooms\n      if (item.items && Array.isArray(item.items)) {\n        for (const roomItem of item.items) {\n          const price = item.price?.amount || item.netPrice?.amount || 0\n\n          hotel.rooms.push({\n            roomId: roomItem.code || `${hotelId}-room-${Math.random()}`,\n            roomName: roomItem.name || \"Standard\",\n            roomCategory: roomItem.category || \"standard\",\n            categoryId: 1,\n            roomImage: \"\",\n            images: [],\n            bedding: roomItem.bedding || \"double\",\n            board: roomItem.board || \"RO\",\n            boardId: 1,\n            boardType: roomItem.boardType || \"RO\",\n            maxOccupancy: roomItem.pax?.adults || 2,\n            size: 0,\n            view: \"\",\n            amenities: [],\n            price,\n            buyPrice: price,\n            originalPrice: price > 0 ? Math.round(price * 1.15) : 0,\n            currency: item.price?.currency || \"USD\",\n            cancellationPolicy: \"refundable\",\n            available: roomItem.quantity?.max || 1,\n            requestJson: item.code,\n            pax: roomItem.pax || { adults: 2, children: [] },\n          })\n        }\n      }\n    }\n\n    return Array.from(hotelMap.values())\n  }\n}\n\n// =====================\n// SINGLETON INSTANCE\n// =====================\n\nexport const knowaaClient = new KnowaaMediciClient()\n\n// =====================\n// HELPER FUNCTIONS\n// =====================\n\n/**\n * Clear token cache (useful for testing or manual refresh)\n */\nexport function clearTokenCache() {\n  tokenCache = null\n  console.log(\"üîÑ Token cache cleared\")\n}\n\n/**\n * Get current token cache status\n */\nexport function getTokenCacheStatus() {\n  if (!tokenCache) {\n    return { cached: false, token: null, expiresIn: null }\n  }\n\n  const expiresIn = tokenCache.expiresAt - Date.now()\n  return {\n    cached: true,\n    token: tokenCache.token?.substring(0, 20) + \"...\", // Only show first 20 chars\n    expiresIn: expiresIn > 0 ? Math.floor(expiresIn / 1000) + \"s\" : \"expired\",\n  }\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 421, "column": 0}, "map": {"version":3,"sources":["file:///workspaces/v0-bookinengine/app/api/test-knowaa/route.ts"],"sourcesContent":["import { type NextRequest, NextResponse } from \"next/server\"\nimport { knowaaClient, getTokenCacheStatus } from \"@/lib/api/knowaa-client\"\n\n/**\n * Test Knowaa authentication and search\n * GET /api/test-knowaa?action=search&city=Tel%20Aviv&dateFrom=2025-02-01&dateTo=2025-02-05\n */\nexport async function GET(request: NextRequest) {\n  try {\n    const { searchParams } = new URL(request.url)\n    const action = searchParams.get(\"action\") || \"status\"\n    const city = searchParams.get(\"city\") || \"Tel Aviv\"\n    const dateFrom = searchParams.get(\"dateFrom\") || \"2025-02-01\"\n    const dateTo = searchParams.get(\"dateTo\") || \"2025-02-05\"\n    const hotelName = searchParams.get(\"hotelName\")\n\n    console.log(`\\nüöÄ [Knowaa Test] Action: ${action}`)\n\n    if (action === \"status\") {\n      const cacheStatus = getTokenCacheStatus()\n      return NextResponse.json({\n        message: \"Knowaa API Integration Status\",\n        timestamp: new Date().toISOString(),\n        tokenCache: cacheStatus,\n        endpoints: {\n          search: \"/api/test-knowaa?action=search&city=Tel%20Aviv&dateFrom=2025-02-01&dateTo=2025-02-05\",\n          searchByHotel: \"/api/test-knowaa?action=search&hotelName=Scarlet&dateFrom=2025-02-01&dateTo=2025-02-05\",\n        },\n      })\n    }\n\n    if (action === \"search\") {\n      console.log(`\\nüîç Searching: ${hotelName ? `Hotel: ${hotelName}` : `City: ${city}`}`)\n\n      const results = await knowaaClient.searchHotels({\n        dateFrom,\n        dateTo,\n        hotelName: hotelName || undefined,\n        city: hotelName ? undefined : city,\n        adults: 2,\n      })\n\n      return NextResponse.json({\n        success: true,\n        count: results.length,\n        dateRange: { dateFrom, dateTo },\n        query: hotelName ? { hotelName } : { city },\n        hotels: results.map((h) => ({\n          id: h.hotelId,\n          name: h.hotelName,\n          city: h.city,\n          stars: h.stars,\n          rooms: h.rooms.length,\n        })),\n        fullResults: results,\n      })\n    }\n\n    return NextResponse.json({ error: \"Unknown action\" }, { status: 400 })\n  } catch (error: any) {\n    console.error(\"‚ùå [Knowaa Test] Error:\", error.message)\n    return NextResponse.json(\n      {\n        error: error.message || \"Test failed\",\n        details: error.response?.data || error.toString(),\n      },\n      { status: 500 }\n    )\n  }\n}\n\n/**\n * POST for search with custom body\n */\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json()\n    const { action = \"search\", ...params } = body\n\n    console.log(`\\nüöÄ [Knowaa API POST] Action: ${action}`)\n\n    if (action === \"search\") {\n      const results = await knowaaClient.searchHotels({\n        dateFrom: params.dateFrom || \"2025-02-01\",\n        dateTo: params.dateTo || \"2025-02-05\",\n        hotelName: params.hotelName,\n        city: params.city || \"Tel Aviv\",\n        adults: params.adults || 2,\n        stars: params.stars,\n        limit: params.limit,\n      })\n\n      return NextResponse.json({\n        success: true,\n        count: results.length,\n        data: results,\n      })\n    }\n\n    if (action === \"prebook\") {\n      const result = await knowaaClient.preBook({\n        jsonRequest: params.jsonRequest,\n      })\n\n      return NextResponse.json({\n        success: result.success,\n        preBookId: result.preBookId,\n        token: result.token,\n        status: result.status,\n        price: result.priceConfirmed,\n      })\n    }\n\n    if (action === \"book\") {\n      const result = await knowaaClient.book({\n        jsonRequest: params.jsonRequest,\n      })\n\n      return NextResponse.json({\n        success: result.success,\n        bookingId: result.bookingId,\n        status: result.status,\n      })\n    }\n\n    return NextResponse.json({ error: \"Unknown action\" }, { status: 400 })\n  } catch (error: any) {\n    console.error(\"‚ùå [Knowaa API POST] Error:\", error.message)\n    return NextResponse.json(\n      {\n        error: error.message || \"Request failed\",\n      },\n      { status: 500 }\n    )\n  }\n}\n"],"names":[],"mappings":"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"}}]
}