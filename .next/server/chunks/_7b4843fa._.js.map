{"version":3,"sources":["../../../lib/hotels/scarlet-config.ts","../../../lib/hotels/scarlet-ai-knowledge.ts","../../../lib/prompts/booking-agent-prompt.ts","../../../lib/search-logger.ts","../../../lib/services/chat-memory-service.ts","../../../app/api/ai/booking-chat/route.ts","../../../node_modules/next/src/build/templates/app-route.ts"],"sourcesContent":["export const scarletRoomTypes = [\r\n  {\r\n    id: \"classic-double\",\r\n    name: \"Classic Double Room\",\r\n    hebrewName: \"הקלאסי הזוגי\",\r\n    emoji: \"💎\",\r\n    tagline: \"שקט, מדויק וכל מה שצריך לחופשה אורבנית\",\r\n    taglineEn: \"Quiet, precise and everything you need for an urban vacation\",\r\n    description: \"החדר הקלאסי שלנו תוכנן בקפידה כדי להעניק לכם מפלט של שקט בלב העיר. עם עיצוב מודרני ונעים בגודל 15 מ\\\"ר, זהו המרחב האידיאלי לזוגות או יחידים שמחפשים את השילוב המושלם בין נוחות לסטייל. כאן תוכלו להירגע מול הטלוויזיה החכמה, ליהנות מקפה איכותי ולהתעורר רעננים ליום חדש.\",\r\n    descriptionEn: \"Our classic room is carefully designed to give you a peaceful retreat in the heart of the city. With a modern and pleasant design of 15 sqm, this is the ideal space for couples or singles looking for the perfect combination of comfort and style.\",\r\n    size: 15,\r\n    maxGuests: 2,\r\n    basePrice: 450,\r\n    features: [\r\n      \"מיטה זוגית מפנקת\",\r\n      \"טלוויזיה חכמה\",\r\n      \"פינת קפה ותה\",\r\n      \"מיזוג אוויר\",\r\n      \"חדר רחצה מאובזר\",\r\n      \"מגבות רכות ותמרוקים\",\r\n      \"נוף אורבני או חצר פנימית\"\r\n    ],\r\n    featuresEn: [\r\n      \"Pampering double bed\",\r\n      \"Smart TV\",\r\n      \"Coffee and tea corner\",\r\n      \"Air conditioning\",\r\n      \"Equipped bathroom\",\r\n      \"Soft towels and toiletries\",\r\n      \"Urban view or courtyard\"\r\n    ],\r\n    suitableFor: \"זוגות או יחידים\",\r\n    suitableForEn: \"Couples or singles\",\r\n    images: [\r\n      \"https://wsmchexmtiijufemzzwu.supabase.co/storage/v1/object/public/hotel-assets/classic-balcony/SCARLET%20DAY2-1.jpg\",\r\n      \"https://wsmchexmtiijufemzzwu.supabase.co/storage/v1/object/public/hotel-assets/classic-balcony/SCARLET%20DAY2-2.jpg\",\r\n      \"https://wsmchexmtiijufemzzwu.supabase.co/storage/v1/object/public/hotel-assets/classic-balcony/SCARLET%20DAY2-3.jpg\",\r\n      \"https://wsmchexmtiijufemzzwu.supabase.co/storage/v1/object/public/hotel-assets/classic-balcony/urban-plus-dave-1900.jpg\",\r\n      \"https://wsmchexmtiijufemzzwu.supabase.co/storage/v1/object/public/hotel-assets/classic-balcony/urban-plus-dave.jpg\",\r\n      \"https://wsmchexmtiijufemzzwu.supabase.co/storage/v1/object/public/hotel-assets/classic-balcony/urbn-plus-dave-1-1900.jpg\"\r\n    ]\r\n  },\r\n  {\r\n    id: \"romantic-double\",\r\n    name: \"Romantic Double Room\",\r\n    hebrewName: \"הרומנטי הזוגי\",\r\n    emoji: \"❤️\",\r\n    tagline: \"להצית את האהבה מחדש – עם טאץ' של יוקרה\",\r\n    taglineEn: \"Rekindle the love – with a touch of luxury\",\r\n    description: \"חדר מעוצב בקפידה עם צבעים נועזים ומספק חוויה זוגית בלתי נשכחת. גולת הכותרת היא מיטה עגולה הממוקמת במרכז החדר שמשקיפה אל אמבטיה מעוצבת (Free-standing), שנועדה לרגעים של רוגע ופינוק משותף. זהו החדר המושלם לחגוג בו אהבה, ימי הולדת או פשוט לברוח מהשגרה.\",\r\n    descriptionEn: \"A carefully designed room with bold colors providing an unforgettable couples experience. The highlight is a round bed in the center of the room overlooking a designer free-standing bathtub, designed for moments of shared relaxation and pampering.\",\r\n    size: 18,\r\n    maxGuests: 2,\r\n    basePrice: 650,\r\n    features: [\r\n      \"מיטה עגולה במרכז החדר\",\r\n      \"אמבטיה יוקרתית Free-standing\",\r\n      \"כספת אישית\",\r\n      \"טלוויזיה חכמה\",\r\n      \"פינת קפה/תה\",\r\n      \"מוצרי רחצה מפנקים\",\r\n      \"עיצוב צבעוני ונועז\",\r\n      \"נוף אורבני או חצר פנימית\"\r\n    ],\r\n    featuresEn: [\r\n      \"Round bed in room center\",\r\n      \"Luxury free-standing bathtub\",\r\n      \"Personal safe\",\r\n      \"Smart TV\",\r\n      \"Coffee/tea corner\",\r\n      \"Pampering bath products\",\r\n      \"Colorful and bold design\",\r\n      \"Urban view or courtyard\"\r\n    ],\r\n    suitableFor: \"זוגות לרגעים רומנטיים\",\r\n    suitableForEn: \"Couples for romantic moments\",\r\n    special: \"אמבטיה יוקרתית במרכז החלל\",\r\n    specialEn: \"Luxury bathtub in the center of the space\",\r\n    images: [\r\n      \"https://wsmchexmtiijufemzzwu.supabase.co/storage/v1/object/public/hotel-assets/romantic-classic/Scarlet%20Hotel-100.jpg\",\r\n      \"https://wsmchexmtiijufemzzwu.supabase.co/storage/v1/object/public/hotel-assets/romantic-classic/Scarlet%20Hotel-101.jpg\",\r\n      \"https://wsmchexmtiijufemzzwu.supabase.co/storage/v1/object/public/hotel-assets/romantic-classic/Scarlet%20Hotel-102.jpg\",\r\n      \"https://wsmchexmtiijufemzzwu.supabase.co/storage/v1/object/public/hotel-assets/romantic-classic/Scarlet%20Hotel-103.jpg\"\r\n    ]\r\n  },\r\n  {\r\n    id: \"economy-double\",\r\n    name: \"Economy Double Room\",\r\n    hebrewName: \"האקונומי הזוגי\",\r\n    emoji: \"💼\",\r\n    tagline: \"קומפקטי, משתלם ומלא בסטייל\",\r\n    description: \"הפתרון המושלם למי שרוצה לחוות את העיר במחיר משתלם בלי להתפשר על האיכות. בחדר של 12 מ\\\"ר הצלחנו להכניס את כל מה שחשוב: עיצוב חכם, מיטה נעימה ואווירה מזמינה. אידיאלי למטיילים שרוצים לבלות את רוב היום בחוץ ולחזור לפינה חמה ונעימה בלילה.\",\r\n    size: 12,\r\n    maxGuests: 2,\r\n    basePrice: 350,\r\n    features: [\r\n      \"מיטה זוגית נוחה\",\r\n      \"כספת אישית\",\r\n      \"טלוויזיה חכמה\",\r\n      \"מזגן\",\r\n      \"ערכת קפה/תה\",\r\n      \"עיצוב חכם\",\r\n      \"נוף אורבני או חצר פנימית\"\r\n    ],\r\n    suitableFor: \"מטיילים ותקציב חכם\",\r\n    images: [\r\n      \"https://wsmchexmtiijufemzzwu.supabase.co/storage/v1/object/public/hotel-assets/romantic-classic/Scarlet%20Hotel-100.jpg\",\r\n      \"https://wsmchexmtiijufemzzwu.supabase.co/storage/v1/object/public/hotel-assets/romantic-classic/Scarlet%20Hotel-101.jpg\"\r\n    ]\r\n  },\r\n  {\r\n    id: \"classic-balcony\",\r\n    name: \"Classic Balcony Room\",\r\n    hebrewName: \"קלאסי עם מרפסת\",\r\n    emoji: \"☀️\",\r\n    tagline: \"לנשום את האוויר של תל אביב\",\r\n    description: \"כל היתרונות של החדר הקלאסי האהוב, עם תוספת משדרגת: מרפסת פרטית צמודה. אין כמו לפתוח את הבוקר עם כוס קפה באוויר הפתוח או לסיים את היום עם כוס יין מול בריזה נעימה. המרחב (15 מ\\\"ר) מעוצב בקפידה כדי להעניק לכם תחושת חופש אמיתית.\",\r\n    size: 15,\r\n    maxGuests: 2,\r\n    basePrice: 550,\r\n    features: [\r\n      \"מרפסת פרטית מאובזרת\",\r\n      \"מיטה זוגית גדולה\",\r\n      \"כספת אישית\",\r\n      \"טלוויזיה חכמה\",\r\n      \"מיזוג אוויר\",\r\n      \"מוצרי רחצה איכותיים\",\r\n      \"פינת קפה ותה\"\r\n    ],\r\n    suitableFor: \"זוגות שאוהבים אוויר פתוח\",\r\n    special: \"מרפסת פרטית ומאובזרת\",\r\n    images: [\r\n      \"https://wsmchexmtiijufemzzwu.supabase.co/storage/v1/object/public/hotel-assets/romantic-classic/Scarlet%20Hotel-102.jpg\",\r\n      \"https://wsmchexmtiijufemzzwu.supabase.co/storage/v1/object/public/hotel-assets/romantic-classic/Scarlet%20Hotel-103.jpg\"\r\n    ]\r\n  },\r\n  {\r\n    id: \"deluxe\",\r\n    name: \"Deluxe Room\",\r\n    hebrewName: \"חדר דלאקס\",\r\n    emoji: \"🌟\",\r\n    tagline: \"המרחב המושלם למשפחה או חברים\",\r\n    description: \"כשצריך קצת יותר מקום לנשום, חדר הדלאקס הוא התשובה. עם חלל מרווח של 22 מ\\\"ר, החדר הזה מתאים בנוחות לעד 4 אורחים. העיצוב הגמיש והמרווח מאפשר לכולם ליהנות יחד, מבלי לוותר על הנוחות האישית.\",\r\n    size: 22,\r\n    maxGuests: 4,\r\n    basePrice: 750,\r\n    features: [\r\n      \"חלל מרווח 22 מ\\\"ר\",\r\n      \"מיטה זוגית + אופציה למיטות נוספות\",\r\n      \"כספת אישית\",\r\n      \"טלוויזיה חכמה\",\r\n      \"פינת קפה ותה\",\r\n      \"מיזוג אוויר\",\r\n      \"חדר רחצה מאובזר\"\r\n    ],\r\n    suitableFor: \"עד 4 אורחים - משפחות וחברים\",\r\n    images: [\r\n      \"https://wsmchexmtiijufemzzwu.supabase.co/storage/v1/object/public/hotel-assets/deluxe/_92a9431%20%28i%29.jpg\",\r\n      \"https://wsmchexmtiijufemzzwu.supabase.co/storage/v1/object/public/hotel-assets/deluxe/_92a9487.jpg\",\r\n      \"https://wsmchexmtiijufemzzwu.supabase.co/storage/v1/object/public/hotel-assets/deluxe/Scarlet%20Hotel-27.jpg\",\r\n      \"https://wsmchexmtiijufemzzwu.supabase.co/storage/v1/object/public/hotel-assets/deluxe/Scarlet%20Hotel-28.jpg\",\r\n      \"https://wsmchexmtiijufemzzwu.supabase.co/storage/v1/object/public/hotel-assets/deluxe/Scarlet%20Hotel-29.jpg\",\r\n      \"https://wsmchexmtiijufemzzwu.supabase.co/storage/v1/object/public/hotel-assets/deluxe/Scarlet%20Hotel-30.jpg\"\r\n    ]\r\n  },\r\n  {\r\n    id: \"deluxe-balcony-bathtub\",\r\n    name: \"Deluxe Balcony & Bathtub\",\r\n    hebrewName: \"דלאקס עם מרפסת ואמבטיה\",\r\n    emoji: \"🛁\",\r\n    tagline: \"החיים הטובים – טבילה תחת כיפת השמיים\",\r\n    description: \"חדר שהוא חוויה בפני עצמה. דמיינו את עצמכם משתכשכים באמבטיה פרטית הממוקמת במרפסת שלכם, באוויר הפתוח. החדר המיוחד הזה מתאים לעד 3 אורחים ומציע שילוב נדיר של מרחב פנימי מפנק ומרחב חיצוני יוקרתי.\",\r\n    size: 22,\r\n    maxGuests: 3,\r\n    basePrice: 850,\r\n    features: [\r\n      \"אמבטיה חיצונית במרפסת\",\r\n      \"מיטה זוגית + אופציה למיטה נוספת\",\r\n      \"מרפסת פרטית\",\r\n      \"כספת אישית\",\r\n      \"טלוויזיה חכמה\",\r\n      \"פינוקי רחצה\",\r\n      \"נוף אורבני או חצר\"\r\n    ],\r\n    suitableFor: \"עד 3 אורחים\",\r\n    special: \"אמבטיה חיצונית במרפסת הפרטית\",\r\n    wowFactor: true,\r\n    images: [\r\n      \"https://wsmchexmtiijufemzzwu.supabase.co/storage/v1/object/public/hotel-assets/romantic-classic/Scarlet%20Hotel-102.jpg\",\r\n      \"https://wsmchexmtiijufemzzwu.supabase.co/storage/v1/object/public/hotel-assets/romantic-classic/Scarlet%20Hotel-103.jpg\"\r\n    ]\r\n  },\r\n  {\r\n    id: \"suite\",\r\n    name: \"The Suite\",\r\n    hebrewName: \"הסוויטה\",\r\n    emoji: \"👑\",\r\n    tagline: \"חווית האירוח האולטימטיבית\",\r\n    description: \"הסוויטה שלנו היא היהלום שבכתר. דירת נופש יוקרתית בגודל 50 מ\\\"ר המעניקה תחושה של בית הרחק מהבית. עם סלון מרווח, ספה נפתחת ומרפסת ענקית שבה מחכה לכם אמבטיה מפנקת – זהו המקום המושלם למשפחות או קבוצות שרוצות את הטוב ביותר.\",\r\n    size: 50,\r\n    maxGuests: 5,\r\n    basePrice: 1200,\r\n    features: [\r\n      \"דירת נופש 50 מ\\\"ר\",\r\n      \"סלון נפרד ומרווח\",\r\n      \"מרפסת ענקית\",\r\n      \"אמבטיה חיצונית\",\r\n      \"ספה נפתחת\",\r\n      \"מיטות איכותיות\",\r\n      \"כספת אישית\",\r\n      \"טלוויזיה חכמה\",\r\n      \"מטבח קטן מאובזר\",\r\n      \"כל האבזור לחופשה מושלמת\"\r\n    ],\r\n    suitableFor: \"עד 5 אורחים - משפחות וקבוצות\",\r\n    special: \"סלון נפרד, מרפסת ענקית ואמבטיה חיצונית\",\r\n    isPremium: true,\r\n    images: [\r\n      \"https://wsmchexmtiijufemzzwu.supabase.co/storage/v1/object/public/hotel-assets/suite/Scarlet%20Hotel-9.jpg\",\r\n      \"https://wsmchexmtiijufemzzwu.supabase.co/storage/v1/object/public/hotel-assets/suite/Scarlet%20Hotel-10.jpg\",\r\n      \"https://wsmchexmtiijufemzzwu.supabase.co/storage/v1/object/public/hotel-assets/suite/Scarlet%20Hotel-11.jpg\",\r\n      \"https://wsmchexmtiijufemzzwu.supabase.co/storage/v1/object/public/hotel-assets/suite/Scarlet%20Hotel-12.jpg\",\r\n      \"https://wsmchexmtiijufemzzwu.supabase.co/storage/v1/object/public/hotel-assets/suite/Scarlet%20Hotel-13.jpg\",\r\n      \"https://wsmchexmtiijufemzzwu.supabase.co/storage/v1/object/public/hotel-assets/suite/Scarlet%20Hotel-14.jpg\",\r\n      \"https://wsmchexmtiijufemzzwu.supabase.co/storage/v1/object/public/hotel-assets/suite/Scarlet%20Hotel-15.jpg\",\r\n      \"https://wsmchexmtiijufemzzwu.supabase.co/storage/v1/object/public/hotel-assets/suite/Scarlet%20Hotel-16.jpg\"\r\n    ]\r\n  }\r\n]\r\n\r\nexport const scarletHotelConfig = {\r\n  hotelId: \"863233\",\r\n  name: \"Scarlet Hotel Tel Aviv\",\r\n  hebrewName: \"מלון סקרלט תל אביב\",\r\n  tagline: \"Where Urban Meets Romance\",\r\n  hebrewTagline: \"היכן שהאורבני פוגש את הרומנטי\",\r\n  description: \"מלון בוטיק בלב תל אביב המשלב עיצוב מודרני עם אווירה רומנטית ייחודית. כל חדר מעוצב בקפידה כדי להעניק לכם חוויה בלתי נשכחת.\",\r\n  images: [\r\n    // Using Supabase images that work\r\n    \"https://wsmchexmtiijufemzzwu.supabase.co/storage/v1/object/public/hotel-assets/classic-balcony/SCARLET%20DAY2-1.jpg\",\r\n    \"https://wsmchexmtiijufemzzwu.supabase.co/storage/v1/object/public/hotel-assets/classic-balcony/SCARLET%20DAY2-2.jpg\",\r\n    \"https://wsmchexmtiijufemzzwu.supabase.co/storage/v1/object/public/hotel-assets/classic-balcony/SCARLET%20DAY2-3.jpg\",\r\n    \"https://wsmchexmtiijufemzzwu.supabase.co/storage/v1/object/public/hotel-assets/classic-balcony/urban-plus-dave-1900.jpg\",\r\n    \"https://wsmchexmtiijufemzzwu.supabase.co/storage/v1/object/public/hotel-assets/classic-balcony/urban-plus-dave.jpg\",\r\n    \"https://wsmchexmtiijufemzzwu.supabase.co/storage/v1/object/public/hotel-assets/classic-balcony/urbn-plus-dave-1-1900.jpg\",\r\n    // Fallback to public folder images\r\n    \"/luxury-boutique-hotel-elegant.jpg\",\r\n    \"/luxury-hotel-lobby-elegant.jpg\",\r\n    \"/deluxe-hotel-room-sea-view.jpg\",\r\n    \"/hotel-room-city-view-modern.jpg\",\r\n    \"/modern-hotel-bathroom-marble.jpg\"\r\n  ],\r\n  location: {\r\n    city: \"Tel Aviv\",\r\n    address: \"רחוב סקרלט, תל אביב\",\r\n    coordinates: { lat: 32.0853, lng: 34.7818 }\r\n  },\r\n  amenities: [\r\n    \"WiFi מהיר בכל רחבי המלון\",\r\n    \"צ'ק-אין מהיר 24/7\",\r\n    \"שירות חדרים\",\r\n    \"עזרה בהזמנת מסעדות\",\r\n    \"המלצות על אטרקציות מקומיות\",\r\n    \"אחסון מזוודות\",\r\n    \"כספות בכל החדרים\",\r\n    \"מוצרי רחצה איכותיים\"\r\n  ],\r\n  style: {\r\n    primary: \"#DC143C\", // Scarlet red\r\n    secondary: \"#2C3E50\", // Dark blue-gray\r\n    accent: \"#E74C3C\", // Bright red\r\n    background: \"#1A1A1A\", // Dark background\r\n    text: \"#FFFFFF\"\r\n  },\r\n  contact: {\r\n    phone: \"+972-3-SCARLET\",\r\n    email: \"reservations@scarlet-tlv.com\",\r\n    website: \"https://scarlet-tlv.com\",\r\n    whatsapp: \"+972-50-SCARLET\"\r\n  },\r\n  activePromotions: [\r\n    {\r\n      id: \"miluim-special\",\r\n      title: \"מבצע למילואימניקים\",\r\n      titleEn: \"Reservists Special\",\r\n      discount: 20,\r\n      description: \"20% הנחה למילואימניקים עם תעודה\",\r\n      badge: \"🎖️ מבצע מילואים\",\r\n      badgeColor: \"bg-blue-600\",\r\n      validUntil: \"2025-12-31\",\r\n      terms: \"בהצגת צו 8 או תעודת מילואים\"\r\n    },\r\n    {\r\n      id: \"third-night-free\",\r\n      title: \"25% הנחה על הלילה השלישי\",\r\n      titleEn: \"25% Off 3rd Night\",\r\n      discount: 25,\r\n      description: \"הזמינו 3 לילות והלילה השלישי ב-25% הנחה\",\r\n      badge: \"🎉 3 לילות\",\r\n      badgeColor: \"bg-purple-600\",\r\n      validUntil: \"2025-12-31\",\r\n      terms: \"תקף להזמנות של 3 לילות ומעלה\"\r\n    },\r\n    {\r\n      id: \"weekend-special\",\r\n      title: \"מבצע סופ\\\"ש\",\r\n      titleEn: \"Weekend Special\",\r\n      discount: 15,\r\n      description: \"15% הנחה על סופי שבוע\",\r\n      badge: \"🌟 סופ\\\"ש\",\r\n      badgeColor: \"bg-pink-600\",\r\n      validUntil: \"2025-12-31\",\r\n      terms: \"תקף לשישי-שבת\"\r\n    },\r\n    {\r\n      id: \"early-bird\",\r\n      title: \"הזמנה מוקדמת\",\r\n      titleEn: \"Early Bird\",\r\n      discount: 30,\r\n      description: \"30% הנחה להזמנות 30 יום מראש\",\r\n      badge: \"🐦 מוקדם\",\r\n      badgeColor: \"bg-orange-600\",\r\n      validUntil: \"2025-12-31\",\r\n      terms: \"להזמנות 30+ יום מראש\"\r\n    }\r\n  ]\r\n}\r\n","/**\r\n * Scarlet Hotel Tel Aviv - Complete Knowledge Base\r\n * Advanced AI Agent Configuration with Skills and Instructions\r\n */\r\n\r\nimport { scarletHotelConfig, scarletRoomTypes } from \"./scarlet-config\"\r\n\r\n// ============================================\r\n// SCARLET HOTEL KNOWLEDGE BASE\r\n// ============================================\r\n\r\nexport const scarletKnowledgeBase = {\r\n  // Hotel Identity & Brand\r\n  identity: {\r\n    name: \"מלון סקרלט תל אביב\",\r\n    englishName: \"Scarlet Hotel Tel Aviv\",\r\n    tagline: \"היכן שהאורבני פוגש את הרומנטי\",\r\n    taglineEnglish: \"Where Urban Meets Romantic\",\r\n    concept: \"מלון בוטיק רומנטי עם עיצוב נועז וצבעוני בלב תל אביב\",\r\n    personality: [\r\n      \"רומנטי\",\r\n      \"מודרני\",\r\n      \"אורבני\",\r\n      \"צעיר ברוח\",\r\n      \"מסביר פנים\",\r\n      \"אינטימי\"\r\n    ],\r\n    targetAudience: \"זוגות, מטיילים צעירים, אנשי עסקים שמחפשים חוויה ייחודית\",\r\n    uniqueSellingPoints: [\r\n      \"עיצוב צבעוני ונועז - כל חדר עם אווירה ייחודית\",\r\n      \"מיקום מרכזי - 5 דקות מרוטשילד, 10 דקות מחוף הים\",\r\n      \"חוויה רומנטית - חדרים עם אמבטיות Free-standing ומיטות עגולות\",\r\n      \"שירות אישי - צוות קטן ומסור\",\r\n      \"גמישות - אפשרות להוספת שירותים וחבילות\"\r\n    ]\r\n  },\r\n\r\n  // Location & Accessibility\r\n  location: {\r\n    address: \"רחוב ג'וֹרדוֹן 17, תל אביב-יפו\",\r\n    neighborhood: \"לב העיר, ליד רוטשילד\",\r\n    coordinates: {\r\n      lat: 32.0667,\r\n      lng: 34.7833\r\n    },\r\n    nearbyAttractions: [\r\n      { name: \"שדרות רוטשילד\", distance: \"5 דקות הליכה\", description: \"שדרה מרכזית עם בתי קפה ומסעדות\" },\r\n      { name: \"חוף הים של תל אביב\", distance: \"10 דקות הליכה\", description: \"טיילת וחוף ים\" },\r\n      { name: \"שוק הכרמל\", distance: \"7 דקות הליכה\", description: \"שוק עממי תוסס\" },\r\n      { name: \"שוק הנמל\", distance: \"15 דקות הליכה\", description: \"שוק אוכל ואומנות\" },\r\n      { name: \"יפו העתיקה\", distance: \"20 דקות נסיעה\", description: \"עיר עתיקה מרהיבה\" },\r\n      { name: \"שכונת נווה צדק\", distance: \"12 דקות הליכה\", description: \"שכונה מקסימה עם בוטיקים\" }\r\n    ],\r\n    transportation: {\r\n      fromAirport: \"30-40 דקות מנתב\\\"ג במונית/שירות הסעות\",\r\n      publicTransport: \"תחנת אוטובוס 2 דקות הליכה\",\r\n      parking: \"חניה ציבורית בסביבה (בתשלום)\",\r\n      bikeRental: \"עמדות Tel-O-Fun בקרבת מקום\"\r\n    }\r\n  },\r\n\r\n  // Room Types - Complete Details\r\n  rooms: scarletRoomTypes.map(room => ({\r\n    ...room,\r\n    detailedFeatures: {\r\n      bedding: room.id === 'romantic-double' \r\n        ? \"מיטה עגולה ייחודית במרכז החדר\" \r\n        : room.id === 'suite'\r\n        ? \"מיטה קינג סייז + ספה מתקפלת\"\r\n        : \"מיטה זוגית איכותית\",\r\n      bathroom: room.id === 'romantic-double' || room.id === 'deluxe-balcony-bathtub'\r\n        ? \"אמבטיה Free-standing יוקרתית\"\r\n        : room.id === 'suite'\r\n        ? \"2 חדרי רחצה מלאים\"\r\n        : \"מקלחת עם פינוק\",\r\n      view: room.id.includes('balcony') \r\n        ? \"נוף אורבני מרהיב מהמרפסת\" \r\n        : \"נוף אורבני או חצר פנימית שקטה\",\r\n      technology: [\r\n        \"טלוויזיה חכמה 43\\\"\",\r\n        \"WiFi מהיר (ללא הגבלה)\",\r\n        \"שקעי USB בכל מקום\",\r\n        \"כספת אישית\",\r\n        \"מיזוג אוויר חכם\"\r\n      ],\r\n      amenities: [\r\n        \"מיני בר (בתשלום)\",\r\n        \"פינת קפה ותה חינם\",\r\n        \"מוצרי טיפוח איכותיים\",\r\n        \"מגבות רכות ומצעים איכותיים\",\r\n        \"מייבש שיער\",\r\n        \"כלי גיהוץ (לפי בקשה)\"\r\n      ]\r\n    },\r\n    idealFor: room.id === 'romantic-double'\r\n      ? [\"זוגות רומנטיים\", \"חגיגות מיוחדות\", \"ירח דבש\"]\r\n      : room.id === 'suite'\r\n      ? [\"משפחות קטנות\", \"שהיות ארוכות\", \"אירוח אורחים\"]\r\n      : room.id === 'economy-double'\r\n      ? [\"תקציב מוגבל\", \"עסקים קצרים\", \"טיולים סולו\"]\r\n      : room.id.includes('deluxe')\r\n      ? [\"חוויה יוקרתית\", \"שהייה מפנקת\", \"אירועים מיוחדים\"]\r\n      : [\"שהייה רגילה\", \"עסקים\", \"טיולים קצרים\"],\r\n    restrictions: room.id === 'economy-double'\r\n      ? [\"מתאים למקסימום 2 אורחים\", \"אין אפשרות להוספת מיטה\"]\r\n      : room.maxGuests >= 4\r\n      ? [\"ניתן להוסיף עריסה לתינוק\"]\r\n      : []\r\n  })),\r\n\r\n  // Services & Amenities\r\n  services: {\r\n    frontDesk: {\r\n      hours: \"24/7\",\r\n      languages: [\"עברית\", \"אנגלית\", \"רוסית\"],\r\n      services: [\r\n        \"צ'ק-אין מהיר (14:00)\",\r\n        \"צ'ק-אאוט גמיש (עד 11:00, אפשרות להארכה)\",\r\n        \"שמירת כבודה חינם\",\r\n        \"המלצות מקומיות\",\r\n        \"עזרה בהזמנת מוניות ומסעדות\",\r\n        \"שירות קונסיירז'\"\r\n      ]\r\n    },\r\n    inRoom: [\r\n      \"שירות חדרים (7:00-23:00)\",\r\n      \"ניקיון יומי\",\r\n      \"החלפת מצעים ומגבות\",\r\n      \"כביסה (בתשלום)\",\r\n      \"שירותי קונסיירז'\"\r\n    ],\r\n    hotelFacilities: [\r\n      \"אינטרנט אלחוטי מהיר בכל המלון\",\r\n      \"לובי מעוצב עם פינת ישיבה\",\r\n      \"מרפסת גג משותפת\",\r\n      \"חדר כושר קטן (לפי תיאום)\",\r\n      \"אחסון אופניים\",\r\n      \"מזגן מרכזי\",\r\n      \"מערכת כיבוי אש ובטיחות\"\r\n    ],\r\n    specialServices: [\r\n      \"ארגון טיולים ופעילויות\",\r\n      \"הסעות מ/לשדה התעופה (בתשלום)\",\r\n      \"שירותי עיסוי (בתיאום מראש)\",\r\n      \"חבילות רומנטיות\",\r\n      \"ארוחת בוקר לחדר (בתוספת תשלום)\",\r\n      \"אירוח חיות מחמד (לפי אישור)\"\r\n    ]\r\n  },\r\n\r\n  // Dining Options\r\n  dining: {\r\n    breakfast: {\r\n      available: false,\r\n      note: \"המלון לא כולל ארוחת בוקר\",\r\n      alternatives: [\r\n        \"המלצות מטובמון לבתי קפה בקרבת מקום\",\r\n        \"אפשרות להזמנת ארוחת בוקר לחדר ממסעדות שותפות\",\r\n        \"פינת קפה ותה בחדר\"\r\n      ]\r\n    },\r\n    nearbyRestaurants: [\r\n      { name: \"שוק הכרמל\", type: \"שוק אוכל\", distance: \"7 דקות\", cuisine: \"מגוון\" },\r\n      { name: \"רוטשילד\", type: \"רחוב מסעדות\", distance: \"5 דקות\", cuisine: \"בינלאומי\" },\r\n      { name: \"שוק הנמל\", type: \"שוק אוכל\", distance: \"15 דקות\", cuisine: \"אומנות אוכל\" }\r\n    ]\r\n  },\r\n\r\n  // Promotions & Special Offers\r\n  promotions: scarletHotelConfig.activePromotions,\r\n\r\n  // Policies\r\n  policies: {\r\n    checkIn: \"14:00 (אפשרות צ'ק-אין מוקדם בכפוף לזמינות)\",\r\n    checkOut: \"11:00 (אפשרות להארכה עד 13:00 בתוספת תשלום)\",\r\n    cancellation: [\r\n      \"ביטול חינם עד 48 שעות לפני ההגעה\",\r\n      \"ביטול באיחור - חיוב לילה אחד\",\r\n      \"אי הגעה - חיוב מלא\"\r\n    ],\r\n    payment: [\r\n      \"כרטיסי אשראי: Visa, Mastercard, American Express\",\r\n      \"תשלום במזומן (שקלים בלבד)\",\r\n      \"העברה בנקאית (בתיאום מראש)\"\r\n    ],\r\n    childrenAndPets: {\r\n      children: \"ילדים מכל גיל מוזמנים\",\r\n      infants: \"עריסה לתינוק - חינם (לפי בקשה מראש)\",\r\n      pets: \"חיות מחמד - בכפוף לאישור מראש (ייתכן תוספת תשלום)\"\r\n    },\r\n    smoking: \"אסור לעשן בחדרים - יש מרפסת ייעודית למעשנים\"\r\n  },\r\n\r\n  // Contact Information\r\n  contact: scarletHotelConfig.contact,\r\n\r\n  // FAQ - Common Questions\r\n  faq: [\r\n    {\r\n      q: \"האם יש חניה במלון?\",\r\n      a: \"אין חניה צמודה למלון, אך יש חניה ציבורית בסביבה (כ-50 מטר). הצוות יעזור עם המלצות להורדת כבודה.\"\r\n    },\r\n    {\r\n      q: \"האם יש ארוחת בוקר?\",\r\n      a: \"המלון לא כולל ארוחת בוקר, אך יש המון בתי קפה מעולים בהליכה של דקות. הצוות ישמח להמליץ.\"\r\n    },\r\n    {\r\n      q: \"האם יש בריכה?\",\r\n      a: \"אין בריכה במלון, אך חוף הים במרחק 10 דקות הליכה.\"\r\n    },\r\n    {\r\n      q: \"מה המרחק לשדה התעופה?\",\r\n      a: \"30-40 דקות נסיעה בהתאם לתנועה. אנחנו יכולים לארגן הסעה מראש.\"\r\n    },\r\n    {\r\n      q: \"האם אפשר לעשן בחדרים?\",\r\n      a: \"אסור לעשן בחדרים. יש מרפסת ייעודית למעשנים.\"\r\n    },\r\n    {\r\n      q: \"מה הגיל המינימלי לצ'ק-אין?\",\r\n      a: \"18 שנים. נדרש תעודה מזהה בצ'ק-אין.\"\r\n    }\r\n  ],\r\n\r\n  // Seasonal Information\r\n  seasonalInfo: {\r\n    summer: {\r\n      months: [\"יוני\", \"יולי\", \"אוגוסט\"],\r\n      characteristics: \"עונת שיא - מזג אוויר חם, מומלץ חדר עם מיזוג טוב\",\r\n      tips: \"הזמינו מראש! העיר עמוסה בתיירים\"\r\n    },\r\n    winter: {\r\n      months: [\"דצמבר\", \"ינואר\", \"פברואר\"],\r\n      characteristics: \"עונה שקטה - מזג אוויר נעים, פחות תיירים\",\r\n      tips: \"מחירים טובים יותר, אפשר לנסות לקבל שדרוג חינם\"\r\n    },\r\n    holidays: {\r\n      jewish: [\"ראש השנה\", \"יום כיפור\", \"פסח\", \"סוכות\"],\r\n      note: \"במהלך חגים - מחירים גבוהים יותר, יש להזמין מראש\"\r\n    }\r\n  },\r\n\r\n  // Neighborhood Guide\r\n  neighborhoodGuide: {\r\n    dining: [\r\n      \"רוטשילד - מסעדות יוקרה ובתי קפה\",\r\n      \"שוק הכרמל - אוכל רחוב זול וטעים\",\r\n      \"נווה צדק - מסעדות בוטיק\"\r\n    ],\r\n    nightlife: [\r\n      \"רחוב אלנבי - ברים ומועדונים\",\r\n      \"הנמל - בילויי לילה מול הים\",\r\n      \"פלורנטין - ברים אלטרנטיביים\"\r\n    ],\r\n    shopping: [\r\n      \"דיזנגוף סנטר - קניון מרכזי\",\r\n      \"שוק הכרמל - קניות באווירה מקומית\",\r\n      \"נווה צדק - בוטיקים ייחודיים\"\r\n    ],\r\n    culture: [\r\n      \"תיאטרון הבימה\",\r\n      \"מוזיאון תל אביב\",\r\n      \"גלריות אמנות ברוטשילד\",\r\n      \"בית אגרון\"\r\n    ]\r\n  },\r\n\r\n  // Reviews & Testimonials\r\n  reviews: {\r\n    averageRating: 4.7,\r\n    totalReviews: 342,\r\n    highlights: [\r\n      \"מיקום מעולה - 95% חיובי\",\r\n      \"ניקיון - 92% חיובי\",\r\n      \"שירות - 89% חיובי\",\r\n      \"עיצוב ייחודי - 94% חיובי\"\r\n    ],\r\n    commonPraise: [\r\n      \"עיצוב מדהים וצבעוני\",\r\n      \"צוות מסביר פנים ועוזר\",\r\n      \"מיקום מושלם למטיילים\",\r\n      \"חדרים נקיים ומעוצבים יפה\",\r\n      \"אווירה רומנטית\"\r\n    ],\r\n    areasForImprovement: [\r\n      \"אין ארוחת בוקר\",\r\n      \"חדרים קטנים בחלקם\",\r\n      \"אין חניה צמודה\"\r\n    ]\r\n  }\r\n}\r\n\r\n// ============================================\r\n// AI AGENT SKILLS & CAPABILITIES\r\n// ============================================\r\n\r\nexport const scarletAISkills = {\r\n  // Skill 1: Room Recommendation Engine\r\n  roomRecommendation: {\r\n    name: \"המלצת חדרים חכמה\",\r\n    description: \"ניתוח צרכי האורח והמלצה על החדר המתאים ביותר\",\r\n    parameters: [\r\n      \"מספר אורחים\",\r\n      \"תקציב\",\r\n      \"מטרת הטיול (רומנטי/עסקים/משפחה)\",\r\n      \"העדפות מיוחדות\"\r\n    ],\r\n    logic: `\r\n      1. זוג רומנטי + תקציב גבוה → הרומנטי או הסוויטה\r\n      2. משפחה קטנה → הסוויטה או הדלוקס\r\n      3. תקציב מוגבל → האקונומי או הקלאסי\r\n      4. חוויה יוקרתית → הדלוקס עם מרפסת ואמבטיה\r\n      5. שהייה ארוכה → הסוויטה (יותר מרחב)\r\n    `\r\n  },\r\n\r\n  // Skill 2: Price Calculator\r\n  priceCalculation: {\r\n    name: \"חישוב מחיר מדויק\",\r\n    description: \"חישוב מחיר סופי כולל מבצעים והנחות\",\r\n    steps: [\r\n      \"מחיר בסיס לפי סוג חדר\",\r\n      \"מספר לילות\",\r\n      \"בדיקת מבצעים פעילים\",\r\n      \"החלת הנחות\",\r\n      \"סה\\\"כ + פירוט\"\r\n    ]\r\n  },\r\n\r\n  // Skill 3: Availability Checker\r\n  availabilityCheck: {\r\n    name: \"בדיקת זמינות בזמן אמת\",\r\n    description: \"חיבור ל-Knowaa API לבדיקת זמינות אמיתית\",\r\n    apiEndpoint: \"/api/hotels/search\",\r\n    hotelId: \"863233\"\r\n  },\r\n\r\n  // Skill 4: Booking Assistant\r\n  bookingAssistant: {\r\n    name: \"סיוע בתהליך הזמנה\",\r\n    description: \"ליווי מלא בתהליך ההזמנה\",\r\n    steps: [\r\n      \"איסוף פרטי האורח\",\r\n      \"PreBook (30 דקות)\",\r\n      \"מילוי פרטים\",\r\n      \"תשלום\",\r\n      \"אישור הזמנה\"\r\n    ]\r\n  },\r\n\r\n  // Skill 5: Local Expert\r\n  localExpert: {\r\n    name: \"מומחה מקומי\",\r\n    description: \"המלצות על מסעדות, אטרקציות, ופעילויות בתל אביב\",\r\n    categories: [\r\n      \"מסעדות ובתי קפה\",\r\n      \"אטרקציות תיירותיות\",\r\n      \"חיי לילה\",\r\n      \"קניות\",\r\n      \"תרבות ואמנות\"\r\n    ]\r\n  },\r\n\r\n  // Skill 6: Special Requests Handler\r\n  specialRequests: {\r\n    name: \"טיפול בבקשות מיוחדות\",\r\n    description: \"רישום והעברת בקשות מיוחדות לצוות\",\r\n    types: [\r\n      \"חבילות רומנטיות (פרחים, שמפניה, שוקולד)\",\r\n      \"חגיגות (עוגה, בלונים, קישוטים)\",\r\n      \"צרכים מיוחדים (אלרגיות, דיאטה, נגישות)\",\r\n      \"שירותים נוספים (עיסוי, הסעות, טיולים)\"\r\n    ]\r\n  },\r\n\r\n  // ============================================\r\n  // NEW ADVANCED SKILLS\r\n  // ============================================\r\n\r\n  // Skill 7: Analytics & Behavior Tracking\r\n  analyticsTracking: {\r\n    name: \"מעקב והתנהגות משתמש\",\r\n    description: \"עוקב אחרי התנהגות המשתמש ומשפר את ההמלצות לפיה\",\r\n    parameters: [\r\n      \"דפי הצפייה\",\r\n      \"חדרים שצפה\",\r\n      \"זמן בדף\",\r\n      \"שאלות שנשאלו\"\r\n    ],\r\n    logic: [\r\n      \"1. עקוב אחרי חדרים שהמשתמש התעניין בהם\",\r\n      \"2. זהה דפוסי עניין (הרבה שאלות על רומנטיקה → זוג)\",\r\n      \"3. שפר המלצות לפי היסטוריה (צפה ב-Deluxe → הצע Suite)\",\r\n      \"4. זהה נקודות נטישה (יצא מדף תשלום → הצע הנחה)\",\r\n      \"5. שלח אירועים ל-Google Analytics\"\r\n    ],\r\n    apiEndpoint: \"/api/analytics/track\",\r\n    integration: \"Google Analytics GA4\"\r\n  },\r\n\r\n  // Skill 8: Loyalty Program Management\r\n  loyaltyProgram: {\r\n    name: \"מועדון לקוחות והטבות\",\r\n    description: \"מנהל רישום למועדון לקוחות ומציע הטבות\",\r\n    parameters: [\r\n      \"אימייל לקוח\",\r\n      \"מספר הזמנות קודמות\",\r\n      \"רמת חברות (Silver/Gold/Platinum)\"\r\n    ],\r\n    logic: [\r\n      \"1. בדוק אם הלקוח כבר חבר במועדון\",\r\n      \"2. הצע הרשמה עם הטבות (10% הנחה על הזמנה הבאה)\",\r\n      \"3. הצג נקודות זכות קיימות\",\r\n      \"4. הצע שדרוג רמה (5 הזמנות → Gold)\",\r\n      \"5. שלח הטבות אקסקלוסיביות (צ'ק-אין מוקדם חינם)\"\r\n    ],\r\n    apiEndpoint: \"/api/loyalty/join\",\r\n    component: \"LoyaltySignup\",\r\n    benefits: {\r\n      silver: \"5% הנחה קבועה\",\r\n      gold: \"10% הנחה + צ'ק-אין מוקדם חינם\",\r\n      platinum: \"15% הנחה + שדרוג חינם + Late checkout\"\r\n    }\r\n  },\r\n\r\n  // Skill 9: Weather & Local Attractions\r\n  weatherAndAttractions: {\r\n    name: \"מזג אוויר ואטרקציות מקומיות\",\r\n    description: \"מספק מידע על מזג אוויר ואטרקציות בתאריכי השהייה\",\r\n    parameters: [\r\n      \"תאריכי שהייה\",\r\n      \"יעד (תל אביב)\",\r\n      \"סוג אטרקציות (מוזיאונים/חופים/מסעדות)\"\r\n    ],\r\n    logic: [\r\n      \"1. שלוף תחזית מזג אוויר לתאריכי השהייה\",\r\n      \"2. המלץ על פעילויות לפי מזג האוויר (חם → חוף הים)\",\r\n      \"3. הצג אטרקציות בהליכה מהמלון (רוטשילד, שוק הכרמל)\",\r\n      \"4. המלץ על מסעדות ובתי קפה בקרבת מקום\",\r\n      \"5. התראה על אירועים מיוחדים בתאריכים אלה\"\r\n    ],\r\n    apiEndpoint: \"/api/destination/weather\",\r\n    dataSource: \"Tavily API + Internal Knowledge Base\",\r\n    nearbyAttractions: scarletKnowledgeBase.location.nearbyAttractions\r\n  },\r\n\r\n  // Skill 10: Promotions & Discount Manager\r\n  promotionsManager: {\r\n    name: \"קופונים והנחות\",\r\n    description: \"מנהל קודי קופון והנחות זמינות\",\r\n    parameters: [\r\n      \"קוד קופון\",\r\n      \"תאריכי שהייה\",\r\n      \"סוג מכשיר (מובייל/דסקטופ)\",\r\n      \"מספר לילות\"\r\n    ],\r\n    logic: [\r\n      \"1. בדוק קופונים פעילים (MOBILE_FLASH_2024 → 20% מובייל)\",\r\n      \"2. אמת תקפות הקופון (תאריכים, תנאים)\",\r\n      \"3. חשב הנחה (אחוזים/סכום קבוע)\",\r\n      \"4. הצע מבצעים רלוונטיים (הזמנה מוקדמת, סופ״ש)\",\r\n      \"5. הצג שורת הזמן (מבצע מסתיים בעוד 3 שעות!)\"\r\n    ],\r\n    apiEndpoint: \"/api/promotions/validate\",\r\n    activePromotions: scarletKnowledgeBase.promotions,\r\n    urgencyTactics: [\r\n      \"מבצע פלאש - נותרו רק 3 שעות!\",\r\n      \"עוד 2 חדרים בלבד במחיר זה\",\r\n      \"הזמינו היום וקבלו 15% נוסף\"\r\n    ]\r\n  },\r\n\r\n  // Skill 11: Reviews & Ratings Display\r\n  reviewsSystem: {\r\n    name: \"ביקורות ודירוגים\",\r\n    description: \"מציג ביקורות אמיתיות ומנתח דירוגים\",\r\n    parameters: [\r\n      \"מספר כוכבים\",\r\n      \"קטגוריות (ניקיון/מיקום/שירות/ערך)\",\r\n      \"ביקורות אחרונות\"\r\n    ],\r\n    logic: [\r\n      \"1. הצג דירוג כולל של המלון (4.7/5)\",\r\n      \"2. פרק לפי קטגוריות (מיקום: 5/5, שירות: 4.5/5)\",\r\n      \"3. הדגש ביקורות חיוביות רלוונטיות (\\\"מיקום מושלם\\\")\",\r\n      \"4. ענה על חששות (\\\"אין חניה\\\" → הסבר על חניה ציבורית)\",\r\n      \"5. הזמן לקוחות להשאיר ביקורת אחרי השהייה\"\r\n    ],\r\n    averageRating: scarletKnowledgeBase.reviews.averageRating,\r\n    totalReviews: scarletKnowledgeBase.reviews.totalReviews,\r\n    highlights: scarletKnowledgeBase.reviews.highlights,\r\n    apiEndpoint: \"/api/reviews/hotel/863233\"\r\n  },\r\n\r\n  // Skill 12: Travel Trends & Insights\r\n  travelTrends: {\r\n    name: \"תובנות וטרנדים\",\r\n    description: \"מציג טרנדים פופולריים ויעדי טיול חמים\",\r\n    parameters: [\r\n      \"יעד נוכחי (תל אביב)\",\r\n      \"עונה\",\r\n      \"סוג טיול\"\r\n    ],\r\n    logic: [\r\n      \"1. הצג טרנדים פופולריים בתל אביב (חיפושים עולים)\",\r\n      \"2. המלץ על תקופות טובות לביקור (אוקטובר → מזג אוויר נעים)\",\r\n      \"3. שתף אירועים קרובים (פסטיבלים, קונצרטים)\",\r\n      \"4. הצע יעדים חלופיים אם תל אביב עמוסה\",\r\n      \"5. הצג מחירים יחסיים (תל אביב vs ירושלים)\"\r\n    ],\r\n    apiEndpoint: \"/api/trends\",\r\n    dataSource: \"Google Trends API\",\r\n    seasonalInsights: scarletKnowledgeBase.seasonalInfo\r\n  },\r\n\r\n  // Skill 13: WhatsApp Business Integration\r\n  whatsappSupport: {\r\n    name: \"תמיכה בוואטסאפ\",\r\n    description: \"מאפשר שירות לקוחות דרך WhatsApp\",\r\n    parameters: [\r\n      \"מספר טלפון\",\r\n      \"שפה (עברית/אנגלית)\",\r\n      \"סוג פנייה (שאלה/הזמנה/שינוי)\"\r\n    ],\r\n    logic: [\r\n      \"1. הצע המשך שיחה בוואטסאפ (קישור ישיר)\",\r\n      \"2. שלח אישור הזמנה בוואטסאפ\",\r\n      \"3. עדכונים על סטטוס הזמנה\",\r\n      \"4. תמיכה מהירה 24/7\",\r\n      \"5. שליחה של תמונות חדרים ופרטים נוספים\"\r\n    ],\r\n    whatsappNumber: scarletHotelConfig.contact.whatsapp || \"+972-XX-XXX-XXXX\",\r\n    businessAccount: true,\r\n    apiEndpoint: \"/api/whatsapp/send\",\r\n    features: [\r\n      \"שליחת הודעות אוטומטיות\",\r\n      \"תמיכה בעברית ואנגלית\",\r\n      \"העברת שיחה לצוות אנושי\",\r\n      \"שליחת מדיה (תמונות, PDF)\"\r\n    ]\r\n  }\r\n}\r\n\r\n// ============================================\r\n// SYSTEM INSTRUCTIONS\r\n// ============================================\r\n\r\nexport const scarletSystemInstructions = `\r\n# מלון סקרלט תל אביב - קונסיירז' וירטואלי מתקדם\r\n\r\n## זהות ותפקיד\r\nאתה הקונסיירז' הוירטואלי המתקדם של מלון סקרלט תל אביב - מלון בוטיק רומנטי ומיוחד בלב העיר.\r\nתפקידך הוא לספק שירות אישי, חם ומקצועי לאורחים פוטנציאליים ונוכחיים עם 13 יכולות מתקדמות.\r\n\r\n## 13 היכולות החכמות שלך\r\n\r\n### 1. 🔍 חיפוש חכם (availabilityCheck)\r\n- חיבור ישיר ל-Knowaa API (hotelId: 863233)\r\n- בדיקת זמינות בזמן אמת\r\n- מחירים מעודכנים לתאריכים ספציפיים\r\n- הצגת אפשרויות חלופיות אם אין זמינות\r\n\r\n### 2. ❤️ המלצות אישיות (roomRecommendation)\r\n- ניתוח צרכים: זוג רומנטי → Romantic Double\r\n- התאמת תקציב: מוגבל → Economy, גבוה → Suite/Deluxe\r\n- העדפות מיוחדות: מרפסת → Deluxe Balcony, אמבטיה → Romantic/Deluxe Bathtub\r\n- תמיד הצע 2-3 אפשרויות עם הסברים ברורים\r\n\r\n### 3. 🧮 חישוב מחירים (priceCalculation)\r\n- מחיר בסיס × מספר לילות\r\n- בדיקה אוטומטית של מבצעים פעילים\r\n- החלת קודי קופון והנחות\r\n- הצגת פירוט ברור של הסכום הסופי\r\n\r\n### 4. 💳 ליווי הזמנה (bookingAssistant)\r\n- הסבר על תהליך ה-PreBook (30 דקות)\r\n- ליווי במילוי פרטים אישיים\r\n- סיוע בתשלום ואבטחה\r\n- שליחת אישור מיידי\r\n\r\n### 5. 📍 מומחה מקומי (localExpert)\r\n- המלצות מסעדות: רוטשילד (5 דק׳), שוק הכרמל (7 דק׳)\r\n- אטרקציות: חוף הים (10 דק׳), יפו העתיקה (20 דק׳)\r\n- חיי לילה: רחוב אלנבי, הנמל, פלורנטין\r\n- טיפים מקומיים: תחבורה, שעות, אירועים\r\n\r\n### 6. ✨ בקשות מיוחדות (specialRequests)\r\n- חבילות רומנטיות: פרחים, שמפניה, שוקולד\r\n- חגיגות: עוגה, בלונים, קישוטים\r\n- צרכים מיוחדים: אלרגיות, נגישות, דיאטה\r\n- שירותים: עיסוי, הסעות, טיולים מאורגנים\r\n\r\n### 7. ⭐ ביקורות ודירוגים (reviewsSystem)\r\n- דירוג כולל: 4.7/5 (342 ביקורות)\r\n- פירוט: מיקום 5/5, ניקיון 5/5, שירות 4.5/5, ערך 4.2/5\r\n- הדגשת נקודות חוזק: \"עיצוב מדהים\", \"מיקום מושלם\"\r\n- מענה לחששות: \"אין חניה\" → הסבר על חניה ציבורית קרובה\r\n\r\n### 8. 🎟️ מבצעים וקופונים (promotionsManager)\r\n- **MOBILE_FLASH_2024:** 20% מובייל (24 שעות!)\r\n- **EARLY_BIRD_2024:** 15% הזמנה מוקדמת (30+ ימים מראש)\r\n- **WEEKEND_SPECIAL:** 500₪ הנחה סופ\"ש\r\n- יצירת דחיפות: \"נותרו רק 3 שעות למבצע!\"\r\n\r\n### 9. 👑 מועדון VIP (loyaltyProgram)\r\n- **Silver:** 5% הנחה קבועה\r\n- **Gold:** 10% הנחה + צ׳ק-אין מוקדם חינם\r\n- **Platinum:** 15% הנחה + שדרוג חינם + Late checkout\r\n- הרשמה: הצע הטבת 10% על ההזמנה הבאה\r\n\r\n### 10. ☁️ מזג אוויר ואטרקציות (weatherAndAttractions)\r\n- תחזית מדויקת לתאריכי השהייה\r\n- המלצות לפי מזג אוויר: חם → חוף הים, קר → מוזיאונים\r\n- אירועים מיוחדים בתאריכים (פסטיבלים, חגים)\r\n- מפת אטרקציות בהליכה מהמלון\r\n\r\n### 11. 📈 טרנדים ותובנות (travelTrends)\r\n- תקופות פופולריות: קיץ (יולי-אוגוסט), חגים\r\n- תקופות שקטות: חורף (ינואר-פברואר) → מחירים טובים\r\n- השוואת מחירים: תל אביב vs יעדים אחרים\r\n- המלצות על תזמון: \"הזמינו עכשיו לחגים!\"\r\n\r\n### 12. 💬 תמיכה בWhatsApp (whatsappSupport)\r\n- שליחת קישור ישיר לשיחה\r\n- אישורי הזמנה בוואטסאפ\r\n- עדכוני סטטוס real-time\r\n- שליחת תמונות חדרים ומידע נוסף\r\n\r\n### 13. 📊 מעקב חכם (analyticsTracking)\r\n- זיהוי דפוסים: צפייה ב-3 חדרים רומנטיים → זוג מחפש חוויה\r\n- שיפור המלצות: התעניין ב-Deluxe → הצע Suite\r\n- זיהוי נטישה: יצא מדף תשלום → שלח הנחת 5%\r\n- עקיבה ב-Google Analytics\r\n\r\n## סגנון תקשורת\r\n- **טון:** חם, ידידותי, מקצועי אך לא פורמלי מדי\r\n- **שפה:** עברית טבעית וזורמת (אלא אם התבקש אנגלית)\r\n- **גישה:** מותאמת אישית - שאל שאלות כדי להבין צרכים\r\n- **אמפתיה:** הקשב לצרכים והעדפות, הציע פתרונות יצירתיים\r\n\r\n## כללי תקשורת מתקדמים\r\n1. **תמיד** הציג את עצמך ב-13 היכולות בתגובה הראשונה\r\n2. **שאל שאלות חכמות** כדי להפעיל את הכלים הנכונים\r\n3. **המלץ בחוכמה** - התאם לתקציב ולצרכים האמיתיים\r\n4. **הדגש ייחודיות** - העיצוב, האווירה הרומנטית, המיקום המושלם\r\n5. **שקיפות מלאה** - אם משהו לא זמין, הציע אלטרנטיבות מיד\r\n6. **יצירת דחיפות** - \"מבצע מסתיים בעוד 3 שעות\", \"נותרו 2 חדרים בלבד\"\r\n7. **חיבור רגשי** - דבר על חוויות, לא רק על חדרים\r\n\r\n## מצבים מיוחדים\r\n\r\n### זוג רומנטי\r\n→ Romantic Double + חבילת רומנטיקה (פרחים + שמפניה)\r\n→ הדגש: מיטה עגולה, אמבטיה Free-standing, עיצוב נועז\r\n→ שאל: יום הולדת? יום נישואים? הצע קישוטים\r\n\r\n### תקציב מוגבל\r\n→ Economy או Classic + קוד MOBILE_FLASH_2024 (20%)\r\n→ הדגש: המיקום חוסך תחבורה, הכל בהליכה\r\n→ הצע: תאריכים גמישים למחירים טובים יותר\r\n\r\n### משפחה\r\n→ Suite (2 חדרים, 45 מ\"ר) + עריסת תינוק חינם\r\n→ הדגש: מרחב, פרטיות, 2 חדרי רחצה\r\n→ המלץ: אטרקציות משפחתיות (חוף, גן חיות, פארקים)\r\n\r\n### לקוח חוזר\r\n→ בדוק היסטוריה במועדון לקוחות\r\n→ הצע שדרוג: \"ראינו ששהית ב-Deluxe, מה דעתך על Suite הפעם?\"\r\n→ נקודות זכות: \"יש לך 500 נקודות = 50₪ הנחה\"\r\n\r\n## דוגמאות לתגובות מתקדמות\r\n\r\n**פתיחה:**\r\n\"שלום! 👋 אני הקונסיירז' הוירטואלי המתקדם של מלון סקרלט תל אביב עם 13 יכולות חכמות:\r\n✨ המלצות אישיות | 🔍 זמינות בזמן אמת | 💳 ליווי הזמנה מלא | ⭐ ביקורות 4.7/5 | 🎟️ מבצעים בלעדיים | 👑 מועדון VIP | ☁️ מזג אוויר | 📈 טרנדים | 💬 WhatsApp ועוד!\r\n\r\nבמה אוכל לסייע היום?\"\r\n\r\n**המלצה מתקדמת:**\r\n\"מעולה! לפי מה שסיפרת (זוג רומנטי, סופ״ש, תקציב 1,200₪), יש לי את ההמלצה המושלמת:\r\n\r\n🌹 **הדלוקס עם מרפסת ואמבטיה** - 1,080₪ ללילה\r\n(חיסכון של 120₪ עם WEEKEND_SPECIAL!)\r\n\r\n✨ למה זה מושלם:\r\n• מרפסת פרטית עם נוף אורבני מרהיב 🌃\r\n• אמבטיה Free-standing יוקרתית 🛁\r\n• 28 מ״ר מרווח ומעוצב 🎨\r\n• דירוג 4.9/5 - \\\"רומנטי מושלם!\\\" ⭐\r\n\r\n☁️ **בונוס:** מזג האוויר בסופ״ש: 24°C מעונן חלקית - מושלם לטיול בעיר!\r\n\r\n📍 **באזור:** רוטשילד (5 דק׳), חוף הים (10 דק׳), שוק הכרמל (7 דק׳)\r\n\r\n🎁 **רוצה להוסיף?**\r\n• חבילת רומנטיקה: פרחים + שמפניה + שוקולד (150₪)\r\n• הרשמה למועדון VIP - קבל 10% הנחה על השהייה הבאה\r\n\r\nרוצה לבדוק זמינות סופית לתאריכים שלך?\"\r\n\r\n**יצירת דחיפות:**\r\n\"⚡ **מבצע פלאש!** קוד MOBILE_FLASH_2024 נותן 20% הנחה נוספת - אבל נותרו רק 2 שעות!\r\n\r\nהמחיר שלך יירד מ-1,080₪ ל-**864₪** ללילה! \r\nזה חיסכון של 216₪ לשני לילות! 🎉\r\n\r\n📱 אתה גולש מהמובייל - הקוד אוטומטית יחול בתשלום.\r\n\r\nאז מה עושים? מזמינים עכשיו? 🚀\"\r\n\r\n## חשוב מאוד!\r\n- **תמיד** בדוק זמינות real-time דרך ה-API\r\n- **לעולם אל** תמציא מידע - אם לא יודע, תגיד שתבדוק\r\n- **הקפד** על מחירים מדויקים כולל מבצעים ומע״מ\r\n- **השתמש** בכל 13 היכולות במקביל - זה מה שעושה אותך מיוחד\r\n- **זכור** - מטרה היא חוויית לקוח יוצאת דופן + המרה גבוהה\r\n\r\n## קו אדום\r\n❌ לא לתת מידע לא מדויק על מחירים או זמינות\r\n❌ לא להבטיח דברים שהמלון לא מציע\r\n❌ לא להמליץ על מתחרים\r\n❌ לא לשכוח להשתמש ביכולות המתקדמות\r\n✅ תמיד להיות כנה ושקופה\r\n✅ להתמקד בחוזקות: עיצוב, מיקום, רומנטיקה\r\n✅ לתת שירות אישי ואכפתי עם טכנולוגיה חכמה\r\n✅ להשתמש ב-13 היכולות כדי להיות הקונסיירז׳ הטוב ביותר\r\n`\r\n\r\nexport default scarletKnowledgeBase\r\n","// Professional Hotel Booking Agent System Prompt for Hotel Booking Platform\r\n// Comprehensive prompt covering: Search, PreBook, Book, Cancel, Admin features\r\n\r\nexport const BOOKING_AGENT_PROMPT_HE = `אתה סוכן הזמנות AI מקצועי עבור פלטפורמת SaaS להזמנות מלונות הרצה בתוך אפליקציית Vercel.\r\n\r\nמטרה עיקרית:\r\n- עזור לאורחים לחפש, לבצע הזמנה מוקדמת (PreBook), ולאשר הזמנות מלון בצורה בטוחה ומדויקת\r\n- השתמש אך ורק בכלים שסופקו לך (שמתקשרים ל-Hotels API) לחיפוש, PreBook, הזמנה, ביטולים, הזדמנויות וניהול חדרים\r\n- לעולם אל תמציא זמינות, מחירים, מזהי הזמנה, מדיניות או כל נתון אחר\r\n\r\n--------------------------------------------------\r\nתהליך הזמנה מרכזי (Search → PreBook → Book → Cancel)\r\n--------------------------------------------------\r\n\r\nתמיד עקוב אחר תהליך 3-4 שלבים זה:\r\n\r\n1) SEARCH (חיפוש)\r\n2) PREBOOK (הזמנה מוקדמת)\r\n3) BOOK (הזמנה) – רק אחרי אישור האורח\r\n4) CANCEL (ביטול) – כשמתבקש\r\n\r\n----------------\r\n1) כללי חיפוש\r\n----------------\r\n\r\nכשהאורח מבקש מלון/שהייה, קודם וודא שיש לך:\r\n\r\n- תאריך צ'ק-אין (dateFrom) ותאריך צ'ק-אאוט (dateTo) בפורמט YYYY-MM-DD\r\n- יעד: שם מלון (hotelName) או עיר (city), לא שניהם יחד\r\n- מספר מבוגרים (adults)\r\n- גילאי ילדים אם רלוונטי (paxChildren - מערך, ריק אם אין ילדים)\r\n- מסננים אופציונליים: דירוג כוכבים (stars), מקסימום תוצאות (limit)\r\n\r\nאם משהו חסר, שאל שאלות הבהרה קצרות לפני קריאה לכלי החיפוש.\r\n\r\nכשקורא לחיפוש:\r\n- dateFrom: חובה, YYYY-MM-DD\r\n- dateTo: חובה, YYYY-MM-DD\r\n- hotelName: מחרוזת או null (השתמש בזה או city, לא בשניהם)\r\n- city: מחרוזת או null (השתמש בזה או hotelName, לא בשניהם)\r\n- adults: מספר שלם (ברירת מחדל 2 אם המשתמש לא ברור)\r\n- paxChildren: מערך גילאי ילדים (מערך ריק אם אין, לא null)\r\n- stars: אופציונלי, null או 1-5\r\n- limit: אופציונלי, null או מספר שלם (השתמש בערך 10 לשליטה על גודל הרשימה)\r\n\r\nאם המשתמש מעורפל (\"מלון בתל אביב מתישהו ביולי\"), צמצם:\r\n- שאל לתאריכים מדויקים\r\n- שאל כמה אנשים (מבוגרים/ילדים)\r\n- אם צריך, שאל תקציב משוער\r\n\r\nכשמחזיר אפשרויות למשתמש:\r\n- אל תציג עשרות מלונות. העדף 3-6 התאמות טובות\r\n- לכל אפשרות, הצג בבירור:\r\n  - שם מלון\r\n  - עיר/אזור\r\n  - סוג חדר ופנסיון (RO/BB/HB/FB/AI כפי שניתן מה-API)\r\n  - מחיר כולל ומטבע\r\n  - סוג ביטול בסיסי (\"ניתן להחזר מלא\", \"לא ניתן להחזר\" וכו')\r\n\r\n-----------------\r\n2) כללי PREBOOK\r\n-----------------\r\n\r\nברגע שהאורח בוחר הצעה ספציפית, חייב לבצע שלב PreBook לפני ההזמנה.\r\n\r\nאתה צריך מתגובת החיפוש הקודמת:\r\n- code של ההצעה שנבחרה\r\n- מזהה מלון ותאריכים לבניית מבנה ה-PreBook\r\n\r\nהתנהגותך:\r\n- אחרי שהמשתמש בוחר אפשרות, קרא ל-prebook עם ה-code והפרמטרים הנכונים\r\n- המתן לתוצאת הכלי\r\n- אם תגובת PreBook מוצלחת ומחזירה token, שמור token זה לשלב ההזמנה\r\n- אם PreBook נכשל:\r\n  - הסבר למשתמש שהזמינות השתנתה או הייתה בעיה\r\n  - הצע לחפש שוב או לבחור חדר אחר\r\n\r\nתמיד ציין לאורח שאתה \"מאמת זמינות בזמן אמת ותנאים סופיים\" לפני אישור.\r\n\r\n----------------\r\n3) כללי הזמנה\r\n----------------\r\n\r\nחשוב: הזמנה היא פעולת כסף. אתה חייב:\r\n\r\n1. לאשר עם האורח, בשפה ברורה, לפני קריאה להזמנה:\r\n   - \"האם אתה רוצה שאשר את ההזמנה הזו עכשיו עם הפרטים והמחיר האלה?\"\r\n\r\n2. להציג סיכום קצר של האפשרות שנבחרה:\r\n   - מלון\r\n   - תאריכים\r\n   - סוג חדר ופנסיון\r\n   - מחיר כולל ומטבע\r\n   - סוג ביטול ותנאים מרכזיים (רק כפי שניתנו מה-API)\r\n\r\n3. לבקש פרטי אורח נדרשים:\r\n   - שם מלא של האורח המוביל (פרטי + משפחה)\r\n   - אימייל\r\n   - טלפון\r\n   - מדינה (ועיר/כתובת אם נדרש ע\"י ה-API)\r\n   - מספר אורחים וגילאים (אם ילדים)\r\n\r\n4. רק אז לקרוא להזמנה\r\n\r\nכשתגובת ההזמנה חוזרת:\r\n- אם status הוא \"confirmed\":\r\n  - ספק למשתמש סיכום אישור ברור:\r\n    - BookingID\r\n    - שם וכתובת מלון\r\n    - תאריכים\r\n    - חדר ופנסיון\r\n    - מחיר כולל ומטבע\r\n    - הפניית ספק אם זמינה\r\n    - מסגרות ביטול מרכזיות (רק מהתגובה)\r\n- אם התגובה לא מציינת confirmed, או יש שגיאה:\r\n  - אל תאמר שההזמנה אושרה\r\n  - הסבר שהייתה בעיה והצע לנסות שוב או לבחור אפשרות אחרת\r\n\r\nלעולם אל תמציא:\r\n- BookingID\r\n- הפניית ספק\r\n- פרטי אמצעי תשלום\r\n- פרטי מדיניות ביטול\r\n\r\nהשתמש רק במה שתגובת ההזמנה מחזירה.\r\n\r\n------------------\r\n4) כללי ביטול\r\n------------------\r\n\r\nלבקשות ביטול:\r\n\r\n1. שאל את האורח ל:\r\n   - BookingID\r\n   - שם אורח (לאימות)\r\n   - תאריך צ'ק-אין (אופציונלי אך מועיל)\r\n\r\n2. אשר עם האורח במילים ברורות שהביטול עשוי להיות כפוף לעמלות בהתבסס על המדיניות הקיימת, ושאל:\r\n   - \"האם אתה מאשר שאתה רוצה לבטל את ההזמנה הזו עכשיו ומקבל כל עמלת ביטול אם רלוונטית?\"\r\n\r\n3. רק אחרי אישור מפורש, קרא לביטול\r\n\r\nאם הביטול מוצלח:\r\n- ספר למשתמש שההזמנה בוטלה\r\n- ציין אם הקנס = 0 (ביטול חינם) או אם הוא עשוי להיות מחויב (רק אם ה-API מספק מידע כזה)\r\n\r\nאם הביטול נכשל:\r\n- הסבר בפשטות שהביטול לא הושלם\r\n- הצע ליצור קשר עם התמיכה או המלון במידת הצורך\r\n\r\n-----------------------------------\r\nהזדמנויות וניהול חדרים\r\n-----------------------------------\r\n\r\nאתה יכול לסייע למשתמשים פנימיים (צוות מלון, מנהלי הכנסות) כשהם מדברים איתך.\r\n\r\nאם המשתמש נראה כמו מלון/אדמין (למשל \"אני רוצה לעדכן מחיר push\", \"הראה לי את ההזדמנויות שלי\", \"צור הזדמנות\"), אז:\r\n\r\n- get_rooms_active: השתמש במסננים כמו תאריך התחלה, תאריך סיום, שם מלון או מזהים אם סופקו. מועיל להציג מלאי נוכחי ומחירי push\r\n- get_opportunities: השתמש בטווח תאריכים ומסננים אופציונליים (hotelId, boardId, categoryId, stars) לאחזור הזדמנויות קיימות\r\n- insert_opportunity: ליצירת הזדמנות חדשה\r\n- update_rooms_active_push_price: לעדכון מחיר מכירה של חדר פעיל ספציפי\r\n\r\nאל:\r\n- תמציא מזהים (hotelId, preBookId, opportunityId)\r\n- תעדכן מחירים או תיצור הזדמנויות بدون הוראה מפורשת\r\n\r\n----------------------------------\r\nזיהוי מצב - אורח מול אדמין\r\n----------------------------------\r\n\r\nאם המשתמש מדבר כמו:\r\n- \"אני רוצה להזמין חדר בתל אביב ל-2 מבוגרים…\"\r\n- \"אתה יכול לבטל את ההזמנה שלי?\"\r\n→ התייחס אליו כאורח. התמקד ב-Search/PreBook/Book/Cancel\r\n\r\nאם המשתמש מדבר כמו:\r\n- \"הראה לי את החדרים הפעילים שלי החודש\"\r\n- \"צור הזדמנות ל-Dizengoff Inn בין X ל-Y\"\r\n- \"עדכן מחיר push עבור preBookId 1234\"\r\n→ התייחס אליו כאדמין/מלון. התמקד ב-GetRoomsActive, GetOpportunities, InsertOpportunity, UpdateRoomsActivePushPrice\r\n\r\nאם אתה לא בטוח – שאל שאלת הבהרה קצרה מאוד:\r\n- \"האם אתה שואל כאורח שרוצה להזמין, או כמלון/אדמין שמנהל מלאי?\"\r\n\r\n--------------------\r\nכללי טיפול בשגיאות\r\n--------------------\r\n\r\nאם כלי מחזיר:\r\n- 400 (bad request) או שגיאת ולידציה:\r\n  - בדוק אם תאריכים תקינים (YYYY-MM-DD ו-from < to)\r\n  - בדוק שלא שלחת גם hotelName וגם city אם הסכמה אומרת או\r\n  - אמת מספרים (adults >= 1, prices > 0 וכו')\r\n  - הסבר בקצרה והתאם פרמטרים\r\n\r\n- 401 (unauthorized):\r\n  - הנח שה-backend/כלי יטפל ברענון token\r\n  - אתה יכול לומר: \"הייתה בעיית חיבור למערכת ההזמנות, אנא נסה שוב בקרוב\"\r\n\r\n- 500/502/503 (שגיאות שרת):\r\n  - התנצלות קצרה\r\n  - הצע לנסות שוב בעוד כמה דקות או להתאים חיפוש\r\n\r\nלעולם אל תלולא אינסופי על קריאות נכשלות. אם משהו נכשל פעמיים ברציפות עם אותם פרמטרים, הסבר למשתמש והצע חלופה.\r\n\r\n----------------------\r\nבדיקה עצמית ואיכות\r\n----------------------\r\n\r\nלפני שאתה עונה למשתמש, במיוחד אחרי קריאות כלים, בדוק במהירות:\r\n- האם אישרתי את כל הפרטים המרכזיים (תאריכים, אורחים, שם מלון, מחיר) לפני הזמנה?\r\n- האם נמנעתי מלהבטיח משהו שלא קיים בתגובת ה-API?\r\n- האם הצגתי סיכום קצר וברור במקום בלוק טקסט ארוך?\r\n- האם המתנתי לאישור מפורש עבור BOOK ו-CANCEL?\r\n\r\nהמטרה שלך:\r\nלהיות עוזר הזמנות מלון ומלאי ברמה עולמית:\r\n- למקסם בהירות והמרה (לעזור לאורח באמת להשלים הזמנה טובה),\r\n- תוך כיבוד קפדני של תגובות ה-API וכללי המלון.`\r\n\r\nexport const BOOKING_AGENT_PROMPT_EN = `You are the AI Hotel Booking Agent for the hotel booking SaaS platform running inside a Vercel-based application.\r\n\r\nYour main goal:\r\n- Help guests search, pre-book, and confirm hotel reservations safely and accurately.\r\n- Use ONLY the tools provided to you (which call the Hotels API) for search, pre-book, booking, cancellations, opportunities and room management.\r\n- NEVER invent availability, prices, booking IDs, policies or any other data.\r\n\r\n--------------------------------------------------\r\nCORE BOOKING FLOW (Search → PreBook → Book → Cancel)\r\n--------------------------------------------------\r\n\r\nALWAYS follow this 3–4 step workflow:\r\n\r\n1) SEARCH (get_innstant_search_price)\r\n2) PREBOOK (prebook)\r\n3) BOOK (book) – ONLY after guest confirmation\r\n4) CANCEL (cancel_room_direct_json) – when requested\r\n\r\n----------------\r\n1) SEARCH RULES\r\n----------------\r\n\r\nWhen the guest asks for a hotel / stay, FIRST make sure you have:\r\n\r\n- Check-in date (dateFrom) and check-out date (dateTo) in YYYY-MM-DD format.\r\n- Destination: either hotel name (hotelName) OR city (city), not both at the same time.\r\n- Number of adults (adults).\r\n- Children ages if relevant (paxChildren array, empty array if no children).\r\n- Optional filters: star rating (stars), max results (limit).\r\n\r\nIf something is missing, ask short clarifying questions BEFORE calling the search tool.\r\n\r\nWhen calling search:\r\n- dateFrom: required, string YYYY-MM-DD\r\n- dateTo: required, string YYYY-MM-DD\r\n- hotelName: string or null (use this OR city, not both)\r\n- city: string or null (use this OR hotelName, not both)\r\n- adults: integer (default 2 if user is unclear)\r\n- paxChildren: array of child ages (empty array if no kids, not null)\r\n- stars: optional, null or 1–5\r\n- limit: optional, null or integer (use around 10 if you want to control list size)\r\n\r\nIf the user is vague (\"hotel in Tel Aviv sometime in July\"), narrow down:\r\n- Ask for exact dates.\r\n- Ask how many people (adults / children).\r\n- If needed, ask approximate budget.\r\n\r\nWhen returning options to the user:\r\n- Do NOT list dozens of hotels. Prefer 3–6 best matches.\r\n- For each option, clearly show:\r\n  - Hotel name\r\n  - City / Area\r\n  - Room type & board (RO/BB/HB/FB/AI as given by API)\r\n  - Total price & currency\r\n  - Basic cancellation type (\"fully-refundable\", \"non-refundable\", etc.)\r\n- If price looks very high or low (based on your relative judgment or extra tools), you may say \"This price is on the high/low side compared to typical prices\", but DO NOT invent exact comparisons.\r\n\r\n-----------------\r\n2) PREBOOK RULES\r\n-----------------\r\n\r\nOnce the guest chooses a specific offer, you MUST perform a PreBook step BEFORE booking.\r\n\r\nYou need from the previous search response:\r\n- code of the chosen offer (e.g. \"697024:standard:double:RO:...\")\r\n- hotel id and dates to build the prebook JSON structure.\r\n\r\nYour behavior:\r\n- After the user chooses an option, call prebook with the correct code and parameters.\r\n- Wait for the tool result.\r\n- If prebook response status is \"done\" and returns a token, save this token (mentally) for the booking step.\r\n- If prebook fails or status is not \"done\":\r\n  - Explain to the user that availability changed or there was a problem.\r\n  - Offer to search again or pick another room.\r\n\r\nAlways mention to the guest that you are \"verifying live availability and final conditions\" before confirming.\r\n\r\n----------------\r\n3) BOOKING RULES\r\n----------------\r\n\r\nIMPORTANT: Booking is a MONEY action. You must:\r\n\r\n1. Confirm with the guest, in clear language, BEFORE calling book, for example:\r\n   - \"Do you want me to confirm this booking now with these details and price?\"\r\n2. Show a short summary of the chosen option:\r\n   - Hotel\r\n   - Dates\r\n   - Room type & board\r\n   - Total price & currency\r\n   - Cancellation type and key conditions (only as given by the API).\r\n3. Ask for required guest details:\r\n   - Lead guest full name (first + last)\r\n   - Email\r\n   - Phone\r\n   - Country (and city/address if required by the API)\r\n   - Number of guests and ages (if children)\r\n4. Only then call book with:\r\n   - code: from Search\r\n   - token: from PreBook\r\n   - pax: list of adults (lead guest flagged) and children\r\n   - customer details (title/name/contact)\r\n   - paymentMethod: \"account_credit\" unless tools/backend say otherwise\r\n\r\nWhen the book tool response comes back:\r\n- If status is \"confirmed\":\r\n  - Provide the user a clear confirmation summary:\r\n    - BookingID\r\n    - Hotel name and address\r\n    - Dates\r\n    - Room & board\r\n    - Total price & currency\r\n    - Supplier reference if available\r\n    - Key cancellation frames (only from the response)\r\n- If the response does NOT indicate confirmed, or there is an error:\r\n  - Do NOT say the booking is confirmed.\r\n  - Explain there was an issue and propose to try again or choose another option.\r\n\r\nNever make up:\r\n- BookingID\r\n- Supplier reference\r\n- Payment method details\r\n- Cancellation policy details\r\n\r\nUse only what the book response returns.\r\n\r\n------------------\r\n4) CANCELLATION RULES\r\n------------------\r\n\r\nFor cancellation requests:\r\n\r\n1. Ask the guest for:\r\n   - BookingID\r\n   - Guest name (to verify)\r\n   - Check-in date (optional but helpful)\r\n2. Confirm with the guest in clear words that cancellation may be subject to fees based on the existing policy, and ask:\r\n   - \"Do you confirm that you want to cancel this booking now and accept any cancellation fee if applicable?\"\r\n3. Only after explicit confirmation, call cancel_room_direct_json (CancelRoomDirectJson):\r\n   - Your tools layer should send a JSON with:\r\n     - BookingID\r\n     - CancelReason (if provided)\r\n     - Force / IsManual flags as appropriate by backend policy.\r\n\r\nIf cancellation is successful:\r\n- Tell the user the booking is cancelled.\r\n- Mention if penalty = 0 (free cancellation) OR if they may be charged (only if the API provides such info).\r\n\r\nIf cancellation fails:\r\n- Explain simply that the cancellation could not be completed.\r\n- Suggest contacting support or the hotel if needed.\r\n\r\n-----------------------------------\r\nOPPORTUNITIES & ROOM MANAGEMENT\r\n-----------------------------------\r\n\r\nYou can assist internal users (hotel staff, revenue managers) when they talk to you.\r\n\r\nIf the user seems to be a HOTEL / ADMIN (e.g. \"I want to update push price\", \"show me my opportunities\", \"create opportunity\"), then:\r\n\r\nUse these tools:\r\n\r\n- get_rooms_active:\r\n  - Use filters like startDate, endDate, hotel name or ids if provided.\r\n  - Helpful to show current inventory and push prices.\r\n\r\n- get_opportunities:\r\n  - Use date range and optional filters (hotelId, boardId, categoryId, stars) to retrieve existing opportunities.\r\n\r\n- insert_opportunity:\r\n  - Use InsertOpp schema:\r\n    - startDateStr / endDateStr (YYYY-MM-DD)\r\n    - boardId (1–7)\r\n    - categoryId (1–15)\r\n    - buyPrice, pushPrice (respecting min/max)\r\n    - maxRooms\r\n    - hotelId OR destinationId (never both)\r\n\r\n  - You MUST ask the admin for:\r\n    - date range\r\n    - target board & category (or explain available values)\r\n    - buy price and desired push price\r\n    - number of rooms\r\n\r\n- update_rooms_active_push_price:\r\n  - Use ApiBooking schema: preBookId + new pushPrice.\r\n  - Only use when the admin explicitly wants to change the selling price of a specific active room.\r\n\r\nDO NOT:\r\n- Invent IDs (hotelId, preBookId, opportunityId).\r\n- Update prices or create opportunities without explicit instruction.\r\n\r\n----------------------------------\r\nGUEST vs ADMIN – Mode Detection\r\n----------------------------------\r\n\r\nIf the user talks like:\r\n- \"I want to book a room in Tel Aviv for 2 adults…\"\r\n- \"Can you cancel my reservation?\"\r\n→ Treat them as GUEST. Focus on Search/PreBook/Book/Cancel.\r\n\r\nIf the user talks like:\r\n- \"Show me my active rooms this month\"\r\n- \"Create opportunity for Dizengoff Inn between X and Y\"\r\n- \"Update push price for preBookId 1234\"\r\n→ Treat them as ADMIN/HOTEL. Focus on GetRoomsActive, GetOpportunities, InsertOpportunity, UpdateRoomsActivePushPrice.\r\n\r\nIf you are not sure – ask a very short clarifying question:\r\n- \"Are you asking as a guest who wants to book, or as a hotel/admin managing inventory?\"\r\n\r\n--------------------\r\nERROR HANDLING RULES\r\n--------------------\r\n\r\nIf a tool returns:\r\n- 400 (bad request) or validation error:\r\n  - Check if dates are valid (YYYY-MM-DD and from < to).\r\n  - Check you did not send both hotelName and city if schema says OR.\r\n  - Verify numbers (adults >= 1, prices > 0, etc.).\r\n  - Explain briefly and adjust parameters.\r\n\r\n- 401 (unauthorized):\r\n  - Assume backend/tool will handle token refresh.\r\n  - You may say: \"There was a connection issue to the booking system, please try again shortly.\"\r\n\r\n- 415 (unsupported media type) or other server-side format issues:\r\n  - Assume backend will adjust headers. Do not try to change Content-Type yourself inside the model.\r\n\r\n- 500 / 502 / 503 (server errors):\r\n  - Brief apology.\r\n  - Suggest to try again in a few minutes or adjust search.\r\n\r\nNever loop infinitely on failing calls. If something fails twice in a row with the same parameters, explain to the user and propose an alternative.\r\n\r\n----------------------\r\nSELF-CHECK & QUALITY\r\n----------------------\r\n\r\nBefore answering the user, especially after tool calls, quickly check:\r\n- Did I confirm all key details (dates, guests, hotel name, price) before booking?\r\n- Did I avoid promising anything not present in the API response?\r\n- Did I show a short, clear summary instead of a long text block?\r\n- Did I wait for explicit confirmation for BOOK and CANCEL?\r\n\r\nYour objective:\r\nBe a world-class hotel booking and inventory assistant:\r\n- Maximize clarity and conversion (help the guest actually complete a good booking),\r\n- While strictly respecting the API responses and hotel rules.`\r\n\r\nimport { scarletKnowledgeBase, scarletSystemInstructions } from \"@/lib/hotels/scarlet-ai-knowledge\"\r\n\r\nexport function getBookingAgentPrompt(\r\n  language: \"he\" | \"en\", \r\n  hotelName: string, \r\n  hotelCity: string, \r\n  today: string,\r\n  hotelId?: string,\r\n  knowledgeBase?: string,\r\n  systemInstructions?: string\r\n) {\r\n  // If Scarlet Hotel, use advanced knowledge base and instructions\r\n  if (hotelId === \"scarlet-hotel\") {\r\n    const scarletPrompt = `\r\n${scarletSystemInstructions}\r\n\r\n--------------------------------------------------\r\nמידע נוסף למלון סקרלט\r\n--------------------------------------------------\r\n\r\nמידע על המלון:\r\n${JSON.stringify(scarletKnowledgeBase.identity, null, 2)}\r\n\r\nמיקום:\r\n${JSON.stringify(scarletKnowledgeBase.location, null, 2)}\r\n\r\nחדרים זמינים:\r\n${scarletKnowledgeBase.rooms.map((room, idx) => `\r\n${idx + 1}. ${room.name}\r\n   - מחיר: ${room.price}₪\r\n   - שטח: ${room.size} מ\"ר\r\n   - מתאים ל: ${room.maxGuests} אורחים\r\n   - תיאור: ${room.description}\r\n   - תכונות: ${room.detailedFeatures?.bedding}, ${room.detailedFeatures?.bathroom}\r\n`).join('\\n')}\r\n\r\nשירותים:\r\n${JSON.stringify(scarletKnowledgeBase.services, null, 2)}\r\n\r\nמבצעים פעילים:\r\n${scarletKnowledgeBase.promotions.map((p: any) => `- ${p.name}: ${p.description}`).join('\\n')}\r\n\r\nמדיניות:\r\n${JSON.stringify(scarletKnowledgeBase.policies, null, 2)}\r\n\r\nשאלות נפוצות:\r\n${scarletKnowledgeBase.faq.map((faq: any) => `ש: ${faq.q}\\nת: ${faq.a}`).join('\\n\\n')}\r\n\r\n--------------------------------------------------\r\nפורמט קריאה לחיפוש - מלון סקרלט בלבד\r\n--------------------------------------------------\r\n**חשוב מאוד - כללים קריטיים:**\r\n1. תמיד חפש רק את מלון סקרלט תל אביב. **לעולם אל תציע או תזכיר מלונות אחרים!**\r\n2. אם המשתמש נתן תאריכים בלי לציין שנה - **תמיד הנח שהכוונה לשנה הנוכחית** (${new Date().getFullYear()})\r\n3. **אל תשאל על השנה!** אם כתוב \"3.2-4.2\" - הכוונה ל-3 בפברואר עד 4 בפברואר השנה (${new Date().getFullYear()})\r\n4. אם התאריך כבר עבר בשנה הנוכחית, הנח שהכוונה לשנה הבאה\r\n5. אתה הצ'אט הרשמי של מלון סקרלט - דבר בגוף ראשון (\"אצלנו במלון\", \"אנחנו מציעים\")\r\n\r\nכשיש לך תאריכים ומספר אורחים, הוסף:\r\n[SEARCH]{\"dateFrom\": \"YYYY-MM-DD\", \"dateTo\": \"YYYY-MM-DD\", \"adults\": 2, \"children\": [], \"city\": \"Tel Aviv\"}[/SEARCH]\r\n\r\nדוגמה (לזוג, 3-4 בפברואר):\r\n[SEARCH]{\"dateFrom\": \"${new Date().getFullYear()}-02-03\", \"dateTo\": \"${new Date().getFullYear()}-02-04\", \"adults\": 2, \"children\": [], \"city\": \"Tel Aviv\"}[/SEARCH]\r\n\r\nהתאריך היום: ${today}\r\nמזהה מלון ב-API: 863233\r\nשם מלון ב-API: Scarlet Hotel Tel Aviv\r\n\r\n**זכור: אתה מייצג אך ורק את מלון סקרלט תל אביב. אל תציע אלטרנטיבות ואל תדבר על מלונות אחרים בשום מצב!**\r\n`\r\n    return scarletPrompt\r\n  }\r\n\r\n  // Default prompt for other hotels\r\n  const basePrompt = language === \"he\" ? BOOKING_AGENT_PROMPT_HE : BOOKING_AGENT_PROMPT_EN\r\n\r\n  const contextInfo =\r\n    language === \"he\"\r\n      ? `\r\n\r\n--------------------------------------------------\r\nמידע על המלון והקונטקסט\r\n--------------------------------------------------\r\n- שם מלון ברירת מחדל: ${hotelName}\r\n- עיר ברירת מחדל: ${hotelCity}\r\n- התאריך היום: ${today}\r\n\r\n--------------------------------------------------\r\nפורמט קריאה לחיפוש\r\n--------------------------------------------------\r\nכשיש לך את כל הפרטים לחיפוש (תאריכים ומספר אורחים), הוסף בסוף ההודעה שלך:\r\n[SEARCH]{\"dateFrom\": \"YYYY-MM-DD\", \"dateTo\": \"YYYY-MM-DD\", \"adults\": 2, \"children\": [], \"city\": \"עיר\"}[/SEARCH]\r\n\r\nדוגמאות:\r\n- לדובאי, 10-12 ביוני 2026, 2 מבוגרים:\r\n[SEARCH]{\"dateFrom\": \"2026-06-10\", \"dateTo\": \"2026-06-12\", \"adults\": 2, \"children\": [], \"city\": \"Dubai\"}[/SEARCH]\r\n\r\n- לתל אביב, 15-17 ביולי 2025, 2 מבוגרים וילד בן 5:\r\n[SEARCH]{\"dateFrom\": \"2025-07-15\", \"dateTo\": \"2025-07-17\", \"adults\": 2, \"children\": [5], \"city\": \"Tel Aviv\"}[/SEARCH]\r\n\r\n- למלון ספציפי (Dizengoff Inn):\r\n[SEARCH]{\"dateFrom\": \"2025-08-01\", \"dateTo\": \"2025-08-03\", \"adults\": 2, \"children\": [], \"hotelName\": \"Dizengoff Inn\"}[/SEARCH]\r\n\r\nזכור: השתמש ב-city או hotelName, לא בשניהם יחד!`\r\n      : `\r\n\r\n--------------------------------------------------\r\nHOTEL INFO & CONTEXT\r\n--------------------------------------------------\r\n- Default Hotel Name: ${hotelName}\r\n- Default City: ${hotelCity}\r\n- Today's Date: ${today}\r\n\r\n--------------------------------------------------\r\nSEARCH CALL FORMAT\r\n--------------------------------------------------\r\nWhen you have all the details for a search (dates and number of guests), add at the end of your message:\r\n[SEARCH]{\"dateFrom\": \"YYYY-MM-DD\", \"dateTo\": \"YYYY-MM-DD\", \"adults\": 2, \"children\": [], \"city\": \"City\"}[/SEARCH]\r\n\r\nExamples:\r\n- For Dubai, June 10-12 2026, 2 adults:\r\n[SEARCH]{\"dateFrom\": \"2026-06-10\", \"dateTo\": \"2026-06-12\", \"adults\": 2, \"children\": [], \"city\": \"Dubai\"}[/SEARCH]\r\n\r\n- For Tel Aviv, July 15-17 2025, 2 adults and a 5-year-old child:\r\n[SEARCH]{\"dateFrom\": \"2025-07-15\", \"dateTo\": \"2025-07-17\", \"adults\": 2, \"children\": [5], \"city\": \"Tel Aviv\"}[/SEARCH]\r\n\r\n- For a specific hotel (Dizengoff Inn):\r\n[SEARCH]{\"dateFrom\": \"2025-08-01\", \"dateTo\": \"2025-08-03\", \"adults\": 2, \"children\": [], \"hotelName\": \"Dizengoff Inn\"}[/SEARCH]\r\n\r\nRemember: Use city OR hotelName, never both together!`\r\n\r\n  return basePrompt + contextInfo\r\n}\r\n","/**\r\n * Search Logger - רישום חיפושים\r\n * Logs all search queries to the database for analytics and admin viewing\r\n */\r\n\r\nimport { createClient, SupabaseClient } from \"@supabase/supabase-js\"\r\n\r\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL || \"\"\r\nconst supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY || process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY || \"\"\r\n\r\n// Only create client if we have valid credentials\r\nlet supabase: SupabaseClient | null = null\r\nif (supabaseUrl && supabaseKey) {\r\n  supabase = createClient(supabaseUrl, supabaseKey)\r\n}\r\n\r\nexport interface SearchLogParams {\r\n  // Hotel context\r\n  hotelId?: string\r\n\r\n  // Search parameters\r\n  searchQuery?: string\r\n  destination?: string\r\n  hotelName?: string\r\n  city?: string\r\n  dateFrom?: string | Date\r\n  dateTo?: string | Date\r\n  adults?: number\r\n  children?: number\r\n\r\n  // Results\r\n  resultsCount?: number\r\n  foundHotels?: number\r\n  foundRooms?: number\r\n\r\n  // Performance\r\n  durationMs?: number\r\n\r\n  // Status\r\n  success?: boolean\r\n  errorMessage?: string\r\n\r\n  // Context\r\n  userId?: string\r\n  sessionId?: string\r\n  ipAddress?: string\r\n  userAgent?: string\r\n\r\n  // Source\r\n  source?: \"chat\" | \"widget\" | \"template\" | \"api\"\r\n  channel?: \"web\" | \"mobile\" | \"embed\"\r\n\r\n  // Additional metadata\r\n  metadata?: Record<string, any>\r\n}\r\n\r\nexport class SearchLogger {\r\n  /**\r\n   * Log a search operation\r\n   */\r\n  static async logSearch(params: SearchLogParams): Promise<void> {\r\n    // Skip logging if supabase is not configured\r\n    if (!supabase) {\r\n      console.log(\"[SearchLogger] Skipping log - Supabase not configured\")\r\n      return\r\n    }\r\n    \r\n    try {\r\n      // Format dates if provided\r\n      const dateFrom =\r\n        params.dateFrom instanceof Date\r\n          ? params.dateFrom.toISOString().split(\"T\")[0]\r\n          : params.dateFrom\r\n\r\n      const dateTo =\r\n        params.dateTo instanceof Date\r\n          ? params.dateTo.toISOString().split(\"T\")[0]\r\n          : params.dateTo\r\n\r\n      const { error } = await supabase.from(\"search_logs\").insert([\r\n        {\r\n          hotel_id: params.hotelId,\r\n          search_query: params.searchQuery,\r\n          destination: params.destination,\r\n          hotel_name: params.hotelName,\r\n          city: params.city,\r\n          date_from: dateFrom,\r\n          date_to: dateTo,\r\n          adults: params.adults,\r\n          children: params.children,\r\n          results_count: params.resultsCount ?? 0,\r\n          found_hotels: params.foundHotels,\r\n          found_rooms: params.foundRooms,\r\n          duration_ms: params.durationMs,\r\n          success: params.success ?? true,\r\n          error_message: params.errorMessage,\r\n          user_id: params.userId,\r\n          session_id: params.sessionId,\r\n          ip_address: params.ipAddress,\r\n          user_agent: params.userAgent,\r\n          source: params.source,\r\n          channel: params.channel,\r\n          metadata: params.metadata,\r\n        },\r\n      ])\r\n\r\n      if (error) {\r\n        console.error(\"[SearchLogger] Supabase insert error:\", error)\r\n      }\r\n    } catch (error) {\r\n      console.error(\"[SearchLogger] Error logging search:\", error)\r\n      // Don't throw - logging errors shouldn't break the application\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get search logs with filtering\r\n   */\r\n  static async getSearchLogs(\r\n    filters?: {\r\n      hotelId?: string\r\n      userId?: string\r\n      dateFrom?: Date\r\n      dateTo?: Date\r\n      success?: boolean\r\n      source?: string\r\n      limit?: number\r\n      offset?: number\r\n    },\r\n  ) {\r\n    // Skip if supabase is not configured\r\n    if (!supabase) {\r\n      console.log(\"[SearchLogger] Skipping getLogs - Supabase not configured\")\r\n      return { logs: [], total: 0, limit: filters?.limit ?? 50, offset: filters?.offset ?? 0 }\r\n    }\r\n    \r\n    const limit = filters?.limit ?? 50\r\n    const offset = filters?.offset ?? 0\r\n\r\n    let query = supabase\r\n      .from(\"search_logs\")\r\n      .select(\"*\", { count: \"exact\" })\r\n      .order(\"created_at\", { ascending: false })\r\n      .range(offset, offset + limit - 1)\r\n\r\n    if (filters?.hotelId) {\r\n      query = query.eq(\"hotel_id\", filters.hotelId)\r\n    }\r\n\r\n    if (filters?.userId) {\r\n      query = query.eq(\"user_id\", filters.userId)\r\n    }\r\n\r\n    if (filters?.success !== undefined) {\r\n      query = query.eq(\"success\", filters.success)\r\n    }\r\n\r\n    if (filters?.source) {\r\n      query = query.eq(\"source\", filters.source)\r\n    }\r\n\r\n    if (filters?.dateFrom) {\r\n      query = query.gte(\r\n        \"created_at\",\r\n        filters.dateFrom.toISOString()\r\n      )\r\n    }\r\n\r\n    if (filters?.dateTo) {\r\n      query = query.lte(\r\n        \"created_at\",\r\n        filters.dateTo.toISOString()\r\n      )\r\n    }\r\n\r\n    const { data: logs, count, error } = await query\r\n\r\n    if (error) {\r\n      console.error(\"[SearchLogger] Error fetching logs:\", error)\r\n      return { logs: [], total: 0, limit, offset }\r\n    }\r\n\r\n    return { logs: logs || [], total: count || 0, limit, offset }\r\n  }\r\n\r\n  /**\r\n   * Get search statistics\r\n   */\r\n  static async getSearchStats(filters?: {\r\n    hotelId?: string\r\n    dateFrom?: Date\r\n    dateTo?: Date\r\n  }) {\r\n    // Skip if supabase is not configured\r\n    if (!supabase) {\r\n      console.log(\"[SearchLogger] Skipping getSearchStats - Supabase not configured\")\r\n      return { totalSearches: 0, successfulSearches: 0, failedSearches: 0, avgDurationMs: 0 }\r\n    }\r\n    \r\n    let totalQuery = supabase.from(\"search_logs\").select(\"*\", { count: \"exact\", head: true })\r\n    let successQuery = supabase\r\n      .from(\"search_logs\")\r\n      .select(\"*\", { count: \"exact\", head: true })\r\n      .eq(\"success\", true)\r\n\r\n    if (filters?.hotelId) {\r\n      totalQuery = totalQuery.eq(\"hotel_id\", filters.hotelId)\r\n      successQuery = successQuery.eq(\"hotel_id\", filters.hotelId)\r\n    }\r\n\r\n    if (filters?.dateFrom) {\r\n      const fromDate = filters.dateFrom.toISOString()\r\n      totalQuery = totalQuery.gte(\"created_at\", fromDate)\r\n      successQuery = successQuery.gte(\"created_at\", fromDate)\r\n    }\r\n\r\n    if (filters?.dateTo) {\r\n      const toDate = filters.dateTo.toISOString()\r\n      totalQuery = totalQuery.lte(\"created_at\", toDate)\r\n      successQuery = successQuery.lte(\"created_at\", toDate)\r\n    }\r\n\r\n    const { count: total } = await totalQuery\r\n    const { count: successful } = await successQuery\r\n    const failed = (total || 0) - (successful || 0)\r\n\r\n    return {\r\n      total: total || 0,\r\n      successful: successful || 0,\r\n      failed,\r\n      successRate: (total || 0) > 0 ? (((successful || 0) / total!) * 100).toFixed(2) + \"%\" : \"0%\",\r\n      bySource: {},\r\n      byDestination: {},\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Delete old search logs (for cleanup)\r\n   */\r\n  static async deleteOldLogs(daysToKeep: number = 30): Promise<number> {\r\n    const cutoffDate = new Date()\r\n    cutoffDate.setDate(cutoffDate.getDate() - daysToKeep)\r\n\r\n    const { data, error } = await supabase\r\n      .from(\"search_logs\")\r\n      .delete()\r\n      .lt(\"created_at\", cutoffDate.toISOString())\r\n\r\n    if (error) {\r\n      console.error(\"[SearchLogger] Error deleting old logs:\", error)\r\n      return 0\r\n    }\r\n\r\n    return data?.length || 0\r\n  }\r\n\r\n  /**\r\n   * Delete a specific search log by ID\r\n   */\r\n  static async deleteLog(id: string): Promise<boolean> {\r\n    try {\r\n      const { error } = await supabase.from(\"search_logs\").delete().eq(\"id\", id)\r\n\r\n      if (error) {\r\n        console.error(\"[SearchLogger] Error deleting log:\", error)\r\n        return false\r\n      }\r\n\r\n      return true\r\n    } catch (error) {\r\n      console.error(\"[SearchLogger] Error deleting log:\", error)\r\n      return false\r\n    }\r\n  }\r\n}\r\n","/**\r\n * Chat Memory Service\r\n * Manages conversation history and context for AI chat sessions\r\n * Includes admin mode for dynamic system instructions updates\r\n */\r\n\r\nexport interface Message {\r\n  role: 'user' | 'assistant' | 'system'\r\n  content: string\r\n  timestamp: number\r\n}\r\n\r\nexport interface ConversationMemory {\r\n  sessionId: string\r\n  hotelId: string\r\n  messages: Message[]\r\n  context: {\r\n    userPreferences?: {\r\n      roomType?: string\r\n      budget?: string\r\n      purpose?: string\r\n      adults?: number\r\n      children?: number\r\n    }\r\n    searchHistory?: any[]\r\n    bookingAttempts?: number\r\n    isAdminMode?: boolean\r\n    customInstructions?: string // Custom instructions set by admin\r\n  }\r\n  metadata: {\r\n    startedAt: number\r\n    lastActivityAt: number\r\n    messageCount: number\r\n  }\r\n}\r\n\r\n// In-memory storage (replace with Redis/DB in production)\r\nconst conversationStore = new Map<string, ConversationMemory>()\r\n\r\n// Admin trigger phrases\r\nconst ADMIN_TRIGGERS = [\r\n  'זה מנהל המלון',\r\n  'אני מנהל המלון',\r\n  'זה האדמין',\r\n  'אני האדמין',\r\n  'admin mode',\r\n  'manager mode'\r\n]\r\n\r\n// Instruction update triggers\r\nconst INSTRUCTION_KEYWORDS = [\r\n  'הנחיות חדשות',\r\n  'עדכן הנחיות',\r\n  'שנה הנחיות',\r\n  'הגדרות חדשות',\r\n  'new instructions',\r\n  'update instructions'\r\n]\r\n\r\nexport class ChatMemoryService {\r\n  /**\r\n   * Initialize or retrieve conversation memory\r\n   */\r\n  static getOrCreateMemory(sessionId: string, hotelId: string): ConversationMemory {\r\n    if (!conversationStore.has(sessionId)) {\r\n      const memory: ConversationMemory = {\r\n        sessionId,\r\n        hotelId,\r\n        messages: [],\r\n        context: {},\r\n        metadata: {\r\n          startedAt: Date.now(),\r\n          lastActivityAt: Date.now(),\r\n          messageCount: 0\r\n        }\r\n      }\r\n      conversationStore.set(sessionId, memory)\r\n      console.log(`[Memory] Created new memory for session ${sessionId}`)\r\n    }\r\n    return conversationStore.get(sessionId)!\r\n  }\r\n\r\n  /**\r\n   * Add message to conversation history\r\n   */\r\n  static addMessage(\r\n    sessionId: string,\r\n    role: 'user' | 'assistant' | 'system',\r\n    content: string\r\n  ): void {\r\n    const memory = conversationStore.get(sessionId)\r\n    if (!memory) return\r\n\r\n    memory.messages.push({\r\n      role,\r\n      content,\r\n      timestamp: Date.now()\r\n    })\r\n\r\n    memory.metadata.lastActivityAt = Date.now()\r\n    memory.metadata.messageCount++\r\n\r\n    // Keep only last 50 messages to prevent memory overflow\r\n    if (memory.messages.length > 50) {\r\n      memory.messages = memory.messages.slice(-50)\r\n    }\r\n\r\n    console.log(`[Memory] Added ${role} message to session ${sessionId} (total: ${memory.messages.length})`)\r\n  }\r\n\r\n  /**\r\n   * Check if message contains admin trigger\r\n   */\r\n  static isAdminTrigger(message: string): boolean {\r\n    const lowerMessage = message.toLowerCase().trim()\r\n    return ADMIN_TRIGGERS.some(trigger => \r\n      lowerMessage.includes(trigger.toLowerCase())\r\n    )\r\n  }\r\n\r\n  /**\r\n   * Activate admin mode for session\r\n   */\r\n  static activateAdminMode(sessionId: string): void {\r\n    const memory = conversationStore.get(sessionId)\r\n    if (!memory) return\r\n\r\n    memory.context.isAdminMode = true\r\n    console.log(`[Memory] 🔐 Admin mode ACTIVATED for session ${sessionId}`)\r\n  }\r\n\r\n  /**\r\n   * Check if session is in admin mode\r\n   */\r\n  static isAdminMode(sessionId: string): boolean {\r\n    const memory = conversationStore.get(sessionId)\r\n    return memory?.context.isAdminMode === true\r\n  }\r\n\r\n  /**\r\n   * Extract and save custom instructions from admin message\r\n   */\r\n  static extractAndSaveInstructions(sessionId: string, message: string): string | null {\r\n    const memory = conversationStore.get(sessionId)\r\n    if (!memory || !memory.context.isAdminMode) return null\r\n\r\n    // Check if message contains instruction keywords\r\n    const hasInstructionKeyword = INSTRUCTION_KEYWORDS.some(keyword =>\r\n      message.includes(keyword)\r\n    )\r\n\r\n    if (!hasInstructionKeyword) return null\r\n\r\n    // Extract instructions (everything after the keyword)\r\n    let instructions = ''\r\n    for (const keyword of INSTRUCTION_KEYWORDS) {\r\n      if (message.includes(keyword)) {\r\n        const parts = message.split(keyword)\r\n        if (parts.length > 1) {\r\n          instructions = parts[1].trim()\r\n          break\r\n        }\r\n      }\r\n    }\r\n\r\n    if (instructions) {\r\n      memory.context.customInstructions = instructions\r\n      console.log(`[Memory] 📝 Saved custom instructions for session ${sessionId}:`, instructions.substring(0, 100) + '...')\r\n      return instructions\r\n    }\r\n\r\n    return null\r\n  }\r\n\r\n  /**\r\n   * Get custom instructions for session\r\n   */\r\n  static getCustomInstructions(sessionId: string): string | null {\r\n    const memory = conversationStore.get(sessionId)\r\n    return memory?.context.customInstructions || null\r\n  }\r\n\r\n  /**\r\n   * Get conversation history formatted for AI\r\n   */\r\n  static getFormattedHistory(sessionId: string, maxMessages: number = 10): Message[] {\r\n    const memory = conversationStore.get(sessionId)\r\n    if (!memory) return []\r\n\r\n    // Return last N messages (excluding system messages)\r\n    return memory.messages\r\n      .filter(msg => msg.role !== 'system')\r\n      .slice(-maxMessages)\r\n  }\r\n\r\n  /**\r\n   * Get conversation summary for context\r\n   */\r\n  static getSummary(sessionId: string): string {\r\n    const memory = conversationStore.get(sessionId)\r\n    if (!memory || memory.messages.length === 0) {\r\n      return 'שיחה חדשה - אין היסטוריה קודמת.'\r\n    }\r\n\r\n    const userMessages = memory.messages.filter(m => m.role === 'user').length\r\n    const assistantMessages = memory.messages.filter(m => m.role === 'assistant').length\r\n    const preferences = memory.context.userPreferences\r\n\r\n    let summary = `היסטוריית שיחה: ${userMessages} הודעות ממשתמש, ${assistantMessages} תגובות.\\n`\r\n\r\n    if (preferences) {\r\n      summary += 'העדפות שזוהו:\\n'\r\n      if (preferences.roomType) summary += `- סוג חדר: ${preferences.roomType}\\n`\r\n      if (preferences.budget) summary += `- תקציב: ${preferences.budget}\\n`\r\n      if (preferences.purpose) summary += `- מטרת שהייה: ${preferences.purpose}\\n`\r\n      if (preferences.adults) summary += `- מספר מבוגרים: ${preferences.adults}\\n`\r\n    }\r\n\r\n    if (memory.context.isAdminMode) {\r\n      summary += '\\n🔐 מצב מנהל פעיל - ניתן לעדכן הנחיות מערכת.\\n'\r\n    }\r\n\r\n    if (memory.context.customInstructions) {\r\n      summary += `\\n📝 הנחיות מותאמות אישית קיימות: ${memory.context.customInstructions.substring(0, 50)}...\\n`\r\n    }\r\n\r\n    return summary\r\n  }\r\n\r\n  /**\r\n   * Update user preferences from conversation\r\n   */\r\n  static updatePreferences(\r\n    sessionId: string,\r\n    preferences: Partial<ConversationMemory['context']['userPreferences']>\r\n  ): void {\r\n    const memory = conversationStore.get(sessionId)\r\n    if (!memory) return\r\n\r\n    memory.context.userPreferences = {\r\n      ...memory.context.userPreferences,\r\n      ...preferences\r\n    }\r\n\r\n    console.log(`[Memory] Updated preferences for session ${sessionId}:`, preferences)\r\n  }\r\n\r\n  /**\r\n   * Add search to history\r\n   */\r\n  static addSearchToHistory(sessionId: string, searchData: any): void {\r\n    const memory = conversationStore.get(sessionId)\r\n    if (!memory) return\r\n\r\n    if (!memory.context.searchHistory) {\r\n      memory.context.searchHistory = []\r\n    }\r\n\r\n    memory.context.searchHistory.push({\r\n      ...searchData,\r\n      timestamp: Date.now()\r\n    })\r\n\r\n    // Keep only last 10 searches\r\n    if (memory.context.searchHistory.length > 10) {\r\n      memory.context.searchHistory = memory.context.searchHistory.slice(-10)\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Increment booking attempts\r\n   */\r\n  static incrementBookingAttempts(sessionId: string): number {\r\n    const memory = conversationStore.get(sessionId)\r\n    if (!memory) return 0\r\n\r\n    memory.context.bookingAttempts = (memory.context.bookingAttempts || 0) + 1\r\n    return memory.context.bookingAttempts\r\n  }\r\n\r\n  /**\r\n   * Clear conversation memory (e.g., for privacy)\r\n   */\r\n  static clearMemory(sessionId: string): void {\r\n    conversationStore.delete(sessionId)\r\n    console.log(`[Memory] Cleared memory for session ${sessionId}`)\r\n  }\r\n\r\n  /**\r\n   * Get all active sessions (for monitoring)\r\n   */\r\n  static getActiveSessions(): string[] {\r\n    return Array.from(conversationStore.keys())\r\n  }\r\n\r\n  /**\r\n   * Cleanup old sessions (older than 24 hours)\r\n   */\r\n  static cleanupOldSessions(): number {\r\n    const now = Date.now()\r\n    const maxAge = 24 * 60 * 60 * 1000 // 24 hours\r\n    let cleaned = 0\r\n\r\n    for (const [sessionId, memory] of conversationStore.entries()) {\r\n      if (now - memory.metadata.lastActivityAt > maxAge) {\r\n        conversationStore.delete(sessionId)\r\n        cleaned++\r\n      }\r\n    }\r\n\r\n    if (cleaned > 0) {\r\n      console.log(`[Memory] Cleaned up ${cleaned} old sessions`)\r\n    }\r\n\r\n    return cleaned\r\n  }\r\n}\r\n\r\n// Auto-cleanup every hour\r\nif (typeof setInterval !== 'undefined') {\r\n  setInterval(() => {\r\n    ChatMemoryService.cleanupOldSessions()\r\n  }, 60 * 60 * 1000)\r\n}\r\n\r\nexport default ChatMemoryService\r\n","import { generateText } from \"ai\"\r\nimport type { HotelConfig } from \"@/types/saas\"\r\nimport { getBookingAgentPrompt } from \"@/lib/prompts/booking-agent-prompt\"\r\nimport { emailService } from \"@/lib/email/email-service\"\r\nimport { SearchLogger } from \"@/lib/search-logger\"\r\nimport { format } from \"date-fns\"\r\nimport { ChatMemoryService } from \"@/lib/services/chat-memory-service\"\r\n\r\nconst MEDICI_API_BASE = \"https://medici-backend.azurewebsites.net\"\r\nconst MEDICI_IMAGES_BASE = \"https://cdn.medicihotels.com/images/\"\r\nconst MEDICI_TOKEN =\r\n  \"eyJhbGciOiJodHRwOi8vd3d3LnczLm9yZy8yMDAxLzA0L3htbGRzaWctbW9yZSNobWFjLXNoYTI1NiIsInR5cCI6IkpXVCJ9.eyJQZXJtaXNzaW9ucyI6IjEiLCJVc2VySWQiOiIxMSIsIm5iZiI6MTc2ODQ1NzU5NSwiZXhwIjoyMDgzOTkwMzk1LCJpc3MiOiJodHRwczovL2FkbWluLm1lZGljaWhvdGVscy5jb20vIiwiYXVkIjoiaHR0cHM6Ly9hZG1pbi5tZWRpY2lob3RlbHMuY29tLyJ9.g-CO7I75BlowE-F3J3GqlXsbIgNtG8_w2v1WMwG6djE\"\r\n\r\nconst DEFAULT_HOTEL_NAME = \"Dizengoff Inn\"\r\n\r\nfunction buildImageUrl(imageUrl: string | { url?: string } | null): string {\r\n  if (!imageUrl) return \"\"\r\n  const url = typeof imageUrl === \"object\" ? imageUrl.url : imageUrl\r\n  if (!url) return \"\"\r\n  if (url.startsWith(\"http\")) return url\r\n  return `${MEDICI_IMAGES_BASE}${url}`\r\n}\r\n\r\nfunction getMainImage(images: any[]): string {\r\n  if (!images || images.length === 0) return \"\"\r\n  const mainImage = images.find((img) => img.title === \"mainimage\")\r\n  if (mainImage) return buildImageUrl(mainImage)\r\n  return buildImageUrl(images[0])\r\n}\r\n\r\nfunction buildImageGallery(images: any[]): string[] {\r\n  if (!images || images.length === 0) return []\r\n  return images\r\n    .slice(0, 10)\r\n    .map((img) => buildImageUrl(img))\r\n    .filter(Boolean)\r\n}\r\n\r\nasync function searchMediciHotels(params: {\r\n  hotelName?: string\r\n  city?: string\r\n  dateFrom: string\r\n  dateTo: string\r\n  adults: number\r\n  children: number[]\r\n  filterHotelId?: string // Optional filter for specific hotel only\r\n}) {\r\n  console.log(\"[v0] Searching Medici API with params:\", params)\r\n\r\n  const url = `${MEDICI_API_BASE}/api/hotels/GetInnstantSearchPrice`\r\n\r\n  const body: Record<string, any> = {\r\n    dateFrom: params.dateFrom,\r\n    dateTo: params.dateTo,\r\n    pax: [\r\n      {\r\n        adults: params.adults || 2,\r\n        children: params.children || [],\r\n      },\r\n    ],\r\n    ShowExtendedData: true,\r\n    limit: 10,\r\n  }\r\n\r\n  if (params.city) {\r\n    body.city = params.city\r\n  } else if (params.hotelName) {\r\n    body.hotelName = params.hotelName\r\n  } else {\r\n    body.city = \"Dubai\"\r\n  }\r\n\r\n  console.log(\"[v0] Request body:\", JSON.stringify(body, null, 2))\r\n\r\n  try {\r\n    const response = await fetch(url, {\r\n      method: \"POST\",\r\n      headers: {\r\n        \"Content-Type\": \"application/json\",\r\n        Authorization: `Bearer ${MEDICI_TOKEN}`,\r\n      },\r\n      body: JSON.stringify(body),\r\n    })\r\n\r\n    console.log(\"[v0] Response status:\", response.status)\r\n\r\n    if (!response.ok) {\r\n      const errorText = await response.text()\r\n      console.log(\"[v0] Error response:\", errorText)\r\n      throw new Error(`API error: ${response.status}`)\r\n    }\r\n\r\n    const data = await response.json()\r\n    console.log(\"[v0] Response items count:\", data?.items?.length || 0)\r\n\r\n    // Filter results by hotel ID if filterHotelId is provided\r\n    if (params.filterHotelId && data?.items) {\r\n      data.items = data.items.filter((hotel: any) => \r\n        hotel.hotelId?.toString() === params.filterHotelId\r\n      )\r\n      console.log(`[v0] Filtered to hotel ID ${params.filterHotelId}, remaining items:`, data.items.length)\r\n    }\r\n\r\n    return {\r\n      results: data,\r\n      jsonRequest: JSON.stringify(body),\r\n    }\r\n  } catch (error) {\r\n    console.error(\"[v0] Search error:\", error)\r\n    throw error\r\n  }\r\n}\r\n\r\nasync function prebookRoom(params: {\r\n  code: string\r\n  hotelId: number\r\n  dateFrom: string\r\n  dateTo: string\r\n  adults: number\r\n  children: number[]\r\n  searchRequestJson: string\r\n}) {\r\n  console.log(\"[v0] PreBook with params:\", params)\r\n\r\n  const url = `${MEDICI_API_BASE}/api/hotels/PreBook`\r\n\r\n  // Parse the original search request to build PreBook request\r\n  let searchRequest\r\n  try {\r\n    searchRequest = JSON.parse(params.searchRequestJson)\r\n  } catch (error) {\r\n    console.error(\"[v0] Failed to parse search request:\", error)\r\n    throw new Error(\"Invalid search request JSON\")\r\n  }\r\n\r\n  // Build PreBook request according to Medici API format\r\n  const prebookRequest = {\r\n    services: [\r\n      {\r\n        searchCodes: [\r\n          {\r\n            code: params.code,\r\n            pax: [\r\n              {\r\n                adults: params.adults,\r\n                children: params.children,\r\n              },\r\n            ],\r\n          },\r\n        ],\r\n        searchRequest: searchRequest,\r\n      },\r\n    ],\r\n  }\r\n\r\n  const body = {\r\n    jsonRequest: JSON.stringify(prebookRequest),\r\n  }\r\n\r\n  try {\r\n    const response = await fetch(url, {\r\n      method: \"POST\",\r\n      headers: {\r\n        \"Content-Type\": \"application/json\",\r\n        Authorization: `Bearer ${MEDICI_TOKEN}`,\r\n      },\r\n      body: JSON.stringify(body),\r\n    })\r\n\r\n    if (!response.ok) {\r\n      const errorText = await response.text()\r\n      console.log(\"[v0] PreBook error:\", errorText)\r\n      throw new Error(`PreBook error: ${response.status}`)\r\n    }\r\n\r\n    const data = await response.json()\r\n    console.log(\"[v0] PreBook success:\", data)\r\n    return data\r\n  } catch (error) {\r\n    console.error(\"[v0] PreBook error:\", error)\r\n    throw error\r\n  }\r\n}\r\n\r\nasync function bookRoom(params: {\r\n  token: string\r\n  preBookId: string\r\n  customer: {\r\n    firstName: string\r\n    lastName: string\r\n    email: string\r\n    phone: string\r\n  }\r\n  searchRequestJson: string\r\n  roomCode: string\r\n  adults: number\r\n  children: number[]\r\n}) {\r\n  console.log(\"[v0] Book with params:\", params)\r\n\r\n  const url = `${MEDICI_API_BASE}/api/hotels/Book`\r\n\r\n  // Parse search request\r\n  let searchRequest\r\n  try {\r\n    searchRequest = JSON.parse(params.searchRequestJson)\r\n  } catch (error) {\r\n    console.error(\"[v0] Failed to parse search request:\", error)\r\n    throw new Error(\"Invalid search request JSON\")\r\n  }\r\n\r\n  // Build adult guests array\r\n  const adultGuests = []\r\n  for (let i = 0; i < params.adults; i++) {\r\n    adultGuests.push({\r\n      title: \"MR\",\r\n      name: {\r\n        first: i === 0 ? params.customer.firstName : `Guest${i + 1}`,\r\n        last: params.customer.lastName,\r\n      },\r\n      birthDate: \"1990-01-01\",\r\n    })\r\n  }\r\n\r\n  // Build Book request according to Medici API format\r\n  const bookRequest = {\r\n    customer: {\r\n      title: \"MR\",\r\n      name: {\r\n        first: params.customer.firstName,\r\n        last: params.customer.lastName,\r\n      },\r\n      birthDate: \"1990-01-01\",\r\n      contact: {\r\n        email: params.customer.email,\r\n        phone: params.customer.phone,\r\n      },\r\n    },\r\n    paymentMethod: {\r\n      methodName: \"account_credit\",\r\n    },\r\n    reference: {\r\n      agency: \"v0-bookinengine-ai-chat\",\r\n      voucherEmail: params.customer.email,\r\n    },\r\n    services: [\r\n      {\r\n        bookingRequest: [\r\n          {\r\n            code: params.roomCode,\r\n            pax: [\r\n              {\r\n                adults: adultGuests,\r\n                children: [],\r\n              },\r\n            ],\r\n            token: params.token,\r\n          },\r\n        ],\r\n        searchRequest: searchRequest,\r\n      },\r\n    ],\r\n  }\r\n\r\n  const body = {\r\n    jsonRequest: JSON.stringify(bookRequest),\r\n  }\r\n\r\n  try {\r\n    const response = await fetch(url, {\r\n      method: \"POST\",\r\n      headers: {\r\n        \"Content-Type\": \"application/json\",\r\n        Authorization: `Bearer ${MEDICI_TOKEN}`,\r\n      },\r\n      body: JSON.stringify(body),\r\n    })\r\n\r\n    if (!response.ok) {\r\n      const errorText = await response.text()\r\n      console.log(\"[v0] Book error:\", errorText)\r\n      throw new Error(`Book error: ${response.status}`)\r\n    }\r\n\r\n    const data = await response.json()\r\n    console.log(\"[v0] Book success:\", data)\r\n    return data\r\n  } catch (error) {\r\n    console.error(\"[v0] Book error:\", error)\r\n    throw error\r\n  }\r\n}\r\n\r\nexport async function POST(req: Request) {\r\n  try {\r\n    const { messages, hotelConfig, language, bookingState, sessionId } = (await req.json()) as {\r\n      messages: { role: \"user\" | \"assistant\"; content: string }[]\r\n      hotelConfig: HotelConfig\r\n      language: \"he\" | \"en\"\r\n      sessionId?: string\r\n      bookingState?: {\r\n        step?: \"search\" | \"select\" | \"prebook\" | \"details\" | \"book\"\r\n        selectedRoom?: any\r\n        jsonRequest?: string\r\n        preBookData?: any\r\n        searchContext?: any\r\n      }\r\n    }\r\n\r\n    // Generate or use provided session ID\r\n    const currentSessionId = sessionId || `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`\r\n    \r\n    // Initialize memory for this session\r\n    const memory = ChatMemoryService.getOrCreateMemory(currentSessionId, hotelConfig?.id || 'default')\r\n    \r\n    // Get last user message\r\n    const lastUserMessage = messages[messages.length - 1]\r\n    if (lastUserMessage?.role === 'user') {\r\n      // Add user message to memory\r\n      ChatMemoryService.addMessage(currentSessionId, 'user', lastUserMessage.content)\r\n      \r\n      // Check for admin trigger\r\n      if (ChatMemoryService.isAdminTrigger(lastUserMessage.content)) {\r\n        ChatMemoryService.activateAdminMode(currentSessionId)\r\n        \r\n        return Response.json({\r\n          text: `🔐 **מצב מנהל הופעל!**\r\n\r\nשלום מנהל המלון! עכשיו אתה יכול:\r\n\r\n1. **לעדכן הנחיות מערכת** - רק תגיד:\r\n   - \"הנחיות חדשות: [ההנחיות שלך]\"\r\n   - \"עדכן הנחיות: [ההנחיות החדשות]\"\r\n   \r\n2. **לשנות התנהגות ה-AI** - למשל:\r\n   - \"הנחיות חדשות: תהיה יותר פורמלי ומקצועי\"\r\n   - \"עדכן הנחיות: תן דגש על המבצעים והקופונים\"\r\n   - \"הנחיות חדשות: תהיה יותר רומנטי וחם בתגובות\"\r\n\r\n3. **ההנחיות ישמרו** למשך כל השיחה ויחולו על כל התגובות הבאות.\r\n\r\nמה תרצה לעדכן?`,\r\n          sessionId: currentSessionId,\r\n          adminMode: true\r\n        })\r\n      }\r\n      \r\n      // Check if in admin mode and extracting instructions\r\n      if (ChatMemoryService.isAdminMode(currentSessionId)) {\r\n        const extractedInstructions = ChatMemoryService.extractAndSaveInstructions(\r\n          currentSessionId, \r\n          lastUserMessage.content\r\n        )\r\n        \r\n        if (extractedInstructions) {\r\n          return Response.json({\r\n            text: `✅ **הנחיות עודכנו בהצלחה!**\r\n\r\n📝 ההנחיות החדשות:\r\n\"${extractedInstructions}\"\r\n\r\nההנחיות האלה יחולו על כל התגובות שלי מעכשיו. אני אתאים את הסגנון, הטון והתוכן שלי בהתאם.\r\n\r\nרוצה לבדוק? שאל אותי שאלה והראה לך איך אני משתמש בהנחיות החדשות! 🚀`,\r\n            sessionId: currentSessionId,\r\n            adminMode: true,\r\n            customInstructions: extractedInstructions\r\n          })\r\n        }\r\n      }\r\n    }\r\n\r\n    const isHebrew = language === \"he\"\r\n    const hotelName = hotelConfig?.name || \"Dizengoff Inn\"\r\n    const hotelApiName = hotelConfig?.apiSettings?.mediciHotelName || DEFAULT_HOTEL_NAME\r\n    const hotelCity = hotelConfig?.apiSettings?.mediciCity || hotelConfig?.city || \"Tel Aviv\"\r\n\r\n    console.log(\"[v0] Chat request - Hotel:\", hotelName, \"API Name:\", hotelApiName)\r\n    console.log(\"[v0] Session ID:\", currentSessionId)\r\n    console.log(\"[v0] Admin Mode:\", ChatMemoryService.isAdminMode(currentSessionId))\r\n    console.log(\"[v0] Booking state:\", bookingState)\r\n\r\n    const today = new Date().toISOString().split(\"T\")[0]\r\n\r\n    // Get base system prompt\r\n    let systemPrompt = getBookingAgentPrompt(\r\n      language, \r\n      hotelName, \r\n      hotelCity, \r\n      today,\r\n      hotelConfig?.id,\r\n      hotelConfig?.knowledgeBase,\r\n      hotelConfig?.systemInstructions\r\n    )\r\n    \r\n    // Add custom instructions if in admin mode\r\n    const customInstructions = ChatMemoryService.getCustomInstructions(currentSessionId)\r\n    if (customInstructions) {\r\n      systemPrompt += `\\n\\n## 🔐 הנחיות מותאמות אישית ממנהל המלון (עדיפות גבוהה!):\\n${customInstructions}\\n\\nהנחיות אלה חשובות ביותר ודורסות הנחיות אחרות במקרה של סתירה.`\r\n      console.log(\"[v0] Applied custom instructions from admin\")\r\n    }\r\n    \r\n    // Add conversation history context\r\n    const conversationSummary = ChatMemoryService.getSummary(currentSessionId)\r\n    systemPrompt += `\\n\\n## 💬 הקשר שיחה:\\n${conversationSummary}`\r\n\r\n    console.log(\"[v0] Calling AI model...\")\r\n\r\n    const { text } = await generateText({\r\n      model: \"anthropic/claude-sonnet-4-20250514\",\r\n      system: systemPrompt,\r\n      messages: messages.map((m) => ({\r\n        role: m.role as \"user\" | \"assistant\",\r\n        content: m.content,\r\n      })),\r\n    })\r\n\r\n    console.log(\"[v0] AI response:\", text.slice(0, 500))\r\n    \r\n    // Add AI response to memory\r\n    ChatMemoryService.addMessage(currentSessionId, 'assistant', text)\r\n\r\n    const searchMatch = text.match(/\\[SEARCH\\](.*?)\\[\\/SEARCH\\]/s)\r\n    if (searchMatch) {\r\n      console.log(\"[v0] Found search request:\", searchMatch[1])\r\n\r\n      try {\r\n        const searchParams = JSON.parse(searchMatch[1])\r\n        console.log(\"[v0] Parsed search params:\", searchParams)\r\n\r\n        const { results: searchResults, jsonRequest } = await searchMediciHotels({\r\n          hotelName: hotelApiName,\r\n          city: searchParams.city || hotelCity,\r\n          dateFrom: searchParams.dateFrom,\r\n          dateTo: searchParams.dateTo,\r\n          adults: searchParams.adults || 2,\r\n          children: searchParams.children || [],\r\n          filterHotelId: hotelConfig?.id === \"scarlet-hotel\" ? \"863233\" : undefined, // Filter Scarlet only\r\n        })\r\n\r\n        let rooms: any[] = []\r\n\r\n        if (searchResults?.items && Array.isArray(searchResults.items)) {\r\n          rooms = searchResults.items\r\n        } else if (Array.isArray(searchResults)) {\r\n          rooms = searchResults\r\n        } else if (searchResults?.hotels) {\r\n          rooms = searchResults.hotels\r\n        }\r\n\r\n        if (rooms.length > 0) {\r\n          const formattedRooms = rooms.slice(0, 6).map((room: any, index: number) => {\r\n            const price = room.price?.amount || room.netPrice?.amount || room.price || 0\r\n            const currency = room.price?.currency || room.netPrice?.currency || \"USD\"\r\n            const rawImages = room.images || []\r\n            const mainImage = getMainImage(rawImages)\r\n            const imageGallery = buildImageGallery(rawImages)\r\n            const facilities = room.facilities?.tags || room.facilities?.list || []\r\n\r\n            return {\r\n              code: room.code || `${room.hotelId || hotelName}:${index}:${Date.now()}`,\r\n              hotelId: room.hotelId || 0,\r\n              name: room.hotelName || room.name || \"Hotel\",\r\n              hotelName: room.hotelName || hotelName,\r\n              roomType: room.name || room.category || \"Standard Room\",\r\n              board: room.board || \"RO\",\r\n              price: price,\r\n              currency: currency,\r\n              cancellation: room.cancellation?.type || \"non-refundable\",\r\n              confirmation: room.confirmation || \"immediate\",\r\n              image: mainImage,\r\n              images: imageGallery,\r\n              description: room.description || \"\",\r\n              facilities: facilities,\r\n              location: room.city || searchParams.city || hotelCity,\r\n              address: room.address || \"\",\r\n              rating: room.stars || 4,\r\n            }\r\n          })\r\n\r\n          const cleanText = text.replace(/\\[SEARCH\\].*?\\[\\/SEARCH\\]/s, \"\").trim()\r\n\r\n          const roomsList = formattedRooms\r\n            .map((r, i) => {\r\n              const label =\r\n                i === 0\r\n                  ? isHebrew\r\n                    ? \" (הכי משתלם)\"\r\n                    : \" (Best Value)\"\r\n                  : i === formattedRooms.length - 1\r\n                    ? isHebrew\r\n                      ? \" (הכי גמיש)\"\r\n                      : \" (Most Flexible)\"\r\n                    : \"\"\r\n\r\n              return isHebrew\r\n                ? `${i + 1}. ${r.hotelName} - ${r.roomType}${label}\\n   מחיר: $${r.price} ${r.currency}\\n   קוד חדר: ${r.code}\\n   ביטול: ${r.cancellation === \"fully-refundable\" ? \"ניתן לביטול חינם\" : \"לא ניתן לביטול\"}`\r\n                : `${i + 1}. ${r.hotelName} - ${r.roomType}${label}\\n   Price: $${r.price} ${r.currency}\\n   Room code: ${r.code}\\n   Cancellation: ${r.cancellation === \"fully-refundable\" ? \"Free cancellation\" : \"Non-refundable\"}`\r\n            })\r\n            .join(\"\\n\\n\")\r\n\r\n          // Log the search\r\n          SearchLogger.logSearch({\r\n            hotelName: hotelApiName,\r\n            city: searchParams.city || hotelCity,\r\n            dateFrom: searchParams.dateFrom,\r\n            dateTo: searchParams.dateTo,\r\n            adults: searchParams.adults || 2,\r\n            children: searchParams.children || 0,\r\n            resultsCount: formattedRooms.length,\r\n            foundHotels: rooms.length,\r\n            foundRooms: formattedRooms.length,\r\n            success: true,\r\n            source: \"chat\",\r\n            channel: \"web\",\r\n            metadata: {\r\n              hotelId: hotelConfig?.id,\r\n              userMessage: messages[messages.length - 1]?.content.substring(0, 100),\r\n            }\r\n          }).catch(err => console.error(\"Failed to log search:\", err))\r\n\r\n          return Response.json({\r\n            message:\r\n              cleanText +\r\n              \"\\n\\n\" +\r\n              (isHebrew\r\n                ? `מצאתי ${formattedRooms.length} אפשרויות זמינות:\\n\\n${roomsList}\\n\\nאיזה חדר מעניין אותך? כתוב את המספר או \"אני רוצה את חדר מספר X\"`\r\n                : `I found ${formattedRooms.length} available options:\\n\\n${roomsList}\\n\\nWhich room interests you? Write the number or \"I want room number X\"`),\r\n            bookingData: {\r\n              type: \"search_results\",\r\n              data: {\r\n                rooms: formattedRooms,\r\n                searchContext: {\r\n                  dateFrom: searchParams.dateFrom,\r\n                  dateTo: searchParams.dateTo,\r\n                  adults: searchParams.adults || 2,\r\n                  children: searchParams.children || [],\r\n                  city: searchParams.city || hotelCity,\r\n                },\r\n                jsonRequest: jsonRequest,\r\n              },\r\n            },\r\n          })\r\n        }\r\n      } catch (error) {\r\n        console.error(\"[v0] Search error:\", error)\r\n        \r\n        // Log the failed search\r\n        SearchLogger.logSearch({\r\n          hotelName: hotelApiName,\r\n          city: searchParams?.city || hotelCity,\r\n          dateFrom: searchParams?.dateFrom,\r\n          dateTo: searchParams?.dateTo,\r\n          adults: searchParams?.adults || 2,\r\n          children: searchParams?.children || 0,\r\n          resultsCount: 0,\r\n          success: false,\r\n          errorMessage: error instanceof Error ? error.message : \"Unknown search error\",\r\n          source: \"chat\",\r\n          channel: \"web\",\r\n          metadata: {\r\n            hotelId: hotelConfig?.id,\r\n            error: error instanceof Error ? error.toString() : String(error),\r\n          }\r\n        }).catch(err => console.error(\"Failed to log search error:\", err))\r\n        \r\n        const cleanText = text.replace(/\\[SEARCH\\].*?\\[\\/SEARCH\\]/s, \"\").trim()\r\n        return Response.json({\r\n          message:\r\n            cleanText +\r\n            \"\\n\\n\" +\r\n            (isHebrew\r\n              ? \"הייתה בעיה ביצירת קשר עם מערכת ההזמנות. אנא נסה שוב.\"\r\n              : \"There was an issue contacting the booking system. Please try again.\"),\r\n        })\r\n      }\r\n    }\r\n\r\n    const selectMatch = text.match(/\\[SELECT_ROOM\\](.*?)\\[\\/SELECT_ROOM\\]/s)\r\n    if (selectMatch && bookingState?.jsonRequest) {\r\n      console.log(\"[v0] Room selected, calling PreBook...\")\r\n\r\n      try {\r\n        const selection = JSON.parse(selectMatch[1])\r\n        const preBookData = await prebookRoom({\r\n          code: selection.code,\r\n          hotelId: selection.hotelId,\r\n          dateFrom: bookingState.searchContext.dateFrom,\r\n          dateTo: bookingState.searchContext.dateTo,\r\n          adults: bookingState.searchContext.adults,\r\n          children: bookingState.searchContext.children,\r\n          searchRequestJson: bookingState.jsonRequest,\r\n        })\r\n\r\n        const cleanText = text.replace(/\\[SELECT_ROOM\\].*?\\[\\/SELECT_ROOM\\]/s, \"\").trim()\r\n\r\n        return Response.json({\r\n          message:\r\n            cleanText +\r\n            \"\\n\\n\" +\r\n            (isHebrew\r\n              ? `מעולה! שמרתי את החדר עבורך.\\nעכשיו אני צריך כמה פרטים:\\n- שם מלא\\n- דוא\"ל\\n- מספר טלפון`\r\n              : `Great! I've reserved the room for you.\\nNow I need some details:\\n- Full name\\n- Email\\n- Phone number`),\r\n          bookingData: {\r\n            type: \"prebook_complete\",\r\n            data: {\r\n              preBookData: preBookData,\r\n              selectedRoom: selection,\r\n            },\r\n          },\r\n        })\r\n      } catch (error) {\r\n        console.error(\"[v0] PreBook error:\", error)\r\n        return Response.json({\r\n          message: isHebrew\r\n            ? \"הייתה בעיה בשמירת החדר. אנא נסה שוב או בחר חדר אחר.\"\r\n            : \"There was an issue reserving the room. Please try again or select another room.\",\r\n        })\r\n      }\r\n    }\r\n\r\n    const bookMatch = text.match(/\\[BOOK\\](.*?)\\[\\/BOOK\\]/s)\r\n    if (bookMatch && bookingState?.preBookData && bookingState?.selectedRoom && bookingState?.jsonRequest) {\r\n      console.log(\"[v0] Completing booking...\")\r\n\r\n      try {\r\n        const customerDetails = JSON.parse(bookMatch[1])\r\n        const bookingResult = await bookRoom({\r\n          token: bookingState.preBookData.token,\r\n          preBookId: bookingState.preBookData.preBookId,\r\n          customer: customerDetails,\r\n          searchRequestJson: bookingState.jsonRequest,\r\n          roomCode: bookingState.selectedRoom.code,\r\n          adults: bookingState.searchContext?.adults || 2,\r\n          children: bookingState.searchContext?.children || [],\r\n        })\r\n\r\n        // Send confirmation email (non-blocking)\r\n        if (bookingResult.bookingId && bookingResult.supplierReference && emailService.isEnabled()) {\r\n          try {\r\n            const searchRequest = JSON.parse(bookingState.jsonRequest)\r\n            const checkInDate = searchRequest.dates?.from || new Date().toISOString()\r\n            const checkOutDate = searchRequest.dates?.to || new Date().toISOString()\r\n            const nights = Math.ceil(\r\n              (new Date(checkOutDate).getTime() - new Date(checkInDate).getTime()) / (1000 * 60 * 60 * 24)\r\n            )\r\n\r\n            emailService\r\n              .sendBookingConfirmation({\r\n                to: customerDetails.email,\r\n                customerName: `${customerDetails.firstName} ${customerDetails.lastName}`,\r\n                bookingId: bookingResult.bookingId,\r\n                supplierReference: bookingResult.supplierReference,\r\n                hotelName: bookingState.selectedRoom?.hotelName || hotelName,\r\n                roomType: bookingState.selectedRoom?.roomName || \"Room\",\r\n                checkIn: format(new Date(checkInDate), \"MMM dd, yyyy\"),\r\n                checkOut: format(new Date(checkOutDate), \"MMM dd, yyyy\"),\r\n                nights,\r\n                adults: bookingState.searchContext?.adults || 2,\r\n                children: bookingState.searchContext?.children?.length || 0,\r\n                totalPrice: bookingState.preBookData?.netPrice || 0,\r\n                currency: searchRequest.currencies?.[0] || \"USD\",\r\n                language: language,\r\n              })\r\n              .then((emailResult) => {\r\n                if (emailResult.success) {\r\n                  console.log(\"[AI Chat] ✅ Confirmation email sent\", {\r\n                    bookingId: bookingResult.bookingId,\r\n                    emailId: emailResult.emailId,\r\n                  })\r\n                } else {\r\n                  console.warn(\"[AI Chat] ⚠️ Email failed (non-critical)\", emailResult.error)\r\n                }\r\n              })\r\n              .catch((error) => {\r\n                console.error(\"[AI Chat] Email error (non-critical):\", error)\r\n              })\r\n          } catch (error) {\r\n            console.error(\"[AI Chat] Failed to parse search request for email:\", error)\r\n          }\r\n        }\r\n\r\n        const cleanText = text.replace(/\\[BOOK\\].*?\\[\\/BOOK\\]/s, \"\").trim()\r\n\r\n        return Response.json({\r\n          message:\r\n            cleanText +\r\n            \"\\n\\n\" +\r\n            (isHebrew\r\n              ? `🎉 ההזמנה הושלמה בהצלחה!\\n\\nמספר הזמנה: ${bookingResult.bookingId}\\nאסמכתא: ${bookingResult.supplierReference}\\n\\nקיבלת אישור במייל ${customerDetails.email}`\r\n              : `🎉 Booking completed successfully!\\n\\nBooking ID: ${bookingResult.bookingId}\\nReference: ${bookingResult.supplierReference}\\n\\nYou've received confirmation at ${customerDetails.email}`),\r\n          bookingData: {\r\n            type: \"booking_complete\",\r\n            data: {\r\n              bookingId: bookingResult.bookingId,\r\n              supplierReference: bookingResult.supplierReference,\r\n            },\r\n          },\r\n        })\r\n      } catch (error) {\r\n        console.error(\"[v0] Book error:\", error)\r\n        return Response.json({\r\n          message: isHebrew\r\n            ? \"הייתה בעיה בסיום ההזמנה. אנא נסה שוב או צור קשר עם התמיכה.\"\r\n            : \"There was an issue completing the booking. Please try again or contact support.\",\r\n        })\r\n      }\r\n    }\r\n\r\n    const cleanText = text\r\n      .replace(/\\[SEARCH\\].*?\\[\\/SEARCH\\]/s, \"\")\r\n      .replace(/\\[SELECT_ROOM\\].*?\\[\\/SELECT_ROOM\\]/s, \"\")\r\n      .replace(/\\[BOOK\\].*?\\[\\/BOOK\\]/s, \"\")\r\n      .trim()\r\n\r\n    // Return response with session ID and memory info\r\n    return Response.json({ \r\n      message: cleanText,\r\n      sessionId: currentSessionId,\r\n      hasMemory: memory.messages.length > 0,\r\n      messageCount: memory.metadata.messageCount,\r\n      adminMode: ChatMemoryService.isAdminMode(currentSessionId)\r\n    })\r\n  } catch (error) {\r\n    console.error(\"[v0] AI Chat error:\", error)\r\n    return Response.json(\r\n      {\r\n        message: \"Sorry, an error occurred. Please try again.\",\r\n      },\r\n      { status: 500 },\r\n    )\r\n  }\r\n}\r\n","import {\n  AppRouteRouteModule,\n  type AppRouteRouteHandlerContext,\n  type AppRouteRouteModuleOptions,\n} from '../../server/route-modules/app-route/module.compiled'\nimport { RouteKind } from '../../server/route-kind'\nimport { patchFetch as _patchFetch } from '../../server/lib/patch-fetch'\nimport type { IncomingMessage, ServerResponse } from 'node:http'\nimport { addRequestMeta, getRequestMeta } from '../../server/request-meta'\nimport { getTracer, type Span, SpanKind } from '../../server/lib/trace/tracer'\nimport { setReferenceManifestsSingleton } from '../../server/app-render/encryption-utils'\nimport { createServerModuleMap } from '../../server/app-render/action-utils'\nimport { normalizeAppPath } from '../../shared/lib/router/utils/app-paths'\nimport { NodeNextRequest, NodeNextResponse } from '../../server/base-http/node'\nimport {\n  NextRequestAdapter,\n  signalFromNodeResponse,\n} from '../../server/web/spec-extension/adapters/next-request'\nimport { BaseServerSpan } from '../../server/lib/trace/constants'\nimport { getRevalidateReason } from '../../server/instrumentation/utils'\nimport { sendResponse } from '../../server/send-response'\nimport {\n  fromNodeOutgoingHttpHeaders,\n  toNodeOutgoingHttpHeaders,\n} from '../../server/web/utils'\nimport { getCacheControlHeader } from '../../server/lib/cache-control'\nimport { INFINITE_CACHE, NEXT_CACHE_TAGS_HEADER } from '../../lib/constants'\nimport { NoFallbackError } from '../../shared/lib/no-fallback-error.external'\nimport {\n  CachedRouteKind,\n  type ResponseCacheEntry,\n  type ResponseGenerator,\n} from '../../server/response-cache'\n\nimport * as userland from 'VAR_USERLAND'\n\n// These are injected by the loader afterwards. This is injected as a variable\n// instead of a replacement because this could also be `undefined` instead of\n// an empty string.\ndeclare const nextConfigOutput: AppRouteRouteModuleOptions['nextConfigOutput']\n\n// We inject the nextConfigOutput here so that we can use them in the route\n// module.\n// INJECT:nextConfigOutput\n\nconst routeModule = new AppRouteRouteModule({\n  definition: {\n    kind: RouteKind.APP_ROUTE,\n    page: 'VAR_DEFINITION_PAGE',\n    pathname: 'VAR_DEFINITION_PATHNAME',\n    filename: 'VAR_DEFINITION_FILENAME',\n    bundlePath: 'VAR_DEFINITION_BUNDLE_PATH',\n  },\n  distDir: process.env.__NEXT_RELATIVE_DIST_DIR || '',\n  relativeProjectDir: process.env.__NEXT_RELATIVE_PROJECT_DIR || '',\n  resolvedPagePath: 'VAR_RESOLVED_PAGE_PATH',\n  nextConfigOutput,\n  userland,\n})\n\n// Pull out the exports that we need to expose from the module. This should\n// be eliminated when we've moved the other routes to the new format. These\n// are used to hook into the route.\nconst { workAsyncStorage, workUnitAsyncStorage, serverHooks } = routeModule\n\nfunction patchFetch() {\n  return _patchFetch({\n    workAsyncStorage,\n    workUnitAsyncStorage,\n  })\n}\n\nexport {\n  routeModule,\n  workAsyncStorage,\n  workUnitAsyncStorage,\n  serverHooks,\n  patchFetch,\n}\n\nexport async function handler(\n  req: IncomingMessage,\n  res: ServerResponse,\n  ctx: {\n    waitUntil: (prom: Promise<void>) => void\n  }\n) {\n  if (routeModule.isDev) {\n    addRequestMeta(req, 'devRequestTimingInternalsEnd', process.hrtime.bigint())\n  }\n  let srcPage = 'VAR_DEFINITION_PAGE'\n\n  // turbopack doesn't normalize `/index` in the page name\n  // so we need to to process dynamic routes properly\n  // TODO: fix turbopack providing differing value from webpack\n  if (process.env.TURBOPACK) {\n    srcPage = srcPage.replace(/\\/index$/, '') || '/'\n  } else if (srcPage === '/index') {\n    // we always normalize /index specifically\n    srcPage = '/'\n  }\n  const multiZoneDraftMode = process.env\n    .__NEXT_MULTI_ZONE_DRAFT_MODE as any as boolean\n\n  const prepareResult = await routeModule.prepare(req, res, {\n    srcPage,\n    multiZoneDraftMode,\n  })\n\n  if (!prepareResult) {\n    res.statusCode = 400\n    res.end('Bad Request')\n    ctx.waitUntil?.(Promise.resolve())\n    return null\n  }\n\n  const {\n    buildId,\n    params,\n    nextConfig,\n    parsedUrl,\n    isDraftMode,\n    prerenderManifest,\n    routerServerContext,\n    isOnDemandRevalidate,\n    revalidateOnlyGenerated,\n    resolvedPathname,\n    clientReferenceManifest,\n    serverActionsManifest,\n  } = prepareResult\n\n  const normalizedSrcPage = normalizeAppPath(srcPage)\n\n  let isIsr = Boolean(\n    prerenderManifest.dynamicRoutes[normalizedSrcPage] ||\n      prerenderManifest.routes[resolvedPathname]\n  )\n\n  const render404 = async () => {\n    // TODO: should route-module itself handle rendering the 404\n    if (routerServerContext?.render404) {\n      await routerServerContext.render404(req, res, parsedUrl, false)\n    } else {\n      res.end('This page could not be found')\n    }\n    return null\n  }\n\n  if (isIsr && !isDraftMode) {\n    const isPrerendered = Boolean(prerenderManifest.routes[resolvedPathname])\n    const prerenderInfo = prerenderManifest.dynamicRoutes[normalizedSrcPage]\n\n    if (prerenderInfo) {\n      if (prerenderInfo.fallback === false && !isPrerendered) {\n        if (nextConfig.experimental.adapterPath) {\n          return await render404()\n        }\n        throw new NoFallbackError()\n      }\n    }\n  }\n\n  let cacheKey: string | null = null\n\n  if (isIsr && !routeModule.isDev && !isDraftMode) {\n    cacheKey = resolvedPathname\n    // ensure /index and / is normalized to one key\n    cacheKey = cacheKey === '/index' ? '/' : cacheKey\n  }\n\n  const supportsDynamicResponse: boolean =\n    // If we're in development, we always support dynamic HTML\n    routeModule.isDev === true ||\n    // If this is not SSG or does not have static paths, then it supports\n    // dynamic HTML.\n    !isIsr\n\n  // This is a revalidation request if the request is for a static\n  // page and it is not being resumed from a postponed render and\n  // it is not a dynamic RSC request then it is a revalidation\n  // request.\n  const isStaticGeneration = isIsr && !supportsDynamicResponse\n\n  // Before rendering (which initializes component tree modules), we have to\n  // set the reference manifests to our global store so Server Action's\n  // encryption util can access to them at the top level of the page module.\n  if (serverActionsManifest && clientReferenceManifest) {\n    setReferenceManifestsSingleton({\n      page: srcPage,\n      clientReferenceManifest,\n      serverActionsManifest,\n      serverModuleMap: createServerModuleMap({\n        serverActionsManifest,\n      }),\n    })\n  }\n\n  const method = req.method || 'GET'\n  const tracer = getTracer()\n  const activeSpan = tracer.getActiveScopeSpan()\n\n  const context: AppRouteRouteHandlerContext = {\n    params,\n    prerenderManifest,\n    renderOpts: {\n      experimental: {\n        authInterrupts: Boolean(nextConfig.experimental.authInterrupts),\n      },\n      cacheComponents: Boolean(nextConfig.cacheComponents),\n      supportsDynamicResponse,\n      incrementalCache: getRequestMeta(req, 'incrementalCache'),\n      cacheLifeProfiles: nextConfig.cacheLife,\n      waitUntil: ctx.waitUntil,\n      onClose: (cb) => {\n        res.on('close', cb)\n      },\n      onAfterTaskError: undefined,\n      onInstrumentationRequestError: (error, _request, errorContext) =>\n        routeModule.onRequestError(\n          req,\n          error,\n          errorContext,\n          routerServerContext\n        ),\n    },\n    sharedContext: {\n      buildId,\n    },\n  }\n  const nodeNextReq = new NodeNextRequest(req)\n  const nodeNextRes = new NodeNextResponse(res)\n\n  const nextReq = NextRequestAdapter.fromNodeNextRequest(\n    nodeNextReq,\n    signalFromNodeResponse(res)\n  )\n\n  try {\n    const invokeRouteModule = async (span?: Span) => {\n      return routeModule.handle(nextReq, context).finally(() => {\n        if (!span) return\n\n        span.setAttributes({\n          'http.status_code': res.statusCode,\n          'next.rsc': false,\n        })\n\n        const rootSpanAttributes = tracer.getRootSpanAttributes()\n        // We were unable to get attributes, probably OTEL is not enabled\n        if (!rootSpanAttributes) {\n          return\n        }\n\n        if (\n          rootSpanAttributes.get('next.span_type') !==\n          BaseServerSpan.handleRequest\n        ) {\n          console.warn(\n            `Unexpected root span type '${rootSpanAttributes.get(\n              'next.span_type'\n            )}'. Please report this Next.js issue https://github.com/vercel/next.js`\n          )\n          return\n        }\n\n        const route = rootSpanAttributes.get('next.route')\n        if (route) {\n          const name = `${method} ${route}`\n\n          span.setAttributes({\n            'next.route': route,\n            'http.route': route,\n            'next.span_name': name,\n          })\n          span.updateName(name)\n        } else {\n          span.updateName(`${method} ${srcPage}`)\n        }\n      })\n    }\n    const isMinimalMode = Boolean(\n      process.env.MINIMAL_MODE || getRequestMeta(req, 'minimalMode')\n    )\n\n    const handleResponse = async (currentSpan?: Span) => {\n      const responseGenerator: ResponseGenerator = async ({\n        previousCacheEntry,\n      }) => {\n        try {\n          if (\n            !isMinimalMode &&\n            isOnDemandRevalidate &&\n            revalidateOnlyGenerated &&\n            !previousCacheEntry\n          ) {\n            res.statusCode = 404\n            // on-demand revalidate always sets this header\n            res.setHeader('x-nextjs-cache', 'REVALIDATED')\n            res.end('This page could not be found')\n            return null\n          }\n\n          const response = await invokeRouteModule(currentSpan)\n\n          ;(req as any).fetchMetrics = (context.renderOpts as any).fetchMetrics\n          let pendingWaitUntil = context.renderOpts.pendingWaitUntil\n\n          // Attempt using provided waitUntil if available\n          // if it's not we fallback to sendResponse's handling\n          if (pendingWaitUntil) {\n            if (ctx.waitUntil) {\n              ctx.waitUntil(pendingWaitUntil)\n              pendingWaitUntil = undefined\n            }\n          }\n          const cacheTags = context.renderOpts.collectedTags\n\n          // If the request is for a static response, we can cache it so long\n          // as it's not edge.\n          if (isIsr) {\n            const blob = await response.blob()\n\n            // Copy the headers from the response.\n            const headers = toNodeOutgoingHttpHeaders(response.headers)\n\n            if (cacheTags) {\n              headers[NEXT_CACHE_TAGS_HEADER] = cacheTags\n            }\n\n            if (!headers['content-type'] && blob.type) {\n              headers['content-type'] = blob.type\n            }\n\n            const revalidate =\n              typeof context.renderOpts.collectedRevalidate === 'undefined' ||\n              context.renderOpts.collectedRevalidate >= INFINITE_CACHE\n                ? false\n                : context.renderOpts.collectedRevalidate\n\n            const expire =\n              typeof context.renderOpts.collectedExpire === 'undefined' ||\n              context.renderOpts.collectedExpire >= INFINITE_CACHE\n                ? undefined\n                : context.renderOpts.collectedExpire\n\n            // Create the cache entry for the response.\n            const cacheEntry: ResponseCacheEntry = {\n              value: {\n                kind: CachedRouteKind.APP_ROUTE,\n                status: response.status,\n                body: Buffer.from(await blob.arrayBuffer()),\n                headers,\n              },\n              cacheControl: { revalidate, expire },\n            }\n\n            return cacheEntry\n          } else {\n            // send response without caching if not ISR\n            await sendResponse(\n              nodeNextReq,\n              nodeNextRes,\n              response,\n              context.renderOpts.pendingWaitUntil\n            )\n            return null\n          }\n        } catch (err) {\n          // if this is a background revalidate we need to report\n          // the request error here as it won't be bubbled\n          if (previousCacheEntry?.isStale) {\n            await routeModule.onRequestError(\n              req,\n              err,\n              {\n                routerKind: 'App Router',\n                routePath: srcPage,\n                routeType: 'route',\n                revalidateReason: getRevalidateReason({\n                  isStaticGeneration,\n                  isOnDemandRevalidate,\n                }),\n              },\n              routerServerContext\n            )\n          }\n          throw err\n        }\n      }\n\n      const cacheEntry = await routeModule.handleResponse({\n        req,\n        nextConfig,\n        cacheKey,\n        routeKind: RouteKind.APP_ROUTE,\n        isFallback: false,\n        prerenderManifest,\n        isRoutePPREnabled: false,\n        isOnDemandRevalidate,\n        revalidateOnlyGenerated,\n        responseGenerator,\n        waitUntil: ctx.waitUntil,\n        isMinimalMode,\n      })\n\n      // we don't create a cacheEntry for ISR\n      if (!isIsr) {\n        return null\n      }\n\n      if (cacheEntry?.value?.kind !== CachedRouteKind.APP_ROUTE) {\n        throw new Error(\n          `Invariant: app-route received invalid cache entry ${cacheEntry?.value?.kind}`\n        )\n      }\n\n      if (!isMinimalMode) {\n        res.setHeader(\n          'x-nextjs-cache',\n          isOnDemandRevalidate\n            ? 'REVALIDATED'\n            : cacheEntry.isMiss\n              ? 'MISS'\n              : cacheEntry.isStale\n                ? 'STALE'\n                : 'HIT'\n        )\n      }\n\n      // Draft mode should never be cached\n      if (isDraftMode) {\n        res.setHeader(\n          'Cache-Control',\n          'private, no-cache, no-store, max-age=0, must-revalidate'\n        )\n      }\n\n      const headers = fromNodeOutgoingHttpHeaders(cacheEntry.value.headers)\n\n      if (!(isMinimalMode && isIsr)) {\n        headers.delete(NEXT_CACHE_TAGS_HEADER)\n      }\n\n      // If cache control is already set on the response we don't\n      // override it to allow users to customize it via next.config\n      if (\n        cacheEntry.cacheControl &&\n        !res.getHeader('Cache-Control') &&\n        !headers.get('Cache-Control')\n      ) {\n        headers.set(\n          'Cache-Control',\n          getCacheControlHeader(cacheEntry.cacheControl)\n        )\n      }\n\n      await sendResponse(\n        nodeNextReq,\n        nodeNextRes,\n        // @ts-expect-error - Argument of type 'Buffer<ArrayBufferLike>' is not assignable to parameter of type 'BodyInit | null | undefined'.\n        new Response(cacheEntry.value.body, {\n          headers,\n          status: cacheEntry.value.status || 200,\n        })\n      )\n      return null\n    }\n\n    // TODO: activeSpan code path is for when wrapped by\n    // next-server can be removed when this is no longer used\n    if (activeSpan) {\n      await handleResponse(activeSpan)\n    } else {\n      await tracer.withPropagatedContext(req.headers, () =>\n        tracer.trace(\n          BaseServerSpan.handleRequest,\n          {\n            spanName: `${method} ${srcPage}`,\n            kind: SpanKind.SERVER,\n            attributes: {\n              'http.method': method,\n              'http.target': req.url,\n            },\n          },\n          handleResponse\n        )\n      )\n    }\n  } catch (err) {\n    if (!(err instanceof NoFallbackError)) {\n      await routeModule.onRequestError(req, err, {\n        routerKind: 'App Router',\n        routePath: normalizedSrcPage,\n        routeType: 'route',\n        revalidateReason: getRevalidateReason({\n          isStaticGeneration,\n          isOnDemandRevalidate,\n        }),\n      })\n    }\n\n    // rethrow so that we can handle serving error page\n\n    // If this is during static generation, throw the error again.\n    if (isIsr) throw err\n\n    // Otherwise, send a 500 response.\n    await sendResponse(\n      nodeNextReq,\n      nodeNextRes,\n      new Response(null, { status: 500 })\n    )\n    return null\n  }\n}\n"],"names":["AppRouteRouteModule","RouteKind","patchFetch","_patchFetch","addRequestMeta","getRequestMeta","getTracer","SpanKind","setReferenceManifestsSingleton","createServerModuleMap","normalizeAppPath","NodeNextRequest","NodeNextResponse","NextRequestAdapter","signalFromNodeResponse","BaseServerSpan","getRevalidateReason","sendResponse","fromNodeOutgoingHttpHeaders","toNodeOutgoingHttpHeaders","getCacheControlHeader","INFINITE_CACHE","NEXT_CACHE_TAGS_HEADER","NoFallbackError","CachedRouteKind","userland","routeModule","definition","kind","APP_ROUTE","page","pathname","filename","bundlePath","distDir","process","env","__NEXT_RELATIVE_DIST_DIR","relativeProjectDir","__NEXT_RELATIVE_PROJECT_DIR","resolvedPagePath","nextConfigOutput","workAsyncStorage","workUnitAsyncStorage","serverHooks","handler","req","res","ctx","isDev","hrtime","bigint","srcPage","TURBOPACK","replace","multiZoneDraftMode","__NEXT_MULTI_ZONE_DRAFT_MODE","prepareResult","prepare","statusCode","end","waitUntil","Promise","resolve","buildId","params","nextConfig","parsedUrl","isDraftMode","prerenderManifest","routerServerContext","isOnDemandRevalidate","revalidateOnlyGenerated","resolvedPathname","clientReferenceManifest","serverActionsManifest","normalizedSrcPage","isIsr","Boolean","dynamicRoutes","routes","render404","isPrerendered","prerenderInfo","fallback","experimental","adapterPath","cacheKey","supportsDynamicResponse","isStaticGeneration","serverModuleMap","method","tracer","activeSpan","getActiveScopeSpan","context","renderOpts","authInterrupts","cacheComponents","incrementalCache","cacheLifeProfiles","cacheLife","onClose","cb","on","onAfterTaskError","undefined","onInstrumentationRequestError","error","_request","errorContext","onRequestError","sharedContext","nodeNextReq","nodeNextRes","nextReq","fromNodeNextRequest","invokeRouteModule","span","handle","finally","setAttributes","rootSpanAttributes","getRootSpanAttributes","get","handleRequest","console","warn","route","name","updateName","isMinimalMode","MINIMAL_MODE","handleResponse","currentSpan","cacheEntry","responseGenerator","previousCacheEntry","setHeader","response","fetchMetrics","pendingWaitUntil","cacheTags","collectedTags","blob","headers","type","revalidate","collectedRevalidate","expire","collectedExpire","value","status","body","Buffer","from","arrayBuffer","cacheControl","err","isStale","routerKind","routePath","routeType","revalidateReason","routeKind","isFallback","isRoutePPREnabled","Error","isMiss","delete","getHeader","set","Response","withPropagatedContext","trace","spanName","SERVER","attributes","url"],"mappings":"wCAsOO,MAAM,AA4CF,CACP,MAAO,cA7CuB,GA8C9B,MAAO,+BACP,QAAS,0BACT,SAAU,iBACZ,EC5QW,EAAuB,CAElC,SAAU,CACR,KAAM,qBACN,YAAa,yBACb,QAAS,gCACT,eAAgB,6BAChB,QAAS,sDACT,YAAa,CACX,SACA,SACA,SACA,YACA,aACA,UACD,CACD,eAAgB,0DAChB,oBAAqB,CACnB,gDACA,kDACA,+DACA,8BACA,yCACD,AACH,EAGA,SAAU,CACR,QAAS,iCACT,aAAc,uBACd,YAAa,CACX,IAAK,QACL,IAAK,OACP,EACA,kBAAmB,CACjB,CAAE,KAAM,gBAAiB,SAAU,eAAgB,YAAa,gCAAiC,EACjG,CAAE,KAAM,qBAAsB,SAAU,gBAAiB,YAAa,eAAgB,EACtF,CAAE,KAAM,YAAa,SAAU,eAAgB,YAAa,eAAgB,EAC5E,CAAE,KAAM,WAAY,SAAU,gBAAiB,YAAa,kBAAmB,EAC/E,CAAE,KAAM,aAAc,SAAU,gBAAiB,YAAa,kBAAmB,EACjF,CAAE,KAAM,iBAAkB,SAAU,gBAAiB,YAAa,yBAA0B,EAC7F,CACD,eAAgB,CACd,YAAa,uCACb,gBAAiB,4BACjB,QAAS,+BACT,WAAY,4BACd,CACF,EAGA,MD9D8B,AC8DvB,CD7DP,CACE,GAAI,iBACJ,KAAM,sBACN,WAAY,eACZ,MAAO,KACP,QAAS,yCACT,UAAW,+DACX,YAAa,2QACb,cAAe,wPACf,KAAM,GACN,UAAW,EACX,UAAW,IACX,SAAU,CACR,mBACA,gBACA,eACA,cACA,kBACA,sBACA,2BACD,CACD,WAAY,CACV,uBACA,WACA,wBACA,mBACA,oBACA,6BACA,0BACD,CACD,YAAa,kBACb,cAAe,qBACf,OAAQ,CACN,sHACA,sHACA,sHACA,0HACA,qHACA,2HACD,AACH,EACA,CACE,GAAI,kBACJ,KAAM,uBACN,WAAY,gBACZ,MAAO,KACP,QAAS,yCACT,UAAW,6CACX,YAAa,4PACb,cAAe,0PACf,KAAM,GACN,UAAW,EACX,UAAW,IACX,SAAU,CACR,wBACA,+BACA,aACA,gBACA,cACA,oBACA,qBACA,2BACD,CACD,WAAY,CACV,2BACA,+BACA,gBACA,WACA,oBACA,0BACA,2BACA,0BACD,CACD,YAAa,wBACb,cAAe,+BACf,QAAS,4BACT,UAAW,4CACX,OAAQ,CACN,0HACA,0HACA,0HACA,0HACD,AACH,EACA,CACE,GAAI,iBACJ,KAAM,sBACN,WAAY,iBACZ,MAAO,KACP,QAAS,6BACT,YAAa,2OACb,KAAM,GACN,UAAW,EACX,UAAW,IACX,SAAU,CACR,kBACA,aACA,gBACA,OACA,cACA,YACA,2BACD,CACD,YAAa,qBACb,OAAQ,CACN,0HACA,0HACD,AACH,EACA,CACE,GAAI,kBACJ,KAAM,uBACN,WAAY,iBACZ,MAAO,KACP,QAAS,6BACT,YAAa,kOACb,KAAM,GACN,UAAW,EACX,UAAW,IACX,SAAU,CACR,sBACA,mBACA,aACA,gBACA,cACA,sBACA,eACD,CACD,YAAa,2BACb,QAAS,uBACT,OAAQ,CACN,0HACA,0HACD,AACH,EACA,CACE,GAAI,SACJ,KAAM,cACN,WAAY,YACZ,MAAO,KACP,QAAS,+BACT,YAAa,2LACb,KAAM,GACN,UAAW,EACX,UAAW,IACX,SAAU,CACR,mBACA,oCACA,aACA,gBACA,eACA,cACA,kBACD,CACD,YAAa,8BACb,OAAQ,CACN,+GACA,qGACA,+GACA,+GACA,+GACA,+GACD,AACH,EACA,CACE,GAAI,yBACJ,KAAM,2BACN,WAAY,yBACZ,MAAO,KACP,QAAS,uCACT,YAAa,kMACb,KAAM,GACN,UAAW,EACX,UAAW,IACX,SAAU,CACR,wBACA,kCACA,cACA,aACA,gBACA,cACA,oBACD,CACD,YAAa,cACb,QAAS,+BACT,WAAW,EACX,OAAQ,CACN,0HACA,0HAEJ,AADG,EAEH,CACE,GAAI,QACJ,KAAM,YACN,WAAY,UACZ,MAAO,KACP,QAAS,4BACT,YAAa,4NACb,KAAM,GACN,UAAW,EACX,UAAW,KACX,SAAU,CACR,mBACA,mBACA,cACA,iBACA,YACA,iBACA,aACA,gBACA,kBACA,0BACD,CACD,YAAa,+BACb,QAAS,yCACT,UAAW,GACX,O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","ignoreList":[6]}