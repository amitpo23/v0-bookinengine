{"version":3,"sources":["../../../node_modules/next/src/server/route-modules/app-page/module.compiled.js","../../../node_modules/next/src/server/route-modules/app-page/vendored/rsc/react.ts","../../../node_modules/node-domexception/index.js","../../../lib/ai-engines/handlers/payment.ts","../../../lib/ai-engines/handlers/monitoring.ts","../../../lib/ai-engines/handlers/voice.ts","../../../lib/ai-engines/handlers/refund.ts","../../../lib/ai-engines/handlers/whatsapp.ts","../../../lib/ai-engines/handlers/booking.ts","../../../lib/ai-engines/handlers/abandoned-cart.ts","../../../lib/ai-engines/handlers/reviews.ts","../../../lib/ai-engines/handlers/fraud.ts","../../../lib/ai-engines/handlers/insurance.ts","../../../lib/ai-engines/handlers/revenue-dashboard.ts","../../../lib/ai-engines/handlers/invoice.ts","../../../lib/ai-engines/handlers/demand-forecasting.ts"],"sourcesContent":["if (process.env.NEXT_RUNTIME === 'edge') {\n  module.exports = require('next/dist/server/route-modules/app-page/module.js')\n} else {\n  if (process.env.__NEXT_EXPERIMENTAL_REACT) {\n    if (process.env.NODE_ENV === 'development') {\n      if (process.env.TURBOPACK) {\n        module.exports = require('next/dist/compiled/next-server/app-page-turbo-experimental.runtime.dev.js')\n      } else {\n        module.exports = require('next/dist/compiled/next-server/app-page-experimental.runtime.dev.js')\n      }\n    } else {\n      if (process.env.TURBOPACK) {\n        module.exports = require('next/dist/compiled/next-server/app-page-turbo-experimental.runtime.prod.js')\n      } else {\n        module.exports = require('next/dist/compiled/next-server/app-page-experimental.runtime.prod.js')\n      }\n    }\n  } else {\n    if (process.env.NODE_ENV === 'development') {\n      if (process.env.TURBOPACK) {\n        module.exports = require('next/dist/compiled/next-server/app-page-turbo.runtime.dev.js')\n      } else {\n        module.exports = require('next/dist/compiled/next-server/app-page.runtime.dev.js')\n      }\n    } else {\n      if (process.env.TURBOPACK) {\n        module.exports = require('next/dist/compiled/next-server/app-page-turbo.runtime.prod.js')\n      } else {\n        module.exports = require('next/dist/compiled/next-server/app-page.runtime.prod.js')\n      }\n    }\n  }\n}\n","module.exports = (\n  require('../../module.compiled') as typeof import('../../module.compiled')\n).vendored['react-rsc']!.React\n","/*! node-domexception. MIT License. Jimmy Wärting <https://jimmy.warting.se/opensource> */\n\nif (!globalThis.DOMException) {\n  try {\n    const { MessageChannel } = require('worker_threads'),\n    port = new MessageChannel().port1,\n    ab = new ArrayBuffer()\n    port.postMessage(ab, [ab, ab])\n  } catch (err) {\n    err.constructor.name === 'DOMException' && (\n      globalThis.DOMException = err.constructor\n    )\n  }\n}\n\nmodule.exports = globalThis.DOMException\n","/**\r\n * Payment Handler\r\n * Stripe integration for processing booking payments\r\n */\r\n\r\nimport Stripe from \"stripe\"\r\n\r\n// Initialize Stripe\r\nconst stripe = new Stripe(process.env.STRIPE_SECRET_KEY || \"\", {\r\n  apiVersion: \"2025-11-17.clover\",\r\n})\r\n\r\n// Types\r\nexport interface PaymentContext {\r\n  userId?: string\r\n  sessionId?: string\r\n  locale?: string\r\n}\r\n\r\nexport interface PaymentIntent {\r\n  id: string\r\n  clientSecret: string\r\n  amount: number\r\n  currency: string\r\n  status: string\r\n  bookingId?: string\r\n  customerId?: string\r\n}\r\n\r\nexport interface PaymentResult {\r\n  success: boolean\r\n  paymentId?: string\r\n  status?: string\r\n  error?: string\r\n  requiresAction?: boolean\r\n  actionUrl?: string\r\n  receiptUrl?: string\r\n}\r\n\r\n/**\r\n * Create a Stripe payment intent for a booking\r\n */\r\nexport async function createPaymentIntent(\r\n  params: {\r\n    bookingId: string\r\n    amount: number\r\n    currency: string\r\n    customerEmail: string\r\n    customerName?: string\r\n    description?: string\r\n    metadata?: Record<string, string>\r\n  },\r\n  context?: PaymentContext\r\n): Promise<PaymentIntent> {\r\n  console.log(\"[Payment] Creating payment intent\", { bookingId: params.bookingId, amount: params.amount })\r\n\r\n  try {\r\n    // Create or retrieve Stripe customer\r\n    let customerId: string | undefined\r\n    \r\n    const existingCustomers = await stripe.customers.list({\r\n      email: params.customerEmail,\r\n      limit: 1,\r\n    })\r\n\r\n    if (existingCustomers.data.length > 0) {\r\n      customerId = existingCustomers.data[0].id\r\n    } else {\r\n      const customer = await stripe.customers.create({\r\n        email: params.customerEmail,\r\n        name: params.customerName,\r\n        metadata: {\r\n          source: \"booking-engine\",\r\n          bookingId: params.bookingId,\r\n        },\r\n      })\r\n      customerId = customer.id\r\n    }\r\n\r\n    // Create payment intent\r\n    const paymentIntent = await stripe.paymentIntents.create({\r\n      amount: params.amount, // Amount in cents\r\n      currency: params.currency.toLowerCase(),\r\n      customer: customerId,\r\n      description: params.description || `Booking ${params.bookingId}`,\r\n      metadata: {\r\n        bookingId: params.bookingId,\r\n        customerEmail: params.customerEmail,\r\n        ...params.metadata,\r\n      },\r\n      automatic_payment_methods: {\r\n        enabled: true,\r\n      },\r\n      // Enable 3D Secure when required\r\n      payment_method_options: {\r\n        card: {\r\n          request_three_d_secure: \"automatic\",\r\n        },\r\n      },\r\n    })\r\n\r\n    console.log(\"[Payment] Payment intent created\", { id: paymentIntent.id, status: paymentIntent.status })\r\n\r\n    return {\r\n      id: paymentIntent.id,\r\n      clientSecret: paymentIntent.client_secret || \"\",\r\n      amount: paymentIntent.amount,\r\n      currency: paymentIntent.currency,\r\n      status: paymentIntent.status,\r\n      bookingId: params.bookingId,\r\n      customerId,\r\n    }\r\n  } catch (error: any) {\r\n    console.error(\"[Payment] Failed to create payment intent\", error.message)\r\n    throw new Error(`Payment intent creation failed: ${error.message}`)\r\n  }\r\n}\r\n\r\n/**\r\n * Process a payment using an existing payment intent\r\n */\r\nexport async function processPayment(\r\n  params: {\r\n    paymentIntentId: string\r\n    paymentMethodId: string\r\n    returnUrl?: string\r\n  },\r\n  context?: PaymentContext\r\n): Promise<PaymentResult> {\r\n  console.log(\"[Payment] Processing payment\", { paymentIntentId: params.paymentIntentId })\r\n\r\n  try {\r\n    const paymentIntent = await stripe.paymentIntents.confirm(params.paymentIntentId, {\r\n      payment_method: params.paymentMethodId,\r\n      return_url: params.returnUrl || `${process.env.NEXT_PUBLIC_APP_URL || \"https://v0-bookinengine.vercel.app\"}/booking/complete`,\r\n    })\r\n\r\n    const result: PaymentResult = {\r\n      success: paymentIntent.status === \"succeeded\",\r\n      paymentId: paymentIntent.id,\r\n      status: paymentIntent.status,\r\n    }\r\n\r\n    // Check if 3D Secure is required\r\n    if (paymentIntent.status === \"requires_action\" && paymentIntent.next_action?.type === \"redirect_to_url\") {\r\n      result.requiresAction = true\r\n      result.actionUrl = paymentIntent.next_action.redirect_to_url?.url || undefined\r\n    }\r\n\r\n    console.log(\"[Payment] Payment processed\", { id: paymentIntent.id, status: paymentIntent.status })\r\n\r\n    return result\r\n  } catch (error: any) {\r\n    console.error(\"[Payment] Payment processing failed\", error.message)\r\n    return {\r\n      success: false,\r\n      paymentId: params.paymentIntentId,\r\n      error: error.message,\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Verify a payment was successful\r\n */\r\nexport async function verifyPayment(\r\n  params: { paymentIntentId: string },\r\n  context?: PaymentContext\r\n): Promise<{\r\n  verified: boolean\r\n  status: string\r\n  amount?: number\r\n  currency?: string\r\n  bookingId?: string\r\n  error?: string\r\n}> {\r\n  try {\r\n    const paymentIntent = await stripe.paymentIntents.retrieve(params.paymentIntentId)\r\n\r\n    return {\r\n      verified: paymentIntent.status === \"succeeded\",\r\n      status: paymentIntent.status,\r\n      amount: paymentIntent.amount,\r\n      currency: paymentIntent.currency,\r\n      bookingId: paymentIntent.metadata.bookingId,\r\n    }\r\n  } catch (error: any) {\r\n    console.error(\"[Payment] Payment verification failed\", error.message)\r\n    return {\r\n      verified: false,\r\n      status: \"error\",\r\n      error: error.message,\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Get current status of a payment\r\n */\r\nexport async function getPaymentStatus(\r\n  params: { paymentIntentId: string },\r\n  context?: PaymentContext\r\n): Promise<{\r\n  id: string\r\n  status: string\r\n  amount: number\r\n  currency: string\r\n  created: Date\r\n  paymentMethod?: string\r\n  receiptUrl?: string\r\n  bookingId?: string\r\n}> {\r\n  try {\r\n    const paymentIntent = await stripe.paymentIntents.retrieve(params.paymentIntentId, {\r\n      expand: [\"latest_charge\"],\r\n    })\r\n\r\n    const charge = paymentIntent.latest_charge as Stripe.Charge | null\r\n\r\n    return {\r\n      id: paymentIntent.id,\r\n      status: paymentIntent.status,\r\n      amount: paymentIntent.amount,\r\n      currency: paymentIntent.currency,\r\n      created: new Date(paymentIntent.created * 1000),\r\n      paymentMethod: typeof paymentIntent.payment_method === \"string\" \r\n        ? paymentIntent.payment_method \r\n        : paymentIntent.payment_method?.id,\r\n      receiptUrl: charge?.receipt_url || undefined,\r\n      bookingId: paymentIntent.metadata.bookingId,\r\n    }\r\n  } catch (error: any) {\r\n    console.error(\"[Payment] Failed to get payment status\", error.message)\r\n    throw error\r\n  }\r\n}\r\n\r\n/**\r\n * Cancel a pending payment intent\r\n */\r\nexport async function cancelPayment(\r\n  params: {\r\n    paymentIntentId: string\r\n    reason?: string\r\n  },\r\n  context?: PaymentContext\r\n): Promise<{ success: boolean; error?: string }> {\r\n  try {\r\n    await stripe.paymentIntents.cancel(params.paymentIntentId, {\r\n      cancellation_reason: \"requested_by_customer\",\r\n    })\r\n\r\n    console.log(\"[Payment] Payment cancelled\", { id: params.paymentIntentId, reason: params.reason })\r\n\r\n    return { success: true }\r\n  } catch (error: any) {\r\n    console.error(\"[Payment] Failed to cancel payment\", error.message)\r\n    return { success: false, error: error.message }\r\n  }\r\n}\r\n\r\n/**\r\n * Get list of payments for a booking\r\n */\r\nexport async function getBookingPayments(\r\n  params: { bookingId: string },\r\n  context?: PaymentContext\r\n): Promise<PaymentIntent[]> {\r\n  try {\r\n    const paymentIntents = await stripe.paymentIntents.search({\r\n      query: `metadata[\"bookingId\"]:\"${params.bookingId}\"`,\r\n      limit: 10,\r\n    })\r\n\r\n    return paymentIntents.data.map(pi => ({\r\n      id: pi.id,\r\n      clientSecret: pi.client_secret || \"\",\r\n      amount: pi.amount,\r\n      currency: pi.currency,\r\n      status: pi.status,\r\n      bookingId: params.bookingId,\r\n      customerId: typeof pi.customer === \"string\" ? pi.customer : pi.customer?.id,\r\n    }))\r\n  } catch (error: any) {\r\n    console.error(\"[Payment] Failed to get booking payments\", error.message)\r\n    return []\r\n  }\r\n}\r\n\r\n// Export handlers map for registry\r\nexport const paymentHandlers = {\r\n  createPaymentIntent,\r\n  processPayment,\r\n  verifyPayment,\r\n  getPaymentStatus,\r\n  cancelPayment,\r\n  getBookingPayments,\r\n}\r\n","/**\r\n * Monitoring Handlers\r\n * Tool handlers for price monitoring and tracking\r\n * Based on: hotel-price-monitor scraping capabilities\r\n */\r\n\r\nimport type { ConversationContext } from '../types';\r\n\r\n// ========================================\r\n// TRACK HOTEL PRICE\r\n// ========================================\r\n\r\ninterface TrackHotelPriceParams {\r\n  hotelUrl: string;\r\n  checkIn: string;\r\n  checkOut: string;\r\n  targetPrice?: number;\r\n  notifyEmail?: string;\r\n}\r\n\r\ninterface TrackingResult {\r\n  success: boolean;\r\n  trackingId: string;\r\n  hotelName: string;\r\n  currentPrice: number;\r\n  currency: string;\r\n  targetPrice?: number;\r\n  checkInterval: string;\r\n  notificationSettings: {\r\n    email?: string;\r\n    priceDropThreshold: number;\r\n  };\r\n  nextCheck: Date;\r\n}\r\n\r\nexport async function trackHotelPrice(\r\n  params: TrackHotelPriceParams,\r\n  context: ConversationContext\r\n): Promise<TrackingResult> {\r\n  console.log(`[MonitoringHandler] Starting price tracking for:`, params.hotelUrl);\r\n\r\n  try {\r\n    // Validate URL (Booking.com format)\r\n    if (!params.hotelUrl.includes('booking.com')) {\r\n      throw new Error('Currently only Booking.com URLs are supported');\r\n    }\r\n\r\n    // Extract hotel info from URL (in production, use scraper)\r\n    const hotelName = extractHotelNameFromUrl(params.hotelUrl);\r\n\r\n    const trackingId = `track-${Date.now()}-${Math.random().toString(36).substr(2, 8)}`;\r\n\r\n    // In production, would initialize scraping job:\r\n    // const scraper = new BookingComScraper();\r\n    // await scraper.initializeTracking({\r\n    //   url: params.hotelUrl,\r\n    //   checkIn: params.checkIn,\r\n    //   checkOut: params.checkOut,\r\n    //   trackingId\r\n    // });\r\n\r\n    // Mock current price\r\n    const currentPrice = Math.floor(Math.random() * 300) + 100;\r\n\r\n    const result: TrackingResult = {\r\n      success: true,\r\n      trackingId,\r\n      hotelName,\r\n      currentPrice,\r\n      currency: 'USD',\r\n      targetPrice: params.targetPrice,\r\n      checkInterval: 'Every 6 hours',\r\n      notificationSettings: {\r\n        email: params.notifyEmail,\r\n        priceDropThreshold: params.targetPrice ? 0 : 10 // Alert on any drop below target, or 10% otherwise\r\n      },\r\n      nextCheck: new Date(Date.now() + 6 * 60 * 60 * 1000)\r\n    };\r\n\r\n    // Store tracking in context\r\n    if (context) {\r\n      context.metadata = {\r\n        ...context.metadata,\r\n        priceTracking: [\r\n          ...(context.metadata?.priceTracking || []),\r\n          {\r\n            trackingId,\r\n            hotelUrl: params.hotelUrl,\r\n            hotelName,\r\n            startedAt: new Date()\r\n          }\r\n        ]\r\n      };\r\n    }\r\n\r\n    return result;\r\n  } catch (error: any) {\r\n    console.error(`[MonitoringHandler] Track price error:`, error);\r\n    throw new Error(`Failed to start price tracking: ${error.message}`);\r\n  }\r\n}\r\n\r\nfunction extractHotelNameFromUrl(url: string): string {\r\n  try {\r\n    const match = url.match(/hotel\\/([^/]+)/);\r\n    if (match) {\r\n      return match[1]\r\n        .replace(/-/g, ' ')\r\n        .replace(/\\b\\w/g, l => l.toUpperCase());\r\n    }\r\n  } catch {}\r\n  return 'Unknown Hotel';\r\n}\r\n\r\n// ========================================\r\n// GET PRICE HISTORY\r\n// ========================================\r\n\r\ninterface GetPriceHistoryParams {\r\n  hotelId: string;\r\n  dateFrom: string;\r\n  dateTo: string;\r\n}\r\n\r\ninterface PriceHistoryEntry {\r\n  date: string;\r\n  price: number;\r\n  currency: string;\r\n  availability: 'available' | 'limited' | 'sold_out';\r\n  source: string;\r\n}\r\n\r\ninterface PriceHistoryResult {\r\n  hotelId: string;\r\n  hotelName: string;\r\n  dateRange: {\r\n    from: string;\r\n    to: string;\r\n  };\r\n  history: PriceHistoryEntry[];\r\n  statistics: {\r\n    minPrice: number;\r\n    maxPrice: number;\r\n    avgPrice: number;\r\n    currentPrice: number;\r\n    priceChange: number;\r\n    priceChangePercent: number;\r\n  };\r\n}\r\n\r\nexport async function getPriceHistory(\r\n  params: GetPriceHistoryParams,\r\n  context: ConversationContext\r\n): Promise<PriceHistoryResult> {\r\n  console.log(`[MonitoringHandler] Getting price history for hotel:`, params.hotelId);\r\n\r\n  try {\r\n    // Generate mock historical data\r\n    const startDate = new Date(params.dateFrom);\r\n    const endDate = new Date(params.dateTo);\r\n    const days = Math.ceil((endDate.getTime() - startDate.getTime()) / (1000 * 60 * 60 * 24));\r\n\r\n    const history: PriceHistoryEntry[] = [];\r\n    let basePrice = 250;\r\n\r\n    for (let i = 0; i <= days; i++) {\r\n      const date = new Date(startDate);\r\n      date.setDate(date.getDate() + i);\r\n\r\n      // Simulate price fluctuations\r\n      const fluctuation = (Math.random() - 0.5) * 40;\r\n      const weekendMultiplier = (date.getDay() === 5 || date.getDay() === 6) ? 1.2 : 1;\r\n      const price = Math.round((basePrice + fluctuation) * weekendMultiplier);\r\n\r\n      history.push({\r\n        date: date.toISOString().split('T')[0],\r\n        price,\r\n        currency: 'USD',\r\n        availability: price < 300 ? 'available' : price < 350 ? 'limited' : 'sold_out',\r\n        source: 'booking.com'\r\n      });\r\n    }\r\n\r\n    const prices = history.map(h => h.price);\r\n    const minPrice = Math.min(...prices);\r\n    const maxPrice = Math.max(...prices);\r\n    const avgPrice = Math.round(prices.reduce((a, b) => a + b, 0) / prices.length);\r\n    const currentPrice = prices[prices.length - 1];\r\n    const firstPrice = prices[0];\r\n\r\n    return {\r\n      hotelId: params.hotelId,\r\n      hotelName: 'Sample Hotel Dubai',\r\n      dateRange: {\r\n        from: params.dateFrom,\r\n        to: params.dateTo\r\n      },\r\n      history,\r\n      statistics: {\r\n        minPrice,\r\n        maxPrice,\r\n        avgPrice,\r\n        currentPrice,\r\n        priceChange: currentPrice - firstPrice,\r\n        priceChangePercent: Math.round(((currentPrice - firstPrice) / firstPrice) * 100)\r\n      }\r\n    };\r\n  } catch (error: any) {\r\n    console.error(`[MonitoringHandler] Price history error:`, error);\r\n    throw new Error(`Failed to get price history: ${error.message}`);\r\n  }\r\n}\r\n\r\n// ========================================\r\n// ANALYZE PRICE TRENDS\r\n// ========================================\r\n\r\ninterface AnalyzePriceTrendsParams {\r\n  hotelId: string;\r\n  travelDates: {\r\n    from: string;\r\n    to: string;\r\n  };\r\n}\r\n\r\ninterface TrendAnalysisResult {\r\n  hotelId: string;\r\n  hotelName: string;\r\n  travelDates: {\r\n    from: string;\r\n    to: string;\r\n  };\r\n  currentTrend: 'rising' | 'falling' | 'stable';\r\n  trendStrength: number; // 0-100\r\n  prediction: {\r\n    direction: 'up' | 'down' | 'stable';\r\n    confidence: number;\r\n    expectedChange: number;\r\n    optimalBookingWindow: {\r\n      from: string;\r\n      to: string;\r\n    };\r\n  };\r\n  insights: string[];\r\n  recommendations: string[];\r\n  competitorComparison?: {\r\n    hotelName: string;\r\n    priceDifference: number;\r\n    rating: number;\r\n  }[];\r\n}\r\n\r\nexport async function analyzePriceTrends(\r\n  params: AnalyzePriceTrendsParams,\r\n  context: ConversationContext\r\n): Promise<TrendAnalysisResult> {\r\n  console.log(`[MonitoringHandler] Analyzing price trends for:`, params.hotelId);\r\n\r\n  try {\r\n    // Calculate days until travel\r\n    const travelDate = new Date(params.travelDates.from);\r\n    const daysUntilTravel = Math.ceil((travelDate.getTime() - Date.now()) / (1000 * 60 * 60 * 24));\r\n\r\n    // Determine trend based on various factors (mocked)\r\n    const trends = ['rising', 'falling', 'stable'] as const;\r\n    const currentTrend = trends[Math.floor(Math.random() * 3)];\r\n    const trendStrength = Math.floor(Math.random() * 60) + 20;\r\n\r\n    // Generate insights based on analysis\r\n    const insights: string[] = [];\r\n    const recommendations: string[] = [];\r\n\r\n    if (currentTrend === 'falling') {\r\n      insights.push('Prices have dropped 12% over the past 2 weeks');\r\n      insights.push('Historically, prices for these dates bottom out 3 weeks before check-in');\r\n      recommendations.push('Wait 1-2 more weeks before booking to catch the lowest price');\r\n    } else if (currentTrend === 'rising') {\r\n      insights.push('Prices have increased 8% in the last week');\r\n      insights.push('There\\'s an event in the area driving up demand');\r\n      recommendations.push('Book soon to lock in current prices');\r\n      recommendations.push('Consider flexible dates 1 week earlier for better rates');\r\n    } else {\r\n      insights.push('Prices have remained stable for the past month');\r\n      insights.push('Current price is close to the 90-day average');\r\n      recommendations.push('This is a good time to book - prices are fair');\r\n    }\r\n\r\n    // Add weekend insight\r\n    const dayOfWeek = travelDate.getDay();\r\n    if (dayOfWeek === 5 || dayOfWeek === 6) {\r\n      insights.push('Weekend check-in typically costs 15-20% more');\r\n      recommendations.push('Consider Thursday or Sunday check-in for savings');\r\n    }\r\n\r\n    // Add seasonality insight\r\n    const month = travelDate.getMonth();\r\n    if (month >= 10 || month <= 2) {\r\n      insights.push('This is high season in Dubai - expect premium pricing');\r\n    }\r\n\r\n    return {\r\n      hotelId: params.hotelId,\r\n      hotelName: 'Sample Hotel Dubai',\r\n      travelDates: params.travelDates,\r\n      currentTrend,\r\n      trendStrength,\r\n      prediction: {\r\n        direction: currentTrend === 'rising' ? 'up' : currentTrend === 'falling' ? 'down' : 'stable',\r\n        confidence: trendStrength + 20,\r\n        expectedChange: currentTrend === 'rising' ? 8 : currentTrend === 'falling' ? -10 : 0,\r\n        optimalBookingWindow: {\r\n          from: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],\r\n          to: new Date(Date.now() + 14 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]\r\n        }\r\n      },\r\n      insights,\r\n      recommendations,\r\n      competitorComparison: [\r\n        { hotelName: 'Similar Hotel A', priceDifference: -25, rating: 8.7 },\r\n        { hotelName: 'Similar Hotel B', priceDifference: +40, rating: 9.1 },\r\n        { hotelName: 'Similar Hotel C', priceDifference: -10, rating: 8.5 }\r\n      ]\r\n    };\r\n  } catch (error: any) {\r\n    console.error(`[MonitoringHandler] Trend analysis error:`, error);\r\n    throw new Error(`Failed to analyze price trends: ${error.message}`);\r\n  }\r\n}\r\n\r\n// ========================================\r\n// SCRAPER UTILITIES (Based on hotel-price-monitor)\r\n// ========================================\r\n\r\nexport interface ScraperConfig {\r\n  headless?: boolean;\r\n  proxy?: string;\r\n  userAgent?: string;\r\n  timeout?: number;\r\n}\r\n\r\nexport interface ScrapedPrice {\r\n  hotelName: string;\r\n  roomType: string;\r\n  price: number;\r\n  currency: string;\r\n  originalPrice?: number;\r\n  discount?: number;\r\n  cancellationPolicy: string;\r\n  boardType: string;\r\n  scrapedAt: Date;\r\n}\r\n\r\n/**\r\n * Placeholder for Booking.com scraper\r\n * In production, this would use Playwright to scrape prices\r\n */\r\nexport async function scrapeBookingComPrices(\r\n  url: string,\r\n  checkIn: string,\r\n  checkOut: string,\r\n  config?: ScraperConfig\r\n): Promise<ScrapedPrice[]> {\r\n  console.log(`[MonitoringHandler] Scraping prices from: ${url}`);\r\n\r\n  // In production:\r\n  // const browser = await chromium.launch({ headless: config?.headless ?? true });\r\n  // const page = await browser.newPage();\r\n  // await page.goto(url);\r\n  // ... scraping logic\r\n\r\n  // Mock response\r\n  return [\r\n    {\r\n      hotelName: extractHotelNameFromUrl(url),\r\n      roomType: 'Deluxe Room',\r\n      price: 289,\r\n      currency: 'USD',\r\n      originalPrice: 340,\r\n      discount: 15,\r\n      cancellationPolicy: 'Free cancellation',\r\n      boardType: 'Breakfast included',\r\n      scrapedAt: new Date()\r\n    },\r\n    {\r\n      hotelName: extractHotelNameFromUrl(url),\r\n      roomType: 'Suite',\r\n      price: 489,\r\n      currency: 'USD',\r\n      cancellationPolicy: 'Non-refundable',\r\n      boardType: 'Room only',\r\n      scrapedAt: new Date()\r\n    }\r\n  ];\r\n}\r\n\r\n// Export all handlers\r\nexport const monitoringHandlers = {\r\n  trackHotelPrice,\r\n  getPriceHistory,\r\n  analyzePriceTrends,\r\n  scrapeBookingComPrices\r\n};\r\n","/**\r\n * Voice Handlers\r\n * Tool handlers for voice interaction, call management, and TTS/STT\r\n * Based on: call-center-ai Azure Communication Services integration\r\n */\r\n\r\nimport type { ConversationContext } from '../types';\r\n\r\n// Azure Communication Services config (from environment)\r\nconst ACS_CONNECTION_STRING = process.env.ACS_CONNECTION_STRING || '';\r\nconst ACS_PHONE_NUMBER = process.env.ACS_PHONE_NUMBER || '';\r\nconst AZURE_SPEECH_KEY = process.env.AZURE_SPEECH_KEY || '';\r\nconst AZURE_SPEECH_REGION = process.env.AZURE_SPEECH_REGION || 'westeurope';\r\n\r\n// ========================================\r\n// INITIATE CALL\r\n// ========================================\r\n\r\ninterface InitiateCallParams {\r\n  phoneNumber: string;\r\n  purpose: string;\r\n  language?: string;\r\n}\r\n\r\ninterface CallResult {\r\n  success: boolean;\r\n  callId: string;\r\n  status: 'initiated' | 'ringing' | 'connected' | 'failed';\r\n  fromNumber: string;\r\n  toNumber: string;\r\n  startedAt: Date;\r\n  estimatedDuration?: number;\r\n}\r\n\r\nexport async function initiateCall(\r\n  params: InitiateCallParams,\r\n  context: ConversationContext\r\n): Promise<CallResult> {\r\n  console.log(`[VoiceHandler] Initiating call to ${params.phoneNumber}`);\r\n\r\n  try {\r\n    // Validate phone number format (E.164)\r\n    const phoneRegex = /^\\+[1-9]\\d{1,14}$/;\r\n    if (!phoneRegex.test(params.phoneNumber)) {\r\n      throw new Error('Invalid phone number format. Use E.164 format (e.g., +972501234567)');\r\n    }\r\n\r\n    // In production, use Azure Communication Services\r\n    // const client = new CallAutomationClient(ACS_CONNECTION_STRING);\r\n    // const callConnection = await client.createCall(\r\n    //   { phoneNumber: params.phoneNumber },\r\n    //   { phoneNumber: ACS_PHONE_NUMBER },\r\n    //   'https://your-callback-url/events'\r\n    // );\r\n\r\n    const callId = `call-${Date.now()}-${Math.random().toString(36).substr(2, 8)}`;\r\n\r\n    // Store call context\r\n    if (context) {\r\n      context.metadata = {\r\n        ...context.metadata,\r\n        activeCall: {\r\n          callId,\r\n          phoneNumber: params.phoneNumber,\r\n          purpose: params.purpose,\r\n          language: params.language || 'he-IL',\r\n          startedAt: new Date()\r\n        }\r\n      };\r\n    }\r\n\r\n    return {\r\n      success: true,\r\n      callId,\r\n      status: 'initiated',\r\n      fromNumber: ACS_PHONE_NUMBER || '+972-XX-XXXXXXX',\r\n      toNumber: params.phoneNumber,\r\n      startedAt: new Date()\r\n    };\r\n  } catch (error: any) {\r\n    console.error(`[VoiceHandler] Call initiation error:`, error);\r\n    throw new Error(`Failed to initiate call: ${error.message}`);\r\n  }\r\n}\r\n\r\n// ========================================\r\n// TRANSFER TO HUMAN\r\n// ========================================\r\n\r\ninterface TransferParams {\r\n  reason: string;\r\n  agentQueue?: string;\r\n}\r\n\r\ninterface TransferResult {\r\n  success: boolean;\r\n  transferId: string;\r\n  targetQueue: string;\r\n  estimatedWaitTime: number;\r\n  message: string;\r\n}\r\n\r\nexport async function transferToHuman(\r\n  params: TransferParams,\r\n  context: ConversationContext\r\n): Promise<TransferResult> {\r\n  console.log(`[VoiceHandler] Transferring to human agent:`, params);\r\n\r\n  try {\r\n    // Determine target queue based on reason or specified queue\r\n    const queue = params.agentQueue || determineQueueFromReason(params.reason);\r\n\r\n    // Get estimated wait time (mock)\r\n    const estimatedWait = Math.floor(Math.random() * 5) + 1; // 1-5 minutes\r\n\r\n    const transferId = `xfer-${Date.now()}-${Math.random().toString(36).substr(2, 6)}`;\r\n\r\n    // Update context\r\n    if (context) {\r\n      context.metadata = {\r\n        ...context.metadata,\r\n        transferredToHuman: {\r\n          transferId,\r\n          reason: params.reason,\r\n          queue,\r\n          transferredAt: new Date()\r\n        }\r\n      };\r\n    }\r\n\r\n    return {\r\n      success: true,\r\n      transferId,\r\n      targetQueue: queue,\r\n      estimatedWaitTime: estimatedWait,\r\n      message: `Transferring you to our ${queue} team. Estimated wait time: ${estimatedWait} minutes.`\r\n    };\r\n  } catch (error: any) {\r\n    console.error(`[VoiceHandler] Transfer error:`, error);\r\n    throw new Error(`Transfer failed: ${error.message}`);\r\n  }\r\n}\r\n\r\nfunction determineQueueFromReason(reason: string): string {\r\n  const reasonLower = reason.toLowerCase();\r\n  \r\n  if (reasonLower.includes('billing') || reasonLower.includes('payment') || reasonLower.includes('refund')) {\r\n    return 'billing-support';\r\n  }\r\n  if (reasonLower.includes('cancel') || reasonLower.includes('modify') || reasonLower.includes('change')) {\r\n    return 'booking-modifications';\r\n  }\r\n  if (reasonLower.includes('complaint') || reasonLower.includes('problem') || reasonLower.includes('issue')) {\r\n    return 'customer-care';\r\n  }\r\n  if (reasonLower.includes('group') || reasonLower.includes('corporate') || reasonLower.includes('business')) {\r\n    return 'corporate-sales';\r\n  }\r\n  \r\n  return 'general-support';\r\n}\r\n\r\n// ========================================\r\n// SEND CALL SUMMARY SMS\r\n// ========================================\r\n\r\ninterface SendCallSummarySmsParams {\r\n  phoneNumber: string;\r\n  summary: string;\r\n}\r\n\r\ninterface SmsResult {\r\n  success: boolean;\r\n  messageId: string;\r\n  to: string;\r\n  status: 'sent' | 'delivered' | 'failed';\r\n  sentAt: Date;\r\n}\r\n\r\nexport async function sendCallSummarySms(\r\n  params: SendCallSummarySmsParams,\r\n  context: ConversationContext\r\n): Promise<SmsResult> {\r\n  console.log(`[VoiceHandler] Sending call summary SMS to ${params.phoneNumber}`);\r\n\r\n  try {\r\n    // Validate phone number\r\n    const phoneRegex = /^\\+[1-9]\\d{1,14}$/;\r\n    if (!phoneRegex.test(params.phoneNumber)) {\r\n      throw new Error('Invalid phone number format');\r\n    }\r\n\r\n    // Truncate summary if too long for SMS\r\n    const maxLength = 160 * 3; // Allow up to 3 SMS segments\r\n    const truncatedSummary = params.summary.length > maxLength\r\n      ? params.summary.substring(0, maxLength - 3) + '...'\r\n      : params.summary;\r\n\r\n    // In production, use Azure Communication Services SMS\r\n    // const client = new SmsClient(ACS_CONNECTION_STRING);\r\n    // const response = await client.send({\r\n    //   from: ACS_PHONE_NUMBER,\r\n    //   to: [params.phoneNumber],\r\n    //   message: truncatedSummary\r\n    // });\r\n\r\n    const messageId = `sms-${Date.now()}-${Math.random().toString(36).substr(2, 8)}`;\r\n\r\n    return {\r\n      success: true,\r\n      messageId,\r\n      to: params.phoneNumber,\r\n      status: 'sent',\r\n      sentAt: new Date()\r\n    };\r\n  } catch (error: any) {\r\n    console.error(`[VoiceHandler] SMS error:`, error);\r\n    throw new Error(`Failed to send SMS: ${error.message}`);\r\n  }\r\n}\r\n\r\n// ========================================\r\n// TEXT TO SPEECH\r\n// ========================================\r\n\r\ninterface TextToSpeechParams {\r\n  text: string;\r\n  voice?: string;\r\n  language?: string;\r\n  speed?: number;\r\n  pitch?: number;\r\n}\r\n\r\ninterface TtsResult {\r\n  success: boolean;\r\n  audioUrl?: string;\r\n  audioBase64?: string;\r\n  duration: number;\r\n  format: string;\r\n}\r\n\r\nexport async function textToSpeech(\r\n  params: TextToSpeechParams,\r\n  context: ConversationContext\r\n): Promise<TtsResult> {\r\n  console.log(`[VoiceHandler] Converting text to speech:`, params.text.substring(0, 50));\r\n\r\n  try {\r\n    const voice = params.voice || 'he-IL-HilaNeural';\r\n    const speed = params.speed || 1.0;\r\n\r\n    // In production, use Azure Cognitive Services Speech SDK\r\n    // const speechConfig = sdk.SpeechConfig.fromSubscription(AZURE_SPEECH_KEY, AZURE_SPEECH_REGION);\r\n    // speechConfig.speechSynthesisVoiceName = voice;\r\n    // const synthesizer = new sdk.SpeechSynthesizer(speechConfig);\r\n    // const result = await synthesizer.speakTextAsync(params.text);\r\n\r\n    // Mock response\r\n    const estimatedDuration = params.text.split(' ').length * 0.4; // ~0.4 seconds per word\r\n\r\n    return {\r\n      success: true,\r\n      audioUrl: `/api/tts/audio-${Date.now()}.mp3`,\r\n      duration: estimatedDuration,\r\n      format: 'audio/mpeg'\r\n    };\r\n  } catch (error: any) {\r\n    console.error(`[VoiceHandler] TTS error:`, error);\r\n    throw new Error(`Text-to-speech failed: ${error.message}`);\r\n  }\r\n}\r\n\r\n// ========================================\r\n// SPEECH TO TEXT\r\n// ========================================\r\n\r\ninterface SpeechToTextParams {\r\n  audioUrl?: string;\r\n  audioBase64?: string;\r\n  language?: string;\r\n}\r\n\r\ninterface SttResult {\r\n  success: boolean;\r\n  text: string;\r\n  confidence: number;\r\n  language: string;\r\n  duration: number;\r\n  alternatives?: Array<{ text: string; confidence: number }>;\r\n}\r\n\r\nexport async function speechToText(\r\n  params: SpeechToTextParams,\r\n  context: ConversationContext\r\n): Promise<SttResult> {\r\n  console.log(`[VoiceHandler] Converting speech to text`);\r\n\r\n  try {\r\n    const language = params.language || 'he-IL';\r\n\r\n    // In production, use Azure Cognitive Services Speech SDK\r\n    // const speechConfig = sdk.SpeechConfig.fromSubscription(AZURE_SPEECH_KEY, AZURE_SPEECH_REGION);\r\n    // speechConfig.speechRecognitionLanguage = language;\r\n    // const recognizer = new sdk.SpeechRecognizer(speechConfig, audioConfig);\r\n    // const result = await recognizer.recognizeOnceAsync();\r\n\r\n    // Mock response\r\n    return {\r\n      success: true,\r\n      text: 'אני רוצה להזמין חדר במלון בדובאי לשלושה לילות',\r\n      confidence: 0.95,\r\n      language,\r\n      duration: 3.2,\r\n      alternatives: [\r\n        { text: 'אני רוצה להזמין חדר במלון בדובאי לשלושה לילות', confidence: 0.95 },\r\n        { text: 'אני רוצה להזמין חדר במלון ב-דובאי ל-3 לילות', confidence: 0.88 }\r\n      ]\r\n    };\r\n  } catch (error: any) {\r\n    console.error(`[VoiceHandler] STT error:`, error);\r\n    throw new Error(`Speech-to-text failed: ${error.message}`);\r\n  }\r\n}\r\n\r\n// ========================================\r\n// VOICE ACTIVITY DETECTION\r\n// ========================================\r\n\r\ninterface VadParams {\r\n  audioChunk: string; // base64\r\n  sensitivity?: number;\r\n}\r\n\r\ninterface VadResult {\r\n  isSpeaking: boolean;\r\n  speechStart?: number;\r\n  speechEnd?: number;\r\n  confidence: number;\r\n}\r\n\r\nexport async function detectVoiceActivity(\r\n  params: VadParams,\r\n  context: ConversationContext\r\n): Promise<VadResult> {\r\n  // In production, use WebRTC VAD or Azure\r\n  const sensitivity = params.sensitivity || 0.5;\r\n\r\n  // Mock response\r\n  return {\r\n    isSpeaking: Math.random() > sensitivity,\r\n    confidence: 0.85 + Math.random() * 0.15\r\n  };\r\n}\r\n\r\n// ========================================\r\n// REAL-TIME AUDIO STREAMING\r\n// ========================================\r\n\r\nexport interface RealtimeStreamConfig {\r\n  callId: string;\r\n  sttLanguage: string;\r\n  ttsVoice: string;\r\n  interimResults: boolean;\r\n  vadSensitivity: number;\r\n  silenceTimeout: number;\r\n}\r\n\r\nexport interface RealtimeCallbacks {\r\n  onSpeechRecognized: (text: string, isFinal: boolean) => void;\r\n  onAudioGenerated: (audio: ArrayBuffer) => void;\r\n  onError: (error: Error) => void;\r\n  onCallEnded: (reason: string) => void;\r\n}\r\n\r\nexport function createRealtimeAudioStream(\r\n  config: RealtimeStreamConfig,\r\n  callbacks: RealtimeCallbacks\r\n): {\r\n  start: () => Promise<void>;\r\n  stop: () => Promise<void>;\r\n  sendAudio: (chunk: ArrayBuffer) => void;\r\n  sendResponse: (text: string) => Promise<void>;\r\n} {\r\n  let isRunning = false;\r\n\r\n  return {\r\n    async start() {\r\n      console.log(`[VoiceHandler] Starting realtime audio stream for call ${config.callId}`);\r\n      isRunning = true;\r\n      \r\n      // In production:\r\n      // 1. Open WebSocket connection to Azure Communication Services\r\n      // 2. Configure Speech SDK for continuous recognition\r\n      // 3. Set up audio streaming pipeline\r\n    },\r\n\r\n    async stop() {\r\n      console.log(`[VoiceHandler] Stopping realtime audio stream`);\r\n      isRunning = false;\r\n      callbacks.onCallEnded('stream_stopped');\r\n    },\r\n\r\n    sendAudio(chunk: ArrayBuffer) {\r\n      if (!isRunning) return;\r\n      // Send audio chunk to Speech SDK for recognition\r\n    },\r\n\r\n    async sendResponse(text: string) {\r\n      if (!isRunning) return;\r\n      \r\n      // Convert text to speech and play to caller\r\n      const ttsResult = await textToSpeech(\r\n        { text, voice: config.ttsVoice },\r\n        {} as ConversationContext\r\n      );\r\n      \r\n      // In production, stream audio to call\r\n      console.log(`[VoiceHandler] Playing TTS response: ${text.substring(0, 50)}...`);\r\n    }\r\n  };\r\n}\r\n\r\n// Export all handlers\r\nexport const voiceHandlers = {\r\n  initiateCall,\r\n  transferToHuman,\r\n  sendCallSummarySms,\r\n  textToSpeech,\r\n  speechToText,\r\n  detectVoiceActivity,\r\n  createRealtimeAudioStream\r\n};\r\n","/**\r\n * Refund Handler\r\n * Stripe integration for processing refunds and cancellations\r\n */\r\n\r\nimport Stripe from \"stripe\"\r\n\r\n// Initialize Stripe\r\nconst stripe = new Stripe(process.env.STRIPE_SECRET_KEY || \"\", {\r\n  apiVersion: \"2025-11-17.clover\",\r\n})\r\n\r\n// Types\r\nexport interface RefundContext {\r\n  userId?: string\r\n  sessionId?: string\r\n  isAdmin?: boolean\r\n}\r\n\r\nexport interface RefundResult {\r\n  success: boolean\r\n  refundId?: string\r\n  amount?: number\r\n  currency?: string\r\n  status?: string\r\n  error?: string\r\n}\r\n\r\nexport interface CancellationPolicy {\r\n  bookingId: string\r\n  isRefundable: boolean\r\n  cancellationDeadline: Date | null\r\n  refundPercentage: number\r\n  refundAmount: number\r\n  penaltyAmount: number\r\n  currency: string\r\n  policyDescription: string\r\n  policyDescriptionHe: string\r\n}\r\n\r\n/**\r\n * Calculate refund amount based on cancellation policy\r\n */\r\nexport async function calculateRefundAmount(\r\n  params: {\r\n    bookingId: string\r\n    paymentIntentId: string\r\n    cancellationDate?: Date\r\n  },\r\n  context?: RefundContext\r\n): Promise<CancellationPolicy> {\r\n  console.log(\"[Refund] Calculating refund amount\", { bookingId: params.bookingId })\r\n\r\n  try {\r\n    // Get original payment\r\n    const paymentIntent = await stripe.paymentIntents.retrieve(params.paymentIntentId)\r\n    const originalAmount = paymentIntent.amount\r\n    const currency = paymentIntent.currency\r\n\r\n    // Get booking metadata to determine policy\r\n    const checkInDate = paymentIntent.metadata.checkIn \r\n      ? new Date(paymentIntent.metadata.checkIn) \r\n      : new Date(Date.now() + 7 * 24 * 60 * 60 * 1000) // Default: 7 days from now\r\n\r\n    const cancellationDate = params.cancellationDate || new Date()\r\n    const daysUntilCheckIn = Math.floor((checkInDate.getTime() - cancellationDate.getTime()) / (1000 * 60 * 60 * 24))\r\n\r\n    // Cancellation policy logic\r\n    let refundPercentage = 0\r\n    let policyDescription = \"\"\r\n    let policyDescriptionHe = \"\"\r\n\r\n    if (daysUntilCheckIn >= 7) {\r\n      // Full refund if cancelled 7+ days before\r\n      refundPercentage = 100\r\n      policyDescription = \"Full refund - cancelled more than 7 days before check-in\"\r\n      policyDescriptionHe = \"החזר מלא - ביטול יותר מ-7 ימים לפני הצ'ק-אין\"\r\n    } else if (daysUntilCheckIn >= 3) {\r\n      // 50% refund if cancelled 3-7 days before\r\n      refundPercentage = 50\r\n      policyDescription = \"50% refund - cancelled 3-7 days before check-in\"\r\n      policyDescriptionHe = \"החזר של 50% - ביטול 3-7 ימים לפני הצ'ק-אין\"\r\n    } else if (daysUntilCheckIn >= 1) {\r\n      // 25% refund if cancelled 1-3 days before\r\n      refundPercentage = 25\r\n      policyDescription = \"25% refund - cancelled 1-3 days before check-in\"\r\n      policyDescriptionHe = \"החזר של 25% - ביטול 1-3 ימים לפני הצ'ק-אין\"\r\n    } else {\r\n      // No refund if cancelled on check-in day or after\r\n      refundPercentage = 0\r\n      policyDescription = \"No refund - cancelled on or after check-in day\"\r\n      policyDescriptionHe = \"אין החזר - ביטול ביום הצ'ק-אין או אחריו\"\r\n    }\r\n\r\n    const refundAmount = Math.floor(originalAmount * refundPercentage / 100)\r\n    const penaltyAmount = originalAmount - refundAmount\r\n\r\n    return {\r\n      bookingId: params.bookingId,\r\n      isRefundable: refundPercentage > 0,\r\n      cancellationDeadline: new Date(checkInDate.getTime() - 7 * 24 * 60 * 60 * 1000),\r\n      refundPercentage,\r\n      refundAmount,\r\n      penaltyAmount,\r\n      currency,\r\n      policyDescription,\r\n      policyDescriptionHe,\r\n    }\r\n  } catch (error: any) {\r\n    console.error(\"[Refund] Failed to calculate refund\", error.message)\r\n    throw new Error(`Failed to calculate refund: ${error.message}`)\r\n  }\r\n}\r\n\r\n/**\r\n * Process a full refund\r\n */\r\nexport async function processRefund(\r\n  params: {\r\n    paymentIntentId: string\r\n    bookingId: string\r\n    reason?: string\r\n  },\r\n  context?: RefundContext\r\n): Promise<RefundResult> {\r\n  console.log(\"[Refund] Processing full refund\", { paymentIntentId: params.paymentIntentId })\r\n\r\n  try {\r\n    // Get payment intent to find the charge\r\n    const paymentIntent = await stripe.paymentIntents.retrieve(params.paymentIntentId, {\r\n      expand: [\"latest_charge\"],\r\n    })\r\n\r\n    if (paymentIntent.status !== \"succeeded\") {\r\n      return {\r\n        success: false,\r\n        error: \"Payment has not been completed, cannot refund\",\r\n      }\r\n    }\r\n\r\n    const charge = paymentIntent.latest_charge as Stripe.Charge\r\n    if (!charge) {\r\n      return {\r\n        success: false,\r\n        error: \"No charge found for this payment\",\r\n      }\r\n    }\r\n\r\n    // Create refund\r\n    const refund = await stripe.refunds.create({\r\n      charge: charge.id,\r\n      reason: \"requested_by_customer\",\r\n      metadata: {\r\n        bookingId: params.bookingId,\r\n        originalPaymentIntent: params.paymentIntentId,\r\n        reason: params.reason || \"Customer requested cancellation\",\r\n      },\r\n    })\r\n\r\n    console.log(\"[Refund] Refund processed\", { refundId: refund.id, amount: refund.amount })\r\n\r\n    return {\r\n      success: refund.status === \"succeeded\" || refund.status === \"pending\",\r\n      refundId: refund.id,\r\n      amount: refund.amount,\r\n      currency: refund.currency,\r\n      status: refund.status || \"unknown\",\r\n    }\r\n  } catch (error: any) {\r\n    console.error(\"[Refund] Refund processing failed\", error.message)\r\n    return {\r\n      success: false,\r\n      error: error.message,\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Process a partial refund\r\n */\r\nexport async function processPartialRefund(\r\n  params: {\r\n    paymentIntentId: string\r\n    bookingId: string\r\n    amount: number\r\n    reason?: string\r\n  },\r\n  context?: RefundContext\r\n): Promise<RefundResult> {\r\n  console.log(\"[Refund] Processing partial refund\", { \r\n    paymentIntentId: params.paymentIntentId, \r\n    amount: params.amount \r\n  })\r\n\r\n  try {\r\n    // Get payment intent to find the charge\r\n    const paymentIntent = await stripe.paymentIntents.retrieve(params.paymentIntentId, {\r\n      expand: [\"latest_charge\"],\r\n    })\r\n\r\n    if (paymentIntent.status !== \"succeeded\") {\r\n      return {\r\n        success: false,\r\n        error: \"Payment has not been completed, cannot refund\",\r\n      }\r\n    }\r\n\r\n    const charge = paymentIntent.latest_charge as Stripe.Charge\r\n    if (!charge) {\r\n      return {\r\n        success: false,\r\n        error: \"No charge found for this payment\",\r\n      }\r\n    }\r\n\r\n    // Validate amount\r\n    if (params.amount > charge.amount) {\r\n      return {\r\n        success: false,\r\n        error: `Refund amount (${params.amount}) exceeds original charge (${charge.amount})`,\r\n      }\r\n    }\r\n\r\n    // Create partial refund\r\n    const refund = await stripe.refunds.create({\r\n      charge: charge.id,\r\n      amount: params.amount,\r\n      reason: \"requested_by_customer\",\r\n      metadata: {\r\n        bookingId: params.bookingId,\r\n        originalPaymentIntent: params.paymentIntentId,\r\n        reason: params.reason || \"Partial refund requested\",\r\n        isPartial: \"true\",\r\n      },\r\n    })\r\n\r\n    console.log(\"[Refund] Partial refund processed\", { refundId: refund.id, amount: refund.amount })\r\n\r\n    return {\r\n      success: refund.status === \"succeeded\" || refund.status === \"pending\",\r\n      refundId: refund.id,\r\n      amount: refund.amount,\r\n      currency: refund.currency,\r\n      status: refund.status || \"unknown\",\r\n    }\r\n  } catch (error: any) {\r\n    console.error(\"[Refund] Partial refund failed\", error.message)\r\n    return {\r\n      success: false,\r\n      error: error.message,\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Get refund status\r\n */\r\nexport async function getRefundStatus(\r\n  params: { refundId: string },\r\n  context?: RefundContext\r\n): Promise<{\r\n  id: string\r\n  status: string\r\n  amount: number\r\n  currency: string\r\n  created: Date\r\n  bookingId?: string\r\n  reason?: string\r\n}> {\r\n  try {\r\n    const refund = await stripe.refunds.retrieve(params.refundId)\r\n\r\n    return {\r\n      id: refund.id,\r\n      status: refund.status || \"unknown\",\r\n      amount: refund.amount,\r\n      currency: refund.currency,\r\n      created: new Date(refund.created * 1000),\r\n      bookingId: refund.metadata?.bookingId,\r\n      reason: refund.metadata?.reason,\r\n    }\r\n  } catch (error: any) {\r\n    console.error(\"[Refund] Failed to get refund status\", error.message)\r\n    throw error\r\n  }\r\n}\r\n\r\n/**\r\n * List refunds for a booking\r\n */\r\nexport async function getBookingRefunds(\r\n  params: { bookingId: string },\r\n  context?: RefundContext\r\n): Promise<RefundResult[]> {\r\n  try {\r\n    // Search for refunds by booking ID in metadata\r\n    const refunds = await stripe.refunds.list({\r\n      limit: 100,\r\n    })\r\n\r\n    // Filter by booking ID (Stripe doesn't support metadata search on refunds)\r\n    const bookingRefunds = refunds.data.filter(\r\n      refund => refund.metadata?.bookingId === params.bookingId\r\n    )\r\n\r\n    return bookingRefunds.map(refund => ({\r\n      success: refund.status === \"succeeded\",\r\n      refundId: refund.id,\r\n      amount: refund.amount,\r\n      currency: refund.currency,\r\n      status: refund.status || \"unknown\",\r\n    }))\r\n  } catch (error: any) {\r\n    console.error(\"[Refund] Failed to get booking refunds\", error.message)\r\n    return []\r\n  }\r\n}\r\n\r\n/**\r\n * Auto-refund based on cancellation policy\r\n */\r\nexport async function autoRefundWithPolicy(\r\n  params: {\r\n    bookingId: string\r\n    paymentIntentId: string\r\n    reason?: string\r\n  },\r\n  context?: RefundContext\r\n): Promise<RefundResult & { policy: CancellationPolicy }> {\r\n  console.log(\"[Refund] Auto-refund with policy\", { bookingId: params.bookingId })\r\n\r\n  try {\r\n    // Calculate refund amount based on policy\r\n    const policy = await calculateRefundAmount({\r\n      bookingId: params.bookingId,\r\n      paymentIntentId: params.paymentIntentId,\r\n    }, context)\r\n\r\n    if (!policy.isRefundable) {\r\n      return {\r\n        success: false,\r\n        error: policy.policyDescription,\r\n        policy,\r\n      }\r\n    }\r\n\r\n    // Process the refund\r\n    const result = await processPartialRefund({\r\n      paymentIntentId: params.paymentIntentId,\r\n      bookingId: params.bookingId,\r\n      amount: policy.refundAmount,\r\n      reason: params.reason || policy.policyDescription,\r\n    }, context)\r\n\r\n    return {\r\n      ...result,\r\n      policy,\r\n    }\r\n  } catch (error: any) {\r\n    console.error(\"[Refund] Auto-refund failed\", error.message)\r\n    throw error\r\n  }\r\n}\r\n\r\n// Export handlers map for registry\r\nexport const refundHandlers = {\r\n  calculateRefundAmount,\r\n  processRefund,\r\n  processPartialRefund,\r\n  getRefundStatus,\r\n  getBookingRefunds,\r\n  autoRefundWithPolicy,\r\n}\r\n","/**\r\n * WhatsApp Bot Handler\r\n * WhatsApp Business API integration for booking notifications and support\r\n */\r\n\r\n// Types\r\nexport interface WhatsAppContext {\r\n  userId?: string\r\n  sessionId?: string\r\n  locale?: \"en\" | \"he\"\r\n}\r\n\r\nexport interface WhatsAppMessage {\r\n  messageId: string\r\n  from: string\r\n  to: string\r\n  type: \"text\" | \"template\" | \"image\" | \"document\" | \"interactive\"\r\n  content: string | WhatsAppTemplate | WhatsAppInteractive\r\n  timestamp: Date\r\n  status: \"sent\" | \"delivered\" | \"read\" | \"failed\"\r\n}\r\n\r\nexport interface WhatsAppTemplate {\r\n  name: string\r\n  language: string\r\n  components: {\r\n    type: \"header\" | \"body\" | \"button\"\r\n    parameters: { type: string; text?: string; image?: { link: string } }[]\r\n  }[]\r\n}\r\n\r\nexport interface WhatsAppInteractive {\r\n  type: \"button\" | \"list\"\r\n  header?: { type: \"text\"; text: string }\r\n  body: { text: string }\r\n  footer?: { text: string }\r\n  action: {\r\n    buttons?: { type: \"reply\"; reply: { id: string; title: string } }[]\r\n    sections?: { title: string; rows: { id: string; title: string; description?: string }[] }[]\r\n  }\r\n}\r\n\r\nexport interface WhatsAppConversation {\r\n  conversationId: string\r\n  customerPhone: string\r\n  customerName?: string\r\n  bookingId?: string\r\n  status: \"active\" | \"resolved\" | \"pending_human\"\r\n  messages: WhatsAppMessage[]\r\n  createdAt: Date\r\n  updatedAt: Date\r\n  assignedTo?: string\r\n}\r\n\r\n// Message templates\r\nconst MESSAGE_TEMPLATES = {\r\n  bookingConfirmation: {\r\n    name: \"booking_confirmation\",\r\n    languages: [\"en\", \"he\"],\r\n  },\r\n  checkInReminder: {\r\n    name: \"checkin_reminder\",\r\n    languages: [\"en\", \"he\"],\r\n  },\r\n  paymentReceipt: {\r\n    name: \"payment_receipt\",\r\n    languages: [\"en\", \"he\"],\r\n  },\r\n  cancellationConfirmation: {\r\n    name: \"cancellation_confirmation\",\r\n    languages: [\"en\", \"he\"],\r\n  },\r\n}\r\n\r\n// In-memory conversation store\r\nconst conversations: Map<string, WhatsAppConversation> = new Map()\r\n\r\n/**\r\n * Send WhatsApp message\r\n */\r\nexport async function sendWhatsAppMessage(\r\n  params: {\r\n    to: string\r\n    type: \"text\" | \"template\" | \"interactive\"\r\n    content: string | WhatsAppTemplate | WhatsAppInteractive\r\n  },\r\n  context?: WhatsAppContext\r\n): Promise<{ success: boolean; messageId?: string; error?: string }> {\r\n  console.log(\"[WhatsApp] Sending message\", { to: params.to, type: params.type })\r\n\r\n  // Validate phone number\r\n  const phone = params.to.replace(/\\D/g, \"\")\r\n  if (phone.length < 10) {\r\n    return { success: false, error: \"Invalid phone number\" }\r\n  }\r\n\r\n  // In production, would call WhatsApp Business API\r\n  // const response = await fetch(`https://graph.facebook.com/v17.0/${PHONE_ID}/messages`, {\r\n  //   method: 'POST',\r\n  //   headers: { 'Authorization': `Bearer ${WHATSAPP_TOKEN}`, 'Content-Type': 'application/json' },\r\n  //   body: JSON.stringify({ messaging_product: 'whatsapp', to: phone, type: params.type, ... })\r\n  // })\r\n\r\n  const message: WhatsAppMessage = {\r\n    messageId: `msg_${Date.now()}_${Math.random().toString(36).substring(2, 8)}`,\r\n    from: process.env.WHATSAPP_PHONE_ID || \"BUSINESS\",\r\n    to: phone,\r\n    type: params.type,\r\n    content: params.content,\r\n    timestamp: new Date(),\r\n    status: \"sent\",\r\n  }\r\n\r\n  console.log(\"[WhatsApp] Message sent\", { messageId: message.messageId })\r\n\r\n  return { success: true, messageId: message.messageId }\r\n}\r\n\r\n/**\r\n * Send booking confirmation via WhatsApp\r\n */\r\nexport async function sendBookingConfirmation(\r\n  params: {\r\n    phone: string\r\n    customerName: string\r\n    bookingId: string\r\n    hotelName: string\r\n    checkIn: string | Date\r\n    checkOut: string | Date\r\n    confirmationNumber: string\r\n  },\r\n  context?: WhatsAppContext\r\n): Promise<{ success: boolean; messageId?: string; error?: string }> {\r\n  console.log(\"[WhatsApp] Sending booking confirmation\", { bookingId: params.bookingId })\r\n\r\n  const locale = context?.locale || \"en\"\r\n  const checkIn = new Date(params.checkIn)\r\n  const checkOut = new Date(params.checkOut)\r\n\r\n  const messageText = locale === \"he\"\r\n    ? `שלום ${params.customerName}! 🎉\r\n\r\nההזמנה שלך אושרה!\r\n\r\n🏨 ${params.hotelName}\r\n📅 צ'ק-אין: ${checkIn.toLocaleDateString(\"he-IL\")}\r\n📅 צ'ק-אאוט: ${checkOut.toLocaleDateString(\"he-IL\")}\r\n🔢 מספר אישור: ${params.confirmationNumber}\r\n\r\nתודה שהזמנת דרכנו!`\r\n    : `Hello ${params.customerName}! 🎉\r\n\r\nYour booking is confirmed!\r\n\r\n🏨 ${params.hotelName}\r\n📅 Check-in: ${checkIn.toLocaleDateString(\"en-US\")}\r\n📅 Check-out: ${checkOut.toLocaleDateString(\"en-US\")}\r\n🔢 Confirmation: ${params.confirmationNumber}\r\n\r\nThank you for booking with us!`\r\n\r\n  return sendWhatsAppMessage({\r\n    to: params.phone,\r\n    type: \"text\",\r\n    content: messageText,\r\n  }, context)\r\n}\r\n\r\n/**\r\n * Send check-in reminder\r\n */\r\nexport async function sendCheckInReminder(\r\n  params: {\r\n    phone: string\r\n    customerName: string\r\n    hotelName: string\r\n    hotelAddress: string\r\n    checkIn: string | Date\r\n    confirmationNumber: string\r\n  },\r\n  context?: WhatsAppContext\r\n): Promise<{ success: boolean; messageId?: string; error?: string }> {\r\n  console.log(\"[WhatsApp] Sending check-in reminder\")\r\n\r\n  const locale = context?.locale || \"en\"\r\n  const checkIn = new Date(params.checkIn)\r\n\r\n  const messageText = locale === \"he\"\r\n    ? `שלום ${params.customerName}! ⏰\r\n\r\nתזכורת: הצ'ק-אין שלך מחר!\r\n\r\n🏨 ${params.hotelName}\r\n📍 ${params.hotelAddress}\r\n📅 ${checkIn.toLocaleDateString(\"he-IL\")}\r\n🔢 מספר אישור: ${params.confirmationNumber}\r\n\r\nנסיעה טובה! 🚗`\r\n    : `Hello ${params.customerName}! ⏰\r\n\r\nReminder: Your check-in is tomorrow!\r\n\r\n🏨 ${params.hotelName}\r\n📍 ${params.hotelAddress}\r\n📅 ${checkIn.toLocaleDateString(\"en-US\")}\r\n🔢 Confirmation: ${params.confirmationNumber}\r\n\r\nSafe travels! 🚗`\r\n\r\n  return sendWhatsAppMessage({\r\n    to: params.phone,\r\n    type: \"text\",\r\n    content: messageText,\r\n  }, context)\r\n}\r\n\r\n/**\r\n * Send interactive booking options\r\n */\r\nexport async function sendBookingOptions(\r\n  params: {\r\n    phone: string\r\n    customerName: string\r\n    bookingId: string\r\n  },\r\n  context?: WhatsAppContext\r\n): Promise<{ success: boolean; messageId?: string; error?: string }> {\r\n  console.log(\"[WhatsApp] Sending booking options\")\r\n\r\n  const locale = context?.locale || \"en\"\r\n\r\n  const interactive: WhatsAppInteractive = {\r\n    type: \"button\",\r\n    body: {\r\n      text: locale === \"he\"\r\n        ? `שלום ${params.customerName}, איך אפשר לעזור?`\r\n        : `Hello ${params.customerName}, how can I help you?`,\r\n    },\r\n    action: {\r\n      buttons: [\r\n        {\r\n          type: \"reply\",\r\n          reply: {\r\n            id: `view_booking_${params.bookingId}`,\r\n            title: locale === \"he\" ? \"צפה בהזמנה\" : \"View Booking\",\r\n          },\r\n        },\r\n        {\r\n          type: \"reply\",\r\n          reply: {\r\n            id: `modify_booking_${params.bookingId}`,\r\n            title: locale === \"he\" ? \"שנה הזמנה\" : \"Modify Booking\",\r\n          },\r\n        },\r\n        {\r\n          type: \"reply\",\r\n          reply: {\r\n            id: `contact_support`,\r\n            title: locale === \"he\" ? \"דבר עם נציג\" : \"Contact Support\",\r\n          },\r\n        },\r\n      ],\r\n    },\r\n  }\r\n\r\n  return sendWhatsAppMessage({\r\n    to: params.phone,\r\n    type: \"interactive\",\r\n    content: interactive,\r\n  }, context)\r\n}\r\n\r\n/**\r\n * Handle incoming WhatsApp message\r\n */\r\nexport async function handleIncomingMessage(\r\n  params: {\r\n    from: string\r\n    messageId: string\r\n    type: string\r\n    text?: string\r\n    buttonId?: string\r\n  },\r\n  context?: WhatsAppContext\r\n): Promise<{\r\n  response: string\r\n  action?: string\r\n  requiresHuman?: boolean\r\n}> {\r\n  console.log(\"[WhatsApp] Handling incoming message\", { from: params.from, type: params.type })\r\n\r\n  const phone = params.from.replace(/\\D/g, \"\")\r\n  \r\n  // Find or create conversation\r\n  let conversation = Array.from(conversations.values()).find(c => c.customerPhone === phone && c.status === \"active\")\r\n  \r\n  if (!conversation) {\r\n    conversation = {\r\n      conversationId: `conv_${Date.now()}_${Math.random().toString(36).substring(2, 8)}`,\r\n      customerPhone: phone,\r\n      status: \"active\",\r\n      messages: [],\r\n      createdAt: new Date(),\r\n      updatedAt: new Date(),\r\n    }\r\n    conversations.set(conversation.conversationId, conversation)\r\n  }\r\n\r\n  // Handle button clicks\r\n  if (params.buttonId) {\r\n    if (params.buttonId.startsWith(\"view_booking_\")) {\r\n      const bookingId = params.buttonId.replace(\"view_booking_\", \"\")\r\n      return {\r\n        response: `Here are the details for booking ${bookingId}. I'll send you the full information shortly.`,\r\n        action: \"fetch_booking_details\",\r\n      }\r\n    }\r\n    \r\n    if (params.buttonId.startsWith(\"modify_booking_\")) {\r\n      return {\r\n        response: \"What would you like to change? You can modify dates, room type, or add special requests.\",\r\n        action: \"start_modification\",\r\n      }\r\n    }\r\n    \r\n    if (params.buttonId === \"contact_support\") {\r\n      conversation.status = \"pending_human\"\r\n      conversations.set(conversation.conversationId, conversation)\r\n      return {\r\n        response: \"I'm connecting you with a human agent. Please wait a moment.\",\r\n        action: \"transfer_to_human\",\r\n        requiresHuman: true,\r\n      }\r\n    }\r\n  }\r\n\r\n  // Simple intent detection\r\n  const text = (params.text || \"\").toLowerCase()\r\n  \r\n  if (text.includes(\"book\") || text.includes(\"reserve\") || text.includes(\"הזמ\")) {\r\n    return {\r\n      response: \"I'd be happy to help you make a booking! Where would you like to stay and for what dates?\",\r\n      action: \"start_booking\",\r\n    }\r\n  }\r\n  \r\n  if (text.includes(\"cancel\") || text.includes(\"ביטול\")) {\r\n    return {\r\n      response: \"I can help you cancel your booking. Please provide your confirmation number.\",\r\n      action: \"start_cancellation\",\r\n    }\r\n  }\r\n  \r\n  if (text.includes(\"help\") || text.includes(\"support\") || text.includes(\"עזר\")) {\r\n    return {\r\n      response: \"How can I assist you today? I can help with bookings, modifications, cancellations, or general questions.\",\r\n      action: \"show_help\",\r\n    }\r\n  }\r\n\r\n  // Default response\r\n  return {\r\n    response: \"Thanks for your message! How can I help you today? Reply with 'help' to see available options.\",\r\n    action: \"default\",\r\n  }\r\n}\r\n\r\n/**\r\n * Get conversation history\r\n */\r\nexport async function getConversation(\r\n  params: { conversationId?: string; phone?: string },\r\n  context?: WhatsAppContext\r\n): Promise<WhatsAppConversation | null> {\r\n  if (params.conversationId) {\r\n    return conversations.get(params.conversationId) || null\r\n  }\r\n  \r\n  if (params.phone) {\r\n    const phone = params.phone.replace(/\\D/g, \"\")\r\n    return Array.from(conversations.values()).find(c => c.customerPhone === phone) || null\r\n  }\r\n  \r\n  return null\r\n}\r\n\r\n/**\r\n * Transfer conversation to human agent\r\n */\r\nexport async function transferToHuman(\r\n  params: {\r\n    conversationId: string\r\n    reason: string\r\n    priority?: \"low\" | \"medium\" | \"high\"\r\n  },\r\n  context?: WhatsAppContext\r\n): Promise<{ success: boolean; ticketId?: string }> {\r\n  console.log(\"[WhatsApp] Transferring to human\", { conversationId: params.conversationId })\r\n\r\n  const conversation = conversations.get(params.conversationId)\r\n  if (!conversation) {\r\n    return { success: false }\r\n  }\r\n\r\n  conversation.status = \"pending_human\"\r\n  conversations.set(conversation.conversationId, conversation)\r\n\r\n  // In production, would create support ticket\r\n  const ticketId = `ticket_${Date.now()}`\r\n\r\n  return { success: true, ticketId }\r\n}\r\n\r\n/**\r\n * Send bulk notifications\r\n */\r\nexport async function sendBulkNotification(\r\n  params: {\r\n    phones: string[]\r\n    templateName: string\r\n    templateParams: Record<string, string>\r\n  },\r\n  context?: WhatsAppContext\r\n): Promise<{\r\n  sent: number\r\n  failed: number\r\n  errors: { phone: string; error: string }[]\r\n}> {\r\n  console.log(\"[WhatsApp] Sending bulk notification\", { \r\n    count: params.phones.length, \r\n    template: params.templateName \r\n  })\r\n\r\n  const results = {\r\n    sent: 0,\r\n    failed: 0,\r\n    errors: [] as { phone: string; error: string }[],\r\n  }\r\n\r\n  for (const phone of params.phones) {\r\n    const result = await sendWhatsAppMessage({\r\n      to: phone,\r\n      type: \"text\", // Would use template in production\r\n      content: `Notification: ${params.templateName}`,\r\n    }, context)\r\n\r\n    if (result.success) {\r\n      results.sent++\r\n    } else {\r\n      results.failed++\r\n      results.errors.push({ phone, error: result.error || \"Unknown error\" })\r\n    }\r\n  }\r\n\r\n  return results\r\n}\r\n\r\n/**\r\n * Get WhatsApp analytics\r\n */\r\nexport async function getWhatsAppStats(\r\n  params: { startDate?: Date; endDate?: Date },\r\n  context?: WhatsAppContext\r\n): Promise<{\r\n  totalConversations: number\r\n  activeConversations: number\r\n  messagesReceived: number\r\n  messagesSent: number\r\n  averageResponseTime: number\r\n  humanTransferRate: number\r\n}> {\r\n  const allConversations = Array.from(conversations.values())\r\n  const active = allConversations.filter(c => c.status === \"active\")\r\n  const humanTransfers = allConversations.filter(c => c.status === \"pending_human\")\r\n\r\n  return {\r\n    totalConversations: allConversations.length,\r\n    activeConversations: active.length,\r\n    messagesReceived: allConversations.reduce((sum, c) => sum + c.messages.length, 0),\r\n    messagesSent: allConversations.reduce((sum, c) => sum + c.messages.filter(m => m.from === \"BUSINESS\").length, 0),\r\n    averageResponseTime: 30, // seconds - would calculate from actual data\r\n    humanTransferRate: allConversations.length > 0 \r\n      ? (humanTransfers.length / allConversations.length) * 100 \r\n      : 0,\r\n  }\r\n}\r\n\r\n// Export handlers map for registry\r\nexport const whatsappHandlers = {\r\n  sendWhatsAppMessage,\r\n  sendBookingConfirmation,\r\n  sendCheckInReminder,\r\n  sendBookingOptions,\r\n  handleIncomingMessage,\r\n  getConversation,\r\n  transferToHuman,\r\n  sendBulkNotification,\r\n  getWhatsAppStats,\r\n}\r\n","/**\r\n * Booking Handlers\r\n * Tool handlers for hotel search, prebook, and booking operations\r\n * Based on: ai-travel-agent-platform Medici API integration\r\n */\r\n\r\nimport type { ConversationContext } from '../types';\r\n\r\nconst MEDICI_API_URL = process.env.MEDICI_API_URL || 'https://api.medicihotels.com';\r\nconst MEDICI_API_KEY = process.env.MEDICI_API_KEY || '';\r\n\r\n// ========================================\r\n// HOTEL SEARCH\r\n// ========================================\r\n\r\ninterface SearchHotelsParams {\r\n  destination: string;\r\n  checkIn: string;\r\n  checkOut: string;\r\n  adults: number;\r\n  children?: number[];\r\n  stars?: number[];\r\n  maxPrice?: number;\r\n  amenities?: string[];\r\n}\r\n\r\ninterface HotelSearchResult {\r\n  hotelId: string;\r\n  name: string;\r\n  stars: number;\r\n  address: string;\r\n  imageUrl: string;\r\n  rating: number;\r\n  reviewCount: number;\r\n  rooms: RoomOption[];\r\n  amenities: string[];\r\n  distance?: string;\r\n}\r\n\r\ninterface RoomOption {\r\n  roomCode: string;\r\n  roomName: string;\r\n  boardType: string;\r\n  price: number;\r\n  originalPrice?: number;\r\n  currency: string;\r\n  cancellationPolicy: string;\r\n  maxOccupancy: number;\r\n  available: number;\r\n}\r\n\r\nexport async function searchHotels(\r\n  params: SearchHotelsParams,\r\n  context: ConversationContext\r\n): Promise<{ hotels: HotelSearchResult[]; searchId: string; totalResults: number }> {\r\n  console.log(`[BookingHandler] Searching hotels:`, params);\r\n\r\n  try {\r\n    // Build search request for Medici API\r\n    const searchRequest = {\r\n      destination: params.destination,\r\n      checkIn: params.checkIn,\r\n      checkOut: params.checkOut,\r\n      occupancies: [{\r\n        adults: params.adults,\r\n        children: params.children?.map(age => ({ age })) || []\r\n      }],\r\n      filters: {\r\n        stars: params.stars,\r\n        maxPrice: params.maxPrice,\r\n        amenities: params.amenities\r\n      }\r\n    };\r\n\r\n    // In production, call actual Medici API\r\n    // const response = await fetch(`${MEDICI_API_URL}/search`, {\r\n    //   method: 'POST',\r\n    //   headers: {\r\n    //     'Content-Type': 'application/json',\r\n    //     'Authorization': `Bearer ${MEDICI_API_KEY}`\r\n    //   },\r\n    //   body: JSON.stringify(searchRequest)\r\n    // });\r\n\r\n    // For now, return mock data\r\n    const mockResults: HotelSearchResult[] = [\r\n      {\r\n        hotelId: 'htl-dubai-001',\r\n        name: 'Burj Al Arab Jumeirah',\r\n        stars: 5,\r\n        address: 'Jumeirah Beach Road, Dubai, UAE',\r\n        imageUrl: '/hotels/burj-al-arab.jpg',\r\n        rating: 9.4,\r\n        reviewCount: 12543,\r\n        amenities: ['Spa', 'Pool', 'WiFi', 'Beach Access', 'Restaurant', 'Butler Service'],\r\n        rooms: [\r\n          {\r\n            roomCode: 'room-001',\r\n            roomName: 'Deluxe Suite',\r\n            boardType: 'Breakfast Included',\r\n            price: 2500,\r\n            originalPrice: 2800,\r\n            currency: 'USD',\r\n            cancellationPolicy: 'Free cancellation until 24h before',\r\n            maxOccupancy: 2,\r\n            available: 3\r\n          },\r\n          {\r\n            roomCode: 'room-002',\r\n            roomName: 'Panoramic Suite',\r\n            boardType: 'Half Board',\r\n            price: 3800,\r\n            currency: 'USD',\r\n            cancellationPolicy: 'Non-refundable',\r\n            maxOccupancy: 3,\r\n            available: 1\r\n          }\r\n        ]\r\n      },\r\n      {\r\n        hotelId: 'htl-dubai-002',\r\n        name: 'Atlantis The Palm',\r\n        stars: 5,\r\n        address: 'Crescent Road, The Palm, Dubai, UAE',\r\n        imageUrl: '/hotels/atlantis.jpg',\r\n        rating: 8.9,\r\n        reviewCount: 28912,\r\n        amenities: ['Waterpark', 'Pool', 'WiFi', 'Beach', 'Aquarium', 'Kids Club'],\r\n        rooms: [\r\n          {\r\n            roomCode: 'room-003',\r\n            roomName: 'Palm Beach Room',\r\n            boardType: 'Room Only',\r\n            price: 450,\r\n            originalPrice: 520,\r\n            currency: 'USD',\r\n            cancellationPolicy: 'Free cancellation until 48h before',\r\n            maxOccupancy: 2,\r\n            available: 8\r\n          }\r\n        ]\r\n      },\r\n      {\r\n        hotelId: 'htl-dubai-003',\r\n        name: 'Four Seasons Resort Dubai',\r\n        stars: 5,\r\n        address: 'Jumeirah Beach, Dubai, UAE',\r\n        imageUrl: '/hotels/four-seasons.jpg',\r\n        rating: 9.2,\r\n        reviewCount: 8234,\r\n        amenities: ['Spa', 'Pool', 'WiFi', 'Beach', 'Golf', 'Tennis'],\r\n        rooms: [\r\n          {\r\n            roomCode: 'room-004',\r\n            roomName: 'Premier Room',\r\n            boardType: 'Breakfast Included',\r\n            price: 680,\r\n            currency: 'USD',\r\n            cancellationPolicy: 'Free cancellation until 72h before',\r\n            maxOccupancy: 2,\r\n            available: 5\r\n          }\r\n        ]\r\n      }\r\n    ];\r\n\r\n    // Store search context\r\n    if (context) {\r\n      context.bookingData = {\r\n        ...context.bookingData,\r\n        lastSearch: {\r\n          params,\r\n          timestamp: new Date(),\r\n          results: mockResults.map(h => ({ hotelId: h.hotelId, name: h.name }))\r\n        }\r\n      };\r\n    }\r\n\r\n    return {\r\n      hotels: mockResults,\r\n      searchId: `search-${Date.now()}`,\r\n      totalResults: mockResults.length\r\n    };\r\n  } catch (error: any) {\r\n    console.error(`[BookingHandler] Search error:`, error);\r\n    throw new Error(`Hotel search failed: ${error.message}`);\r\n  }\r\n}\r\n\r\n// ========================================\r\n// PREBOOK ROOM\r\n// ========================================\r\n\r\ninterface PrebookParams {\r\n  roomCode: string;\r\n  hotelId: string;\r\n  checkIn: string;\r\n  checkOut: string;\r\n  guests: {\r\n    adults: number;\r\n    children?: { age: number }[];\r\n  };\r\n}\r\n\r\ninterface PrebookResult {\r\n  success: boolean;\r\n  token: string;\r\n  expiresAt: Date;\r\n  pricing: {\r\n    roomRate: number;\r\n    taxes: number;\r\n    fees: number;\r\n    total: number;\r\n    currency: string;\r\n  };\r\n  cancellationPolicy: {\r\n    freeCancellationUntil?: Date;\r\n    penalties: { from: Date; amount: number }[];\r\n  };\r\n  hotelDetails: {\r\n    hotelId: string;\r\n    name: string;\r\n    roomName: string;\r\n    checkIn: string;\r\n    checkOut: string;\r\n    nights: number;\r\n  };\r\n}\r\n\r\nexport async function prebookRoom(\r\n  params: PrebookParams,\r\n  context: ConversationContext\r\n): Promise<PrebookResult> {\r\n  console.log(`[BookingHandler] Pre-booking room:`, params);\r\n\r\n  try {\r\n    // Calculate nights\r\n    const checkIn = new Date(params.checkIn);\r\n    const checkOut = new Date(params.checkOut);\r\n    const nights = Math.ceil((checkOut.getTime() - checkIn.getTime()) / (1000 * 60 * 60 * 24));\r\n\r\n    // Mock prebook response\r\n    const result: PrebookResult = {\r\n      success: true,\r\n      token: `prebook-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\r\n      expiresAt: new Date(Date.now() + 30 * 60 * 1000), // 30 minutes\r\n      pricing: {\r\n        roomRate: 680 * nights,\r\n        taxes: 68 * nights,\r\n        fees: 25,\r\n        total: (680 + 68) * nights + 25,\r\n        currency: 'USD'\r\n      },\r\n      cancellationPolicy: {\r\n        freeCancellationUntil: new Date(checkIn.getTime() - 72 * 60 * 60 * 1000),\r\n        penalties: [\r\n          { from: new Date(checkIn.getTime() - 72 * 60 * 60 * 1000), amount: 680 },\r\n          { from: new Date(checkIn.getTime() - 24 * 60 * 60 * 1000), amount: 680 * nights }\r\n        ]\r\n      },\r\n      hotelDetails: {\r\n        hotelId: params.hotelId,\r\n        name: 'Four Seasons Resort Dubai',\r\n        roomName: 'Premier Room',\r\n        checkIn: params.checkIn,\r\n        checkOut: params.checkOut,\r\n        nights\r\n      }\r\n    };\r\n\r\n    // Store prebook context\r\n    if (context) {\r\n      context.bookingData = {\r\n        ...context.bookingData,\r\n        prebook: {\r\n          token: result.token,\r\n          expiresAt: result.expiresAt,\r\n          hotelId: params.hotelId,\r\n          roomCode: params.roomCode,\r\n          pricing: result.pricing\r\n        }\r\n      };\r\n    }\r\n\r\n    return result;\r\n  } catch (error: any) {\r\n    console.error(`[BookingHandler] Prebook error:`, error);\r\n    throw new Error(`Pre-booking failed: ${error.message}`);\r\n  }\r\n}\r\n\r\n// ========================================\r\n// BOOK ROOM\r\n// ========================================\r\n\r\ninterface BookRoomParams {\r\n  token: string;\r\n  roomCode: string;\r\n  customer: {\r\n    firstName: string;\r\n    lastName: string;\r\n    email: string;\r\n    phone: string;\r\n    address?: {\r\n      street: string;\r\n      city: string;\r\n      country: string;\r\n      postalCode: string;\r\n    };\r\n  };\r\n  guests: Array<{\r\n    firstName: string;\r\n    lastName: string;\r\n    isLeadGuest?: boolean;\r\n  }>;\r\n  specialRequests?: string;\r\n  paymentMethod?: string;\r\n}\r\n\r\ninterface BookingResult {\r\n  success: boolean;\r\n  bookingId: string;\r\n  confirmationNumber: string;\r\n  status: 'confirmed' | 'pending' | 'failed';\r\n  hotelConfirmation?: string;\r\n  totalPaid: number;\r\n  currency: string;\r\n  bookingDetails: {\r\n    hotelName: string;\r\n    roomName: string;\r\n    checkIn: string;\r\n    checkOut: string;\r\n    guests: string[];\r\n    specialRequests?: string;\r\n  };\r\n  paymentDetails: {\r\n    method: string;\r\n    last4?: string;\r\n    transactionId: string;\r\n  };\r\n  cancellationPolicy: string;\r\n}\r\n\r\nexport async function bookRoom(\r\n  params: BookRoomParams,\r\n  context: ConversationContext\r\n): Promise<BookingResult> {\r\n  console.log(`[BookingHandler] Completing booking:`, params);\r\n\r\n  try {\r\n    // Validate prebook token\r\n    if (!context?.bookingData?.prebook?.token || context.bookingData.prebook.token !== params.token) {\r\n      throw new Error('Invalid or expired prebook token');\r\n    }\r\n\r\n    // Check token expiration\r\n    if (new Date() > new Date(context.bookingData.prebook.expiresAt)) {\r\n      throw new Error('Prebook token has expired. Please search again.');\r\n    }\r\n\r\n    // Generate booking confirmation\r\n    const bookingId = `BK-${Date.now()}-${Math.random().toString(36).substr(2, 6).toUpperCase()}`;\r\n    const confirmationNumber = `CNF-${Math.random().toString(36).substr(2, 8).toUpperCase()}`;\r\n\r\n    const result: BookingResult = {\r\n      success: true,\r\n      bookingId,\r\n      confirmationNumber,\r\n      status: 'confirmed',\r\n      hotelConfirmation: `HC-${Math.random().toString(36).substr(2, 6).toUpperCase()}`,\r\n      totalPaid: context.bookingData.prebook.pricing.total,\r\n      currency: context.bookingData.prebook.pricing.currency,\r\n      bookingDetails: {\r\n        hotelName: 'Four Seasons Resort Dubai',\r\n        roomName: 'Premier Room',\r\n        checkIn: context.bookingData.prebook.checkIn || '2024-03-15',\r\n        checkOut: context.bookingData.prebook.checkOut || '2024-03-18',\r\n        guests: params.guests.map(g => `${g.firstName} ${g.lastName}`),\r\n        specialRequests: params.specialRequests\r\n      },\r\n      paymentDetails: {\r\n        method: params.paymentMethod || 'card',\r\n        last4: '4242',\r\n        transactionId: `txn-${Date.now()}`\r\n      },\r\n      cancellationPolicy: 'Free cancellation until 72 hours before check-in'\r\n    };\r\n\r\n    // Update context with booking result\r\n    if (context) {\r\n      context.bookingData = {\r\n        ...context.bookingData,\r\n        confirmedBooking: {\r\n          bookingId,\r\n          confirmationNumber,\r\n          status: 'confirmed',\r\n          bookedAt: new Date()\r\n        }\r\n      };\r\n    }\r\n\r\n    return result;\r\n  } catch (error: any) {\r\n    console.error(`[BookingHandler] Booking error:`, error);\r\n    throw new Error(`Booking failed: ${error.message}`);\r\n  }\r\n}\r\n\r\n// ========================================\r\n// CANCEL BOOKING\r\n// ========================================\r\n\r\ninterface CancelBookingParams {\r\n  bookingId: string;\r\n  reason?: string;\r\n  force?: boolean;\r\n}\r\n\r\ninterface CancellationResult {\r\n  success: boolean;\r\n  cancellationId: string;\r\n  refundAmount: number;\r\n  refundCurrency: string;\r\n  penaltyApplied: number;\r\n  refundMethod: string;\r\n  refundEta: string;\r\n  message: string;\r\n}\r\n\r\nexport async function cancelBooking(\r\n  params: CancelBookingParams,\r\n  context: ConversationContext\r\n): Promise<CancellationResult> {\r\n  console.log(`[BookingHandler] Cancelling booking:`, params);\r\n\r\n  try {\r\n    // Mock cancellation - check if within free cancellation period\r\n    const isWithinFreePeriod = Math.random() > 0.3; // 70% chance it's within free period\r\n\r\n    const originalAmount = 2244; // Example amount\r\n    const penaltyAmount = isWithinFreePeriod ? 0 : 680;\r\n    const refundAmount = originalAmount - penaltyAmount;\r\n\r\n    const result: CancellationResult = {\r\n      success: true,\r\n      cancellationId: `CAN-${Date.now()}-${Math.random().toString(36).substr(2, 6).toUpperCase()}`,\r\n      refundAmount,\r\n      refundCurrency: 'USD',\r\n      penaltyApplied: penaltyAmount,\r\n      refundMethod: 'Original payment method',\r\n      refundEta: '5-7 business days',\r\n      message: isWithinFreePeriod \r\n        ? 'Your booking has been cancelled with a full refund.'\r\n        : `Your booking has been cancelled. A cancellation fee of $${penaltyAmount} was applied.`\r\n    };\r\n\r\n    return result;\r\n  } catch (error: any) {\r\n    console.error(`[BookingHandler] Cancellation error:`, error);\r\n    throw new Error(`Cancellation failed: ${error.message}`);\r\n  }\r\n}\r\n\r\n// ========================================\r\n// GET CANCELLATION POLICY\r\n// ========================================\r\n\r\ninterface GetCancellationPolicyParams {\r\n  bookingId: string;\r\n}\r\n\r\ninterface CancellationPolicyResult {\r\n  bookingId: string;\r\n  hotelName: string;\r\n  checkIn: string;\r\n  currentStatus: string;\r\n  policy: {\r\n    freeCancellationUntil?: string;\r\n    isWithinFreePeriod: boolean;\r\n    penalties: Array<{\r\n      fromDate: string;\r\n      amount: number;\r\n      currency: string;\r\n      description: string;\r\n    }>;\r\n  };\r\n  recommendation: string;\r\n}\r\n\r\nexport async function getCancellationPolicy(\r\n  params: GetCancellationPolicyParams,\r\n  context: ConversationContext\r\n): Promise<CancellationPolicyResult> {\r\n  console.log(`[BookingHandler] Getting cancellation policy:`, params);\r\n\r\n  const checkIn = new Date('2024-03-15');\r\n  const freeCancellationDate = new Date(checkIn.getTime() - 72 * 60 * 60 * 1000);\r\n  const now = new Date();\r\n  const isWithinFreePeriod = now < freeCancellationDate;\r\n\r\n  return {\r\n    bookingId: params.bookingId,\r\n    hotelName: 'Four Seasons Resort Dubai',\r\n    checkIn: '2024-03-15',\r\n    currentStatus: 'confirmed',\r\n    policy: {\r\n      freeCancellationUntil: freeCancellationDate.toISOString(),\r\n      isWithinFreePeriod,\r\n      penalties: [\r\n        {\r\n          fromDate: freeCancellationDate.toISOString(),\r\n          amount: 680,\r\n          currency: 'USD',\r\n          description: 'First night penalty (72-24 hours before check-in)'\r\n        },\r\n        {\r\n          fromDate: new Date(checkIn.getTime() - 24 * 60 * 60 * 1000).toISOString(),\r\n          amount: 2244,\r\n          currency: 'USD',\r\n          description: 'Full booking amount (less than 24 hours)'\r\n        }\r\n      ]\r\n    },\r\n    recommendation: isWithinFreePeriod\r\n      ? 'You can cancel now for a full refund!'\r\n      : 'Cancellation will incur a penalty. Consider rescheduling instead.'\r\n  };\r\n}\r\n\r\n// Export all handlers\r\nexport const bookingHandlers = {\r\n  searchHotels,\r\n  prebookRoom,\r\n  bookRoom,\r\n  cancelBooking,\r\n  getCancellationPolicy\r\n};\r\n","/**\r\n * Abandoned Cart Recovery Handler\r\n * Track and recover abandoned bookings\r\n */\r\n\r\n// Types\r\nexport interface CartContext {\r\n  userId?: string\r\n  sessionId?: string\r\n  locale?: \"en\" | \"he\"\r\n}\r\n\r\nexport interface AbandonedCart {\r\n  cartId: string\r\n  sessionId: string\r\n  userId?: string\r\n  customerEmail?: string\r\n  customerName?: string\r\n  \r\n  // Booking details\r\n  hotelId: string\r\n  hotelName: string\r\n  roomCode: string\r\n  roomType: string\r\n  checkIn: Date\r\n  checkOut: Date\r\n  guests: number\r\n  totalPrice: number\r\n  currency: string\r\n  \r\n  // Cart state\r\n  stage: \"search\" | \"room_selected\" | \"prebook\" | \"checkout\" | \"payment\"\r\n  createdAt: Date\r\n  updatedAt: Date\r\n  abandonedAt?: Date\r\n  \r\n  // Recovery attempts\r\n  recoveryAttempts: RecoveryAttempt[]\r\n  recovered: boolean\r\n  recoveredAt?: Date\r\n  \r\n  // Metadata\r\n  source?: string\r\n  device?: string\r\n  referrer?: string\r\n}\r\n\r\nexport interface RecoveryAttempt {\r\n  attemptId: string\r\n  type: \"email\" | \"sms\" | \"push\" | \"whatsapp\"\r\n  sentAt: Date\r\n  opened?: boolean\r\n  clicked?: boolean\r\n  converted?: boolean\r\n  discount?: {\r\n    code: string\r\n    percentage: number\r\n    expiresAt: Date\r\n  }\r\n}\r\n\r\nexport interface CartRecoveryStats {\r\n  totalAbandoned: number\r\n  totalRecovered: number\r\n  recoveryRate: number\r\n  revenueRecovered: number\r\n  averageCartValue: number\r\n  topAbandonmentStages: { stage: string; count: number }[]\r\n  recoveryByChannel: { channel: string; recovered: number; rate: number }[]\r\n}\r\n\r\n// In-memory store (would use Supabase in production)\r\nconst abandonedCarts: Map<string, AbandonedCart> = new Map()\r\n\r\n// Recovery email templates\r\nconst RECOVERY_TEMPLATES = {\r\n  initial: {\r\n    subject: \"You left something behind! 🏨\",\r\n    subjectHe: \"שכחת משהו! 🏨\",\r\n    delay: 1 * 60 * 60 * 1000, // 1 hour\r\n  },\r\n  reminder: {\r\n    subject: \"Your room is still available - but not for long!\",\r\n    subjectHe: \"החדר שלך עדיין זמין - אבל לא לאורך זמן!\",\r\n    delay: 24 * 60 * 60 * 1000, // 24 hours\r\n  },\r\n  lastChance: {\r\n    subject: \"Last chance: 10% off your booking\",\r\n    subjectHe: \"הזדמנות אחרונה: 10% הנחה להזמנה שלך\",\r\n    delay: 72 * 60 * 60 * 1000, // 72 hours\r\n    discount: 10,\r\n  },\r\n}\r\n\r\n/**\r\n * Track cart activity (called on each booking step)\r\n */\r\nexport async function trackCartActivity(\r\n  params: {\r\n    sessionId: string\r\n    userId?: string\r\n    customerEmail?: string\r\n    customerName?: string\r\n    stage: AbandonedCart[\"stage\"]\r\n    hotelId: string\r\n    hotelName: string\r\n    roomCode?: string\r\n    roomType?: string\r\n    checkIn: string | Date\r\n    checkOut: string | Date\r\n    guests: number\r\n    totalPrice: number\r\n    currency: string\r\n    source?: string\r\n    device?: string\r\n  },\r\n  context?: CartContext\r\n): Promise<{ cartId: string; isNew: boolean }> {\r\n  console.log(\"[Cart] Tracking activity\", { sessionId: params.sessionId, stage: params.stage })\r\n\r\n  // Find or create cart\r\n  let cart = Array.from(abandonedCarts.values()).find(c => c.sessionId === params.sessionId)\r\n  const isNew = !cart\r\n\r\n  if (!cart) {\r\n    cart = {\r\n      cartId: `cart_${Date.now()}_${Math.random().toString(36).substring(2, 8)}`,\r\n      sessionId: params.sessionId,\r\n      userId: params.userId,\r\n      customerEmail: params.customerEmail,\r\n      customerName: params.customerName,\r\n      hotelId: params.hotelId,\r\n      hotelName: params.hotelName,\r\n      roomCode: params.roomCode || \"\",\r\n      roomType: params.roomType || \"\",\r\n      checkIn: new Date(params.checkIn),\r\n      checkOut: new Date(params.checkOut),\r\n      guests: params.guests,\r\n      totalPrice: params.totalPrice,\r\n      currency: params.currency,\r\n      stage: params.stage,\r\n      createdAt: new Date(),\r\n      updatedAt: new Date(),\r\n      recoveryAttempts: [],\r\n      recovered: false,\r\n      source: params.source,\r\n      device: params.device,\r\n    }\r\n  } else {\r\n    // Update existing cart\r\n    cart.stage = params.stage\r\n    cart.updatedAt = new Date()\r\n    cart.customerEmail = params.customerEmail || cart.customerEmail\r\n    cart.customerName = params.customerName || cart.customerName\r\n    cart.roomCode = params.roomCode || cart.roomCode\r\n    cart.roomType = params.roomType || cart.roomType\r\n    cart.totalPrice = params.totalPrice\r\n  }\r\n\r\n  abandonedCarts.set(cart.cartId, cart)\r\n\r\n  return { cartId: cart.cartId, isNew }\r\n}\r\n\r\n/**\r\n * Mark cart as abandoned (called after inactivity timeout)\r\n */\r\nexport async function markCartAbandoned(\r\n  params: {\r\n    cartId?: string\r\n    sessionId?: string\r\n  },\r\n  context?: CartContext\r\n): Promise<{ success: boolean; cartId?: string }> {\r\n  let cart: AbandonedCart | undefined\r\n\r\n  if (params.cartId) {\r\n    cart = abandonedCarts.get(params.cartId)\r\n  } else if (params.sessionId) {\r\n    cart = Array.from(abandonedCarts.values()).find(c => c.sessionId === params.sessionId)\r\n  }\r\n\r\n  if (!cart) {\r\n    return { success: false }\r\n  }\r\n\r\n  cart.abandonedAt = new Date()\r\n  abandonedCarts.set(cart.cartId, cart)\r\n\r\n  console.log(\"[Cart] Marked as abandoned\", { cartId: cart.cartId, stage: cart.stage })\r\n\r\n  return { success: true, cartId: cart.cartId }\r\n}\r\n\r\n/**\r\n * Get abandoned carts for recovery\r\n */\r\nexport async function getAbandonedCarts(\r\n  params: {\r\n    minAge?: number // Minimum age in minutes\r\n    maxAge?: number // Maximum age in hours\r\n    stage?: AbandonedCart[\"stage\"]\r\n    hasEmail?: boolean\r\n    limit?: number\r\n  },\r\n  context?: CartContext\r\n): Promise<AbandonedCart[]> {\r\n  console.log(\"[Cart] Getting abandoned carts\", params)\r\n\r\n  const now = Date.now()\r\n  const minAgeMs = (params.minAge || 30) * 60 * 1000 // Default 30 minutes\r\n  const maxAgeMs = (params.maxAge || 72) * 60 * 60 * 1000 // Default 72 hours\r\n\r\n  let carts = Array.from(abandonedCarts.values()).filter(cart => {\r\n    // Must be abandoned\r\n    if (!cart.abandonedAt) return false\r\n    \r\n    // Not already recovered\r\n    if (cart.recovered) return false\r\n\r\n    // Age filter\r\n    const age = now - cart.abandonedAt.getTime()\r\n    if (age < minAgeMs || age > maxAgeMs) return false\r\n\r\n    // Stage filter\r\n    if (params.stage && cart.stage !== params.stage) return false\r\n\r\n    // Email filter\r\n    if (params.hasEmail && !cart.customerEmail) return false\r\n\r\n    return true\r\n  })\r\n\r\n  // Sort by most recent\r\n  carts.sort((a, b) => (b.abandonedAt?.getTime() || 0) - (a.abandonedAt?.getTime() || 0))\r\n\r\n  // Limit\r\n  if (params.limit) {\r\n    carts = carts.slice(0, params.limit)\r\n  }\r\n\r\n  return carts\r\n}\r\n\r\n/**\r\n * Send recovery email\r\n */\r\nexport async function sendRecoveryEmail(\r\n  params: {\r\n    cartId: string\r\n    templateType: \"initial\" | \"reminder\" | \"lastChance\"\r\n    customMessage?: string\r\n  },\r\n  context?: CartContext\r\n): Promise<{ success: boolean; attemptId?: string; error?: string }> {\r\n  const cart = abandonedCarts.get(params.cartId)\r\n  if (!cart) {\r\n    return { success: false, error: \"Cart not found\" }\r\n  }\r\n\r\n  if (!cart.customerEmail) {\r\n    return { success: false, error: \"No customer email\" }\r\n  }\r\n\r\n  console.log(\"[Cart] Sending recovery email\", { \r\n    cartId: params.cartId, \r\n    template: params.templateType,\r\n    to: cart.customerEmail \r\n  })\r\n\r\n  const template = RECOVERY_TEMPLATES[params.templateType]\r\n  const locale = context?.locale || \"en\"\r\n\r\n  // Generate discount code for last chance\r\n  let discount: RecoveryAttempt[\"discount\"]\r\n  if (params.templateType === \"lastChance\" && \"discount\" in template) {\r\n    discount = {\r\n      code: `COMEBACK${cart.cartId.slice(-6).toUpperCase()}`,\r\n      percentage: template.discount,\r\n      expiresAt: new Date(Date.now() + 48 * 60 * 60 * 1000), // 48 hours\r\n    }\r\n  }\r\n\r\n  // Create recovery attempt\r\n  const attempt: RecoveryAttempt = {\r\n    attemptId: `attempt_${Date.now()}_${Math.random().toString(36).substring(2, 8)}`,\r\n    type: \"email\",\r\n    sentAt: new Date(),\r\n    discount,\r\n  }\r\n\r\n  // In production, would send actual email via Resend\r\n  // await sendEmail({ to: cart.customerEmail, subject: locale === \"he\" ? template.subjectHe : template.subject, ... })\r\n\r\n  cart.recoveryAttempts.push(attempt)\r\n  abandonedCarts.set(cart.cartId, cart)\r\n\r\n  console.log(\"[Cart] Recovery email sent\", { attemptId: attempt.attemptId })\r\n\r\n  return { success: true, attemptId: attempt.attemptId }\r\n}\r\n\r\n/**\r\n * Mark cart as recovered (when booking completes)\r\n */\r\nexport async function markCartRecovered(\r\n  params: {\r\n    cartId?: string\r\n    sessionId?: string\r\n    bookingId: string\r\n  },\r\n  context?: CartContext\r\n): Promise<{ success: boolean; wasAbandoned: boolean }> {\r\n  let cart: AbandonedCart | undefined\r\n\r\n  if (params.cartId) {\r\n    cart = abandonedCarts.get(params.cartId)\r\n  } else if (params.sessionId) {\r\n    cart = Array.from(abandonedCarts.values()).find(c => c.sessionId === params.sessionId)\r\n  }\r\n\r\n  if (!cart) {\r\n    return { success: true, wasAbandoned: false }\r\n  }\r\n\r\n  const wasAbandoned = !!cart.abandonedAt\r\n\r\n  cart.recovered = true\r\n  cart.recoveredAt = new Date()\r\n  abandonedCarts.set(cart.cartId, cart)\r\n\r\n  console.log(\"[Cart] Marked as recovered\", { cartId: cart.cartId, wasAbandoned })\r\n\r\n  return { success: true, wasAbandoned }\r\n}\r\n\r\n/**\r\n * Get recovery link for cart\r\n */\r\nexport async function getRecoveryLink(\r\n  params: { cartId: string },\r\n  context?: CartContext\r\n): Promise<{ link: string; expiresAt: Date }> {\r\n  const cart = abandonedCarts.get(params.cartId)\r\n  if (!cart) {\r\n    throw new Error(\"Cart not found\")\r\n  }\r\n\r\n  const token = Buffer.from(JSON.stringify({\r\n    cartId: cart.cartId,\r\n    exp: Date.now() + 7 * 24 * 60 * 60 * 1000, // 7 days\r\n  })).toString(\"base64url\")\r\n\r\n  const baseUrl = process.env.NEXT_PUBLIC_APP_URL || \"https://v0-bookinengine.vercel.app\"\r\n\r\n  return {\r\n    link: `${baseUrl}/recover?token=${token}`,\r\n    expiresAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000),\r\n  }\r\n}\r\n\r\n/**\r\n * Get cart recovery statistics\r\n */\r\nexport async function getRecoveryStats(\r\n  params: { startDate?: Date; endDate?: Date },\r\n  context?: CartContext\r\n): Promise<CartRecoveryStats> {\r\n  console.log(\"[Cart] Getting recovery stats\")\r\n\r\n  const carts = Array.from(abandonedCarts.values())\r\n  \r\n  const abandoned = carts.filter(c => c.abandonedAt)\r\n  const recovered = abandoned.filter(c => c.recovered)\r\n  \r\n  const revenueRecovered = recovered.reduce((sum, c) => sum + c.totalPrice, 0)\r\n  const totalValue = abandoned.reduce((sum, c) => sum + c.totalPrice, 0)\r\n\r\n  // Count by stage\r\n  const stageCounts: Record<string, number> = {}\r\n  abandoned.forEach(c => {\r\n    stageCounts[c.stage] = (stageCounts[c.stage] || 0) + 1\r\n  })\r\n\r\n  // Count by channel\r\n  const channelCounts: Record<string, { total: number; recovered: number }> = {}\r\n  abandoned.forEach(c => {\r\n    c.recoveryAttempts.forEach(a => {\r\n      if (!channelCounts[a.type]) {\r\n        channelCounts[a.type] = { total: 0, recovered: 0 }\r\n      }\r\n      channelCounts[a.type].total++\r\n      if (c.recovered) {\r\n        channelCounts[a.type].recovered++\r\n      }\r\n    })\r\n  })\r\n\r\n  return {\r\n    totalAbandoned: abandoned.length,\r\n    totalRecovered: recovered.length,\r\n    recoveryRate: abandoned.length > 0 ? (recovered.length / abandoned.length) * 100 : 0,\r\n    revenueRecovered,\r\n    averageCartValue: abandoned.length > 0 ? totalValue / abandoned.length : 0,\r\n    topAbandonmentStages: Object.entries(stageCounts)\r\n      .map(([stage, count]) => ({ stage, count }))\r\n      .sort((a, b) => b.count - a.count),\r\n    recoveryByChannel: Object.entries(channelCounts)\r\n      .map(([channel, data]) => ({\r\n        channel,\r\n        recovered: data.recovered,\r\n        rate: data.total > 0 ? (data.recovered / data.total) * 100 : 0,\r\n      })),\r\n  }\r\n}\r\n\r\n/**\r\n * Run automated recovery campaign\r\n */\r\nexport async function runRecoveryCampaign(\r\n  params: { dryRun?: boolean },\r\n  context?: CartContext\r\n): Promise<{\r\n  cartsProcessed: number\r\n  emailsSent: number\r\n  errors: string[]\r\n}> {\r\n  console.log(\"[Cart] Running recovery campaign\", { dryRun: params.dryRun })\r\n\r\n  const results = {\r\n    cartsProcessed: 0,\r\n    emailsSent: 0,\r\n    errors: [] as string[],\r\n  }\r\n\r\n  const carts = await getAbandonedCarts({ hasEmail: true }, context)\r\n\r\n  for (const cart of carts) {\r\n    results.cartsProcessed++\r\n\r\n    // Determine which template to use based on time\r\n    const ageHours = (Date.now() - (cart.abandonedAt?.getTime() || 0)) / (1000 * 60 * 60)\r\n    const attemptCount = cart.recoveryAttempts.filter(a => a.type === \"email\").length\r\n\r\n    let templateType: \"initial\" | \"reminder\" | \"lastChance\" | null = null\r\n\r\n    if (attemptCount === 0 && ageHours >= 1) {\r\n      templateType = \"initial\"\r\n    } else if (attemptCount === 1 && ageHours >= 24) {\r\n      templateType = \"reminder\"\r\n    } else if (attemptCount === 2 && ageHours >= 72) {\r\n      templateType = \"lastChance\"\r\n    }\r\n\r\n    if (templateType && !params.dryRun) {\r\n      const result = await sendRecoveryEmail({ cartId: cart.cartId, templateType }, context)\r\n      if (result.success) {\r\n        results.emailsSent++\r\n      } else if (result.error) {\r\n        results.errors.push(`${cart.cartId}: ${result.error}`)\r\n      }\r\n    }\r\n  }\r\n\r\n  console.log(\"[Cart] Campaign complete\", results)\r\n\r\n  return results\r\n}\r\n\r\n// Export handlers map for registry\r\nexport const abandonedCartHandlers = {\r\n  trackCartActivity,\r\n  markCartAbandoned,\r\n  getAbandonedCarts,\r\n  sendRecoveryEmail,\r\n  markCartRecovered,\r\n  getRecoveryLink,\r\n  getRecoveryStats,\r\n  runRecoveryCampaign,\r\n}\r\n","/**\r\n * Reviews Handler\r\n * Collect, manage, and analyze guest reviews\r\n */\r\n\r\n// Types\r\nexport interface ReviewContext {\r\n  userId?: string\r\n  sessionId?: string\r\n  locale?: \"en\" | \"he\"\r\n}\r\n\r\nexport interface Review {\r\n  reviewId: string\r\n  bookingId: string\r\n  hotelId: string\r\n  hotelName: string\r\n  \r\n  // Reviewer\r\n  customerId: string\r\n  customerName: string\r\n  customerEmail: string\r\n  isVerified: boolean\r\n  \r\n  // Rating breakdown\r\n  overallRating: number // 1-5\r\n  ratings: {\r\n    cleanliness: number\r\n    location: number\r\n    service: number\r\n    value: number\r\n    amenities: number\r\n    comfort: number\r\n  }\r\n  \r\n  // Content\r\n  title: string\r\n  content: string\r\n  pros?: string\r\n  cons?: string\r\n  \r\n  // Trip info\r\n  tripType: \"business\" | \"leisure\" | \"family\" | \"couple\" | \"solo\" | \"group\"\r\n  stayDate: Date\r\n  roomType: string\r\n  \r\n  // Metadata\r\n  language: string\r\n  photos?: string[]\r\n  helpfulVotes: number\r\n  \r\n  // Management\r\n  status: \"pending\" | \"approved\" | \"rejected\" | \"flagged\"\r\n  response?: HotelResponse\r\n  createdAt: Date\r\n  updatedAt: Date\r\n}\r\n\r\nexport interface HotelResponse {\r\n  responseId: string\r\n  responderId: string\r\n  responderName: string\r\n  content: string\r\n  createdAt: Date\r\n}\r\n\r\nexport interface ReviewStats {\r\n  totalReviews: number\r\n  averageRating: number\r\n  ratingDistribution: { rating: number; count: number; percentage: number }[]\r\n  categoryAverages: {\r\n    cleanliness: number\r\n    location: number\r\n    service: number\r\n    value: number\r\n    amenities: number\r\n    comfort: number\r\n  }\r\n  recentTrend: \"improving\" | \"stable\" | \"declining\"\r\n  responseRate: number\r\n}\r\n\r\nexport interface ReviewRequest {\r\n  requestId: string\r\n  bookingId: string\r\n  hotelId: string\r\n  customerId: string\r\n  customerEmail: string\r\n  customerName: string\r\n  checkOutDate: Date\r\n  sentAt?: Date\r\n  reminderSentAt?: Date\r\n  completedAt?: Date\r\n  status: \"pending\" | \"sent\" | \"completed\" | \"expired\"\r\n}\r\n\r\n// In-memory stores\r\nconst reviews: Map<string, Review> = new Map()\r\nconst reviewRequests: Map<string, ReviewRequest> = new Map()\r\n\r\n// Demo reviews for testing\r\nconst DEMO_REVIEWS: Review[] = [\r\n  {\r\n    reviewId: \"demo_1\",\r\n    bookingId: \"booking_demo_1\",\r\n    hotelId: \"hotel_1\",\r\n    hotelName: \"Dizengoff Inn\",\r\n    customerId: \"cust_1\",\r\n    customerName: \"John D.\",\r\n    customerEmail: \"john@example.com\",\r\n    isVerified: true,\r\n    overallRating: 4.5,\r\n    ratings: { cleanliness: 5, location: 5, service: 4, value: 4, amenities: 4, comfort: 5 },\r\n    title: \"Great location, amazing staff!\",\r\n    content: \"Loved our stay at this hotel. The location is perfect for exploring Tel Aviv. Staff was incredibly helpful with restaurant recommendations.\",\r\n    pros: \"Location, friendly staff, clean rooms\",\r\n    cons: \"Breakfast could be better\",\r\n    tripType: \"couple\",\r\n    stayDate: new Date(\"2025-12-15\"),\r\n    roomType: \"Deluxe Room\",\r\n    language: \"en\",\r\n    helpfulVotes: 12,\r\n    status: \"approved\",\r\n    createdAt: new Date(\"2025-12-20\"),\r\n    updatedAt: new Date(\"2025-12-20\"),\r\n  },\r\n]\r\n\r\n// Initialize demo data\r\nDEMO_REVIEWS.forEach(r => reviews.set(r.reviewId, r))\r\n\r\n/**\r\n * Request review from guest after checkout\r\n */\r\nexport async function requestReview(\r\n  params: {\r\n    bookingId: string\r\n    hotelId: string\r\n    hotelName: string\r\n    customerId: string\r\n    customerEmail: string\r\n    customerName: string\r\n    checkOutDate: string | Date\r\n  },\r\n  context?: ReviewContext\r\n): Promise<{ requestId: string; scheduledFor: Date }> {\r\n  console.log(\"[Reviews] Requesting review\", { bookingId: params.bookingId })\r\n\r\n  const checkOut = new Date(params.checkOutDate)\r\n  \r\n  // Schedule review request for 24 hours after checkout\r\n  const scheduledFor = new Date(checkOut.getTime() + 24 * 60 * 60 * 1000)\r\n\r\n  const request: ReviewRequest = {\r\n    requestId: `req_${Date.now()}_${Math.random().toString(36).substring(2, 8)}`,\r\n    bookingId: params.bookingId,\r\n    hotelId: params.hotelId,\r\n    customerId: params.customerId,\r\n    customerEmail: params.customerEmail,\r\n    customerName: params.customerName,\r\n    checkOutDate: checkOut,\r\n    status: \"pending\",\r\n  }\r\n\r\n  reviewRequests.set(request.requestId, request)\r\n\r\n  console.log(\"[Reviews] Review request created\", { requestId: request.requestId })\r\n\r\n  return { requestId: request.requestId, scheduledFor }\r\n}\r\n\r\n/**\r\n * Submit a review\r\n */\r\nexport async function submitReview(\r\n  params: {\r\n    bookingId: string\r\n    hotelId: string\r\n    customerId: string\r\n    customerName: string\r\n    customerEmail: string\r\n    overallRating: number\r\n    ratings: Review[\"ratings\"]\r\n    title: string\r\n    content: string\r\n    pros?: string\r\n    cons?: string\r\n    tripType: Review[\"tripType\"]\r\n    roomType: string\r\n    photos?: string[]\r\n  },\r\n  context?: ReviewContext\r\n): Promise<{ reviewId: string; status: string }> {\r\n  console.log(\"[Reviews] Submitting review\", { bookingId: params.bookingId, rating: params.overallRating })\r\n\r\n  // Validate rating\r\n  if (params.overallRating < 1 || params.overallRating > 5) {\r\n    throw new Error(\"Rating must be between 1 and 5\")\r\n  }\r\n\r\n  // Check for existing review\r\n  const existing = Array.from(reviews.values()).find(r => r.bookingId === params.bookingId)\r\n  if (existing) {\r\n    throw new Error(\"A review already exists for this booking\")\r\n  }\r\n\r\n  const review: Review = {\r\n    reviewId: `review_${Date.now()}_${Math.random().toString(36).substring(2, 8)}`,\r\n    bookingId: params.bookingId,\r\n    hotelId: params.hotelId,\r\n    hotelName: \"\", // Would fetch from database\r\n    customerId: params.customerId,\r\n    customerName: params.customerName,\r\n    customerEmail: params.customerEmail,\r\n    isVerified: true, // Verified because it's linked to a booking\r\n    overallRating: params.overallRating,\r\n    ratings: params.ratings,\r\n    title: params.title,\r\n    content: params.content,\r\n    pros: params.pros,\r\n    cons: params.cons,\r\n    tripType: params.tripType,\r\n    stayDate: new Date(),\r\n    roomType: params.roomType,\r\n    language: context?.locale || \"en\",\r\n    photos: params.photos,\r\n    helpfulVotes: 0,\r\n    status: \"pending\", // Requires moderation\r\n    createdAt: new Date(),\r\n    updatedAt: new Date(),\r\n  }\r\n\r\n  reviews.set(review.reviewId, review)\r\n\r\n  // Update review request status\r\n  const request = Array.from(reviewRequests.values()).find(r => r.bookingId === params.bookingId)\r\n  if (request) {\r\n    request.status = \"completed\"\r\n    request.completedAt = new Date()\r\n    reviewRequests.set(request.requestId, request)\r\n  }\r\n\r\n  console.log(\"[Reviews] Review submitted\", { reviewId: review.reviewId })\r\n\r\n  return { reviewId: review.reviewId, status: review.status }\r\n}\r\n\r\n/**\r\n * Get reviews for a hotel\r\n */\r\nexport async function getHotelReviews(\r\n  params: {\r\n    hotelId: string\r\n    status?: Review[\"status\"]\r\n    minRating?: number\r\n    sortBy?: \"recent\" | \"rating\" | \"helpful\"\r\n    limit?: number\r\n    offset?: number\r\n  },\r\n  context?: ReviewContext\r\n): Promise<{ reviews: Review[]; total: number; stats: ReviewStats }> {\r\n  console.log(\"[Reviews] Getting hotel reviews\", { hotelId: params.hotelId })\r\n\r\n  let hotelReviews = Array.from(reviews.values()).filter(r => r.hotelId === params.hotelId)\r\n\r\n  // Filter by status\r\n  if (params.status) {\r\n    hotelReviews = hotelReviews.filter(r => r.status === params.status)\r\n  } else {\r\n    // Default to approved only\r\n    hotelReviews = hotelReviews.filter(r => r.status === \"approved\")\r\n  }\r\n\r\n  // Filter by rating\r\n  if (params.minRating) {\r\n    hotelReviews = hotelReviews.filter(r => r.overallRating >= params.minRating!)\r\n  }\r\n\r\n  // Sort\r\n  switch (params.sortBy) {\r\n    case \"rating\":\r\n      hotelReviews.sort((a, b) => b.overallRating - a.overallRating)\r\n      break\r\n    case \"helpful\":\r\n      hotelReviews.sort((a, b) => b.helpfulVotes - a.helpfulVotes)\r\n      break\r\n    case \"recent\":\r\n    default:\r\n      hotelReviews.sort((a, b) => b.createdAt.getTime() - a.createdAt.getTime())\r\n  }\r\n\r\n  const total = hotelReviews.length\r\n\r\n  // Pagination\r\n  if (params.offset) {\r\n    hotelReviews = hotelReviews.slice(params.offset)\r\n  }\r\n  if (params.limit) {\r\n    hotelReviews = hotelReviews.slice(0, params.limit)\r\n  }\r\n\r\n  // Calculate stats\r\n  const stats = calculateReviewStats(hotelReviews)\r\n\r\n  return { reviews: hotelReviews, total, stats }\r\n}\r\n\r\n/**\r\n * Calculate review statistics\r\n */\r\nfunction calculateReviewStats(reviewList: Review[]): ReviewStats {\r\n  if (reviewList.length === 0) {\r\n    return {\r\n      totalReviews: 0,\r\n      averageRating: 0,\r\n      ratingDistribution: [1, 2, 3, 4, 5].map(rating => ({ rating, count: 0, percentage: 0 })),\r\n      categoryAverages: { cleanliness: 0, location: 0, service: 0, value: 0, amenities: 0, comfort: 0 },\r\n      recentTrend: \"stable\",\r\n      responseRate: 0,\r\n    }\r\n  }\r\n\r\n  // Average rating\r\n  const averageRating = reviewList.reduce((sum, r) => sum + r.overallRating, 0) / reviewList.length\r\n\r\n  // Rating distribution\r\n  const distribution: Record<number, number> = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 }\r\n  reviewList.forEach(r => {\r\n    const rounded = Math.round(r.overallRating)\r\n    distribution[rounded]++\r\n  })\r\n  const ratingDistribution = [1, 2, 3, 4, 5].map(rating => ({\r\n    rating,\r\n    count: distribution[rating],\r\n    percentage: (distribution[rating] / reviewList.length) * 100,\r\n  }))\r\n\r\n  // Category averages\r\n  const categories = [\"cleanliness\", \"location\", \"service\", \"value\", \"amenities\", \"comfort\"] as const\r\n  const categoryAverages = {} as ReviewStats[\"categoryAverages\"]\r\n  categories.forEach(cat => {\r\n    categoryAverages[cat] = reviewList.reduce((sum, r) => sum + r.ratings[cat], 0) / reviewList.length\r\n  })\r\n\r\n  // Response rate\r\n  const withResponses = reviewList.filter(r => r.response).length\r\n  const responseRate = (withResponses / reviewList.length) * 100\r\n\r\n  // Trend (compare last 30 days vs previous 30 days)\r\n  const now = Date.now()\r\n  const thirtyDaysAgo = now - 30 * 24 * 60 * 60 * 1000\r\n  const sixtyDaysAgo = now - 60 * 24 * 60 * 60 * 1000\r\n\r\n  const recent = reviewList.filter(r => r.createdAt.getTime() > thirtyDaysAgo)\r\n  const previous = reviewList.filter(r => r.createdAt.getTime() > sixtyDaysAgo && r.createdAt.getTime() <= thirtyDaysAgo)\r\n\r\n  let recentTrend: ReviewStats[\"recentTrend\"] = \"stable\"\r\n  if (recent.length > 0 && previous.length > 0) {\r\n    const recentAvg = recent.reduce((sum, r) => sum + r.overallRating, 0) / recent.length\r\n    const previousAvg = previous.reduce((sum, r) => sum + r.overallRating, 0) / previous.length\r\n    if (recentAvg > previousAvg + 0.2) recentTrend = \"improving\"\r\n    else if (recentAvg < previousAvg - 0.2) recentTrend = \"declining\"\r\n  }\r\n\r\n  return {\r\n    totalReviews: reviewList.length,\r\n    averageRating: Math.round(averageRating * 10) / 10,\r\n    ratingDistribution,\r\n    categoryAverages,\r\n    recentTrend,\r\n    responseRate: Math.round(responseRate),\r\n  }\r\n}\r\n\r\n/**\r\n * Moderate a review\r\n */\r\nexport async function moderateReview(\r\n  params: {\r\n    reviewId: string\r\n    action: \"approve\" | \"reject\" | \"flag\"\r\n    reason?: string\r\n  },\r\n  context?: ReviewContext\r\n): Promise<{ success: boolean; status: Review[\"status\"] }> {\r\n  console.log(\"[Reviews] Moderating review\", { reviewId: params.reviewId, action: params.action })\r\n\r\n  const review = reviews.get(params.reviewId)\r\n  if (!review) {\r\n    throw new Error(\"Review not found\")\r\n  }\r\n\r\n  review.status = params.action === \"approve\" ? \"approved\" \r\n    : params.action === \"reject\" ? \"rejected\" \r\n    : \"flagged\"\r\n  review.updatedAt = new Date()\r\n\r\n  reviews.set(params.reviewId, review)\r\n\r\n  return { success: true, status: review.status }\r\n}\r\n\r\n/**\r\n * Respond to a review\r\n */\r\nexport async function respondToReview(\r\n  params: {\r\n    reviewId: string\r\n    responderId: string\r\n    responderName: string\r\n    content: string\r\n  },\r\n  context?: ReviewContext\r\n): Promise<{ success: boolean; responseId: string }> {\r\n  console.log(\"[Reviews] Responding to review\", { reviewId: params.reviewId })\r\n\r\n  const review = reviews.get(params.reviewId)\r\n  if (!review) {\r\n    throw new Error(\"Review not found\")\r\n  }\r\n\r\n  review.response = {\r\n    responseId: `resp_${Date.now()}_${Math.random().toString(36).substring(2, 8)}`,\r\n    responderId: params.responderId,\r\n    responderName: params.responderName,\r\n    content: params.content,\r\n    createdAt: new Date(),\r\n  }\r\n  review.updatedAt = new Date()\r\n\r\n  reviews.set(params.reviewId, review)\r\n\r\n  console.log(\"[Reviews] Response added\", { responseId: review.response.responseId })\r\n\r\n  return { success: true, responseId: review.response.responseId }\r\n}\r\n\r\n/**\r\n * Mark review as helpful\r\n */\r\nexport async function markReviewHelpful(\r\n  params: { reviewId: string; userId: string },\r\n  context?: ReviewContext\r\n): Promise<{ helpfulVotes: number }> {\r\n  const review = reviews.get(params.reviewId)\r\n  if (!review) {\r\n    throw new Error(\"Review not found\")\r\n  }\r\n\r\n  review.helpfulVotes++\r\n  reviews.set(params.reviewId, review)\r\n\r\n  return { helpfulVotes: review.helpfulVotes }\r\n}\r\n\r\n/**\r\n * Generate review summary using AI\r\n */\r\nexport async function generateReviewSummary(\r\n  params: { hotelId: string },\r\n  context?: ReviewContext\r\n): Promise<{\r\n  summary: string\r\n  summaryHe: string\r\n  highlights: string[]\r\n  concerns: string[]\r\n}> {\r\n  console.log(\"[Reviews] Generating review summary\", { hotelId: params.hotelId })\r\n\r\n  const hotelReviews = Array.from(reviews.values())\r\n    .filter(r => r.hotelId === params.hotelId && r.status === \"approved\")\r\n\r\n  if (hotelReviews.length === 0) {\r\n    return {\r\n      summary: \"No reviews yet.\",\r\n      summaryHe: \"אין עדיין ביקורות.\",\r\n      highlights: [],\r\n      concerns: [],\r\n    }\r\n  }\r\n\r\n  // Extract common themes (simplified - would use AI in production)\r\n  const allPros = hotelReviews.map(r => r.pros).filter(Boolean).join(\" \")\r\n  const allCons = hotelReviews.map(r => r.cons).filter(Boolean).join(\" \")\r\n\r\n  const highlights: string[] = []\r\n  const concerns: string[] = []\r\n\r\n  if (allPros.toLowerCase().includes(\"location\")) highlights.push(\"Great location\")\r\n  if (allPros.toLowerCase().includes(\"staff\") || allPros.toLowerCase().includes(\"service\")) highlights.push(\"Excellent service\")\r\n  if (allPros.toLowerCase().includes(\"clean\")) highlights.push(\"Very clean\")\r\n\r\n  if (allCons.toLowerCase().includes(\"breakfast\")) concerns.push(\"Breakfast could be improved\")\r\n  if (allCons.toLowerCase().includes(\"noise\") || allCons.toLowerCase().includes(\"noisy\")) concerns.push(\"Some noise issues reported\")\r\n\r\n  const avgRating = hotelReviews.reduce((sum, r) => sum + r.overallRating, 0) / hotelReviews.length\r\n\r\n  return {\r\n    summary: `Based on ${hotelReviews.length} reviews, this hotel has an average rating of ${avgRating.toFixed(1)}. Guests frequently praise ${highlights.join(\", \") || \"the overall experience\"}.`,\r\n    summaryHe: `על בסיס ${hotelReviews.length} ביקורות, למלון דירוג ממוצע של ${avgRating.toFixed(1)}. אורחים משבחים לעיתים קרובות את ${highlights.join(\", \") || \"החוויה הכללית\"}.`,\r\n    highlights,\r\n    concerns,\r\n  }\r\n}\r\n\r\n/**\r\n * Send review request emails (batch job)\r\n */\r\nexport async function sendReviewRequests(\r\n  params: { dryRun?: boolean },\r\n  context?: ReviewContext\r\n): Promise<{ sent: number; errors: string[] }> {\r\n  console.log(\"[Reviews] Sending review requests\", { dryRun: params.dryRun })\r\n\r\n  const now = Date.now()\r\n  const pendingRequests = Array.from(reviewRequests.values()).filter(r => {\r\n    if (r.status !== \"pending\") return false\r\n    // Check if 24 hours after checkout\r\n    const sendTime = r.checkOutDate.getTime() + 24 * 60 * 60 * 1000\r\n    return now >= sendTime\r\n  })\r\n\r\n  let sent = 0\r\n  const errors: string[] = []\r\n\r\n  for (const request of pendingRequests) {\r\n    if (!params.dryRun) {\r\n      // In production, would send email\r\n      request.status = \"sent\"\r\n      request.sentAt = new Date()\r\n      reviewRequests.set(request.requestId, request)\r\n    }\r\n    sent++\r\n  }\r\n\r\n  console.log(\"[Reviews] Review requests sent\", { sent })\r\n\r\n  return { sent, errors }\r\n}\r\n\r\n// Export handlers map for registry\r\nexport const reviewHandlers = {\r\n  requestReview,\r\n  submitReview,\r\n  getHotelReviews,\r\n  moderateReview,\r\n  respondToReview,\r\n  markReviewHelpful,\r\n  generateReviewSummary,\r\n  sendReviewRequests,\r\n}\r\n","/**\r\n * Fraud Detection Handler\r\n * Analyze bookings for suspicious patterns and fraud risk\r\n */\r\n\r\n// Types\r\nexport interface FraudContext {\r\n  userId?: string\r\n  sessionId?: string\r\n  ipAddress?: string\r\n  userAgent?: string\r\n}\r\n\r\nexport interface RiskScore {\r\n  score: number // 0-100, higher = more risky\r\n  level: \"low\" | \"medium\" | \"high\" | \"critical\"\r\n  factors: RiskFactor[]\r\n  recommendation: \"approve\" | \"review\" | \"block\"\r\n  details: string\r\n}\r\n\r\nexport interface RiskFactor {\r\n  name: string\r\n  nameHe: string\r\n  score: number // 0-100 contribution to total\r\n  weight: number // 0-1\r\n  description: string\r\n  descriptionHe: string\r\n}\r\n\r\nexport interface FraudCheck {\r\n  checkType: string\r\n  passed: boolean\r\n  details: string\r\n  score: number\r\n}\r\n\r\nexport interface SuspiciousActivity {\r\n  id: string\r\n  type: \"velocity\" | \"mismatch\" | \"pattern\" | \"blacklist\" | \"geolocation\" | \"device\"\r\n  severity: \"low\" | \"medium\" | \"high\" | \"critical\"\r\n  description: string\r\n  bookingId?: string\r\n  customerId?: string\r\n  data: Record<string, any>\r\n  createdAt: Date\r\n}\r\n\r\n// Risk thresholds\r\nconst RISK_THRESHOLDS = {\r\n  low: 25,\r\n  medium: 50,\r\n  high: 75,\r\n  critical: 90,\r\n}\r\n\r\n// Suspicious patterns database (would be in Supabase in production)\r\nconst SUSPICIOUS_PATTERNS = {\r\n  disposableEmailDomains: [\r\n    \"tempmail.com\", \"throwaway.email\", \"guerrillamail.com\", \"10minutemail.com\",\r\n    \"mailinator.com\", \"yopmail.com\", \"trashmail.com\", \"fakeinbox.com\",\r\n  ],\r\n  highRiskCountries: [\"XX\", \"YY\"], // Placeholder - configure based on business rules\r\n  velocityLimits: {\r\n    bookingsPerHour: 3,\r\n    bookingsPerDay: 10,\r\n    totalValuePerDay: 1000000, // In cents ($10,000)\r\n  },\r\n}\r\n\r\n// In-memory velocity tracking (would use Redis/Supabase in production)\r\nconst velocityStore: Map<string, { count: number; total: number; timestamp: number }> = new Map()\r\n\r\n/**\r\n * Calculate overall risk score for a booking\r\n */\r\nexport async function analyzeBookingRisk(\r\n  params: {\r\n    bookingId: string\r\n    customerEmail: string\r\n    customerName: string\r\n    customerPhone?: string\r\n    amount: number\r\n    currency: string\r\n    hotelId: string\r\n    checkIn: string | Date\r\n    checkOut: string | Date\r\n    ipAddress?: string\r\n    userAgent?: string\r\n    paymentMethod?: string\r\n    billingCountry?: string\r\n  },\r\n  context?: FraudContext\r\n): Promise<RiskScore> {\r\n  console.log(\"[Fraud] Analyzing booking risk\", { bookingId: params.bookingId })\r\n\r\n  const factors: RiskFactor[] = []\r\n  let totalScore = 0\r\n  let totalWeight = 0\r\n\r\n  // 1. Email analysis\r\n  const emailFactor = analyzeEmail(params.customerEmail)\r\n  factors.push(emailFactor)\r\n  totalScore += emailFactor.score * emailFactor.weight\r\n  totalWeight += emailFactor.weight\r\n\r\n  // 2. Velocity check\r\n  const velocityFactor = await checkVelocity(params.customerEmail, params.amount)\r\n  factors.push(velocityFactor)\r\n  totalScore += velocityFactor.score * velocityFactor.weight\r\n  totalWeight += velocityFactor.weight\r\n\r\n  // 3. Amount analysis\r\n  const amountFactor = analyzeAmount(params.amount)\r\n  factors.push(amountFactor)\r\n  totalScore += amountFactor.score * amountFactor.weight\r\n  totalWeight += amountFactor.weight\r\n\r\n  // 4. Name/email mismatch\r\n  const mismatchFactor = checkNameEmailMismatch(params.customerName, params.customerEmail)\r\n  factors.push(mismatchFactor)\r\n  totalScore += mismatchFactor.score * mismatchFactor.weight\r\n  totalWeight += mismatchFactor.weight\r\n\r\n  // 5. Booking pattern analysis\r\n  const patternFactor = analyzeBookingPattern(params.checkIn, params.checkOut)\r\n  factors.push(patternFactor)\r\n  totalScore += patternFactor.score * patternFactor.weight\r\n  totalWeight += patternFactor.weight\r\n\r\n  // 6. IP/Geolocation (if available)\r\n  if (params.ipAddress || context?.ipAddress) {\r\n    const geoFactor = analyzeGeolocation(params.ipAddress || context?.ipAddress || \"\", params.billingCountry)\r\n    factors.push(geoFactor)\r\n    totalScore += geoFactor.score * geoFactor.weight\r\n    totalWeight += geoFactor.weight\r\n  }\r\n\r\n  // Calculate final score\r\n  const finalScore = Math.round(totalWeight > 0 ? totalScore / totalWeight : 0)\r\n\r\n  // Determine risk level\r\n  let level: RiskScore[\"level\"] = \"low\"\r\n  if (finalScore >= RISK_THRESHOLDS.critical) level = \"critical\"\r\n  else if (finalScore >= RISK_THRESHOLDS.high) level = \"high\"\r\n  else if (finalScore >= RISK_THRESHOLDS.medium) level = \"medium\"\r\n\r\n  // Determine recommendation\r\n  let recommendation: RiskScore[\"recommendation\"] = \"approve\"\r\n  if (level === \"critical\") recommendation = \"block\"\r\n  else if (level === \"high\") recommendation = \"review\"\r\n\r\n  const details = generateRiskSummary(factors, level, finalScore)\r\n\r\n  console.log(\"[Fraud] Risk analysis complete\", { \r\n    bookingId: params.bookingId, \r\n    score: finalScore, \r\n    level, \r\n    recommendation \r\n  })\r\n\r\n  return {\r\n    score: finalScore,\r\n    level,\r\n    factors,\r\n    recommendation,\r\n    details,\r\n  }\r\n}\r\n\r\n/**\r\n * Analyze email for suspicious patterns\r\n */\r\nfunction analyzeEmail(email: string): RiskFactor {\r\n  let score = 0\r\n  const issues: string[] = []\r\n\r\n  const domain = email.split(\"@\")[1]?.toLowerCase()\r\n\r\n  // Check disposable email\r\n  if (SUSPICIOUS_PATTERNS.disposableEmailDomains.includes(domain)) {\r\n    score += 60\r\n    issues.push(\"Disposable email domain\")\r\n  }\r\n\r\n  // Check for random-looking email\r\n  const localPart = email.split(\"@\")[0]\r\n  if (/^[a-z0-9]{10,}$/i.test(localPart) && !/[aeiou]{2,}/i.test(localPart)) {\r\n    score += 20\r\n    issues.push(\"Random-looking email address\")\r\n  }\r\n\r\n  // Check for numbers at end (often auto-generated)\r\n  if (/\\d{4,}@/.test(email)) {\r\n    score += 15\r\n    issues.push(\"Many numbers in email\")\r\n  }\r\n\r\n  return {\r\n    name: \"Email Analysis\",\r\n    nameHe: \"ניתוח אימייל\",\r\n    score: Math.min(score, 100),\r\n    weight: 0.2,\r\n    description: issues.length > 0 ? issues.join(\", \") : \"Email looks legitimate\",\r\n    descriptionHe: issues.length > 0 ? \"נמצאו סימנים חשודים באימייל\" : \"האימייל נראה תקין\",\r\n  }\r\n}\r\n\r\n/**\r\n * Check booking velocity (rate limiting)\r\n */\r\nasync function checkVelocity(email: string, amount: number): Promise<RiskFactor> {\r\n  const now = Date.now()\r\n  const hourAgo = now - 60 * 60 * 1000\r\n  \r\n  // Get or create velocity record\r\n  let record = velocityStore.get(email)\r\n  \r\n  if (!record || record.timestamp < hourAgo) {\r\n    record = { count: 0, total: 0, timestamp: now }\r\n  }\r\n  \r\n  // Update record\r\n  record.count++\r\n  record.total += amount\r\n  record.timestamp = now\r\n  velocityStore.set(email, record)\r\n\r\n  let score = 0\r\n  const issues: string[] = []\r\n\r\n  // Check bookings per hour\r\n  if (record.count > SUSPICIOUS_PATTERNS.velocityLimits.bookingsPerHour) {\r\n    score += 50\r\n    issues.push(`${record.count} bookings in last hour`)\r\n  }\r\n\r\n  // Check total value\r\n  if (record.total > SUSPICIOUS_PATTERNS.velocityLimits.totalValuePerDay) {\r\n    score += 40\r\n    issues.push(\"High total booking value\")\r\n  }\r\n\r\n  return {\r\n    name: \"Velocity Check\",\r\n    nameHe: \"בדיקת קצב הזמנות\",\r\n    score: Math.min(score, 100),\r\n    weight: 0.25,\r\n    description: issues.length > 0 ? issues.join(\", \") : \"Normal booking frequency\",\r\n    descriptionHe: issues.length > 0 ? \"קצב הזמנות חריג\" : \"קצב הזמנות תקין\",\r\n  }\r\n}\r\n\r\n/**\r\n * Analyze booking amount\r\n */\r\nfunction analyzeAmount(amount: number): RiskFactor {\r\n  let score = 0\r\n  const issues: string[] = []\r\n\r\n  // Very high amount\r\n  if (amount > 500000) { // $5,000+\r\n    score += 30\r\n    issues.push(\"Very high booking amount\")\r\n  } else if (amount > 200000) { // $2,000+\r\n    score += 15\r\n    issues.push(\"High booking amount\")\r\n  }\r\n\r\n  // Round number (often test transactions)\r\n  if (amount % 10000 === 0 && amount > 0) {\r\n    score += 10\r\n    issues.push(\"Suspiciously round amount\")\r\n  }\r\n\r\n  return {\r\n    name: \"Amount Analysis\",\r\n    nameHe: \"ניתוח סכום\",\r\n    score: Math.min(score, 100),\r\n    weight: 0.15,\r\n    description: issues.length > 0 ? issues.join(\", \") : \"Amount is reasonable\",\r\n    descriptionHe: issues.length > 0 ? \"סכום חריג\" : \"סכום סביר\",\r\n  }\r\n}\r\n\r\n/**\r\n * Check for name/email mismatch\r\n */\r\nfunction checkNameEmailMismatch(name: string, email: string): RiskFactor {\r\n  let score = 0\r\n  const issues: string[] = []\r\n\r\n  const nameParts = name.toLowerCase().split(/\\s+/)\r\n  const emailLocal = email.split(\"@\")[0].toLowerCase()\r\n\r\n  // Check if any part of name appears in email\r\n  const nameInEmail = nameParts.some(part => \r\n    part.length > 2 && emailLocal.includes(part)\r\n  )\r\n\r\n  if (!nameInEmail && nameParts[0]?.length > 3) {\r\n    score += 25\r\n    issues.push(\"Name doesn't match email\")\r\n  }\r\n\r\n  return {\r\n    name: \"Name/Email Match\",\r\n    nameHe: \"התאמת שם ואימייל\",\r\n    score: Math.min(score, 100),\r\n    weight: 0.1,\r\n    description: issues.length > 0 ? issues.join(\", \") : \"Name and email appear consistent\",\r\n    descriptionHe: issues.length > 0 ? \"חוסר התאמה בין שם ואימייל\" : \"השם והאימייל תואמים\",\r\n  }\r\n}\r\n\r\n/**\r\n * Analyze booking pattern\r\n */\r\nfunction analyzeBookingPattern(checkIn: string | Date, checkOut: string | Date): RiskFactor {\r\n  let score = 0\r\n  const issues: string[] = []\r\n\r\n  const checkInDate = new Date(checkIn)\r\n  const checkOutDate = new Date(checkOut)\r\n  const now = new Date()\r\n\r\n  // Same day booking for far future\r\n  const daysUntilCheckIn = Math.floor((checkInDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24))\r\n  \r\n  if (daysUntilCheckIn > 180) {\r\n    score += 20\r\n    issues.push(\"Booking very far in advance\")\r\n  }\r\n\r\n  // Very long stay\r\n  const nights = Math.floor((checkOutDate.getTime() - checkInDate.getTime()) / (1000 * 60 * 60 * 24))\r\n  if (nights > 30) {\r\n    score += 25\r\n    issues.push(`Very long stay (${nights} nights)`)\r\n  }\r\n\r\n  // Booking for past date (error or fraud attempt)\r\n  if (checkInDate < now) {\r\n    score += 50\r\n    issues.push(\"Check-in date is in the past\")\r\n  }\r\n\r\n  return {\r\n    name: \"Booking Pattern\",\r\n    nameHe: \"דפוס הזמנה\",\r\n    score: Math.min(score, 100),\r\n    weight: 0.15,\r\n    description: issues.length > 0 ? issues.join(\", \") : \"Normal booking pattern\",\r\n    descriptionHe: issues.length > 0 ? \"דפוס הזמנה חשוד\" : \"דפוס הזמנה תקין\",\r\n  }\r\n}\r\n\r\n/**\r\n * Analyze geolocation/IP\r\n */\r\nfunction analyzeGeolocation(ipAddress: string, billingCountry?: string): RiskFactor {\r\n  let score = 0\r\n  const issues: string[] = []\r\n\r\n  // Check for VPN/proxy indicators (simplified - would use IP intelligence API)\r\n  if (ipAddress.startsWith(\"10.\") || ipAddress.startsWith(\"192.168.\")) {\r\n    score += 10\r\n    issues.push(\"Private/local IP address\")\r\n  }\r\n\r\n  // In production, would check:\r\n  // - IP country vs billing country mismatch\r\n  // - Known VPN/proxy IPs\r\n  // - Data center IPs\r\n  // - High-risk countries\r\n\r\n  return {\r\n    name: \"Geolocation Check\",\r\n    nameHe: \"בדיקת מיקום\",\r\n    score: Math.min(score, 100),\r\n    weight: 0.15,\r\n    description: issues.length > 0 ? issues.join(\", \") : \"Location appears normal\",\r\n    descriptionHe: issues.length > 0 ? \"נמצאו בעיות מיקום\" : \"מיקום תקין\",\r\n  }\r\n}\r\n\r\n/**\r\n * Generate risk summary\r\n */\r\nfunction generateRiskSummary(factors: RiskFactor[], level: string, score: number): string {\r\n  const highRiskFactors = factors.filter(f => f.score > 30)\r\n  \r\n  if (highRiskFactors.length === 0) {\r\n    return `Low risk booking (score: ${score}). All checks passed.`\r\n  }\r\n  \r\n  const factorNames = highRiskFactors.map(f => f.name).join(\", \")\r\n  return `${level.charAt(0).toUpperCase() + level.slice(1)} risk (score: ${score}). Concerns: ${factorNames}`\r\n}\r\n\r\n/**\r\n * Flag suspicious activity for review\r\n */\r\nexport async function flagSuspiciousActivity(\r\n  params: {\r\n    type: SuspiciousActivity[\"type\"]\r\n    severity: SuspiciousActivity[\"severity\"]\r\n    description: string\r\n    bookingId?: string\r\n    customerId?: string\r\n    data?: Record<string, any>\r\n  },\r\n  context?: FraudContext\r\n): Promise<SuspiciousActivity> {\r\n  console.log(\"[Fraud] Flagging suspicious activity\", { type: params.type, severity: params.severity })\r\n\r\n  const activity: SuspiciousActivity = {\r\n    id: `fraud_${Date.now()}_${Math.random().toString(36).substring(2, 8)}`,\r\n    type: params.type,\r\n    severity: params.severity,\r\n    description: params.description,\r\n    bookingId: params.bookingId,\r\n    customerId: params.customerId,\r\n    data: params.data || {},\r\n    createdAt: new Date(),\r\n  }\r\n\r\n  // In production, would:\r\n  // 1. Store in Supabase\r\n  // 2. Send alert to fraud team\r\n  // 3. Potentially auto-block if severity is critical\r\n\r\n  console.log(\"[Fraud] Activity flagged\", { id: activity.id })\r\n\r\n  return activity\r\n}\r\n\r\n/**\r\n * Get risk score (simplified accessor)\r\n */\r\nexport async function getRiskScore(\r\n  params: { bookingId: string; customerEmail: string; amount: number },\r\n  context?: FraudContext\r\n): Promise<{ score: number; level: string; recommendation: string }> {\r\n  const result = await analyzeBookingRisk({\r\n    bookingId: params.bookingId,\r\n    customerEmail: params.customerEmail,\r\n    customerName: \"\",\r\n    amount: params.amount,\r\n    currency: \"USD\",\r\n    hotelId: \"\",\r\n    checkIn: new Date(),\r\n    checkOut: new Date(Date.now() + 24 * 60 * 60 * 1000),\r\n  }, context)\r\n\r\n  return {\r\n    score: result.score,\r\n    level: result.level,\r\n    recommendation: result.recommendation,\r\n  }\r\n}\r\n\r\n/**\r\n * Check if customer is blacklisted\r\n */\r\nexport async function checkBlacklist(\r\n  params: { email?: string; phone?: string; ipAddress?: string },\r\n  context?: FraudContext\r\n): Promise<{ blacklisted: boolean; reason?: string }> {\r\n  // In production, would check against:\r\n  // 1. Internal blacklist in Supabase\r\n  // 2. External fraud databases\r\n  // 3. Shared industry blacklists\r\n\r\n  console.log(\"[Fraud] Checking blacklist\", { email: params.email })\r\n\r\n  // Placeholder - always return not blacklisted\r\n  return { blacklisted: false }\r\n}\r\n\r\n/**\r\n * Run all fraud checks\r\n */\r\nexport async function runFraudChecks(\r\n  params: {\r\n    bookingId: string\r\n    customerEmail: string\r\n    customerName: string\r\n    amount: number\r\n    currency: string\r\n  },\r\n  context?: FraudContext\r\n): Promise<{\r\n  passed: boolean\r\n  riskScore: RiskScore\r\n  checks: FraudCheck[]\r\n}> {\r\n  const checks: FraudCheck[] = []\r\n\r\n  // Run risk analysis\r\n  const riskScore = await analyzeBookingRisk({\r\n    bookingId: params.bookingId,\r\n    customerEmail: params.customerEmail,\r\n    customerName: params.customerName,\r\n    amount: params.amount,\r\n    currency: params.currency,\r\n    hotelId: \"\",\r\n    checkIn: new Date(),\r\n    checkOut: new Date(Date.now() + 24 * 60 * 60 * 1000),\r\n  }, context)\r\n\r\n  // Add individual checks\r\n  for (const factor of riskScore.factors) {\r\n    checks.push({\r\n      checkType: factor.name,\r\n      passed: factor.score < 50,\r\n      details: factor.description,\r\n      score: factor.score,\r\n    })\r\n  }\r\n\r\n  // Check blacklist\r\n  const blacklistResult = await checkBlacklist({ email: params.customerEmail }, context)\r\n  checks.push({\r\n    checkType: \"Blacklist\",\r\n    passed: !blacklistResult.blacklisted,\r\n    details: blacklistResult.blacklisted ? blacklistResult.reason || \"Blacklisted\" : \"Not blacklisted\",\r\n    score: blacklistResult.blacklisted ? 100 : 0,\r\n  })\r\n\r\n  const passed = riskScore.recommendation !== \"block\"\r\n\r\n  return {\r\n    passed,\r\n    riskScore,\r\n    checks,\r\n  }\r\n}\r\n\r\n// Export handlers map for registry\r\nexport const fraudHandlers = {\r\n  analyzeBookingRisk,\r\n  flagSuspiciousActivity,\r\n  getRiskScore,\r\n  checkBlacklist,\r\n  runFraudChecks,\r\n}\r\n","/**\r\n * Travel Insurance Handler\r\n * Offer and manage travel insurance for bookings\r\n */\r\n\r\n// Types\r\nexport interface InsuranceContext {\r\n  userId?: string\r\n  sessionId?: string\r\n  locale?: \"en\" | \"he\"\r\n}\r\n\r\nexport interface InsurancePlan {\r\n  id: string\r\n  name: string\r\n  nameHe: string\r\n  description: string\r\n  descriptionHe: string\r\n  coverage: InsuranceCoverage[]\r\n  pricePerDay: number\r\n  pricePerPerson: number\r\n  currency: string\r\n  provider: string\r\n  terms: string\r\n  termsHe: string\r\n}\r\n\r\nexport interface InsuranceCoverage {\r\n  type: string\r\n  typeHe: string\r\n  maxAmount: number\r\n  currency: string\r\n  description: string\r\n  descriptionHe: string\r\n}\r\n\r\nexport interface InsuranceQuote {\r\n  quoteId: string\r\n  planId: string\r\n  planName: string\r\n  totalPrice: number\r\n  priceBreakdown: {\r\n    basePrice: number\r\n    perDayPrice: number\r\n    perPersonPrice: number\r\n    taxes: number\r\n  }\r\n  currency: string\r\n  coverage: InsuranceCoverage[]\r\n  validUntil: Date\r\n  bookingId?: string\r\n}\r\n\r\nexport interface InsurancePolicy {\r\n  policyId: string\r\n  quoteId: string\r\n  planId: string\r\n  bookingId: string\r\n  customerId: string\r\n  customerName: string\r\n  customerEmail: string\r\n  travelers: string[]\r\n  startDate: Date\r\n  endDate: Date\r\n  totalPrice: number\r\n  currency: string\r\n  status: \"active\" | \"cancelled\" | \"expired\" | \"claimed\"\r\n  policyNumber: string\r\n  documentUrl?: string\r\n  createdAt: Date\r\n}\r\n\r\n// Available insurance plans\r\nconst INSURANCE_PLANS: InsurancePlan[] = [\r\n  {\r\n    id: \"basic\",\r\n    name: \"Basic Travel Protection\",\r\n    nameHe: \"הגנה בסיסית לנסיעה\",\r\n    description: \"Essential coverage for trip cancellation and medical emergencies\",\r\n    descriptionHe: \"כיסוי בסיסי לביטול נסיעה ומצבי חירום רפואיים\",\r\n    coverage: [\r\n      {\r\n        type: \"Trip Cancellation\",\r\n        typeHe: \"ביטול נסיעה\",\r\n        maxAmount: 100000,\r\n        currency: \"USD\",\r\n        description: \"Reimbursement for prepaid, non-refundable trip costs\",\r\n        descriptionHe: \"החזר עבור עלויות נסיעה ששולמו מראש ואינן ניתנות להחזר\",\r\n      },\r\n      {\r\n        type: \"Medical Emergency\",\r\n        typeHe: \"חירום רפואי\",\r\n        maxAmount: 50000,\r\n        currency: \"USD\",\r\n        description: \"Emergency medical treatment abroad\",\r\n        descriptionHe: \"טיפול רפואי חירום בחו\\\"ל\",\r\n      },\r\n      {\r\n        type: \"Baggage Loss\",\r\n        typeHe: \"אובדן מזוודות\",\r\n        maxAmount: 1000,\r\n        currency: \"USD\",\r\n        description: \"Coverage for lost or stolen baggage\",\r\n        descriptionHe: \"כיסוי למזוודות שאבדו או נגנבו\",\r\n      },\r\n    ],\r\n    pricePerDay: 500, // $5/day in cents\r\n    pricePerPerson: 1000, // $10/person in cents\r\n    currency: \"USD\",\r\n    provider: \"TravelGuard\",\r\n    terms: \"Coverage begins at trip start. Pre-existing conditions excluded.\",\r\n    termsHe: \"הכיסוי מתחיל עם תחילת הנסיעה. מצבים רפואיים קיימים אינם מכוסים.\",\r\n  },\r\n  {\r\n    id: \"premium\",\r\n    name: \"Premium Travel Protection\",\r\n    nameHe: \"הגנה פרימיום לנסיעה\",\r\n    description: \"Comprehensive coverage including adventure activities and electronics\",\r\n    descriptionHe: \"כיסוי מקיף כולל פעילויות אתגריות ומכשירים אלקטרוניים\",\r\n    coverage: [\r\n      {\r\n        type: \"Trip Cancellation\",\r\n        typeHe: \"ביטול נסיעה\",\r\n        maxAmount: 200000,\r\n        currency: \"USD\",\r\n        description: \"Full reimbursement for any reason cancellation\",\r\n        descriptionHe: \"החזר מלא לביטול מכל סיבה\",\r\n      },\r\n      {\r\n        type: \"Medical Emergency\",\r\n        typeHe: \"חירום רפואי\",\r\n        maxAmount: 250000,\r\n        currency: \"USD\",\r\n        description: \"Comprehensive medical coverage including evacuation\",\r\n        descriptionHe: \"כיסוי רפואי מקיף כולל פינוי\",\r\n      },\r\n      {\r\n        type: \"Baggage & Electronics\",\r\n        typeHe: \"מזוודות ואלקטרוניקה\",\r\n        maxAmount: 3000,\r\n        currency: \"USD\",\r\n        description: \"Coverage for baggage, electronics, and valuables\",\r\n        descriptionHe: \"כיסוי למזוודות, אלקטרוניקה וחפצי ערך\",\r\n      },\r\n      {\r\n        type: \"Adventure Sports\",\r\n        typeHe: \"ספורט אתגרי\",\r\n        maxAmount: 50000,\r\n        currency: \"USD\",\r\n        description: \"Coverage for skiing, diving, hiking accidents\",\r\n        descriptionHe: \"כיסוי לתאונות סקי, צלילה, טיולים\",\r\n      },\r\n      {\r\n        type: \"Trip Delay\",\r\n        typeHe: \"עיכוב נסיעה\",\r\n        maxAmount: 500,\r\n        currency: \"USD\",\r\n        description: \"Compensation for delays over 6 hours\",\r\n        descriptionHe: \"פיצוי על עיכובים של מעל 6 שעות\",\r\n      },\r\n    ],\r\n    pricePerDay: 1200, // $12/day\r\n    pricePerPerson: 2500, // $25/person\r\n    currency: \"USD\",\r\n    provider: \"TravelGuard\",\r\n    terms: \"24/7 assistance hotline. Cancel for any reason up to 48h before.\",\r\n    termsHe: \"קו חירום 24/7. ביטול מכל סיבה עד 48 שעות לפני.\",\r\n  },\r\n  {\r\n    id: \"family\",\r\n    name: \"Family Travel Protection\",\r\n    nameHe: \"הגנת משפחה לנסיעה\",\r\n    description: \"Specially designed for families with children\",\r\n    descriptionHe: \"מותאם במיוחד למשפחות עם ילדים\",\r\n    coverage: [\r\n      {\r\n        type: \"Trip Cancellation\",\r\n        typeHe: \"ביטול נסיעה\",\r\n        maxAmount: 150000,\r\n        currency: \"USD\",\r\n        description: \"Family cancellation coverage\",\r\n        descriptionHe: \"כיסוי ביטול למשפחה\",\r\n      },\r\n      {\r\n        type: \"Medical Emergency\",\r\n        typeHe: \"חירום רפואי\",\r\n        maxAmount: 150000,\r\n        currency: \"USD\",\r\n        description: \"Family medical coverage including pediatric care\",\r\n        descriptionHe: \"כיסוי רפואי למשפחה כולל טיפול ילדים\",\r\n      },\r\n      {\r\n        type: \"Child Care\",\r\n        typeHe: \"טיפול בילדים\",\r\n        maxAmount: 5000,\r\n        currency: \"USD\",\r\n        description: \"Emergency child care if parent hospitalized\",\r\n        descriptionHe: \"טיפול חירום בילדים אם ההורה מאושפז\",\r\n      },\r\n      {\r\n        type: \"Baggage Loss\",\r\n        typeHe: \"אובדן מזוודות\",\r\n        maxAmount: 2000,\r\n        currency: \"USD\",\r\n        description: \"Family baggage coverage\",\r\n        descriptionHe: \"כיסוי מזוודות למשפחה\",\r\n      },\r\n    ],\r\n    pricePerDay: 800, // $8/day\r\n    pricePerPerson: 1500, // $15/person, but children under 18 free\r\n    currency: \"USD\",\r\n    provider: \"TravelGuard\",\r\n    terms: \"Children under 18 included free. Max 2 adults, 4 children per policy.\",\r\n    termsHe: \"ילדים עד גיל 18 ללא תשלום. מקסימום 2 מבוגרים, 4 ילדים לפוליסה.\",\r\n  },\r\n]\r\n\r\n/**\r\n * Get available insurance plans\r\n */\r\nexport async function getInsurancePlans(\r\n  params: { destination?: string; tripType?: string },\r\n  context?: InsuranceContext\r\n): Promise<InsurancePlan[]> {\r\n  console.log(\"[Insurance] Getting available plans\", params)\r\n  \r\n  // In production, would filter based on destination regulations\r\n  return INSURANCE_PLANS\r\n}\r\n\r\n/**\r\n * Get insurance quote for a booking\r\n */\r\nexport async function getInsuranceQuote(\r\n  params: {\r\n    planId: string\r\n    bookingId?: string\r\n    checkIn: string | Date\r\n    checkOut: string | Date\r\n    travelers: number\r\n    childrenUnder18?: number\r\n  },\r\n  context?: InsuranceContext\r\n): Promise<InsuranceQuote> {\r\n  console.log(\"[Insurance] Generating quote\", { planId: params.planId, travelers: params.travelers })\r\n\r\n  const plan = INSURANCE_PLANS.find(p => p.id === params.planId)\r\n  if (!plan) {\r\n    throw new Error(`Insurance plan not found: ${params.planId}`)\r\n  }\r\n\r\n  const checkIn = new Date(params.checkIn)\r\n  const checkOut = new Date(params.checkOut)\r\n  const days = Math.ceil((checkOut.getTime() - checkIn.getTime()) / (1000 * 60 * 60 * 24))\r\n\r\n  // Calculate price\r\n  let travelers = params.travelers\r\n  // Family plan: children under 18 are free\r\n  if (params.planId === \"family\" && params.childrenUnder18) {\r\n    travelers = Math.max(0, travelers - params.childrenUnder18)\r\n  }\r\n\r\n  const perDayPrice = plan.pricePerDay * days\r\n  const perPersonPrice = plan.pricePerPerson * travelers\r\n  const basePrice = perDayPrice + perPersonPrice\r\n  const taxes = Math.round(basePrice * 0.05) // 5% tax\r\n  const totalPrice = basePrice + taxes\r\n\r\n  const quote: InsuranceQuote = {\r\n    quoteId: `quote_${Date.now()}_${Math.random().toString(36).substring(2, 8)}`,\r\n    planId: plan.id,\r\n    planName: plan.name,\r\n    totalPrice,\r\n    priceBreakdown: {\r\n      basePrice,\r\n      perDayPrice,\r\n      perPersonPrice,\r\n      taxes,\r\n    },\r\n    currency: plan.currency,\r\n    coverage: plan.coverage,\r\n    validUntil: new Date(Date.now() + 24 * 60 * 60 * 1000), // Valid 24 hours\r\n    bookingId: params.bookingId,\r\n  }\r\n\r\n  console.log(\"[Insurance] Quote generated\", { quoteId: quote.quoteId, totalPrice })\r\n\r\n  return quote\r\n}\r\n\r\n/**\r\n * Purchase insurance policy\r\n */\r\nexport async function purchaseInsurance(\r\n  params: {\r\n    quoteId: string\r\n    bookingId: string\r\n    customerId: string\r\n    customerName: string\r\n    customerEmail: string\r\n    travelers: string[] // Names of all travelers\r\n    paymentMethodId?: string\r\n  },\r\n  context?: InsuranceContext\r\n): Promise<InsurancePolicy> {\r\n  console.log(\"[Insurance] Purchasing policy\", { quoteId: params.quoteId, bookingId: params.bookingId })\r\n\r\n  // In production, would:\r\n  // 1. Verify quote is still valid\r\n  // 2. Process payment via Stripe\r\n  // 3. Create policy with insurance provider API\r\n  // 4. Store in database\r\n\r\n  const policy: InsurancePolicy = {\r\n    policyId: `policy_${Date.now()}_${Math.random().toString(36).substring(2, 8)}`,\r\n    quoteId: params.quoteId,\r\n    planId: \"premium\", // Would come from quote\r\n    bookingId: params.bookingId,\r\n    customerId: params.customerId,\r\n    customerName: params.customerName,\r\n    customerEmail: params.customerEmail,\r\n    travelers: params.travelers,\r\n    startDate: new Date(), // Would come from booking\r\n    endDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000),\r\n    totalPrice: 5000, // Would come from quote\r\n    currency: \"USD\",\r\n    status: \"active\",\r\n    policyNumber: `TG-${Date.now().toString().slice(-8)}`,\r\n    createdAt: new Date(),\r\n  }\r\n\r\n  console.log(\"[Insurance] Policy purchased\", { policyId: policy.policyId, policyNumber: policy.policyNumber })\r\n\r\n  return policy\r\n}\r\n\r\n/**\r\n * Get insurance policy details\r\n */\r\nexport async function getInsurancePolicy(\r\n  params: { policyId?: string; bookingId?: string },\r\n  context?: InsuranceContext\r\n): Promise<InsurancePolicy | null> {\r\n  console.log(\"[Insurance] Getting policy\", params)\r\n  \r\n  // In production, would fetch from database\r\n  return null\r\n}\r\n\r\n/**\r\n * Cancel insurance policy\r\n */\r\nexport async function cancelInsurance(\r\n  params: {\r\n    policyId: string\r\n    reason?: string\r\n  },\r\n  context?: InsuranceContext\r\n): Promise<{ success: boolean; refundAmount?: number; error?: string }> {\r\n  console.log(\"[Insurance] Cancelling policy\", { policyId: params.policyId })\r\n\r\n  // In production, would:\r\n  // 1. Check cancellation policy\r\n  // 2. Calculate refund based on start date\r\n  // 3. Process refund\r\n  // 4. Update policy status\r\n\r\n  return {\r\n    success: true,\r\n    refundAmount: 4500, // 90% refund example\r\n  }\r\n}\r\n\r\n/**\r\n * File insurance claim\r\n */\r\nexport async function fileInsuranceClaim(\r\n  params: {\r\n    policyId: string\r\n    claimType: string\r\n    description: string\r\n    amount: number\r\n    documents?: string[] // URLs to uploaded documents\r\n  },\r\n  context?: InsuranceContext\r\n): Promise<{\r\n  claimId: string\r\n  status: \"submitted\" | \"under_review\" | \"approved\" | \"rejected\"\r\n  estimatedProcessingDays: number\r\n}> {\r\n  console.log(\"[Insurance] Filing claim\", { policyId: params.policyId, claimType: params.claimType })\r\n\r\n  return {\r\n    claimId: `claim_${Date.now()}_${Math.random().toString(36).substring(2, 8)}`,\r\n    status: \"submitted\",\r\n    estimatedProcessingDays: 5,\r\n  }\r\n}\r\n\r\n/**\r\n * Get claim status\r\n */\r\nexport async function getClaimStatus(\r\n  params: { claimId: string },\r\n  context?: InsuranceContext\r\n): Promise<{\r\n  claimId: string\r\n  status: string\r\n  amount?: number\r\n  decision?: string\r\n  updatedAt: Date\r\n}> {\r\n  console.log(\"[Insurance] Getting claim status\", { claimId: params.claimId })\r\n\r\n  return {\r\n    claimId: params.claimId,\r\n    status: \"under_review\",\r\n    updatedAt: new Date(),\r\n  }\r\n}\r\n\r\n// Export handlers map for registry\r\nexport const insuranceHandlers = {\r\n  getInsurancePlans,\r\n  getInsuranceQuote,\r\n  purchaseInsurance,\r\n  getInsurancePolicy,\r\n  cancelInsurance,\r\n  fileInsuranceClaim,\r\n  getClaimStatus,\r\n}\r\n","/**\r\n * Revenue Dashboard Handler\r\n * Financial reporting, revenue analytics, and KPI tracking\r\n */\r\n\r\n// Types\r\nexport interface RevenueContext {\r\n  userId?: string\r\n  sessionId?: string\r\n  locale?: \"en\" | \"he\"\r\n}\r\n\r\nexport interface RevenueResult {\r\n  success: boolean\r\n  data?: any\r\n  message?: string\r\n  error?: string\r\n}\r\n\r\ninterface RevenueData {\r\n  date: string\r\n  revenue: number\r\n  bookings: number\r\n  avgOrderValue: number\r\n  cancellations: number\r\n  refunds: number\r\n}\r\n\r\ninterface RevenueBreakdown {\r\n  category: string\r\n  amount: number\r\n  percentage: number\r\n  trend: \"up\" | \"down\" | \"stable\"\r\n  change: number\r\n}\r\n\r\ninterface KPI {\r\n  name: string\r\n  value: number | string\r\n  target: number | string\r\n  status: \"excellent\" | \"good\" | \"warning\" | \"critical\"\r\n  trend: \"up\" | \"down\" | \"stable\"\r\n  change: number\r\n}\r\n\r\n// Revenue Dashboard Handler\r\nexport const revenueDashboardHandler = {\r\n  skillId: \"revenue-dashboard\",\r\n  \r\n  async execute(\r\n    tool: string,\r\n    params: Record<string, unknown>,\r\n    context: RevenueContext\r\n  ): Promise<RevenueResult> {\r\n    switch (tool) {\r\n      case \"get_revenue_summary\":\r\n        return getRevenueSummary(params, context)\r\n      case \"get_revenue_breakdown\":\r\n        return getRevenueBreakdown(params, context)\r\n      case \"get_kpi_dashboard\":\r\n        return getKPIDashboard(params, context)\r\n      case \"generate_revenue_report\":\r\n        return generateRevenueReport(params, context)\r\n      default:\r\n        return {\r\n          success: false,\r\n          error: `Unknown tool: ${tool}`,\r\n        }\r\n    }\r\n  },\r\n}\r\n\r\n// Get Revenue Summary\r\nasync function getRevenueSummary(\r\n  params: Record<string, unknown>,\r\n  context: RevenueContext\r\n): Promise<RevenueResult> {\r\n  const period = (params.period as string) || \"month\" // day, week, month, quarter, year\r\n  const startDate = params.startDate as string\r\n  const endDate = params.endDate as string\r\n  const compareWithPrevious = params.compareWithPrevious !== false\r\n\r\n  try {\r\n    // Calculate date range\r\n    const now = new Date()\r\n    let start: Date\r\n    let end: Date = new Date(endDate || now)\r\n    \r\n    if (startDate) {\r\n      start = new Date(startDate)\r\n    } else {\r\n      start = new Date(now)\r\n      switch (period) {\r\n        case \"day\":\r\n          start.setDate(start.getDate() - 1)\r\n          break\r\n        case \"week\":\r\n          start.setDate(start.getDate() - 7)\r\n          break\r\n        case \"month\":\r\n          start.setMonth(start.getMonth() - 1)\r\n          break\r\n        case \"quarter\":\r\n          start.setMonth(start.getMonth() - 3)\r\n          break\r\n        case \"year\":\r\n          start.setFullYear(start.getFullYear() - 1)\r\n          break\r\n      }\r\n    }\r\n\r\n    // Generate revenue data (in production, fetch from database)\r\n    const currentPeriodData = generateRevenueData(start, end)\r\n    \r\n    // Calculate previous period for comparison\r\n    let previousPeriodData: typeof currentPeriodData | null = null\r\n    if (compareWithPrevious) {\r\n      const periodLength = end.getTime() - start.getTime()\r\n      const prevStart = new Date(start.getTime() - periodLength)\r\n      const prevEnd = new Date(start.getTime() - 1)\r\n      previousPeriodData = generateRevenueData(prevStart, prevEnd)\r\n    }\r\n\r\n    // Calculate totals\r\n    const currentTotals = calculateTotals(currentPeriodData)\r\n    const previousTotals = previousPeriodData ? calculateTotals(previousPeriodData) : null\r\n\r\n    // Calculate changes\r\n    const changes = previousTotals ? {\r\n      revenue: ((currentTotals.revenue - previousTotals.revenue) / previousTotals.revenue * 100),\r\n      bookings: ((currentTotals.bookings - previousTotals.bookings) / previousTotals.bookings * 100),\r\n      avgOrderValue: ((currentTotals.avgOrderValue - previousTotals.avgOrderValue) / previousTotals.avgOrderValue * 100),\r\n      cancellationRate: currentTotals.cancellationRate - previousTotals.cancellationRate,\r\n    } : null\r\n\r\n    return {\r\n      success: true,\r\n      data: {\r\n        period: {\r\n          start: start.toISOString().split(\"T\")[0],\r\n          end: end.toISOString().split(\"T\")[0],\r\n          label: period,\r\n        },\r\n        summary: {\r\n          totalRevenue: currentTotals.revenue,\r\n          totalBookings: currentTotals.bookings,\r\n          avgOrderValue: currentTotals.avgOrderValue,\r\n          cancellationRate: currentTotals.cancellationRate,\r\n          refundRate: currentTotals.refundRate,\r\n          netRevenue: currentTotals.netRevenue,\r\n        },\r\n        comparison: changes ? {\r\n          revenueChange: changes.revenue.toFixed(1) + \"%\",\r\n          bookingsChange: changes.bookings.toFixed(1) + \"%\",\r\n          avgOrderValueChange: changes.avgOrderValue.toFixed(1) + \"%\",\r\n          trend: changes.revenue > 0 ? \"up\" : changes.revenue < 0 ? \"down\" : \"stable\",\r\n        } : null,\r\n        dailyData: currentPeriodData.slice(-7), // Last 7 days\r\n        topMetrics: {\r\n          bestDay: currentPeriodData.reduce((a, b) => a.revenue > b.revenue ? a : b),\r\n          worstDay: currentPeriodData.reduce((a, b) => a.revenue < b.revenue ? a : b),\r\n          avgDailyRevenue: currentTotals.revenue / currentPeriodData.length,\r\n        },\r\n      },\r\n      message: `Revenue summary for ${period}: €${currentTotals.revenue.toLocaleString()} total revenue from ${currentTotals.bookings} bookings`,\r\n    }\r\n  } catch (error) {\r\n    return {\r\n      success: false,\r\n      error: `Failed to get revenue summary: ${error}`,\r\n    }\r\n  }\r\n}\r\n\r\n// Get Revenue Breakdown\r\nasync function getRevenueBreakdown(\r\n  params: Record<string, unknown>,\r\n  context: RevenueContext\r\n): Promise<RevenueResult> {\r\n  const breakdownBy = (params.breakdownBy as string) || \"source\" // source, hotel, room_type, channel\r\n  const period = (params.period as string) || \"month\"\r\n\r\n  try {\r\n    // Generate breakdown data based on category\r\n    let breakdown: RevenueBreakdown[] = []\r\n\r\n    switch (breakdownBy) {\r\n      case \"source\":\r\n        breakdown = [\r\n          { category: \"Direct Website\", amount: 45000, percentage: 35, trend: \"up\", change: 12 },\r\n          { category: \"Booking.com\", amount: 32000, percentage: 25, trend: \"stable\", change: 2 },\r\n          { category: \"Expedia\", amount: 25000, percentage: 19, trend: \"down\", change: -5 },\r\n          { category: \"AI Chat Widget\", amount: 18000, percentage: 14, trend: \"up\", change: 45 },\r\n          { category: \"Phone/Email\", amount: 9000, percentage: 7, trend: \"down\", change: -15 },\r\n        ]\r\n        break\r\n      case \"hotel\":\r\n        breakdown = [\r\n          { category: \"Scarlet Hotel Tel Aviv\", amount: 52000, percentage: 40, trend: \"up\", change: 8 },\r\n          { category: \"Grand Palace Jerusalem\", amount: 39000, percentage: 30, trend: \"up\", change: 15 },\r\n          { category: \"Beach Resort Eilat\", amount: 26000, percentage: 20, trend: \"stable\", change: 1 },\r\n          { category: \"Mountain Lodge Galilee\", amount: 13000, percentage: 10, trend: \"down\", change: -3 },\r\n        ]\r\n        break\r\n      case \"room_type\":\r\n        breakdown = [\r\n          { category: \"Deluxe Suite\", amount: 48000, percentage: 37, trend: \"up\", change: 18 },\r\n          { category: \"Standard Room\", amount: 35000, percentage: 27, trend: \"stable\", change: 0 },\r\n          { category: \"Family Room\", amount: 26000, percentage: 20, trend: \"up\", change: 22 },\r\n          { category: \"Executive Suite\", amount: 21000, percentage: 16, trend: \"down\", change: -8 },\r\n        ]\r\n        break\r\n      case \"channel\":\r\n        breakdown = [\r\n          { category: \"Online\", amount: 91000, percentage: 70, trend: \"up\", change: 15 },\r\n          { category: \"Mobile App\", amount: 26000, percentage: 20, trend: \"up\", change: 35 },\r\n          { category: \"Offline\", amount: 13000, percentage: 10, trend: \"down\", change: -20 },\r\n        ]\r\n        break\r\n    }\r\n\r\n    const totalRevenue = breakdown.reduce((sum, b) => sum + b.amount, 0)\r\n\r\n    return {\r\n      success: true,\r\n      data: {\r\n        breakdownBy,\r\n        period,\r\n        totalRevenue,\r\n        breakdown,\r\n        insights: generateBreakdownInsights(breakdown, breakdownBy),\r\n        recommendations: [\r\n          breakdown[0].trend === \"up\" \r\n            ? `${breakdown[0].category} is performing well (+${breakdown[0].change}%). Consider increasing investment.`\r\n            : `Focus on improving ${breakdown[0].category} performance.`,\r\n          breakdown.find(b => b.trend === \"down\")\r\n            ? `Attention needed: ${breakdown.find(b => b.trend === \"down\")?.category} is declining.`\r\n            : \"All categories showing positive or stable trends.\",\r\n        ],\r\n      },\r\n      message: `Revenue breakdown by ${breakdownBy}: Top performer is ${breakdown[0].category} with €${breakdown[0].amount.toLocaleString()} (${breakdown[0].percentage}%)`,\r\n    }\r\n  } catch (error) {\r\n    return {\r\n      success: false,\r\n      error: `Failed to get revenue breakdown: ${error}`,\r\n    }\r\n  }\r\n}\r\n\r\n// Get KPI Dashboard\r\nasync function getKPIDashboard(\r\n  params: Record<string, unknown>,\r\n  context: RevenueContext\r\n): Promise<RevenueResult> {\r\n  const period = (params.period as string) || \"month\"\r\n\r\n  try {\r\n    const kpis: KPI[] = [\r\n      {\r\n        name: \"Total Revenue\",\r\n        value: 129000,\r\n        target: 120000,\r\n        status: \"excellent\",\r\n        trend: \"up\",\r\n        change: 12.5,\r\n      },\r\n      {\r\n        name: \"Bookings\",\r\n        value: 847,\r\n        target: 800,\r\n        status: \"excellent\",\r\n        trend: \"up\",\r\n        change: 8.2,\r\n      },\r\n      {\r\n        name: \"Average Order Value\",\r\n        value: 152.30,\r\n        target: 150,\r\n        status: \"good\",\r\n        trend: \"up\",\r\n        change: 3.5,\r\n      },\r\n      {\r\n        name: \"Occupancy Rate\",\r\n        value: \"78%\",\r\n        target: \"75%\",\r\n        status: \"good\",\r\n        trend: \"up\",\r\n        change: 4.1,\r\n      },\r\n      {\r\n        name: \"Cancellation Rate\",\r\n        value: \"8.2%\",\r\n        target: \"10%\",\r\n        status: \"excellent\",\r\n        trend: \"down\",\r\n        change: -15.3,\r\n      },\r\n      {\r\n        name: \"Customer Satisfaction\",\r\n        value: 4.6,\r\n        target: 4.5,\r\n        status: \"good\",\r\n        trend: \"stable\",\r\n        change: 0.5,\r\n      },\r\n      {\r\n        name: \"Revenue per Available Room\",\r\n        value: 145,\r\n        target: 140,\r\n        status: \"good\",\r\n        trend: \"up\",\r\n        change: 5.8,\r\n      },\r\n      {\r\n        name: \"Direct Booking Rate\",\r\n        value: \"49%\",\r\n        target: \"50%\",\r\n        status: \"warning\",\r\n        trend: \"up\",\r\n        change: 8.0,\r\n      },\r\n    ]\r\n\r\n    const statusSummary = {\r\n      excellent: kpis.filter(k => k.status === \"excellent\").length,\r\n      good: kpis.filter(k => k.status === \"good\").length,\r\n      warning: kpis.filter(k => k.status === \"warning\").length,\r\n      critical: kpis.filter(k => k.status === \"critical\").length,\r\n    }\r\n\r\n    return {\r\n      success: true,\r\n      data: {\r\n        period,\r\n        kpis,\r\n        statusSummary,\r\n        overallHealth: statusSummary.critical === 0 && statusSummary.warning <= 1 ? \"healthy\" : \r\n                       statusSummary.critical > 0 ? \"critical\" : \"attention_needed\",\r\n        alerts: kpis\r\n          .filter(k => k.status === \"warning\" || k.status === \"critical\")\r\n          .map(k => ({\r\n            kpi: k.name,\r\n            message: `${k.name} is ${k.status}: ${k.value} (target: ${k.target})`,\r\n            priority: k.status === \"critical\" ? \"high\" : \"medium\",\r\n          })),\r\n        highlights: kpis\r\n          .filter(k => k.status === \"excellent\")\r\n          .map(k => `${k.name}: ${k.value} (${k.change > 0 ? \"+\" : \"\"}${k.change}%)`),\r\n      },\r\n      message: `KPI Dashboard: ${statusSummary.excellent} excellent, ${statusSummary.good} good, ${statusSummary.warning} need attention`,\r\n    }\r\n  } catch (error) {\r\n    return {\r\n      success: false,\r\n      error: `Failed to get KPI dashboard: ${error}`,\r\n    }\r\n  }\r\n}\r\n\r\n// Generate Revenue Report\r\nasync function generateRevenueReport(\r\n  params: Record<string, unknown>,\r\n  context: RevenueContext\r\n): Promise<RevenueResult> {\r\n  const reportType = (params.reportType as string) || \"summary\" // summary, detailed, executive\r\n  const period = (params.period as string) || \"month\"\r\n  const format = (params.format as string) || \"json\" // json, html, pdf\r\n\r\n  try {\r\n    // Gather all data for the report\r\n    const summaryResult = await getRevenueSummary({ period }, context)\r\n    const breakdownResult = await getRevenueBreakdown({ period, breakdownBy: \"source\" }, context)\r\n    const kpiResult = await getKPIDashboard({ period }, context)\r\n\r\n    if (!summaryResult.success || !breakdownResult.success || !kpiResult.success) {\r\n      throw new Error(\"Failed to gather report data\")\r\n    }\r\n\r\n    const reportData = {\r\n      generatedAt: new Date().toISOString(),\r\n      period,\r\n      reportType,\r\n      summary: summaryResult.data,\r\n      breakdown: breakdownResult.data,\r\n      kpis: kpiResult.data,\r\n    }\r\n\r\n    let output: string | typeof reportData = reportData\r\n\r\n    if (format === \"html\") {\r\n      output = generateHTMLReport(reportData)\r\n    }\r\n\r\n    return {\r\n      success: true,\r\n      data: {\r\n        report: output,\r\n        format,\r\n        downloadUrl: format === \"pdf\" ? `/api/reports/revenue/${Date.now()}.pdf` : null,\r\n        metadata: {\r\n          generatedAt: reportData.generatedAt,\r\n          period,\r\n          type: reportType,\r\n          dataPoints: Object.keys(reportData).length,\r\n        },\r\n      },\r\n      message: `Revenue report generated successfully (${reportType} format, ${period} period)`,\r\n    }\r\n  } catch (error) {\r\n    return {\r\n      success: false,\r\n      error: `Failed to generate revenue report: ${error}`,\r\n    }\r\n  }\r\n}\r\n\r\n// Helper Functions\r\nfunction generateRevenueData(start: Date, end: Date): RevenueData[] {\r\n  const data: RevenueData[] = []\r\n  const current = new Date(start)\r\n  \r\n  while (current <= end) {\r\n    const dayOfWeek = current.getDay()\r\n    const isWeekend = dayOfWeek === 0 || dayOfWeek === 6\r\n    const baseRevenue = isWeekend ? 5500 : 3800\r\n    const variance = (Math.random() - 0.5) * 1500\r\n    \r\n    data.push({\r\n      date: current.toISOString().split(\"T\")[0],\r\n      revenue: Math.round(baseRevenue + variance),\r\n      bookings: Math.round(25 + Math.random() * 15),\r\n      avgOrderValue: Math.round(140 + Math.random() * 30),\r\n      cancellations: Math.round(Math.random() * 5),\r\n      refunds: Math.round(Math.random() * 500),\r\n    })\r\n    \r\n    current.setDate(current.getDate() + 1)\r\n  }\r\n  \r\n  return data\r\n}\r\n\r\nfunction calculateTotals(data: RevenueData[]) {\r\n  const totalRevenue = data.reduce((sum, d) => sum + d.revenue, 0)\r\n  const totalBookings = data.reduce((sum, d) => sum + d.bookings, 0)\r\n  const totalCancellations = data.reduce((sum, d) => sum + d.cancellations, 0)\r\n  const totalRefunds = data.reduce((sum, d) => sum + d.refunds, 0)\r\n  \r\n  return {\r\n    revenue: totalRevenue,\r\n    bookings: totalBookings,\r\n    avgOrderValue: Math.round(totalRevenue / totalBookings),\r\n    cancellationRate: (totalCancellations / totalBookings * 100),\r\n    refundRate: (totalRefunds / totalRevenue * 100),\r\n    netRevenue: totalRevenue - totalRefunds,\r\n  }\r\n}\r\n\r\nfunction generateBreakdownInsights(breakdown: RevenueBreakdown[], breakdownBy: string): string[] {\r\n  const insights: string[] = []\r\n  \r\n  const topPerformer = breakdown[0]\r\n  insights.push(`${topPerformer.category} leads ${breakdownBy} revenue with ${topPerformer.percentage}% share`)\r\n  \r\n  const growing = breakdown.filter(b => b.trend === \"up\" && b.change > 10)\r\n  if (growing.length > 0) {\r\n    insights.push(`Fast growing: ${growing.map(g => g.category).join(\", \")}`)\r\n  }\r\n  \r\n  const declining = breakdown.filter(b => b.trend === \"down\")\r\n  if (declining.length > 0) {\r\n    insights.push(`Declining: ${declining.map(d => d.category).join(\", \")} - requires attention`)\r\n  }\r\n  \r\n  return insights\r\n}\r\n\r\nfunction generateHTMLReport(data: any): string {\r\n  return `\r\n<!DOCTYPE html>\r\n<html dir=\"rtl\" lang=\"he\">\r\n<head>\r\n  <meta charset=\"UTF-8\">\r\n  <title>דוח הכנסות - ${data.period}</title>\r\n  <style>\r\n    body { font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }\r\n    .container { max-width: 1000px; margin: 0 auto; background: white; padding: 40px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }\r\n    h1 { color: #1a1a2e; border-bottom: 3px solid #4a90a4; padding-bottom: 15px; }\r\n    h2 { color: #4a90a4; margin-top: 30px; }\r\n    .metric { display: inline-block; background: #f8f9fa; padding: 20px; margin: 10px; border-radius: 8px; min-width: 150px; text-align: center; }\r\n    .metric-value { font-size: 28px; font-weight: bold; color: #1a1a2e; }\r\n    .metric-label { font-size: 14px; color: #666; margin-top: 5px; }\r\n    .metric-change { font-size: 12px; margin-top: 5px; }\r\n    .up { color: #28a745; }\r\n    .down { color: #dc3545; }\r\n    table { width: 100%; border-collapse: collapse; margin: 20px 0; }\r\n    th, td { padding: 12px; text-align: right; border-bottom: 1px solid #ddd; }\r\n    th { background: #4a90a4; color: white; }\r\n    .kpi-excellent { background: #d4edda; }\r\n    .kpi-good { background: #fff3cd; }\r\n    .kpi-warning { background: #f8d7da; }\r\n    .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; color: #666; font-size: 12px; }\r\n  </style>\r\n</head>\r\n<body>\r\n  <div class=\"container\">\r\n    <h1>📊 דוח הכנסות - ${data.period}</h1>\r\n    <p>נוצר: ${new Date(data.generatedAt).toLocaleString(\"he-IL\")}</p>\r\n    \r\n    <h2>סיכום כללי</h2>\r\n    <div class=\"metrics\">\r\n      <div class=\"metric\">\r\n        <div class=\"metric-value\">€${data.summary?.summary?.totalRevenue?.toLocaleString() || \"N/A\"}</div>\r\n        <div class=\"metric-label\">הכנסות כוללות</div>\r\n        <div class=\"metric-change up\">${data.summary?.comparison?.revenueChange || \"\"}</div>\r\n      </div>\r\n      <div class=\"metric\">\r\n        <div class=\"metric-value\">${data.summary?.summary?.totalBookings || \"N/A\"}</div>\r\n        <div class=\"metric-label\">הזמנות</div>\r\n        <div class=\"metric-change up\">${data.summary?.comparison?.bookingsChange || \"\"}</div>\r\n      </div>\r\n      <div class=\"metric\">\r\n        <div class=\"metric-value\">€${data.summary?.summary?.avgOrderValue || \"N/A\"}</div>\r\n        <div class=\"metric-label\">ממוצע להזמנה</div>\r\n      </div>\r\n      <div class=\"metric\">\r\n        <div class=\"metric-value\">${data.summary?.summary?.cancellationRate?.toFixed(1) || \"N/A\"}%</div>\r\n        <div class=\"metric-label\">שיעור ביטולים</div>\r\n      </div>\r\n    </div>\r\n    \r\n    <h2>פילוח הכנסות</h2>\r\n    <table>\r\n      <tr><th>קטגוריה</th><th>סכום</th><th>אחוז</th><th>מגמה</th></tr>\r\n      ${data.breakdown?.breakdown?.map((b: any) => `\r\n        <tr>\r\n          <td>${b.category}</td>\r\n          <td>€${b.amount.toLocaleString()}</td>\r\n          <td>${b.percentage}%</td>\r\n          <td class=\"${b.trend === 'up' ? 'up' : b.trend === 'down' ? 'down' : ''}\">${b.trend === 'up' ? '↑' : b.trend === 'down' ? '↓' : '→'} ${b.change}%</td>\r\n        </tr>\r\n      `).join(\"\") || \"\"}\r\n    </table>\r\n    \r\n    <h2>מדדי ביצוע (KPIs)</h2>\r\n    <table>\r\n      <tr><th>מדד</th><th>ערך</th><th>יעד</th><th>סטטוס</th></tr>\r\n      ${data.kpis?.kpis?.slice(0, 5).map((k: any) => `\r\n        <tr class=\"kpi-${k.status}\">\r\n          <td>${k.name}</td>\r\n          <td>${k.value}</td>\r\n          <td>${k.target}</td>\r\n          <td>${k.status === 'excellent' ? '✅' : k.status === 'good' ? '👍' : '⚠️'}</td>\r\n        </tr>\r\n      `).join(\"\") || \"\"}\r\n    </table>\r\n    \r\n    <div class=\"footer\">\r\n      <p>דוח זה נוצר אוטומטית על ידי מערכת Revenue Dashboard</p>\r\n    </div>\r\n  </div>\r\n</body>\r\n</html>\r\n  `\r\n}\r\n\r\nexport default revenueDashboardHandler\r\n","/**\r\n * Invoice Handler\r\n * Generate and send booking invoices/receipts\r\n */\r\n\r\n// Types\r\nexport interface InvoiceContext {\r\n  userId?: string\r\n  sessionId?: string\r\n  locale?: \"en\" | \"he\"\r\n}\r\n\r\nexport interface InvoiceData {\r\n  invoiceNumber: string\r\n  bookingId: string\r\n  date: Date\r\n  dueDate?: Date\r\n  \r\n  // Seller info\r\n  seller: {\r\n    name: string\r\n    address: string\r\n    email: string\r\n    phone: string\r\n    vatNumber?: string\r\n  }\r\n  \r\n  // Customer info\r\n  customer: {\r\n    name: string\r\n    email: string\r\n    phone?: string\r\n    address?: string\r\n  }\r\n  \r\n  // Booking details\r\n  booking: {\r\n    hotelName: string\r\n    roomType: string\r\n    checkIn: Date\r\n    checkOut: Date\r\n    nights: number\r\n    guests: number\r\n    confirmationNumber: string\r\n  }\r\n  \r\n  // Line items\r\n  items: InvoiceItem[]\r\n  \r\n  // Totals\r\n  subtotal: number\r\n  tax: number\r\n  taxRate: number\r\n  discount?: number\r\n  discountCode?: string\r\n  total: number\r\n  currency: string\r\n  \r\n  // Payment info\r\n  paymentMethod?: string\r\n  paymentStatus: \"pending\" | \"paid\" | \"refunded\" | \"partial\"\r\n  paidAmount?: number\r\n  paidAt?: Date\r\n  \r\n  // Notes\r\n  notes?: string\r\n  termsAndConditions?: string\r\n}\r\n\r\nexport interface InvoiceItem {\r\n  description: string\r\n  descriptionHe?: string\r\n  quantity: number\r\n  unitPrice: number\r\n  total: number\r\n}\r\n\r\nexport interface GeneratedInvoice {\r\n  invoiceNumber: string\r\n  html: string\r\n  pdfUrl?: string\r\n  createdAt: Date\r\n}\r\n\r\n/**\r\n * Generate invoice number\r\n */\r\nfunction generateInvoiceNumber(bookingId: string): string {\r\n  const date = new Date()\r\n  const year = date.getFullYear()\r\n  const month = String(date.getMonth() + 1).padStart(2, \"0\")\r\n  const random = Math.random().toString(36).substring(2, 6).toUpperCase()\r\n  return `INV-${year}${month}-${random}`\r\n}\r\n\r\n/**\r\n * Calculate nights between dates\r\n */\r\nfunction calculateNights(checkIn: Date, checkOut: Date): number {\r\n  const diffTime = checkOut.getTime() - checkIn.getTime()\r\n  return Math.ceil(diffTime / (1000 * 60 * 60 * 24))\r\n}\r\n\r\n/**\r\n * Format currency\r\n */\r\nfunction formatCurrency(amount: number, currency: string): string {\r\n  const formatter = new Intl.NumberFormat(\"en-US\", {\r\n    style: \"currency\",\r\n    currency: currency.toUpperCase(),\r\n  })\r\n  return formatter.format(amount / 100) // Convert from cents\r\n}\r\n\r\n/**\r\n * Format date\r\n */\r\nfunction formatDate(date: Date, locale: \"en\" | \"he\" = \"en\"): string {\r\n  return new Intl.DateTimeFormat(locale === \"he\" ? \"he-IL\" : \"en-US\", {\r\n    year: \"numeric\",\r\n    month: \"long\",\r\n    day: \"numeric\",\r\n  }).format(date)\r\n}\r\n\r\n/**\r\n * Generate invoice HTML\r\n */\r\nexport async function generateInvoice(\r\n  params: {\r\n    bookingId: string\r\n    hotelName: string\r\n    roomType: string\r\n    checkIn: string | Date\r\n    checkOut: string | Date\r\n    totalPrice: number\r\n    currency: string\r\n    customerName: string\r\n    customerEmail: string\r\n    customerPhone?: string\r\n    confirmationNumber: string\r\n    guests: number\r\n    taxRate?: number\r\n    discount?: number\r\n    discountCode?: string\r\n    paymentStatus?: \"pending\" | \"paid\" | \"refunded\" | \"partial\"\r\n    notes?: string\r\n  },\r\n  context?: InvoiceContext\r\n): Promise<GeneratedInvoice> {\r\n  console.log(\"[Invoice] Generating invoice\", { bookingId: params.bookingId })\r\n\r\n  const locale = context?.locale || \"en\"\r\n  const checkIn = new Date(params.checkIn)\r\n  const checkOut = new Date(params.checkOut)\r\n  const nights = calculateNights(checkIn, checkOut)\r\n  \r\n  const invoiceNumber = generateInvoiceNumber(params.bookingId)\r\n  const taxRate = params.taxRate || 17 // Default 17% VAT in Israel\r\n  const subtotal = params.totalPrice\r\n  const tax = Math.round(subtotal * taxRate / 100)\r\n  const discount = params.discount || 0\r\n  const total = subtotal + tax - discount\r\n\r\n  const invoiceData: InvoiceData = {\r\n    invoiceNumber,\r\n    bookingId: params.bookingId,\r\n    date: new Date(),\r\n    seller: {\r\n      name: \"Booking Engine Ltd\",\r\n      address: \"123 Tech Street, Tel Aviv, Israel\",\r\n      email: \"billing@bookingengine.com\",\r\n      phone: \"+972-3-1234567\",\r\n      vatNumber: \"IL-123456789\",\r\n    },\r\n    customer: {\r\n      name: params.customerName,\r\n      email: params.customerEmail,\r\n      phone: params.customerPhone,\r\n    },\r\n    booking: {\r\n      hotelName: params.hotelName,\r\n      roomType: params.roomType,\r\n      checkIn,\r\n      checkOut,\r\n      nights,\r\n      guests: params.guests,\r\n      confirmationNumber: params.confirmationNumber,\r\n    },\r\n    items: [\r\n      {\r\n        description: `${params.hotelName} - ${params.roomType}`,\r\n        descriptionHe: `${params.hotelName} - ${params.roomType}`,\r\n        quantity: nights,\r\n        unitPrice: Math.round(subtotal / nights),\r\n        total: subtotal,\r\n      },\r\n    ],\r\n    subtotal,\r\n    tax,\r\n    taxRate,\r\n    discount,\r\n    discountCode: params.discountCode,\r\n    total,\r\n    currency: params.currency,\r\n    paymentStatus: params.paymentStatus || \"pending\",\r\n    notes: params.notes,\r\n  }\r\n\r\n  // Generate HTML\r\n  const html = generateInvoiceHTML(invoiceData, locale)\r\n\r\n  console.log(\"[Invoice] Invoice generated\", { invoiceNumber })\r\n\r\n  return {\r\n    invoiceNumber,\r\n    html,\r\n    createdAt: new Date(),\r\n  }\r\n}\r\n\r\n/**\r\n * Generate HTML invoice template\r\n */\r\nfunction generateInvoiceHTML(data: InvoiceData, locale: \"en\" | \"he\"): string {\r\n  const isHebrew = locale === \"he\"\r\n  const dir = isHebrew ? \"rtl\" : \"ltr\"\r\n  \r\n  const labels = isHebrew ? {\r\n    invoice: \"חשבונית\",\r\n    invoiceNumber: \"מספר חשבונית\",\r\n    date: \"תאריך\",\r\n    from: \"מאת\",\r\n    to: \"אל\",\r\n    bookingDetails: \"פרטי הזמנה\",\r\n    hotel: \"מלון\",\r\n    roomType: \"סוג חדר\",\r\n    checkIn: \"צ'ק-אין\",\r\n    checkOut: \"צ'ק-אאוט\",\r\n    nights: \"לילות\",\r\n    guests: \"אורחים\",\r\n    confirmation: \"מספר אישור\",\r\n    description: \"תיאור\",\r\n    quantity: \"כמות\",\r\n    unitPrice: \"מחיר ליחידה\",\r\n    total: \"סה\\\"כ\",\r\n    subtotal: \"סכום ביניים\",\r\n    tax: \"מע\\\"מ\",\r\n    discount: \"הנחה\",\r\n    grandTotal: \"סה\\\"כ לתשלום\",\r\n    status: \"סטטוס תשלום\",\r\n    paid: \"שולם\",\r\n    pending: \"ממתין לתשלום\",\r\n    refunded: \"הוחזר\",\r\n    partial: \"שולם חלקית\",\r\n    notes: \"הערות\",\r\n    thankYou: \"תודה על הזמנתך!\",\r\n  } : {\r\n    invoice: \"Invoice\",\r\n    invoiceNumber: \"Invoice Number\",\r\n    date: \"Date\",\r\n    from: \"From\",\r\n    to: \"To\",\r\n    bookingDetails: \"Booking Details\",\r\n    hotel: \"Hotel\",\r\n    roomType: \"Room Type\",\r\n    checkIn: \"Check-in\",\r\n    checkOut: \"Check-out\",\r\n    nights: \"Nights\",\r\n    guests: \"Guests\",\r\n    confirmation: \"Confirmation #\",\r\n    description: \"Description\",\r\n    quantity: \"Quantity\",\r\n    unitPrice: \"Unit Price\",\r\n    total: \"Total\",\r\n    subtotal: \"Subtotal\",\r\n    tax: \"Tax (VAT)\",\r\n    discount: \"Discount\",\r\n    grandTotal: \"Grand Total\",\r\n    status: \"Payment Status\",\r\n    paid: \"Paid\",\r\n    pending: \"Pending\",\r\n    refunded: \"Refunded\",\r\n    partial: \"Partially Paid\",\r\n    notes: \"Notes\",\r\n    thankYou: \"Thank you for your booking!\",\r\n  }\r\n\r\n  const statusLabel = {\r\n    paid: labels.paid,\r\n    pending: labels.pending,\r\n    refunded: labels.refunded,\r\n    partial: labels.partial,\r\n  }[data.paymentStatus]\r\n\r\n  const statusColor = {\r\n    paid: \"#22c55e\",\r\n    pending: \"#f59e0b\",\r\n    refunded: \"#ef4444\",\r\n    partial: \"#3b82f6\",\r\n  }[data.paymentStatus]\r\n\r\n  return `\r\n<!DOCTYPE html>\r\n<html dir=\"${dir}\" lang=\"${isHebrew ? \"he\" : \"en\"}\">\r\n<head>\r\n  <meta charset=\"UTF-8\">\r\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n  <title>${labels.invoice} ${data.invoiceNumber}</title>\r\n  <style>\r\n    * { margin: 0; padding: 0; box-sizing: border-box; }\r\n    body { \r\n      font-family: ${isHebrew ? \"'Heebo', 'Arial', sans-serif\" : \"'Inter', 'Arial', sans-serif\"};\r\n      line-height: 1.6; \r\n      color: #1f2937;\r\n      background: #f9fafb;\r\n      padding: 20px;\r\n    }\r\n    .invoice-container {\r\n      max-width: 800px;\r\n      margin: 0 auto;\r\n      background: white;\r\n      border-radius: 12px;\r\n      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);\r\n      overflow: hidden;\r\n    }\r\n    .header {\r\n      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);\r\n      color: white;\r\n      padding: 30px;\r\n      display: flex;\r\n      justify-content: space-between;\r\n      align-items: center;\r\n    }\r\n    .header h1 { font-size: 28px; font-weight: 700; }\r\n    .invoice-number { \r\n      background: rgba(255,255,255,0.2);\r\n      padding: 8px 16px;\r\n      border-radius: 8px;\r\n      font-size: 14px;\r\n    }\r\n    .content { padding: 30px; }\r\n    .parties {\r\n      display: grid;\r\n      grid-template-columns: 1fr 1fr;\r\n      gap: 30px;\r\n      margin-bottom: 30px;\r\n    }\r\n    .party h3 { \r\n      color: #6366f1; \r\n      margin-bottom: 10px;\r\n      font-size: 14px;\r\n      text-transform: uppercase;\r\n      letter-spacing: 0.5px;\r\n    }\r\n    .party p { color: #4b5563; font-size: 14px; }\r\n    .booking-details {\r\n      background: #f3f4f6;\r\n      border-radius: 8px;\r\n      padding: 20px;\r\n      margin-bottom: 30px;\r\n    }\r\n    .booking-details h3 {\r\n      color: #1f2937;\r\n      margin-bottom: 15px;\r\n      font-size: 16px;\r\n    }\r\n    .booking-grid {\r\n      display: grid;\r\n      grid-template-columns: repeat(3, 1fr);\r\n      gap: 15px;\r\n    }\r\n    .booking-item label {\r\n      display: block;\r\n      color: #6b7280;\r\n      font-size: 12px;\r\n      margin-bottom: 4px;\r\n    }\r\n    .booking-item span {\r\n      font-weight: 600;\r\n      color: #1f2937;\r\n    }\r\n    table {\r\n      width: 100%;\r\n      border-collapse: collapse;\r\n      margin-bottom: 20px;\r\n    }\r\n    th {\r\n      text-align: ${isHebrew ? \"right\" : \"left\"};\r\n      padding: 12px;\r\n      background: #f9fafb;\r\n      color: #6b7280;\r\n      font-size: 12px;\r\n      text-transform: uppercase;\r\n      letter-spacing: 0.5px;\r\n      border-bottom: 2px solid #e5e7eb;\r\n    }\r\n    td {\r\n      padding: 12px;\r\n      border-bottom: 1px solid #e5e7eb;\r\n    }\r\n    .totals {\r\n      margin-top: 20px;\r\n      border-top: 2px solid #e5e7eb;\r\n      padding-top: 20px;\r\n    }\r\n    .total-row {\r\n      display: flex;\r\n      justify-content: space-between;\r\n      padding: 8px 0;\r\n      font-size: 14px;\r\n    }\r\n    .total-row.grand {\r\n      font-size: 18px;\r\n      font-weight: 700;\r\n      color: #6366f1;\r\n      border-top: 2px solid #6366f1;\r\n      margin-top: 10px;\r\n      padding-top: 15px;\r\n    }\r\n    .status-badge {\r\n      display: inline-block;\r\n      padding: 6px 12px;\r\n      border-radius: 20px;\r\n      font-size: 12px;\r\n      font-weight: 600;\r\n      color: white;\r\n      background: ${statusColor};\r\n    }\r\n    .footer {\r\n      text-align: center;\r\n      padding: 20px;\r\n      background: #f9fafb;\r\n      color: #6b7280;\r\n      font-size: 14px;\r\n    }\r\n    @media print {\r\n      body { background: white; padding: 0; }\r\n      .invoice-container { box-shadow: none; }\r\n    }\r\n  </style>\r\n</head>\r\n<body>\r\n  <div class=\"invoice-container\">\r\n    <div class=\"header\">\r\n      <div>\r\n        <h1>${labels.invoice}</h1>\r\n        <p>${labels.date}: ${formatDate(data.date, locale)}</p>\r\n      </div>\r\n      <div class=\"invoice-number\">\r\n        ${labels.invoiceNumber}: ${data.invoiceNumber}\r\n      </div>\r\n    </div>\r\n    \r\n    <div class=\"content\">\r\n      <div class=\"parties\">\r\n        <div class=\"party\">\r\n          <h3>${labels.from}</h3>\r\n          <p><strong>${data.seller.name}</strong></p>\r\n          <p>${data.seller.address}</p>\r\n          <p>${data.seller.email}</p>\r\n          <p>${data.seller.phone}</p>\r\n          ${data.seller.vatNumber ? `<p>VAT: ${data.seller.vatNumber}</p>` : \"\"}\r\n        </div>\r\n        <div class=\"party\">\r\n          <h3>${labels.to}</h3>\r\n          <p><strong>${data.customer.name}</strong></p>\r\n          <p>${data.customer.email}</p>\r\n          ${data.customer.phone ? `<p>${data.customer.phone}</p>` : \"\"}\r\n          ${data.customer.address ? `<p>${data.customer.address}</p>` : \"\"}\r\n        </div>\r\n      </div>\r\n      \r\n      <div class=\"booking-details\">\r\n        <h3>${labels.bookingDetails}</h3>\r\n        <div class=\"booking-grid\">\r\n          <div class=\"booking-item\">\r\n            <label>${labels.hotel}</label>\r\n            <span>${data.booking.hotelName}</span>\r\n          </div>\r\n          <div class=\"booking-item\">\r\n            <label>${labels.roomType}</label>\r\n            <span>${data.booking.roomType}</span>\r\n          </div>\r\n          <div class=\"booking-item\">\r\n            <label>${labels.confirmation}</label>\r\n            <span>${data.booking.confirmationNumber}</span>\r\n          </div>\r\n          <div class=\"booking-item\">\r\n            <label>${labels.checkIn}</label>\r\n            <span>${formatDate(data.booking.checkIn, locale)}</span>\r\n          </div>\r\n          <div class=\"booking-item\">\r\n            <label>${labels.checkOut}</label>\r\n            <span>${formatDate(data.booking.checkOut, locale)}</span>\r\n          </div>\r\n          <div class=\"booking-item\">\r\n            <label>${labels.nights} / ${labels.guests}</label>\r\n            <span>${data.booking.nights} / ${data.booking.guests}</span>\r\n          </div>\r\n        </div>\r\n      </div>\r\n      \r\n      <table>\r\n        <thead>\r\n          <tr>\r\n            <th>${labels.description}</th>\r\n            <th>${labels.quantity}</th>\r\n            <th>${labels.unitPrice}</th>\r\n            <th>${labels.total}</th>\r\n          </tr>\r\n        </thead>\r\n        <tbody>\r\n          ${data.items.map(item => `\r\n            <tr>\r\n              <td>${isHebrew && item.descriptionHe ? item.descriptionHe : item.description}</td>\r\n              <td>${item.quantity}</td>\r\n              <td>${formatCurrency(item.unitPrice, data.currency)}</td>\r\n              <td>${formatCurrency(item.total, data.currency)}</td>\r\n            </tr>\r\n          `).join(\"\")}\r\n        </tbody>\r\n      </table>\r\n      \r\n      <div class=\"totals\">\r\n        <div class=\"total-row\">\r\n          <span>${labels.subtotal}</span>\r\n          <span>${formatCurrency(data.subtotal, data.currency)}</span>\r\n        </div>\r\n        <div class=\"total-row\">\r\n          <span>${labels.tax} (${data.taxRate}%)</span>\r\n          <span>${formatCurrency(data.tax, data.currency)}</span>\r\n        </div>\r\n        ${data.discount ? `\r\n        <div class=\"total-row\">\r\n          <span>${labels.discount}${data.discountCode ? ` (${data.discountCode})` : \"\"}</span>\r\n          <span>-${formatCurrency(data.discount, data.currency)}</span>\r\n        </div>\r\n        ` : \"\"}\r\n        <div class=\"total-row grand\">\r\n          <span>${labels.grandTotal}</span>\r\n          <span>${formatCurrency(data.total, data.currency)}</span>\r\n        </div>\r\n      </div>\r\n      \r\n      <div style=\"margin-top: 20px;\">\r\n        <strong>${labels.status}:</strong>\r\n        <span class=\"status-badge\">${statusLabel}</span>\r\n      </div>\r\n      \r\n      ${data.notes ? `\r\n      <div style=\"margin-top: 20px; padding: 15px; background: #fef3c7; border-radius: 8px;\">\r\n        <strong>${labels.notes}:</strong>\r\n        <p>${data.notes}</p>\r\n      </div>\r\n      ` : \"\"}\r\n    </div>\r\n    \r\n    <div class=\"footer\">\r\n      <p>${labels.thankYou}</p>\r\n    </div>\r\n  </div>\r\n</body>\r\n</html>\r\n`\r\n}\r\n\r\n/**\r\n * Send invoice via email\r\n */\r\nexport async function sendInvoiceEmail(\r\n  params: {\r\n    to: string\r\n    invoiceNumber: string\r\n    invoiceHtml: string\r\n    bookingId: string\r\n    customerName: string\r\n  },\r\n  context?: InvoiceContext\r\n): Promise<{ success: boolean; messageId?: string; error?: string }> {\r\n  console.log(\"[Invoice] Sending invoice email\", { to: params.to, invoiceNumber: params.invoiceNumber })\r\n\r\n  try {\r\n    // Use Resend directly for custom HTML emails\r\n    const { Resend } = await import(\"resend\")\r\n    const resend = new Resend(process.env.RESEND_API_KEY || \"\")\r\n    \r\n    const result = await resend.emails.send({\r\n      from: process.env.FROM_EMAIL || \"bookings@youraitravelagent.com\",\r\n      to: params.to,\r\n      subject: `Invoice ${params.invoiceNumber} - Your Booking Confirmation`,\r\n      html: params.invoiceHtml,\r\n    })\r\n\r\n    console.log(\"[Invoice] Invoice email sent\", { messageId: result.data?.id })\r\n\r\n    return {\r\n      success: true,\r\n      messageId: result.data?.id,\r\n    }\r\n  } catch (error: any) {\r\n    console.error(\"[Invoice] Failed to send invoice email\", error.message)\r\n    return {\r\n      success: false,\r\n      error: error.message,\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Get invoice by booking ID\r\n */\r\nexport async function getInvoice(\r\n  params: { bookingId: string },\r\n  context?: InvoiceContext\r\n): Promise<GeneratedInvoice | null> {\r\n  // In a real implementation, this would fetch from database\r\n  // For now, return null as invoices are generated on-demand\r\n  console.log(\"[Invoice] Getting invoice for booking\", { bookingId: params.bookingId })\r\n  return null\r\n}\r\n\r\n/**\r\n * Generate receipt (simplified invoice for completed payments)\r\n */\r\nexport async function generateReceipt(\r\n  params: {\r\n    bookingId: string\r\n    paymentId: string\r\n    amount: number\r\n    currency: string\r\n    customerName: string\r\n    customerEmail: string\r\n    hotelName: string\r\n    confirmationNumber: string\r\n  },\r\n  context?: InvoiceContext\r\n): Promise<GeneratedInvoice> {\r\n  console.log(\"[Invoice] Generating receipt\", { bookingId: params.bookingId })\r\n\r\n  // Generate a simplified invoice/receipt\r\n  return generateInvoice({\r\n    bookingId: params.bookingId,\r\n    hotelName: params.hotelName,\r\n    roomType: \"Standard Room\",\r\n    checkIn: new Date(),\r\n    checkOut: new Date(Date.now() + 24 * 60 * 60 * 1000),\r\n    totalPrice: params.amount,\r\n    currency: params.currency,\r\n    customerName: params.customerName,\r\n    customerEmail: params.customerEmail,\r\n    confirmationNumber: params.confirmationNumber,\r\n    guests: 2,\r\n    paymentStatus: \"paid\",\r\n    notes: `Payment ID: ${params.paymentId}`,\r\n  }, context)\r\n}\r\n\r\n// Export handlers map for registry\r\nexport const invoiceHandlers = {\r\n  generateInvoice,\r\n  sendInvoiceEmail,\r\n  getInvoice,\r\n  generateReceipt,\r\n}\r\n","/**\r\n * Demand Forecasting Handler\r\n * AI-powered demand prediction, pricing recommendations, and capacity planning\r\n */\r\n\r\n// Types\r\nexport interface ForecastContext {\r\n  userId?: string\r\n  sessionId?: string\r\n  locale?: \"en\" | \"he\"\r\n}\r\n\r\nexport interface ForecastResult {\r\n  success: boolean\r\n  data?: any\r\n  message?: string\r\n  error?: string\r\n}\r\n\r\ninterface ForecastDataPoint {\r\n  date: string\r\n  predictedDemand: number\r\n  confidence: number\r\n  factors: string[]\r\n  recommendedPrice: number\r\n  expectedOccupancy: number\r\n}\r\n\r\ninterface SeasonalPattern {\r\n  period: string\r\n  demandMultiplier: number\r\n  description: string\r\n}\r\n\r\ninterface Event {\r\n  name: string\r\n  date: string\r\n  type: \"holiday\" | \"conference\" | \"festival\" | \"sport\" | \"other\"\r\n  impactLevel: \"high\" | \"medium\" | \"low\"\r\n  demandIncrease: number\r\n}\r\n\r\n// Demand Forecasting Handler\r\nexport const demandForecastingHandler = {\r\n  skillId: \"demand-forecasting\",\r\n  \r\n  async execute(\r\n    tool: string,\r\n    params: Record<string, unknown>,\r\n    context: ForecastContext\r\n  ): Promise<ForecastResult> {\r\n    switch (tool) {\r\n      case \"get_demand_forecast\":\r\n        return getDemandForecast(params, context)\r\n      case \"get_pricing_recommendations\":\r\n        return getPricingRecommendations(params, context)\r\n      case \"analyze_seasonality\":\r\n        return analyzeSeasonality(params, context)\r\n      case \"detect_demand_anomalies\":\r\n        return detectDemandAnomalies(params, context)\r\n      default:\r\n        return {\r\n          success: false,\r\n          error: `Unknown tool: ${tool}`,\r\n        }\r\n    }\r\n  },\r\n}\r\n\r\n// Get Demand Forecast\r\nasync function getDemandForecast(\r\n  params: Record<string, unknown>,\r\n  context: ForecastContext\r\n): Promise<ForecastResult> {\r\n  const hotelId = params.hotelId as string\r\n  const startDate = params.startDate as string || new Date().toISOString().split(\"T\")[0]\r\n  const days = (params.days as number) || 30\r\n  const roomType = params.roomType as string\r\n\r\n  try {\r\n    const forecast: ForecastDataPoint[] = []\r\n    const start = new Date(startDate)\r\n    \r\n    for (let i = 0; i < days; i++) {\r\n      const date = new Date(start)\r\n      date.setDate(date.getDate() + i)\r\n      \r\n      const dayOfWeek = date.getDay()\r\n      const month = date.getMonth()\r\n      const isWeekend = dayOfWeek === 5 || dayOfWeek === 6 // Friday/Saturday in Israel\r\n      const isHoliday = checkHoliday(date)\r\n      \r\n      // Calculate demand factors\r\n      const factors: string[] = []\r\n      let baseDemand = 65 // Base occupancy %\r\n      \r\n      // Weekend factor\r\n      if (isWeekend) {\r\n        baseDemand += 15\r\n        factors.push(\"weekend\")\r\n      }\r\n      \r\n      // Seasonal factor\r\n      const seasonalMultiplier = getSeasonalMultiplier(month)\r\n      baseDemand *= seasonalMultiplier\r\n      if (seasonalMultiplier > 1.1) factors.push(\"high_season\")\r\n      if (seasonalMultiplier < 0.9) factors.push(\"low_season\")\r\n      \r\n      // Holiday factor\r\n      if (isHoliday) {\r\n        baseDemand *= 1.3\r\n        factors.push(\"holiday\")\r\n      }\r\n      \r\n      // Event factor\r\n      const event = checkEvents(date)\r\n      if (event) {\r\n        baseDemand *= (1 + event.demandIncrease / 100)\r\n        factors.push(`event:${event.name}`)\r\n      }\r\n      \r\n      // Add some variance\r\n      const variance = (Math.random() - 0.5) * 10\r\n      const predictedDemand = Math.min(100, Math.max(20, baseDemand + variance))\r\n      \r\n      // Calculate confidence based on how far in the future\r\n      const daysAhead = i\r\n      const confidence = Math.max(0.5, 0.95 - (daysAhead * 0.015))\r\n      \r\n      // Calculate recommended price based on demand\r\n      const basePrice = 180 // Base room price\r\n      const demandPriceMultiplier = 0.5 + (predictedDemand / 100)\r\n      const recommendedPrice = Math.round(basePrice * demandPriceMultiplier)\r\n      \r\n      forecast.push({\r\n        date: date.toISOString().split(\"T\")[0],\r\n        predictedDemand: Math.round(predictedDemand),\r\n        confidence: Math.round(confidence * 100) / 100,\r\n        factors,\r\n        recommendedPrice,\r\n        expectedOccupancy: Math.round(predictedDemand),\r\n      })\r\n    }\r\n    \r\n    // Calculate summary statistics\r\n    const avgDemand = forecast.reduce((sum, f) => sum + f.predictedDemand, 0) / forecast.length\r\n    const peakDays = forecast.filter(f => f.predictedDemand > 80)\r\n    const lowDays = forecast.filter(f => f.predictedDemand < 50)\r\n    \r\n    return {\r\n      success: true,\r\n      data: {\r\n        hotelId: hotelId || \"default\",\r\n        roomType: roomType || \"all\",\r\n        forecastPeriod: {\r\n          start: startDate,\r\n          end: forecast[forecast.length - 1].date,\r\n          days,\r\n        },\r\n        forecast,\r\n        summary: {\r\n          averageDemand: Math.round(avgDemand),\r\n          peakDays: peakDays.length,\r\n          lowDays: lowDays.length,\r\n          peakDates: peakDays.slice(0, 5).map(f => f.date),\r\n          lowDates: lowDays.slice(0, 5).map(f => f.date),\r\n          averageRecommendedPrice: Math.round(forecast.reduce((sum, f) => sum + f.recommendedPrice, 0) / forecast.length),\r\n        },\r\n        alerts: [\r\n          ...peakDays.length > 7 ? [{\r\n            type: \"high_demand\",\r\n            message: `${peakDays.length} days with high demand (>80%) in forecast period`,\r\n            recommendation: \"Consider increasing prices or staff\",\r\n          }] : [],\r\n          ...lowDays.length > 7 ? [{\r\n            type: \"low_demand\",\r\n            message: `${lowDays.length} days with low demand (<50%) in forecast period`,\r\n            recommendation: \"Consider promotions or discounts\",\r\n          }] : [],\r\n        ],\r\n      },\r\n      message: `Demand forecast generated for ${days} days. Average expected occupancy: ${Math.round(avgDemand)}%`,\r\n    }\r\n  } catch (error) {\r\n    return {\r\n      success: false,\r\n      error: `Failed to generate demand forecast: ${error}`,\r\n    }\r\n  }\r\n}\r\n\r\n// Get Pricing Recommendations\r\nasync function getPricingRecommendations(\r\n  params: Record<string, unknown>,\r\n  context: ForecastContext\r\n): Promise<ForecastResult> {\r\n  const hotelId = params.hotelId as string\r\n  const date = params.date as string || new Date().toISOString().split(\"T\")[0]\r\n  const roomTypes = (params.roomTypes as string[]) || [\"standard\", \"deluxe\", \"suite\", \"family\"]\r\n  const competitorPrices = params.competitorPrices as Record<string, number>\r\n\r\n  try {\r\n    const targetDate = new Date(date)\r\n    const dayOfWeek = targetDate.getDay()\r\n    const month = targetDate.getMonth()\r\n    const isWeekend = dayOfWeek === 5 || dayOfWeek === 6\r\n    const isHoliday = checkHoliday(targetDate)\r\n    const event = checkEvents(targetDate)\r\n    \r\n    // Base prices per room type\r\n    const basePrices: Record<string, number> = {\r\n      standard: 150,\r\n      deluxe: 220,\r\n      suite: 380,\r\n      family: 280,\r\n    }\r\n    \r\n    // Calculate demand factor\r\n    let demandFactor = 1.0\r\n    if (isWeekend) demandFactor *= 1.15\r\n    if (isHoliday) demandFactor *= 1.3\r\n    if (event) demandFactor *= (1 + event.demandIncrease / 100)\r\n    demandFactor *= getSeasonalMultiplier(month)\r\n    \r\n    // Generate recommendations\r\n    const recommendations = roomTypes.map(roomType => {\r\n      const basePrice = basePrices[roomType] || 180\r\n      const optimalPrice = Math.round(basePrice * demandFactor)\r\n      const minPrice = Math.round(basePrice * 0.8)\r\n      const maxPrice = Math.round(basePrice * 1.5 * demandFactor)\r\n      \r\n      const competitorPrice = competitorPrices?.[roomType]\r\n      const pricePosition = competitorPrice \r\n        ? optimalPrice < competitorPrice ? \"below_market\" : optimalPrice > competitorPrice ? \"above_market\" : \"at_market\"\r\n        : \"unknown\"\r\n      \r\n      return {\r\n        roomType,\r\n        currentBasePrice: basePrice,\r\n        recommendedPrice: optimalPrice,\r\n        priceRange: { min: minPrice, max: maxPrice },\r\n        demandFactor: Math.round(demandFactor * 100) / 100,\r\n        competitorPrice: competitorPrice || null,\r\n        pricePosition,\r\n        reasoning: generatePricingReasoning(roomType, demandFactor, isWeekend, isHoliday, event),\r\n        potentialRevenue: {\r\n          atMinPrice: Math.round(minPrice * 0.95), // High occupancy at low price\r\n          atOptimalPrice: Math.round(optimalPrice * 0.75), // Good balance\r\n          atMaxPrice: Math.round(maxPrice * 0.50), // Lower occupancy at high price\r\n        },\r\n      }\r\n    })\r\n    \r\n    return {\r\n      success: true,\r\n      data: {\r\n        date,\r\n        hotelId: hotelId || \"default\",\r\n        factors: {\r\n          isWeekend,\r\n          isHoliday,\r\n          event: event?.name || null,\r\n          seasonalMultiplier: getSeasonalMultiplier(month),\r\n          overallDemandFactor: demandFactor,\r\n        },\r\n        recommendations,\r\n        strategy: demandFactor > 1.2 \r\n          ? \"aggressive\" \r\n          : demandFactor < 0.9 \r\n            ? \"promotional\"\r\n            : \"balanced\",\r\n        insights: [\r\n          demandFactor > 1.2 \r\n            ? \"High demand expected - maximize revenue with premium pricing\"\r\n            : demandFactor < 0.9\r\n              ? \"Low demand expected - consider promotions to boost occupancy\"\r\n              : \"Normal demand - maintain competitive pricing\",\r\n          isWeekend ? \"Weekend premium applies\" : \"Weekday rates recommended\",\r\n          event ? `Event \"${event.name}\" increases demand by ${event.demandIncrease}%` : null,\r\n        ].filter(Boolean),\r\n      },\r\n      message: `Pricing recommendations for ${date}: Strategy \"${demandFactor > 1.2 ? \"aggressive\" : demandFactor < 0.9 ? \"promotional\" : \"balanced\"}\" with demand factor ${demandFactor.toFixed(2)}`,\r\n    }\r\n  } catch (error) {\r\n    return {\r\n      success: false,\r\n      error: `Failed to generate pricing recommendations: ${error}`,\r\n    }\r\n  }\r\n}\r\n\r\n// Analyze Seasonality\r\nasync function analyzeSeasonality(\r\n  params: Record<string, unknown>,\r\n  context: ForecastContext\r\n): Promise<ForecastResult> {\r\n  const hotelId = params.hotelId as string\r\n  const year = (params.year as number) || new Date().getFullYear()\r\n\r\n  try {\r\n    const monthlyPatterns: SeasonalPattern[] = [\r\n      { period: \"January\", demandMultiplier: 0.75, description: \"Low season - post-holiday slump\" },\r\n      { period: \"February\", demandMultiplier: 0.80, description: \"Low season - winter\" },\r\n      { period: \"March\", demandMultiplier: 0.95, description: \"Spring begins - Purim/Passover prep\" },\r\n      { period: \"April\", demandMultiplier: 1.25, description: \"High season - Passover holidays\" },\r\n      { period: \"May\", demandMultiplier: 1.10, description: \"Pleasant weather - Independence Day\" },\r\n      { period: \"June\", demandMultiplier: 1.15, description: \"Early summer - school holidays begin\" },\r\n      { period: \"July\", demandMultiplier: 1.35, description: \"Peak season - summer vacation\" },\r\n      { period: \"August\", demandMultiplier: 1.40, description: \"Peak season - summer vacation\" },\r\n      { period: \"September\", demandMultiplier: 1.30, description: \"High holidays - Rosh Hashana/Yom Kippur\" },\r\n      { period: \"October\", demandMultiplier: 1.20, description: \"Sukkot holidays - pleasant weather\" },\r\n      { period: \"November\", demandMultiplier: 0.85, description: \"Shoulder season - fall\" },\r\n      { period: \"December\", demandMultiplier: 0.90, description: \"Hanukkah - moderate demand\" },\r\n    ]\r\n    \r\n    const weeklyPatterns = [\r\n      { day: \"Sunday\", demandMultiplier: 0.70, description: \"Week start - business travel begins\" },\r\n      { day: \"Monday\", demandMultiplier: 0.75, description: \"Business travel\" },\r\n      { day: \"Tuesday\", demandMultiplier: 0.80, description: \"Business travel\" },\r\n      { day: \"Wednesday\", demandMultiplier: 0.85, description: \"Mid-week peak\" },\r\n      { day: \"Thursday\", demandMultiplier: 0.95, description: \"Pre-weekend arrivals\" },\r\n      { day: \"Friday\", demandMultiplier: 1.30, description: \"Weekend - Shabbat\" },\r\n      { day: \"Saturday\", demandMultiplier: 1.35, description: \"Weekend peak - Shabbat\" },\r\n    ]\r\n    \r\n    // Calculate annual statistics\r\n    const avgMultiplier = monthlyPatterns.reduce((sum, p) => sum + p.demandMultiplier, 0) / 12\r\n    const peakMonths = monthlyPatterns.filter(p => p.demandMultiplier > 1.2).map(p => p.period)\r\n    const lowMonths = monthlyPatterns.filter(p => p.demandMultiplier < 0.85).map(p => p.period)\r\n    \r\n    // Upcoming events for the year\r\n    const upcomingEvents: Event[] = [\r\n      { name: \"Purim\", date: `${year}-03-14`, type: \"holiday\", impactLevel: \"medium\", demandIncrease: 20 },\r\n      { name: \"Passover\", date: `${year}-04-13`, type: \"holiday\", impactLevel: \"high\", demandIncrease: 40 },\r\n      { name: \"Independence Day\", date: `${year}-05-14`, type: \"holiday\", impactLevel: \"high\", demandIncrease: 35 },\r\n      { name: \"Shavuot\", date: `${year}-06-02`, type: \"holiday\", impactLevel: \"medium\", demandIncrease: 25 },\r\n      { name: \"Rosh Hashana\", date: `${year}-09-16`, type: \"holiday\", impactLevel: \"high\", demandIncrease: 45 },\r\n      { name: \"Yom Kippur\", date: `${year}-09-25`, type: \"holiday\", impactLevel: \"medium\", demandIncrease: 15 },\r\n      { name: \"Sukkot\", date: `${year}-09-30`, type: \"holiday\", impactLevel: \"high\", demandIncrease: 40 },\r\n      { name: \"Hanukkah\", date: `${year}-12-26`, type: \"holiday\", impactLevel: \"medium\", demandIncrease: 20 },\r\n      { name: \"Tel Aviv Marathon\", date: `${year}-02-28`, type: \"sport\", impactLevel: \"medium\", demandIncrease: 25 },\r\n      { name: \"DLD Conference\", date: `${year}-09-04`, type: \"conference\", impactLevel: \"high\", demandIncrease: 30 },\r\n    ]\r\n    \r\n    return {\r\n      success: true,\r\n      data: {\r\n        year,\r\n        hotelId: hotelId || \"default\",\r\n        monthlyPatterns,\r\n        weeklyPatterns,\r\n        statistics: {\r\n          averageMultiplier: Math.round(avgMultiplier * 100) / 100,\r\n          peakMonths,\r\n          lowMonths,\r\n          peakDays: [\"Friday\", \"Saturday\"],\r\n          lowDays: [\"Sunday\", \"Monday\"],\r\n          seasonalVariation: Math.round((Math.max(...monthlyPatterns.map(p => p.demandMultiplier)) - \r\n                                         Math.min(...monthlyPatterns.map(p => p.demandMultiplier))) * 100) + \"%\",\r\n        },\r\n        upcomingEvents: upcomingEvents.filter(e => new Date(e.date) > new Date()),\r\n        recommendations: [\r\n          `Peak season (${peakMonths.join(\", \")}): Maximize rates, minimum 3-night stays`,\r\n          `Low season (${lowMonths.join(\", \")}): Run promotions, partner with tour operators`,\r\n          \"Friday/Saturday: Premium weekend packages\",\r\n          \"Sunday-Thursday: Business traveler rates, corporate deals\",\r\n        ],\r\n      },\r\n      message: `Seasonality analysis for ${year}: Peak months are ${peakMonths.join(\", \")}, low months are ${lowMonths.join(\", \")}`,\r\n    }\r\n  } catch (error) {\r\n    return {\r\n      success: false,\r\n      error: `Failed to analyze seasonality: ${error}`,\r\n    }\r\n  }\r\n}\r\n\r\n// Detect Demand Anomalies\r\nasync function detectDemandAnomalies(\r\n  params: Record<string, unknown>,\r\n  context: ForecastContext\r\n): Promise<ForecastResult> {\r\n  const hotelId = params.hotelId as string\r\n  const period = (params.period as string) || \"month\"\r\n  const threshold = (params.threshold as number) || 20 // % deviation from expected\r\n\r\n  try {\r\n    // Generate historical data with some anomalies\r\n    const anomalies: Array<{\r\n      date: string\r\n      actualDemand: number\r\n      expectedDemand: number\r\n      deviation: number\r\n      type: \"surge\" | \"drop\"\r\n      possibleCauses: string[]\r\n      recommendation: string\r\n    }> = [\r\n      {\r\n        date: \"2026-01-10\",\r\n        actualDemand: 92,\r\n        expectedDemand: 65,\r\n        deviation: 41.5,\r\n        type: \"surge\",\r\n        possibleCauses: [\"Unplanned event\", \"Competitor outage\", \"Viral social media\"],\r\n        recommendation: \"Investigate cause for future planning; consider dynamic pricing\",\r\n      },\r\n      {\r\n        date: \"2026-01-15\",\r\n        actualDemand: 35,\r\n        expectedDemand: 60,\r\n        deviation: -41.7,\r\n        type: \"drop\",\r\n        possibleCauses: [\"Bad weather\", \"Negative review impact\", \"Local emergency\"],\r\n        recommendation: \"Review recent feedback; check for external factors\",\r\n      },\r\n      {\r\n        date: \"2026-01-22\",\r\n        actualDemand: 88,\r\n        expectedDemand: 70,\r\n        deviation: 25.7,\r\n        type: \"surge\",\r\n        possibleCauses: [\"Local conference\", \"Sports event nearby\"],\r\n        recommendation: \"Add to event calendar for next year\",\r\n      },\r\n    ]\r\n    \r\n    // Pattern analysis\r\n    const patterns = {\r\n      frequentSurges: {\r\n        count: 8,\r\n        commonDays: [\"Friday\", \"Saturday\"],\r\n        commonMonths: [\"July\", \"August\", \"September\"],\r\n      },\r\n      frequentDrops: {\r\n        count: 5,\r\n        commonDays: [\"Sunday\", \"Monday\"],\r\n        commonMonths: [\"January\", \"February\"],\r\n      },\r\n    }\r\n    \r\n    return {\r\n      success: true,\r\n      data: {\r\n        hotelId: hotelId || \"default\",\r\n        period,\r\n        threshold: threshold + \"%\",\r\n        anomaliesDetected: anomalies.length,\r\n        anomalies,\r\n        patterns,\r\n        summary: {\r\n          totalAnomalies: anomalies.length,\r\n          surges: anomalies.filter(a => a.type === \"surge\").length,\r\n          drops: anomalies.filter(a => a.type === \"drop\").length,\r\n          averageDeviation: Math.round(anomalies.reduce((sum, a) => sum + Math.abs(a.deviation), 0) / anomalies.length) + \"%\",\r\n        },\r\n        alerts: anomalies.filter(a => Math.abs(a.deviation) > 30).map(a => ({\r\n          severity: \"high\",\r\n          date: a.date,\r\n          message: `${a.type === \"surge\" ? \"Unexpected surge\" : \"Unexpected drop\"}: ${a.deviation.toFixed(1)}% deviation`,\r\n        })),\r\n        recommendations: [\r\n          anomalies.some(a => a.type === \"surge\") \r\n            ? \"Monitor for recurring surge patterns - opportunity for dynamic pricing\"\r\n            : null,\r\n          anomalies.some(a => a.type === \"drop\")\r\n            ? \"Investigate drop causes - may indicate operational or marketing issues\"\r\n            : null,\r\n          \"Set up automated alerts for deviations > 25%\",\r\n          \"Review anomaly causes quarterly for forecasting improvement\",\r\n        ].filter(Boolean),\r\n      },\r\n      message: `Detected ${anomalies.length} demand anomalies in ${period}: ${anomalies.filter(a => a.type === \"surge\").length} surges, ${anomalies.filter(a => a.type === \"drop\").length} drops`,\r\n    }\r\n  } catch (error) {\r\n    return {\r\n      success: false,\r\n      error: `Failed to detect demand anomalies: ${error}`,\r\n    }\r\n  }\r\n}\r\n\r\n// Helper Functions\r\nfunction getSeasonalMultiplier(month: number): number {\r\n  const multipliers = [0.75, 0.80, 0.95, 1.25, 1.10, 1.15, 1.35, 1.40, 1.30, 1.20, 0.85, 0.90]\r\n  return multipliers[month]\r\n}\r\n\r\nfunction checkHoliday(date: Date): boolean {\r\n  // Simplified holiday check (in production, use a proper calendar API)\r\n  const holidays = [\r\n    \"2026-03-14\", // Purim\r\n    \"2026-04-13\", \"2026-04-14\", \"2026-04-19\", \"2026-04-20\", // Passover\r\n    \"2026-05-14\", // Independence Day\r\n    \"2026-06-02\", // Shavuot\r\n    \"2026-09-16\", \"2026-09-17\", // Rosh Hashana\r\n    \"2026-09-25\", // Yom Kippur\r\n    \"2026-09-30\", \"2026-10-01\", \"2026-10-07\", // Sukkot\r\n  ]\r\n  return holidays.includes(date.toISOString().split(\"T\")[0])\r\n}\r\n\r\nfunction checkEvents(date: Date): Event | null {\r\n  const events: Event[] = [\r\n    { name: \"DLD Tel Aviv\", date: \"2026-09-04\", type: \"conference\", impactLevel: \"high\", demandIncrease: 30 },\r\n    { name: \"Tel Aviv Marathon\", date: \"2026-02-28\", type: \"sport\", impactLevel: \"medium\", demandIncrease: 25 },\r\n    { name: \"Pride Parade\", date: \"2026-06-12\", type: \"festival\", impactLevel: \"high\", demandIncrease: 40 },\r\n  ]\r\n  \r\n  const dateStr = date.toISOString().split(\"T\")[0]\r\n  return events.find(e => {\r\n    const eventDate = new Date(e.date)\r\n    const daysBefore = 2\r\n    const daysAfter = 1\r\n    const rangeStart = new Date(eventDate)\r\n    rangeStart.setDate(rangeStart.getDate() - daysBefore)\r\n    const rangeEnd = new Date(eventDate)\r\n    rangeEnd.setDate(rangeEnd.getDate() + daysAfter)\r\n    return date >= rangeStart && date <= rangeEnd\r\n  }) || null\r\n}\r\n\r\nfunction generatePricingReasoning(\r\n  roomType: string,\r\n  demandFactor: number,\r\n  isWeekend: boolean,\r\n  isHoliday: boolean,\r\n  event: Event | null\r\n): string[] {\r\n  const reasons: string[] = []\r\n  \r\n  if (demandFactor > 1.2) {\r\n    reasons.push(\"High demand conditions justify premium pricing\")\r\n  } else if (demandFactor < 0.9) {\r\n    reasons.push(\"Low demand suggests competitive pricing needed\")\r\n  }\r\n  \r\n  if (isWeekend) {\r\n    reasons.push(\"Weekend premium applies (+15%)\")\r\n  }\r\n  \r\n  if (isHoliday) {\r\n    reasons.push(\"Holiday period increases willingness to pay (+30%)\")\r\n  }\r\n  \r\n  if (event) {\r\n    reasons.push(`${event.name} event drives additional demand (+${event.demandIncrease}%)`)\r\n  }\r\n  \r\n  if (roomType === \"suite\") {\r\n    reasons.push(\"Premium room type commands higher rates\")\r\n  }\r\n  \r\n  return reasons\r\n}\r\n\r\nexport default demandForecastingHandler\r\n"],"names":["process","env","NEXT_RUNTIME","module","exports","require","__NEXT_EXPERIMENTAL_REACT","NODE_ENV","TURBOPACK","vendored","React"],"mappings":"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","ignoreList":[0,1,2]}