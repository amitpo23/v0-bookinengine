module.exports=[75428,e=>{"use strict";var t=e.i(74119),r=e.i(74815),o=e.i(66969),s=e.i(8984),n=e.i(80568),a=e.i(85983),i=e.i(51311),l=e.i(48892),d=e.i(16339),u=e.i(34600),c=e.i(71794),p=e.i(4358),h=e.i(80603),m=e.i(79181),g=e.i(53442),f=e.i(70798),k=e.i(93695);e.i(51004);var R=e.i(64291),y=e.i(14539),v=e.i(27338);class B{preBooks=new Map;PREBOOK_VALIDITY_MINUTES=30;savePreBook(e,t){let r=new Date;r.setMinutes(r.getMinutes()+this.PREBOOK_VALIDITY_MINUTES);let o={token:t.token,priceConfirmed:t.priceConfirmed,requestJson:t.requestJson,expiresAt:r,roomCode:e};return this.preBooks.set(e,o),setTimeout(()=>{this.preBooks.delete(e)},60*this.PREBOOK_VALIDITY_MINUTES*1e3),o}getPreBook(e){let t=this.preBooks.get(e);return t?new Date>t.expiresAt?(this.preBooks.delete(e),null):t:null}isValid(e){return null!==this.getPreBook(e)}getTimeRemaining(e){let t=this.getPreBook(e);if(!t)return 0;let r=new Date;return Math.max(0,Math.floor((t.expiresAt.getTime()-r.getTime())/1e3/60))}async refreshIfNeeded(e,t){if(5>this.getTimeRemaining(e))try{let r=await v.mediciApi.preBook({jsonRequest:t.requestJson});if(r.success)return this.savePreBook(e,r)}catch(e){console.error("Failed to refresh PreBook:",e)}return this.getPreBook(e)}cleanup(){let e=new Date;for(let[t,r]of this.preBooks.entries())e>r.expiresAt&&this.preBooks.delete(t)}}let C=new B;setInterval(()=>{C.cleanup()},3e5);let w=new class{defaultConfig={maxRetries:3,retryDelay:1e3,backoffMultiplier:2};async retryWithBackoff(e,t={}){let r={...this.defaultConfig,...t},o=null;for(let t=1;t<=r.maxRetries;t++)try{let r=await e();return{success:!0,data:r,attempts:t}}catch(e){if(o=e,console.warn(`[Retry] Attempt ${t}/${r.maxRetries} failed:`,e.message),this.isNonRetryableError(e))break;if(t<r.maxRetries){let e=r.retryDelay*Math.pow(r.backoffMultiplier,t-1);await this.sleep(e)}}return{success:!1,error:o?.message||"Operation failed after retries",attempts:r.maxRetries}}async preBookWithRetry(e){return this.retryWithBackoff(async()=>{let t=await v.mediciApi.preBook({jsonRequest:e.jsonRequest});if(!t.success||!t.token)throw Error("PreBook failed: "+(t.error||"No token received"));return C.savePreBook(e.roomCode,t),t})}async bookWithRetry(e){return this.retryWithBackoff(async()=>{let t=await v.mediciApi.book({jsonRequest:e.jsonRequest});if(!t.success)throw Error("Booking failed: "+(t.error||"Unknown error"));return t},{maxRetries:2,retryDelay:2e3})}async searchWithRetry(e){return this.retryWithBackoff(async()=>{let t=await v.mediciApi.searchHotels(e);if(!t||0===t.length)throw Error("No results found");return t})}isNonRetryableError(e){let t=e.message?.toLowerCase()||"";return!![400,401,403,404].includes(e.status||e.statusCode)||["not available","sold out","invalid token","expired","unauthorized","forbidden"].some(e=>t.includes(e))}sleep(e){return new Promise(t=>setTimeout(t,e))}async recoverFromPreBookFailure(e){console.log("[Recovery] Attempting to recover from PreBook failure...");let t=await this.searchWithRetry(e.originalSearchParams);if(!t.success||!t.data)return t;let r=t.data.find(t=>t.rooms.some(t=>t.code===e.roomCode));if(!r)return{success:!1,error:"Room no longer available",attempts:1};let o=r.rooms.find(t=>t.code===e.roomCode);return this.preBookWithRetry({jsonRequest:o.requestJson,roomCode:e.roomCode})}};var T=e.i(82520);class E{logs=[];sessionId=this.generateSessionId();log(e){let t={...e,timestamp:new Date,sessionId:this.sessionId};this.logs.push(t),this.sendToAnalytics(t)}logSearchStarted(e){this.log({eventType:"search_started",metadata:{dateFrom:e.dateFrom,dateTo:e.dateTo,hotelName:e.hotelName,city:e.city,adults:e.adults,children:e.children?.length||0}})}logSearchCompleted(e,t){this.log({eventType:"search_completed",metadata:{resultsCount:e,durationMs:t}})}logPreBookStarted(e,t){this.log({eventType:"prebook_started",hotelId:t,roomCode:e})}logPreBookCompleted(e){this.log({eventType:"prebook_completed",hotelId:e.hotelId,roomCode:e.roomCode,preBookId:e.preBookId,price:e.price,currency:e.currency,metadata:{token:e.token.substring(0,4)+"****"}})}logPreBookFailed(e,t){this.log({eventType:"prebook_failed",roomCode:e,error:t})}logPreBookExpired(e,t){this.log({eventType:"prebook_expired",roomCode:e,preBookId:t})}logBookStarted(e){this.log({eventType:"book_started",roomCode:e.roomCode,preBookId:e.preBookId,metadata:{guestEmail:e.guestEmail}})}logBookCompleted(e){this.log({eventType:"book_completed",bookingId:e.bookingId,price:e.price,currency:e.currency,metadata:{supplierReference:e.supplierReference,guestEmail:e.guestEmail}})}logBookFailed(e,t){this.log({eventType:"book_failed",preBookId:e,error:t})}logBookingCancelled(e,t){this.log({eventType:"booking_cancelled",bookingId:e,metadata:{reason:t}})}logEmailSent(e,t){this.log({eventType:"email_sent",bookingId:e,metadata:{to:t}})}logEmailFailed(e,t){this.log({eventType:"email_failed",bookingId:e,error:t})}getSessionLogs(){return this.logs.filter(e=>e.sessionId===this.sessionId)}getStats(){let e=this.getSessionLogs();return{totalSearches:e.filter(e=>"search_started"===e.eventType).length,successfulPreBooks:e.filter(e=>"prebook_completed"===e.eventType).length,failedPreBooks:e.filter(e=>"prebook_failed"===e.eventType).length,successfulBookings:e.filter(e=>"book_completed"===e.eventType).length,failedBookings:e.filter(e=>"book_failed"===e.eventType).length}}exportToCsv(){return[["Timestamp","Event Type","Session ID","Hotel ID","Room Code","PreBook ID","Booking ID","Price","Currency","Error"],...this.logs.map(e=>[(0,T.format)(e.timestamp,"yyyy-MM-dd HH:mm:ss"),e.eventType,e.sessionId,e.hotelId||"",e.roomCode||"",e.preBookId||"",e.bookingId||"",e.price?.toString()||"",e.currency||"",e.error||""])].map(e=>e.join(",")).join("\n")}sendToAnalytics(e){}generateSessionId(){return`session_${Date.now()}_${Math.random().toString(36).substring(7)}`}resetSession(){this.sessionId=this.generateSessionId()}}let x=new E;var P=e.i(90881);async function b(e){try{if(P.DEMO_MODE){let e=await (0,P.mockPreBook)();return y.NextResponse.json(e)}let{jsonRequest:t,roomCode:r,hotelId:o}=await e.json();if(!t||"string"!=typeof t)return y.NextResponse.json({error:"jsonRequest is required - must be the requestJson from search results",received:{jsonRequest:typeof t}},{status:400});if(!r)return y.NextResponse.json({error:"roomCode is required for PreBook management"},{status:400});x.logPreBookStarted(r,o||"unknown");let s=C.getPreBook(r);if(s){let e=C.getTimeRemaining(r);return x.log({eventType:"prebook_completed",roomCode:r,hotelId:o,preBookId:s.token,price:s.priceConfirmed,currency:"USD",metadata:{cached:!0,timeRemaining:e}}),y.NextResponse.json({success:!0,token:s.token,priceConfirmed:s.priceConfirmed,currency:"USD",status:"done",expiresAt:s.expiresAt,timeRemaining:e,cached:!0,message:`PreBook still valid for ${e} minutes`})}let n=await w.preBookWithRetry({jsonRequest:t,roomCode:r});if(!n.success||!n.data)return x.logPreBookFailed(r,n.error||"Unknown error"),y.NextResponse.json({success:!1,error:n.error||"PreBook failed - room may no longer be available",attempts:n.attempts},{status:400});let a=n.data,i=C.getPreBook(r);if(!i)return y.NextResponse.json({error:"Failed to save PreBook data"},{status:500});return x.logPreBookCompleted({roomCode:r,hotelId:o||"unknown",preBookId:a.preBookId?.toString()||"unknown",token:a.token,price:a.priceConfirmed,currency:a.currency||"USD"}),y.NextResponse.json({success:!0,preBookId:a.preBookId,token:a.token,priceConfirmed:a.priceConfirmed,currency:a.currency,status:a.status,expiresAt:i.expiresAt,timeRemaining:C.getTimeRemaining(r),cached:!1,attempts:n.attempts,requestJson:a.requestJson,responseJson:a.responseJson})}catch(e){return console.error("PreBook API Error:",e.message),x.log({eventType:"prebook_failed",error:e.message}),y.NextResponse.json({success:!1,error:e.message||"PreBook failed"},{status:500})}}async function I(e){try{let{searchParams:t}=new URL(e.url),r=t.get("roomCode");if(!r)return y.NextResponse.json({error:"roomCode parameter is required"},{status:400});let o=C.getPreBook(r);if(!o)return y.NextResponse.json({valid:!1,message:"PreBook not found or expired"});let s=C.getTimeRemaining(r);return y.NextResponse.json({valid:!0,token:o.token,priceConfirmed:o.priceConfirmed,expiresAt:o.expiresAt,timeRemaining:s,isWarning:s<5})}catch(e){return y.NextResponse.json({error:e.message},{status:500})}}e.s(["GET",()=>I,"POST",()=>b],97800);var A=e.i(97800);let _=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/booking/prebook-enhanced/route",pathname:"/api/booking/prebook-enhanced",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/v0-bookinengine/app/api/booking/prebook-enhanced/route.ts",nextConfigOutput:"",userland:A}),{workAsyncStorage:S,workUnitAsyncStorage:N,serverHooks:D}=_;function M(){return(0,o.patchFetch)({workAsyncStorage:S,workUnitAsyncStorage:N})}async function q(e,t,o){_.isDev&&(0,s.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let y="/api/booking/prebook-enhanced/route";y=y.replace(/\/index$/,"")||"/";let v=await _.prepare(e,t,{srcPage:y,multiZoneDraftMode:!1});if(!v)return t.statusCode=400,t.end("Bad Request"),null==o.waitUntil||o.waitUntil.call(o,Promise.resolve()),null;let{buildId:B,params:C,nextConfig:w,parsedUrl:T,isDraftMode:E,prerenderManifest:x,routerServerContext:P,isOnDemandRevalidate:b,revalidateOnlyGenerated:I,resolvedPathname:A,clientReferenceManifest:S,serverActionsManifest:N}=v,D=(0,l.normalizeAppPath)(y),M=!!(x.dynamicRoutes[D]||x.routes[A]),q=async()=>((null==P?void 0:P.render404)?await P.render404(e,t,T,!1):t.end("This page could not be found"),null);if(M&&!E){let e=!!x.routes[A],t=x.dynamicRoutes[D];if(t&&!1===t.fallback&&!e){if(w.experimental.adapterPath)return await q();throw new k.NoFallbackError}}let O=null;!M||_.isDev||E||(O="/index"===(O=A)?"/":O);let j=!0===_.isDev||!M,U=M&&!j;N&&S&&(0,a.setReferenceManifestsSingleton)({page:y,clientReferenceManifest:S,serverActionsManifest:N,serverModuleMap:(0,i.createServerModuleMap)({serverActionsManifest:N})});let H=e.method||"GET",F=(0,n.getTracer)(),$=F.getActiveScopeSpan(),W={params:C,prerenderManifest:x,renderOpts:{experimental:{authInterrupts:!!w.experimental.authInterrupts},cacheComponents:!!w.cacheComponents,supportsDynamicResponse:j,incrementalCache:(0,s.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:w.cacheLife,waitUntil:o.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,o)=>_.onRequestError(e,t,o,P)},sharedContext:{buildId:B}},L=new d.NodeNextRequest(e),K=new d.NodeNextResponse(t),J=u.NextRequestAdapter.fromNodeNextRequest(L,(0,u.signalFromNodeResponse)(t));try{let a=async e=>_.handle(J,W).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=F.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let o=r.get("next.route");if(o){let t=`${H} ${o}`;e.setAttributes({"next.route":o,"http.route":o,"next.span_name":t}),e.updateName(t)}else e.updateName(`${H} ${y}`)}),i=!!(0,s.getRequestMeta)(e,"minimalMode"),l=async s=>{var n,l;let d=async({previousCacheEntry:r})=>{try{if(!i&&b&&I&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await a(s);e.fetchMetrics=W.renderOpts.fetchMetrics;let l=W.renderOpts.pendingWaitUntil;l&&o.waitUntil&&(o.waitUntil(l),l=void 0);let d=W.renderOpts.collectedTags;if(!M)return await (0,h.sendResponse)(L,K,n,W.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,m.toNodeOutgoingHttpHeaders)(n.headers);d&&(t[f.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==W.renderOpts.collectedRevalidate&&!(W.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&W.renderOpts.collectedRevalidate,o=void 0===W.renderOpts.collectedExpire||W.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:W.renderOpts.collectedExpire;return{value:{kind:R.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:o}}}}catch(t){throw(null==r?void 0:r.isStale)&&await _.onRequestError(e,t,{routerKind:"App Router",routePath:y,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:U,isOnDemandRevalidate:b})},P),t}},u=await _.handleResponse({req:e,nextConfig:w,cacheKey:O,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:x,isRoutePPREnabled:!1,isOnDemandRevalidate:b,revalidateOnlyGenerated:I,responseGenerator:d,waitUntil:o.waitUntil,isMinimalMode:i});if(!M)return null;if((null==u||null==(n=u.value)?void 0:n.kind)!==R.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(l=u.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});i||t.setHeader("x-nextjs-cache",b?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),E&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let c=(0,m.fromNodeOutgoingHttpHeaders)(u.value.headers);return i&&M||c.delete(f.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||c.get("Cache-Control")||c.set("Cache-Control",(0,g.getCacheControlHeader)(u.cacheControl)),await (0,h.sendResponse)(L,K,new Response(u.value.body,{headers:c,status:u.value.status||200})),null};$?await l($):await F.withPropagatedContext(e.headers,()=>F.trace(c.BaseServerSpan.handleRequest,{spanName:`${H} ${y}`,kind:n.SpanKind.SERVER,attributes:{"http.method":H,"http.target":e.url}},l))}catch(t){if(t instanceof k.NoFallbackError||await _.onRequestError(e,t,{routerKind:"App Router",routePath:D,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:U,isOnDemandRevalidate:b})}),M)throw t;return await (0,h.sendResponse)(L,K,new Response(null,{status:500})),null}}e.s(["handler",()=>q,"patchFetch",()=>M,"routeModule",()=>_,"serverHooks",()=>D,"workAsyncStorage",()=>S,"workUnitAsyncStorage",()=>N],75428)}];

//# sourceMappingURL=52597_next_dist_esm_build_templates_app-route_1702a306.js.map