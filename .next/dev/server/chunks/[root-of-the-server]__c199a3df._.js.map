{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/97250/Desktop/booking%20engine/v0-bookinengine/lib/api/medici-types.ts"],"sourcesContent":["// Types and constants for Medici API - safe for client-side use\r\n// No environment variables accessed here\r\n\r\nexport interface HotelSearchResult {\r\n  hotelId: number\r\n  hotelName: string\r\n  hotelImage: string\r\n  images: string[]\r\n  location: string\r\n  city: string\r\n  stars: number\r\n  address: string\r\n  description: string\r\n  facilities: string[]\r\n  rooms: RoomResult[]\r\n  requestJson?: string // Original requestJson from API response - used for PreBook\r\n  responseJson?: any // Original responseJson from API response\r\n  // Extended data from ShowExtendedData: true\r\n  phone?: string\r\n  fax?: string\r\n  lat?: number\r\n  lon?: number\r\n  seoname?: string\r\n  destinations?: { destinationId: number; type: string }[]\r\n  surroundings?: { destinationId: number; type: string }[]\r\n}\r\n\r\nexport interface CancellationFrame {\r\n  from: string\r\n  to: string\r\n  penalty: {\r\n    amount: number\r\n    currency: string\r\n  }\r\n}\r\n\r\nexport interface CancellationInfo {\r\n  type: \"fully-refundable\" | \"non-refundable\" | \"partially-refundable\"\r\n  frames: CancellationFrame[]\r\n}\r\n\r\nexport interface Provider {\r\n  id: number\r\n  name: string\r\n}\r\n\r\nexport interface RoomResult {\r\n  code: string // The booking code from API (e.g., \"697024:standard:double:RO:6881f6a596dd21.40624605$1003X1095n1095t\")\r\n  roomId: string\r\n  roomName: string\r\n  roomCategory: string\r\n  categoryId: number\r\n  roomImage: string\r\n  images: string[]\r\n  bedding: string\r\n  board: string\r\n  boardId: number\r\n  boardType: string\r\n  maxOccupancy: number\r\n  size: number\r\n  view: string\r\n  amenities: string[]\r\n  price: number\r\n  buyPrice: number\r\n  originalPrice: number\r\n  currency: string\r\n  cancellationPolicy: string\r\n  cancellation?: CancellationInfo | null\r\n  available: number\r\n  requestJson?: string // Room code for prebook\r\n  pax?: { adults: number; children: number[] } // Occupancy info\r\n  // Extended data from ShowExtendedData: true\r\n  confirmation?: string // \"immediate\" | \"on_request\"\r\n  paymentType?: string // \"pre\" | \"post\"\r\n  providers?: Provider[]\r\n  specialOffers?: any[]\r\n}\r\n\r\nexport interface PreBookResponse {\r\n  success: boolean\r\n  preBookId: number\r\n  token: string // The token from content.services.hotels[0].token\r\n  status: string // Status from API (e.g., \"done\")\r\n  priceConfirmed: number\r\n  currency: string\r\n  requestJson?: string // The requestJson from PreBook response\r\n  responseJson?: string // The responseJson from PreBook response\r\n  error?: string\r\n}\r\n\r\nexport interface BookResponse {\r\n  success: boolean\r\n  bookingId: string // bookingID from bookRes.content.bookingID\r\n  supplierReference: string // supplier.reference from bookRes.content.services[0].supplier.reference\r\n  status: string // Status from API (e.g., \"confirmed\")\r\n  error?: string\r\n}\r\n\r\n// Board type translations\r\nexport const BOARD_TYPES: Record<number, string> = {\r\n  1: \"Room Only\",\r\n  2: \"Bed & Breakfast\",\r\n  3: \"Half Board\",\r\n  4: \"Full Board\",\r\n  5: \"All Inclusive\",\r\n}\r\n\r\n// Room category translations\r\nexport const ROOM_CATEGORIES: Record<number, string> = {\r\n  1: \"Standard\",\r\n  2: \"Superior\",\r\n  3: \"Deluxe\",\r\n  4: \"Suite\",\r\n  5: \"Executive\",\r\n}\r\n"],"names":[],"mappings":"AAAA,gEAAgE;AAChE,yCAAyC;;;;;;;AAkGlC,MAAM,cAAsC;IACjD,GAAG;IACH,GAAG;IACH,GAAG;IACH,GAAG;IACH,GAAG;AACL;AAGO,MAAM,kBAA0C;IACrD,GAAG;IACH,GAAG;IACH,GAAG;IACH,GAAG;IACH,GAAG;AACL"}},
    {"offset": {"line": 66, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/97250/Desktop/booking%20engine/v0-bookinengine/lib/logging/api-logger.ts"],"sourcesContent":["// Comprehensive API Logging System\r\n// Tracks all API calls, responses, and errors\r\n\r\nimport { createClient } from \"@supabase/supabase-js\"\r\n\r\n// Log levels\r\nexport type LogLevel = \"debug\" | \"info\" | \"warn\" | \"error\"\r\n\r\n// Log entry structure\r\nexport interface ApiLogEntry {\r\n  id?: string\r\n  timestamp: string\r\n  level: LogLevel\r\n  category: \"api\" | \"medici\" | \"booking\" | \"auth\" | \"system\"\r\n  action: string\r\n  method?: string\r\n  endpoint?: string\r\n  requestBody?: any\r\n  responseBody?: any\r\n  statusCode?: number\r\n  duration?: number\r\n  userId?: string\r\n  sessionId?: string\r\n  ip?: string\r\n  userAgent?: string\r\n  error?: string\r\n  metadata?: Record<string, any>\r\n}\r\n\r\n// In-memory buffer for logs (also saved to Supabase if configured)\r\nconst logBuffer: ApiLogEntry[] = []\r\nconst MAX_BUFFER_SIZE = 1000\r\n\r\n// Supabase client for persistent logging\r\nlet supabase: ReturnType<typeof createClient> | null = null\r\n\r\nfunction getSupabase() {\r\n  if (!supabase && process.env.NEXT_PUBLIC_SUPABASE_URL && process.env.SUPABASE_SERVICE_KEY) {\r\n    supabase = createClient(\r\n      process.env.NEXT_PUBLIC_SUPABASE_URL,\r\n      process.env.SUPABASE_SERVICE_KEY\r\n    )\r\n  }\r\n  return supabase\r\n}\r\n\r\n// Color codes for console output\r\nconst colors = {\r\n  reset: \"\\x1b[0m\",\r\n  bright: \"\\x1b[1m\",\r\n  dim: \"\\x1b[2m\",\r\n  red: \"\\x1b[31m\",\r\n  green: \"\\x1b[32m\",\r\n  yellow: \"\\x1b[33m\",\r\n  blue: \"\\x1b[34m\",\r\n  magenta: \"\\x1b[35m\",\r\n  cyan: \"\\x1b[36m\",\r\n  white: \"\\x1b[37m\",\r\n  bgRed: \"\\x1b[41m\",\r\n  bgGreen: \"\\x1b[42m\",\r\n  bgYellow: \"\\x1b[43m\",\r\n  bgBlue: \"\\x1b[44m\",\r\n}\r\n\r\nfunction getLevelColor(level: LogLevel): string {\r\n  switch (level) {\r\n    case \"debug\": return colors.dim\r\n    case \"info\": return colors.cyan\r\n    case \"warn\": return colors.yellow\r\n    case \"error\": return colors.red\r\n    default: return colors.white\r\n  }\r\n}\r\n\r\nfunction getCategoryIcon(category: ApiLogEntry[\"category\"]): string {\r\n  switch (category) {\r\n    case \"api\": return \"üåê\"\r\n    case \"medici\": return \"üè®\"\r\n    case \"booking\": return \"üìã\"\r\n    case \"auth\": return \"üîê\"\r\n    case \"system\": return \"‚öôÔ∏è\"\r\n    default: return \"üìù\"\r\n  }\r\n}\r\n\r\nfunction formatDuration(ms: number): string {\r\n  if (ms < 1000) return `${ms}ms`\r\n  return `${(ms / 1000).toFixed(2)}s`\r\n}\r\n\r\nfunction truncate(str: string, maxLen: number = 200): string {\r\n  if (!str) return \"\"\r\n  if (str.length <= maxLen) return str\r\n  return str.substring(0, maxLen) + \"...\"\r\n}\r\n\r\n// Main logger class\r\nclass ApiLogger {\r\n  private static instance: ApiLogger\r\n  private enabled: boolean = true\r\n\r\n  private constructor() {}\r\n\r\n  static getInstance(): ApiLogger {\r\n    if (!ApiLogger.instance) {\r\n      ApiLogger.instance = new ApiLogger()\r\n    }\r\n    return ApiLogger.instance\r\n  }\r\n\r\n  setEnabled(enabled: boolean) {\r\n    this.enabled = enabled\r\n  }\r\n\r\n  private formatLogForConsole(entry: ApiLogEntry): string {\r\n    const time = new Date(entry.timestamp).toLocaleTimeString(\"he-IL\")\r\n    const icon = getCategoryIcon(entry.category)\r\n    const levelColor = getLevelColor(entry.level)\r\n    \r\n    let output = `${colors.dim}[${time}]${colors.reset} ${icon} ${levelColor}[${entry.level.toUpperCase()}]${colors.reset} `\r\n    output += `${colors.bright}${entry.action}${colors.reset}`\r\n    \r\n    if (entry.method && entry.endpoint) {\r\n      const methodColor = entry.method === \"GET\" ? colors.green : \r\n                         entry.method === \"POST\" ? colors.blue : \r\n                         entry.method === \"PUT\" ? colors.yellow : colors.red\r\n      output += ` ${methodColor}${entry.method}${colors.reset} ${entry.endpoint}`\r\n    }\r\n    \r\n    if (entry.statusCode) {\r\n      const statusColor = entry.statusCode < 300 ? colors.green : \r\n                         entry.statusCode < 400 ? colors.yellow : colors.red\r\n      output += ` ${statusColor}[${entry.statusCode}]${colors.reset}`\r\n    }\r\n    \r\n    if (entry.duration) {\r\n      output += ` ${colors.magenta}(${formatDuration(entry.duration)})${colors.reset}`\r\n    }\r\n    \r\n    return output\r\n  }\r\n\r\n  async log(entry: Omit<ApiLogEntry, \"id\" | \"timestamp\">): Promise<void> {\r\n    if (!this.enabled) return\r\n\r\n    const fullEntry: ApiLogEntry = {\r\n      ...entry,\r\n      timestamp: new Date().toISOString(),\r\n    }\r\n\r\n    // Console output\r\n    console.log(this.formatLogForConsole(fullEntry))\r\n    \r\n    // Additional details for errors or debug\r\n    if (entry.level === \"error\" && entry.error) {\r\n      console.error(`${colors.red}  Error: ${entry.error}${colors.reset}`)\r\n    }\r\n    \r\n    if (entry.requestBody && (entry.level === \"debug\" || entry.level === \"error\")) {\r\n      console.log(`${colors.dim}  Request: ${truncate(JSON.stringify(entry.requestBody))}${colors.reset}`)\r\n    }\r\n    \r\n    if (entry.responseBody && entry.level === \"error\") {\r\n      console.log(`${colors.dim}  Response: ${truncate(JSON.stringify(entry.responseBody))}${colors.reset}`)\r\n    }\r\n\r\n    // Add to buffer\r\n    logBuffer.push(fullEntry)\r\n    if (logBuffer.length > MAX_BUFFER_SIZE) {\r\n      logBuffer.shift()\r\n    }\r\n\r\n    // Save to Supabase (async, non-blocking)\r\n    this.saveToSupabase(fullEntry).catch(() => {})\r\n  }\r\n\r\n  private async saveToSupabase(entry: ApiLogEntry): Promise<void> {\r\n    const db = getSupabase()\r\n    if (!db) return\r\n\r\n    try {\r\n      // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n      await (db.from(\"api_logs\") as any).insert({\r\n        timestamp: entry.timestamp,\r\n        level: entry.level,\r\n        category: entry.category,\r\n        action: entry.action,\r\n        method: entry.method,\r\n        endpoint: entry.endpoint,\r\n        request_body: entry.requestBody,\r\n        response_body: entry.responseBody,\r\n        status_code: entry.statusCode,\r\n        duration_ms: entry.duration,\r\n        user_id: entry.userId,\r\n        session_id: entry.sessionId,\r\n        ip_address: entry.ip,\r\n        user_agent: entry.userAgent,\r\n        error_message: entry.error,\r\n        metadata: entry.metadata,\r\n      })\r\n    } catch (error) {\r\n      // Silent fail - don't let logging break the app\r\n    }\r\n  }\r\n\r\n  // Convenience methods\r\n  debug(category: ApiLogEntry[\"category\"], action: string, metadata?: Record<string, any>) {\r\n    this.log({ level: \"debug\", category, action, metadata })\r\n  }\r\n\r\n  info(category: ApiLogEntry[\"category\"], action: string, metadata?: Record<string, any>) {\r\n    this.log({ level: \"info\", category, action, metadata })\r\n  }\r\n\r\n  warn(category: ApiLogEntry[\"category\"], action: string, metadata?: Record<string, any>) {\r\n    this.log({ level: \"warn\", category, action, metadata })\r\n  }\r\n\r\n  error(category: ApiLogEntry[\"category\"], action: string, error?: string, metadata?: Record<string, any>) {\r\n    this.log({ level: \"error\", category, action, error, metadata })\r\n  }\r\n\r\n  // API request logging\r\n  async logApiRequest(params: {\r\n    method: string\r\n    endpoint: string\r\n    requestBody?: any\r\n    responseBody?: any\r\n    statusCode: number\r\n    duration: number\r\n    userId?: string\r\n    ip?: string\r\n    userAgent?: string\r\n    error?: string\r\n  }) {\r\n    const level: LogLevel = params.statusCode >= 500 ? \"error\" : \r\n                           params.statusCode >= 400 ? \"warn\" : \"info\"\r\n    \r\n    await this.log({\r\n      level,\r\n      category: \"api\",\r\n      action: `API Request`,\r\n      ...params,\r\n    })\r\n  }\r\n\r\n  // Medici API logging\r\n  async logMediciCall(params: {\r\n    action: string\r\n    endpoint: string\r\n    requestBody?: any\r\n    responseBody?: any\r\n    statusCode: number\r\n    duration: number\r\n    error?: string\r\n  }) {\r\n    const level: LogLevel = params.statusCode >= 500 ? \"error\" : \r\n                           params.statusCode >= 400 ? \"warn\" : \"info\"\r\n    \r\n    await this.log({\r\n      level,\r\n      category: \"medici\",\r\n      method: \"POST\",\r\n      ...params,\r\n    })\r\n  }\r\n\r\n  // Get recent logs\r\n  getRecentLogs(count: number = 100, filter?: Partial<ApiLogEntry>): ApiLogEntry[] {\r\n    let logs = [...logBuffer].reverse()\r\n    \r\n    if (filter) {\r\n      logs = logs.filter(log => {\r\n        if (filter.level && log.level !== filter.level) return false\r\n        if (filter.category && log.category !== filter.category) return false\r\n        if (filter.action && !log.action.includes(filter.action)) return false\r\n        return true\r\n      })\r\n    }\r\n    \r\n    return logs.slice(0, count)\r\n  }\r\n\r\n  // Clear buffer\r\n  clearBuffer() {\r\n    logBuffer.length = 0\r\n  }\r\n}\r\n\r\n// Export singleton instance\r\nexport const apiLogger = ApiLogger.getInstance()\r\n\r\n// Export helper for timing operations\r\nexport function withTiming<T>(operation: () => Promise<T>): Promise<{ result: T; duration: number }> {\r\n  const start = Date.now()\r\n  return operation().then(result => ({\r\n    result,\r\n    duration: Date.now() - start\r\n  }))\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 315, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/97250/Desktop/booking%20engine/v0-bookinengine/lib/api/medici-client.ts"],"sourcesContent":["// Medici Hotels API Client\r\n// Complete AI-Executable Integration\r\n// Base URL: https://medici-backend.azurewebsites.net\r\n\r\nimport type { HotelSearchResult, PreBookResponse, BookResponse } from \"./medici-types\"\r\nimport \"server-only\"\r\nexport * from \"./medici-types\"\r\n\r\n// Import logger\r\nimport { apiLogger } from \"@/lib/logging/api-logger\"\r\n\r\nconst MEDICI_BASE_URL = process.env.MEDICI_BASE_URL || \"https://medici-backend.azurewebsites.net\"\r\nconst MEDICI_IMAGES_BASE = \"https://medici-images.azurewebsites.net/images/\"\r\n\r\n// KNOWAA TOKEN (partnerships@knowaaglobal.com, UserId:24, AetherTokenStorageId:4, expires 2084) \r\n// PRIMARY TOKEN - Knowaa provider - Fresh from OnlyNightUsersTokenAPI\r\nconst KNOWAA_TOKEN = \"eyJhbGciOiJodHRwOi8vd3d3LnczLm9yZy8yMDAxLzA0L3htbGRzaWctbW9yZSNobWFjLXNoYTI1NiIsInR5cCI6IkpXVCJ9.eyJQZXJtaXNzaW9ucyI6IjEiLCJVc2VySWQiOiIyNCIsIm5iZiI6MTc2OTEwODU0MiwiZXhwIjoyMDg0NjQxMzQyLCJpc3MiOiJodHRwczovL2FkbWluLm1lZGljaWhvdGVscy5jb20vIiwiYXVkIjoiaHR0cHM6Ly9hZG1pbi5tZWRpY2lob3RlbHMuY29tLyJ9.HlssMhdMpHq45f2u8ZdrXA7NWBDCwgO67CIG_lnjL0w\"\r\n\r\n// B2B MEDICI TOKEN (UserId:11, expires 2083) - BACKUP ONLY (has issues)\r\nconst MEDICI_TOKEN_LEGACY = \"eyJhbGciOiJodHRwOi8vd3d3LnczLm9yZy8yMDAxLzA0L3htbGRzaWctbW9yZSNobWFjLXNoYTI1NiIsInR5cCI6IkpXVCJ9.eyJQZXJtaXNzaW9ucyI6IjEiLCJVc2VySWQiOiIxMSIsIm5iZiI6MTc2ODQ1NzU5NSwiZXhwIjoyMDgzOTkwMzk1LCJpc3MiOiJodHRwczovL2FkbWluLm1lZGljaWhvdGVscy5jb20vIiwiYXVkIjoiaHR0cHM6Ly9hZG1pbi5tZWRpY2lob3RlbHMuY29tLyJ9.g-CO7I75BlowE-F3J3GqlXsbIgNtG8_w2v1WMwG6djE\"\r\n\r\n// Use KNOWAA token as primary - already defined in code, no env var needed!\r\nconst MEDICI_TOKEN = KNOWAA_TOKEN\r\n\r\n// KNOWAA LIVE Aether Token - Required for Scarlet Hotel (863233) and full inventory\r\nconst KNOWAA_LIVE_AETHER_TOKEN = \"$2y$10$WrOg1sVjhWS32f3FA7/JTep2JvIialrDDNJD4uNNWhAm8DLBifGku\"\r\n\r\n// =====================\r\n// TYPES\r\n// =====================\r\n\r\n// Types are imported from medici-types.ts\r\n\r\n// =====================\r\n// REFERENCE TABLES\r\n// =====================\r\n\r\nexport const BOARD_TYPES: Record<number, { code: string; name: string; nameHe: string }> = {\r\n  1: { code: \"RO\", name: \"Room Only\", nameHe: \"◊ú◊ô◊†◊î ◊ë◊ú◊ë◊ì\" },\r\n  2: { code: \"BB\", name: \"Bed & Breakfast\", nameHe: \"◊ê◊®◊ï◊ó◊™ ◊ë◊ï◊ß◊®\" },\r\n  3: { code: \"HB\", name: \"Half Board\", nameHe: \"◊ó◊¶◊ô ◊§◊†◊°◊ô◊ï◊ü\" },\r\n  4: { code: \"FB\", name: \"Full Board\", nameHe: \"◊§◊†◊°◊ô◊ï◊ü ◊û◊ú◊ê\" },\r\n  5: { code: \"AI\", name: \"All Inclusive\", nameHe: \"◊î◊õ◊ú ◊õ◊ú◊ï◊ú\" },\r\n}\r\n\r\nexport const ROOM_CATEGORIES: Record<number, { name: string; nameHe: string }> = {\r\n  1: { name: \"Standard\", nameHe: \"◊°◊ò◊†◊ì◊®◊ò\" },\r\n  2: { name: \"Superior\", nameHe: \"◊°◊ï◊§◊®◊ô◊ï◊®\" },\r\n  3: { name: \"Deluxe\", nameHe: \"◊ì◊ú◊ï◊ß◊°\" },\r\n  4: { name: \"Suite\", nameHe: \"◊°◊ï◊ï◊ô◊ò◊î\" },\r\n  5: { name: \"Junior Suite\", nameHe: \"◊°◊ï◊ï◊ô◊ò◊™ ◊í'◊ï◊†◊ô◊ï◊®\" },\r\n  6: { name: \"Family\", nameHe: \"◊û◊©◊§◊ó◊™◊ô\" },\r\n}\r\n\r\n// =====================\r\n// API CLIENT CLASS\r\n// =====================\r\n\r\nexport class MediciApiClient {\r\n  private baseUrl: string\r\n  private token: string\r\n  private retries: number\r\n  private maxRetries: number\r\n\r\n  constructor(token?: string) {\r\n    this.token = token || MEDICI_TOKEN\r\n    this.baseUrl = MEDICI_BASE_URL\r\n    this.retries = 0\r\n    this.maxRetries = 2\r\n  }\r\n\r\n  private async request<T>(endpoint: string, options: RequestInit = {}): Promise<T> {\r\n    const url = `${this.baseUrl}${endpoint}`\r\n    const startTime = Date.now()\r\n\r\n    const headers: Record<string, string> = {\r\n      \"Content-Type\": \"application/json\",\r\n      Authorization: `Bearer ${this.token}`,\r\n      ...(options.headers as Record<string, string>),\r\n    }\r\n\r\n    // Log request start\r\n    apiLogger.debug(\"medici\", `Medici API Request: ${endpoint}`, {\r\n      url,\r\n      method: options.method || \"GET\",\r\n    })\r\n\r\n    try {\r\n      const response = await fetch(url, {\r\n        ...options,\r\n        headers,\r\n      })\r\n\r\n      const duration = Date.now() - startTime\r\n\r\n      if (response.status === 204) {\r\n        apiLogger.info(\"medici\", `Medici API Success (204 No Content)`, {\r\n          endpoint,\r\n          duration,\r\n        })\r\n        return { _status: 204 } as T\r\n      }\r\n\r\n      if (!response.ok) {\r\n        const errorBody = await response.text()\r\n\r\n        // Log error\r\n        await apiLogger.logMediciCall({\r\n          action: \"Medici API Error\",\r\n          endpoint,\r\n          requestBody: options.body ? JSON.parse(options.body as string) : undefined,\r\n          statusCode: response.status,\r\n          duration,\r\n          error: errorBody,\r\n        })\r\n\r\n        if (response.status === 401 && this.retries < this.maxRetries) {\r\n          this.retries++\r\n          apiLogger.warn(\"medici\", `Token expired, refreshing (attempt ${this.retries})`)\r\n          await this.refreshToken()\r\n          return this.request<T>(endpoint, options)\r\n        }\r\n\r\n        throw new Error(`API Error ${response.status}: ${errorBody}`)\r\n      }\r\n\r\n      const data = await response.json()\r\n      this.retries = 0\r\n\r\n      // Log successful response\r\n      await apiLogger.logMediciCall({\r\n        action: \"Medici API Success\",\r\n        endpoint,\r\n        requestBody: options.body ? JSON.parse(options.body as string) : undefined,\r\n        responseBody: { itemCount: Array.isArray(data) ? data.length : (data?.items?.length || 1) },\r\n        statusCode: response.status,\r\n        duration,\r\n      })\r\n\r\n      return data\r\n    } catch (error) {\r\n      const duration = Date.now() - startTime\r\n      \r\n      if (error instanceof Error) {\r\n        apiLogger.error(\"medici\", `Medici API Exception: ${endpoint}`, error.message, { duration })\r\n        throw error\r\n      }\r\n      throw new Error(\"Unknown error occurred\")\r\n    }\r\n  }\r\n\r\n  // =====================\r\n  // STEP 1: SEARCH HOTELS\r\n  // =====================\r\n  async searchHotels(params: {\r\n    dateFrom: string\r\n    dateTo: string\r\n    hotelName?: string\r\n    city?: string\r\n    rooms?: Array<{ adults: number; children: number[] }> // Array of rooms\r\n    adults?: number // Fallback for single room\r\n    children?: number[] // Fallback for single room\r\n    stars?: number\r\n    limit?: number\r\n  }): Promise<HotelSearchResult[]> {\r\n    console.log(\"üîç MediciApi.searchHotels called with params:\", params)\r\n    \r\n    const pax = params.rooms || [\r\n      {\r\n        adults: params.adults || 2,\r\n        children: params.children || [],\r\n      },\r\n    ]\r\n\r\n    const searchBody: any = {\r\n      dateFrom: params.dateFrom,\r\n      dateTo: params.dateTo,\r\n      pax,\r\n      stars: params.stars || null,\r\n      limit: params.limit || null,\r\n      ShowExtendedData: true, // Get images, description, facilities from Medici\r\n      aetherAccessToken: KNOWAA_LIVE_AETHER_TOKEN, // Required for Scarlet Hotel and full inventory\r\n    }\r\n\r\n    if (params.hotelName) {\r\n      searchBody.hotelName = params.hotelName\r\n    } else if (params.city) {\r\n      searchBody.city = params.city\r\n    }\r\n\r\n    console.log(\"üåê Making request to Medici API:\")\r\n    console.log(\"URL:\", `${this.baseUrl}/api/hotels/GetInnstantSearchPrice`)\r\n    console.log(\"Body:\", JSON.stringify(searchBody, null, 2))\r\n    console.log(\"Token (first 20 chars):\", this.token.substring(0, 20) + \"...\")\r\n\r\n    try {\r\n      const response = await this.request<any>(\"/api/hotels/GetInnstantSearchPrice\", {\r\n        method: \"POST\",\r\n        body: JSON.stringify(searchBody),\r\n      })\r\n\r\n      console.log(\"‚úÖ Medici API response received, length:\", JSON.stringify(response).length)\r\n      const hotels = this.transformSearchResults(response)\r\n      console.log(\"üè® Transformed to\", hotels.length, \"hotels\")\r\n\r\n      return hotels.map((hotel) => ({\r\n        ...hotel,\r\n        requestJson: JSON.stringify(params),\r\n        responseJson: JSON.stringify(response),\r\n      }))\r\n    } catch (error) {\r\n      console.error(\"‚ùå Medici API search failed:\", error)\r\n      \r\n      // Return empty array instead of throwing - let the caller handle it\r\n      return []\r\n    }\r\n  }\r\n\r\n  // =====================\r\n  // STEP 2: PRE-BOOK\r\n  // =====================\r\n  async preBook(params: {\r\n    jsonRequest: string\r\n  }): Promise<PreBookResponse> {\r\n    const preBookBody = {\r\n      jsonRequest: params.jsonRequest,\r\n    }\r\n\r\n    const response = await this.request<any>(\"/api/hotels/PreBook\", {\r\n      method: \"POST\",\r\n      body: JSON.stringify(preBookBody),\r\n    })\r\n\r\n    if (response._status === 204) {\r\n      return {\r\n        success: true,\r\n        preBookId: 0,\r\n        token: \"\",\r\n        status: \"done\",\r\n        priceConfirmed: 0,\r\n        currency: \"USD\",\r\n        requestJson: params.jsonRequest,\r\n        responseJson: \"\",\r\n      }\r\n    }\r\n\r\n    const token = response?.content?.services?.hotels?.[0]?.token || response?.token || response?.preBookToken || \"\"\r\n\r\n    const preBookId = response?.opportunityId || response?.preBookId || response?.id || 0\r\n\r\n    const priceConfirmed =\r\n      response?.content?.services?.hotels?.[0]?.netPrice?.amount ||\r\n      response?.content?.services?.hotels?.[0]?.price?.amount ||\r\n      response?.price?.amount ||\r\n      0\r\n\r\n    const currency =\r\n      response?.content?.services?.hotels?.[0]?.netPrice?.currency ||\r\n      response?.content?.services?.hotels?.[0]?.price?.currency ||\r\n      \"USD\"\r\n\r\n    const isSuccess = token || response?.status === \"done\"\r\n\r\n    return {\r\n      success: isSuccess,\r\n      preBookId,\r\n      token,\r\n      status: response?.status || (isSuccess ? \"done\" : \"failed\"),\r\n      priceConfirmed,\r\n      currency,\r\n      requestJson: params.jsonRequest,\r\n      responseJson: response,\r\n    }\r\n  }\r\n\r\n  // =====================\r\n  // STEP 3: BOOK\r\n  // =====================\r\n  async book(params: {\r\n    jsonRequest: string\r\n  }): Promise<BookResponse> {\r\n    const bookBody = {\r\n      jsonRequest: params.jsonRequest,\r\n    }\r\n\r\n    try {\r\n      const response = await this.request<any>(\"/api/hotels/Book\", {\r\n        method: \"POST\",\r\n        body: JSON.stringify(bookBody),\r\n      })\r\n\r\n      console.log('[DEBUG] Book API Response:', JSON.stringify(response, null, 2))\r\n\r\n      const bookingID =\r\n        response?.bookRes?.content?.bookingID ||\r\n        response?.content?.bookingID ||\r\n        response?.bookingId ||\r\n        response?.bookingID ||\r\n        \"\"\r\n\r\n      const supplierReference =\r\n        response?.bookRes?.content?.services?.[0]?.supplier?.reference ||\r\n        response?.content?.services?.[0]?.supplier?.reference ||\r\n        response?.supplierReference ||\r\n        \"\"\r\n\r\n      const status = response?.bookRes?.content?.status || response?.content?.status || response?.status || \"\"\r\n\r\n      console.log('[DEBUG] Parsed:', { bookingID, supplierReference, status })\r\n\r\n      const isSuccess = status === \"confirmed\"\r\n\r\n      return {\r\n        success: isSuccess,\r\n        bookingId: String(bookingID),\r\n        supplierReference,\r\n        status,\r\n      }\r\n    } catch (error: any) {\r\n      return {\r\n        success: false,\r\n        bookingId: \"\",\r\n        supplierReference: \"\",\r\n        status: \"failed\",\r\n        error: error.message,\r\n      }\r\n    }\r\n  }\r\n\r\n  // =====================\r\n  // MANUAL BOOK (by code)\r\n  // =====================\r\n  async manualBook(params: { opportunityId: number; code: string }): Promise<BookResponse> {\r\n    try {\r\n      const response = await this.request<any>(\"/api/hotels/ManualBook\", {\r\n        method: \"POST\",\r\n        body: JSON.stringify({\r\n          opportunityId: params.opportunityId,\r\n          code: params.code,\r\n        }),\r\n      })\r\n\r\n      return {\r\n        success: response?.success || response?.bookingId,\r\n        bookingId: String(response?.bookingId || \"\"),\r\n        status: \"confirmed\",\r\n      }\r\n    } catch (error: any) {\r\n      return {\r\n        success: false,\r\n        error: error.message,\r\n      }\r\n    }\r\n  }\r\n\r\n  // =====================\r\n  // CANCEL BOOKING\r\n  // =====================\r\n  async cancelBooking(preBookId: number): Promise<{ success: boolean; error?: string }> {\r\n    try {\r\n      await this.request(`/api/hotels/CancelRoomActive?prebookId=${preBookId}`, {\r\n        method: \"DELETE\",\r\n      })\r\n      return { success: true }\r\n    } catch (error: any) {\r\n      return { success: false, error: error.message }\r\n    }\r\n  }\r\n\r\n  // =====================\r\n  // ROOM MANAGEMENT\r\n  // =====================\r\n\r\n  async getActiveRooms(params?: {\r\n    startDate?: string\r\n    endDate?: string\r\n    hotelName?: string\r\n    hotelStars?: number\r\n    city?: string\r\n    roomBoard?: string\r\n    roomCategory?: string\r\n    provider?: string\r\n  }): Promise<any[]> {\r\n    const response = await this.request<any>(\"/api/hotels/GetRoomsActive\", {\r\n      method: \"POST\",\r\n      body: JSON.stringify(params || {}),\r\n    })\r\n    return Array.isArray(response) ? response : []\r\n  }\r\n\r\n  async getSoldRooms(params?: {\r\n    startDate?: string\r\n    endDate?: string\r\n    hotelName?: string\r\n  }): Promise<any[]> {\r\n    const response = await this.request<any>(\"/api/hotels/GetRoomsSales\", {\r\n      method: \"POST\",\r\n      body: JSON.stringify(params || {}),\r\n    })\r\n    return Array.isArray(response) ? response : []\r\n  }\r\n\r\n  async getCancelledRooms(params?: {\r\n    startDate?: string\r\n    endDate?: string\r\n    hotelName?: string\r\n  }): Promise<any[]> {\r\n    const response = await this.request<any>(\"/api/hotels/GetRoomsCancel\", {\r\n      method: \"POST\",\r\n      body: JSON.stringify(params || {}),\r\n    })\r\n    return Array.isArray(response) ? response : []\r\n  }\r\n\r\n  // =====================\r\n  // DASHBOARD\r\n  // =====================\r\n  async getDashboardInfo(params?: {\r\n    hotelStars?: number\r\n    city?: string\r\n    hotelName?: string\r\n    reservationMonthDate?: string\r\n    checkInMonthDate?: string\r\n    provider?: string\r\n  }): Promise<any> {\r\n    const response = await this.request<any>(\"/api/hotels/GetDashboardInfo\", {\r\n      method: \"POST\",\r\n      body: JSON.stringify(params || {}),\r\n    })\r\n    return response || {}\r\n  }\r\n\r\n  // =====================\r\n  // OPPORTUNITIES\r\n  // =====================\r\n\r\n  async getOpportunities(params?: {\r\n    startDate?: string\r\n    endDate?: string\r\n  }): Promise<any[]> {\r\n    const response = await this.request<any>(\"/api/hotels/GetOpportunities\", {\r\n      method: \"POST\",\r\n      body: JSON.stringify(params || {}),\r\n    })\r\n    return Array.isArray(response) ? response : []\r\n  }\r\n\r\n  async insertOpportunity(params: {\r\n    hotelId?: number\r\n    startDateStr: string\r\n    endDateStr: string\r\n    boardId: number\r\n    categoryId: number\r\n    buyPrice: number\r\n    pushPrice: number\r\n    maxRooms: number\r\n    paxAdults?: number\r\n    paxChildren?: number[]\r\n  }): Promise<{ success: boolean; opportunityId?: number; error?: string }> {\r\n    try {\r\n      const response = await this.request<any>(\"/api/hotels/InsertOpportunity\", {\r\n        method: \"POST\",\r\n        body: JSON.stringify(params),\r\n      })\r\n      return { success: true, opportunityId: response?.opportunityId }\r\n    } catch (error: any) {\r\n      return { success: false, error: error.message }\r\n    }\r\n  }\r\n\r\n  // =====================\r\n  // PRICE UPDATE\r\n  // =====================\r\n  async updatePushPrice(preBookId: number, pushPrice: number): Promise<{ success: boolean; error?: string }> {\r\n    try {\r\n      await this.request(\"/api/hotels/UpdateRoomsActivePushPrice\", {\r\n        method: \"POST\",\r\n        body: JSON.stringify({\r\n          preBookId,\r\n          pushPrice,\r\n        }),\r\n      })\r\n      return { success: true }\r\n    } catch (error: any) {\r\n      return { success: false, error: error.message }\r\n    }\r\n  }\r\n\r\n  // =====================\r\n  // ARCHIVE\r\n  // =====================\r\n  async getRoomArchive(params: {\r\n    stayFrom?: string\r\n    stayTo?: string\r\n    hotelName?: string\r\n    minPrice?: number\r\n    maxPrice?: number\r\n    city?: string\r\n    roomBoard?: string\r\n    roomCategory?: string\r\n    pageNumber?: number\r\n    pageSize?: number\r\n  }): Promise<{ data: any[]; totalCount: number }> {\r\n    const response = await this.request<any>(\"/api/hotels/GetRoomArchiveData\", {\r\n      method: \"POST\",\r\n      body: JSON.stringify({\r\n        ...params,\r\n        pageNumber: params.pageNumber || 1,\r\n        pageSize: params.pageSize || 50,\r\n      }),\r\n    })\r\n\r\n    return {\r\n      data: response?.data || [],\r\n      totalCount: response?.totalCount || 0,\r\n    }\r\n  }\r\n\r\n  async refreshToken(): Promise<string> {\r\n    try {\r\n      const formData = new URLSearchParams()\r\n      formData.append(\r\n        \"client_secret\",\r\n        process.env.MEDICI_CLIENT_SECRET || \"zlbgGGxz~|l3.Q?XXAT)uT!Lty,kJC>R?`:k?oQH$I=P7rL<R:Em:qDaM1G(jFU7\",\r\n      )\r\n\r\n      const response = await fetch(`${this.baseUrl}/api/auth/OnlyNightUsersTokenAPI`, {\r\n        method: \"POST\",\r\n        headers: {\r\n          \"Content-Type\": \"application/x-www-form-urlencoded\",\r\n        },\r\n        body: formData.toString(),\r\n      })\r\n\r\n      if (!response.ok) {\r\n        const errorText = await response.text()\r\n        throw new Error(`Token refresh failed: ${response.status} - ${errorText}`)\r\n      }\r\n\r\n      const data = await response.json()\r\n      this.token = data.token || data.access_token || data.aether_access_token\r\n      return this.token\r\n    } catch (error: any) {\r\n      console.error(\"Failed to refresh token:\", error.message)\r\n      throw error\r\n    }\r\n  }\r\n\r\n  private transformSearchResults(response: any): HotelSearchResult[] {\r\n    if (!response) {\r\n      return []\r\n    }\r\n\r\n    let items: any[] = []\r\n\r\n    if (Array.isArray(response)) {\r\n      items = response\r\n    } else if (response.items && Array.isArray(response.items)) {\r\n      items = response.items\r\n    } else if (response.data && Array.isArray(response.data)) {\r\n      items = response.data\r\n    }\r\n\r\n    const hotelMap = new Map<number, HotelSearchResult>()\r\n\r\n    for (const item of items) {\r\n      // Support new Medici format with ShowExtendedData\r\n      const hotelIdRaw = item.id || item.hotelId || item.hotelCode || item.HotelId || item.hotel_id || \r\n        (item.items?.[0]?.hotelId) || 0\r\n      const hotelId = typeof hotelIdRaw === \"number\" ? hotelIdRaw : Number.parseInt(String(hotelIdRaw), 10) || 0\r\n      const hotelName = item.name || item.hotelName || item.HotelName || item.items?.[0]?.hotelName || \"Unknown Hotel\"\r\n\r\n      // Extract facilities from new format (facilities.list or facilities.tags)\r\n      let facilitiesList: string[] = []\r\n      if (item.facilities) {\r\n        if (Array.isArray(item.facilities)) {\r\n          facilitiesList = item.facilities\r\n        } else if (item.facilities.list && Array.isArray(item.facilities.list)) {\r\n          facilitiesList = item.facilities.list\r\n        } else if (item.facilities.tags && Array.isArray(item.facilities.tags)) {\r\n          facilitiesList = item.facilities.tags\r\n        }\r\n      }\r\n\r\n      if (!hotelMap.has(hotelId)) {\r\n        hotelMap.set(hotelId, {\r\n          hotelId,\r\n          hotelName,\r\n          hotelImage: getHotelMainImage(item),\r\n          images: buildImagesArray(item),\r\n          location: item.address || item.location || \"\",\r\n          city: item.city || extractCityFromDestinations(item) || \"\",\r\n          stars: item.stars || item.rating || 0,\r\n          address: item.address || \"\",\r\n          description: item.description || \"\",\r\n          facilities: facilitiesList,\r\n          phone: item.phone || \"\",\r\n          fax: item.fax || \"\",\r\n          lat: item.lat || 0,\r\n          lon: item.lon || 0,\r\n          seoname: item.seoname || \"\",\r\n          rooms: [],\r\n        })\r\n      }\r\n\r\n      const hotel = hotelMap.get(hotelId)!\r\n\r\n      const roomItems = item.items || [item]\r\n\r\n      for (let roomIdx = 0; roomIdx < roomItems.length; roomIdx++) {\r\n        const roomItem = roomItems[roomIdx]\r\n\r\n        const possibleCodeFields = [\r\n          roomItem.code,\r\n          roomItem.Code,\r\n          roomItem.roomCode,\r\n          roomItem.RoomCode,\r\n          roomItem.rateKey,\r\n          roomItem.RateKey,\r\n          roomItem.bookingCode,\r\n          roomItem.BookingCode,\r\n          roomItem.optionCode,\r\n          roomItem.OptionCode,\r\n          roomItem.key,\r\n          roomItem.Key,\r\n          roomItem.id?.toString(),\r\n          roomItem.rate?.code,\r\n          roomItem.rate?.key,\r\n          roomItem.option?.code,\r\n          roomItem.booking?.code,\r\n        ]\r\n\r\n        let roomCode = \"\"\r\n        for (const codeField of possibleCodeFields) {\r\n          if (codeField && typeof codeField === \"string\" && codeField.length > 0) {\r\n            roomCode = codeField\r\n            break\r\n          }\r\n        }\r\n\r\n        if (!roomCode) {\r\n          const tempCode = `TEMP-${hotelId}-${roomItem.id || Date.now()}-${roomIdx}`\r\n          roomCode = tempCode\r\n        }\r\n\r\n        // Extract price from room item first, then fallback to parent item (hotel level)\r\n        let price = extractPriceFromRoom(roomItem)\r\n        if (price === 0) {\r\n          price = extractPriceFromRoom(item) // Fallback to hotel-level price\r\n        }\r\n\r\n        hotel.rooms.push({\r\n          code: roomCode,\r\n          roomId: String(roomItem.id || roomItem.roomId || `${hotel.hotelId}-${hotel.rooms.length + 1}`),\r\n          roomName: roomItem.name || roomItem.roomName || \"Standard Room\",\r\n          roomCategory: roomItem.category || roomItem.roomType || \"standard\",\r\n          categoryId: roomItem.categoryId || roomItem.category_id || 1,\r\n          roomImage: getRoomMainImage(roomItem) || hotel.hotelImage, // Fallback to hotel image\r\n          images: buildRoomImagesArray(roomItem),\r\n          bedding: roomItem.bedding || \"\",\r\n          board: roomItem.board || \"RO\",\r\n          boardId: roomItem.boardId || getBoardIdFromCode(roomItem.board || \"RO\"),\r\n          boardType: roomItem.board || \"RO\",\r\n          maxOccupancy: roomItem.pax?.adults || roomItem.maxOccupancy || 2,\r\n          size: roomItem.size || roomItem.roomSize || 0,\r\n          view: roomItem.view || \"\",\r\n          amenities: roomItem.amenities || roomItem.facilities || [],\r\n          price: price,\r\n          buyPrice: price,\r\n          originalPrice: price > 0 ? Math.round(price * 1.15) : 0,\r\n          currency: roomItem.currency || item.price?.currency || item.netPrice?.currency || \"USD\",\r\n          cancellationPolicy: formatCancellationPolicy(item.cancellation) || roomItem.cancellationPolicy || \"free\",\r\n          cancellation: item.cancellation || null,\r\n          available: roomItem.quantity?.max || roomItem.available || 1,\r\n          requestJson: item.code || roomItem.code || roomCode, // Use hotel-level code for prebook\r\n          pax: roomItem.pax || { adults: 2, children: [] },\r\n          confirmation: item.confirmation || \"on_request\",\r\n          paymentType: item.paymentType || \"pre\",\r\n          providers: item.providers || [],\r\n          specialOffers: item.specialOffers || [],\r\n        })\r\n      }\r\n    }\r\n\r\n    const results = Array.from(hotelMap.values())\r\n    return results\r\n  }\r\n}\r\n\r\nexport const mediciApi = new MediciApiClient()\r\n\r\n// =====================\r\n// HELPER FUNCTIONS\r\n// =====================\r\n\r\nfunction buildFullImageUrl(imagePath: string | undefined): string {\r\n  if (!imagePath) return \"\"\r\n  if (imagePath.startsWith(\"http://\") || imagePath.startsWith(\"https://\")) {\r\n    return imagePath\r\n  }\r\n  return `${MEDICI_IMAGES_BASE}${imagePath}`\r\n}\r\n\r\nfunction getHotelMainImage(item: any): string {\r\n  if (item.imageUrl) return buildFullImageUrl(item.imageUrl)\r\n  if (item.image) return buildFullImageUrl(item.image)\r\n  if (item.mainImage) return buildFullImageUrl(item.mainImage)\r\n\r\n  if (item.images && Array.isArray(item.images) && item.images.length > 0) {\r\n    const firstImage = item.images[0]\r\n    if (typeof firstImage === \"string\") return buildFullImageUrl(firstImage)\r\n    if (firstImage?.url) return buildFullImageUrl(firstImage.url)\r\n    if (firstImage?.path) return buildFullImageUrl(firstImage.path)\r\n  }\r\n\r\n  if (item.items && item.items[0]?.images && item.items[0].images.length > 0) {\r\n    return buildFullImageUrl(item.items[0].images[0])\r\n  }\r\n\r\n  return \"\"\r\n}\r\n\r\nfunction buildImagesArray(item: any): string[] {\r\n  const images: string[] = []\r\n\r\n  if (item.images && Array.isArray(item.images)) {\r\n    for (const img of item.images) {\r\n      if (typeof img === \"string\") {\r\n        images.push(buildFullImageUrl(img))\r\n      } else if (img?.url) {\r\n        images.push(buildFullImageUrl(img.url))\r\n      } else if (img?.path) {\r\n        images.push(buildFullImageUrl(img.path))\r\n      }\r\n    }\r\n  }\r\n\r\n  if (item.items && item.items[0]?.images) {\r\n    for (const img of item.items[0].images) {\r\n      if (typeof img === \"string\") {\r\n        images.push(buildFullImageUrl(img))\r\n      }\r\n    }\r\n  }\r\n\r\n  return images.filter(Boolean)\r\n}\r\n\r\nfunction extractPriceFromRoom(room: any): number {\r\n  const priceLocations = [\r\n    // Medici API uses netPrice as primary price field\r\n    { name: \"netPrice.amount\", value: room.netPrice?.amount },\r\n    { name: \"price.amount\", value: room.price?.amount },\r\n    { name: \"price.value\", value: room.price?.value },\r\n    { name: \"price (direct)\", value: room.price },\r\n    { name: \"buyPrice\", value: room.buyPrice },\r\n    { name: \"sellPrice\", value: room.sellPrice },\r\n    { name: \"totalPrice\", value: room.totalPrice },\r\n    { name: \"amount\", value: room.amount },\r\n    { name: \"rate.amount\", value: room.rate?.amount },\r\n    { name: \"rate.value\", value: room.rate?.value },\r\n    { name: \"rate (direct)\", value: room.rate },\r\n    { name: \"cost\", value: room.cost },\r\n    { name: \"netPrice\", value: room.netPrice },\r\n    { name: \"grossPrice\", value: room.grossPrice },\r\n    { name: \"Price\", value: room.Price },\r\n    { name: \"BuyPrice\", value: room.BuyPrice },\r\n    { name: \"SellPrice\", value: room.SellPrice },\r\n    { name: \"TotalPrice\", value: room.TotalPrice },\r\n  ]\r\n\r\n  for (const { name, value } of priceLocations) {\r\n    if (typeof value === \"number\" && value > 0) {\r\n      return value\r\n    }\r\n    if (typeof value === \"string\") {\r\n      const parsed = Number.parseFloat(value)\r\n      if (!isNaN(parsed) && parsed > 0) {\r\n        return parsed\r\n      }\r\n    }\r\n  }\r\n\r\n  return 0\r\n}\r\n\r\nfunction getRoomMainImage(room: any): string {\r\n  if (room.imageUrl) return buildFullImageUrl(room.imageUrl)\r\n  if (room.image) return buildFullImageUrl(room.image)\r\n  if (room.mainImage) return buildFullImageUrl(room.mainImage)\r\n\r\n  if (room.images && Array.isArray(room.images) && room.images.length > 0) {\r\n    const firstImage = room.images[0]\r\n    if (typeof firstImage === \"string\") return buildFullImageUrl(firstImage)\r\n    if (firstImage?.url) return buildFullImageUrl(firstImage.url)\r\n    if (firstImage?.path) return buildFullImageUrl(firstImage.path)\r\n  }\r\n\r\n  return \"\"\r\n}\r\n\r\nfunction buildRoomImagesArray(room: any): string[] {\r\n  const images: string[] = []\r\n\r\n  if (room.images && Array.isArray(room.images)) {\r\n    for (const img of room.images) {\r\n      if (typeof img === \"string\") {\r\n        images.push(buildFullImageUrl(img))\r\n      } else if (img?.url) {\r\n        images.push(buildFullImageUrl(img.url))\r\n      } else if (img?.path) {\r\n        images.push(buildFullImageUrl(img.path))\r\n      }\r\n    }\r\n  }\r\n\r\n  return images.filter(Boolean)\r\n}\r\n\r\nfunction getBoardIdFromCode(boardCode: string): number {\r\n  for (const [id, board] of Object.entries(BOARD_TYPES)) {\r\n    if (board.code === boardCode) {\r\n      return Number.parseInt(id, 10)\r\n    }\r\n  }\r\n  return 0\r\n}\r\n\r\n// Extract city from destinations array (new Medici format)\r\nfunction extractCityFromDestinations(item: any): string {\r\n  if (item.destinations && Array.isArray(item.destinations)) {\r\n    const cityDest = item.destinations.find((d: any) => d.type === \"city\")\r\n    if (cityDest?.destinationId) {\r\n      return `City-${cityDest.destinationId}` // Will be resolved by enrichment\r\n    }\r\n  }\r\n  if (item.surroundings && Array.isArray(item.surroundings)) {\r\n    const citySurr = item.surroundings.find((s: any) => s.type === \"city\")\r\n    if (citySurr?.destinationId) {\r\n      return `City-${citySurr.destinationId}`\r\n    }\r\n  }\r\n  return \"\"\r\n}\r\n\r\n// Format cancellation policy from new Medici format\r\nfunction formatCancellationPolicy(cancellation: any): string {\r\n  if (!cancellation) return \"free\"\r\n  \r\n  if (cancellation.type === \"fully-refundable\") {\r\n    return \"free\"\r\n  } else if (cancellation.type === \"non-refundable\") {\r\n    return \"non-refundable\"\r\n  } else if (cancellation.type === \"partially-refundable\") {\r\n    return \"partial\"\r\n  }\r\n  \r\n  // Check frames for deadline\r\n  if (cancellation.frames && Array.isArray(cancellation.frames)) {\r\n    const freeFrame = cancellation.frames.find((f: any) => \r\n      f.penalty?.amount === 0\r\n    )\r\n    if (freeFrame) {\r\n      const deadline = new Date(freeFrame.to)\r\n      return `Free cancellation until ${deadline.toLocaleDateString()}`\r\n    }\r\n  }\r\n  \r\n  return cancellation.type || \"free\"\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1114, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/97250/Desktop/booking%20engine/v0-bookinengine/lib/api/knowaa-client.ts"],"sourcesContent":["// Knowaa Hotels API Client - Token-based Authentication\r\n// Handles bearer token retrieval and all hotel API calls via Knowaa credentials\r\n\r\nimport axios, { AxiosInstance } from \"axios\"\r\nimport type { HotelSearchResult, PreBookResponse, BookResponse } from \"./medici-types\"\r\nimport \"server-only\"\r\n\r\nconst MEDICI_BASE_URL = \"https://medici-backend.azurewebsites.net\"\r\nconst TOKEN_ENDPOINT = \"/api/auth/OnlyNightUsersTokenAPI\"\r\n\r\n// Knowaa credentials\r\nconst KNOWAA_CLIENT_SECRET = process.env.KNOWAA_CLIENT_SECRET || \"zlbgGGxz~|l3.Q?XXAT)uT!Lty,kJC>R?`:k?oQH$I=P7rL<R:Em:qDaM1G(jFU7\"\r\nconst KNOWAA_EMAIL = process.env.KNOWAA_EMAIL || \"partnerships@knowaaglobal.com\"\r\n\r\n// Token cache with expiry\r\ninterface TokenCache {\r\n  token: string\r\n  expiresAt: number\r\n}\r\n\r\nlet tokenCache: TokenCache | null = null\r\n\r\n// =====================\r\n// TOKEN MANAGEMENT\r\n// =====================\r\n\r\nasync function getKnowaaBearerToken(): Promise<string> {\r\n  // If env token provided, use it (testing override)\r\n  const ENV_TOKEN = process.env.KNOWAA_BEARER_TOKEN\r\n  if (ENV_TOKEN) {\r\n    if (!tokenCache) {\r\n      tokenCache = { token: ENV_TOKEN, expiresAt: Date.now() + 24 * 60 * 60 * 1000 }\r\n    }\r\n    return tokenCache.token\r\n  }\r\n\r\n  // Return cached token if still valid\r\n  if (tokenCache && tokenCache.expiresAt > Date.now()) {\r\n    return tokenCache.token\r\n  }\r\n\r\n  try {\r\n    console.log(\"‚â°∆í◊§◊† [Knowaa] Requesting bearer token...\")\r\n    const tokenUrl = `${MEDICI_BASE_URL}${TOKEN_ENDPOINT}`\r\n\r\n    // Build form data using URLSearchParams and convert to string\r\n    const formData = new URLSearchParams()\r\n    formData.append(\"client_secret\", KNOWAA_CLIENT_SECRET)\r\n    formData.append(\"email\", KNOWAA_EMAIL)\r\n\r\n    const response = await axios.post(tokenUrl, formData.toString(), {\r\n      headers: {\r\n        \"Content-Type\": \"application/x-www-form-urlencoded\",\r\n        \"Content-Length\": formData.toString().length.toString(),\r\n      },\r\n      timeout: 15000,\r\n    })\r\n\r\n    console.log(\"‚â°∆í◊§◊† [Knowaa] Token response status:\", response.status)\r\n\r\n    // Response format: { \"email1\": \"token1\", \"email2\": \"token2\", ... }\r\n    const token = response.data[KNOWAA_EMAIL] || response.data.token || response.data.access_token\r\n\r\n    if (!token) {\r\n      console.error(\"‚â°∆í◊§◊† [Knowaa] Response data:\", JSON.stringify(response.data).substring(0, 200))\r\n      throw new Error(\"No token received from Knowaa auth endpoint\")\r\n    }\r\n\r\n    // Cache token for 55 minutes (typical JWT expiry is 1 hour)\r\n    tokenCache = {\r\n      token,\r\n      expiresAt: Date.now() + 55 * 60 * 1000,\r\n    }\r\n\r\n    console.log(\"Œì¬£◊ï Knowaa Bearer Token acquired successfully\")\r\n    return tokenCache.token\r\n  } catch (error: any) {\r\n    console.error(\"Œì¬•◊ú Failed to get Knowaa Bearer Token:\")\r\n    console.error(\"Error message:\", error.message)\r\n    if (error.response) {\r\n      console.error(\"Response status:\", error.response.status)\r\n      console.error(\"Response data:\", error.response.data)\r\n    }\r\n    throw new Error(`Authentication failed: ${error.message}`)\r\n  }\r\n}\r\n\r\n// =====================\r\n// API CLIENT CLASS\r\n// =====================\r\n\r\nexport class KnowaaMediciClient {\r\n  private client: AxiosInstance\r\n  private baseUrl: string\r\n\r\n  constructor() {\r\n    this.baseUrl = MEDICI_BASE_URL\r\n    this.client = axios.create({\r\n      baseURL: this.baseUrl,\r\n      timeout: 30000,\r\n    })\r\n  }\r\n\r\n  /**\r\n   * Create request with Knowaa bearer token\r\n   */\r\n  private async getAuthHeaders() {\r\n    const token = await getKnowaaBearerToken()\r\n    // WORKAROUND: Use the legacy token (UserID 11) which works via fetch\r\n    // The Knowaa token works with curl but returns 500 from axios/fetch for unknown reasons\r\n    const LEGACY_TOKEN = \"eyJhbGciOiJodHRwOi8vd3d3LnczLm9yZy8yMDAxLzA0L3htbGRzaWctbW9yZSNobWFjLXNoYTI1NiIsInR5cCI6IkpXVCJ9.eyJQZXJtaXNzaW9ucyI6IjEiLCJVc2VySWQiOiIxMSIsIm5iZiI6MTc2ODQ1NzU5NSwiZXhwIjoyMDgzOTkwMzk1LCJpc3MiOiJodHRwczovL2FkbWluLm1lZGljaWhvdGVscy5jb20vIiwiYXVkIjoiaHR0cHM6Ly9hZG1pbi5tZWRpY2lob3RlbHMuY29tLyJ9.g-CO7I75BlowE-F3J3GqlXsbIgNtG8_w2v1WMwG6djE\"\r\n    return {\r\n      Authorization: `Bearer ${token || LEGACY_TOKEN}`,\r\n      \"Content-Type\": \"application/json\",\r\n    }\r\n  }\r\n\r\n  /**\r\n   * STEP 1: Search Hotels\r\n   * GET /api/hotels/GetInnstantSearchPrice\r\n   */\r\n  async searchHotels(params: {\r\n    dateFrom: string // \"2025-02-01\"\r\n    dateTo: string // \"2025-02-05\"\r\n    hotelName?: string // Search by hotel name\r\n    city?: string // Search by city\r\n    adults?: number\r\n    children?: number[]\r\n    stars?: number | null\r\n    limit?: number | null\r\n  }): Promise<HotelSearchResult[]> {\r\n    try {\r\n      const headers = await this.getAuthHeaders()\r\n\r\n      const pax = {\r\n        adults: params.adults || 2,\r\n        children: params.children?.length || 0,\r\n      }\r\n\r\n      const body: any = {\r\n        dateFrom: params.dateFrom,\r\n        dateTo: params.dateTo,\r\n        pax,\r\n        stars: params.stars || null,\r\n        limit: params.limit || null,\r\n        ShowExtendedData: true, // Get images, description, facilities\r\n      }\r\n\r\n      if (params.hotelName) {\r\n        body.hotelName = params.hotelName\r\n      } else if (params.city) {\r\n        body.city = params.city\r\n      }\r\n\r\n      console.log(\"‚â°∆í◊§◊ù [Knowaa] Searching hotels:\", { dateFrom: params.dateFrom, dateTo: params.dateTo, ...body })\r\n\r\n      const response = await fetch(`${this.baseUrl}/api/hotels/GetInnstantSearchPrice`, {\r\n        method: \"POST\",\r\n        headers,\r\n        body: JSON.stringify(body),\r\n      })\r\n\r\n      if (!response.ok) {\r\n        throw new Error(`Medici API returned ${response.status}`)\r\n      }\r\n\r\n      const data = await response.json()\r\n      const hotels = this.transformSearchResults(data)\r\n\r\n      console.log(`Œì¬£◊ï [Knowaa] Found ${hotels.length} hotels`)\r\n\r\n      return hotels.map((hotel) => ({\r\n        ...hotel,\r\n        requestJson: JSON.stringify(body),\r\n        responseJson: data,\r\n      }))\r\n    } catch (error) {\r\n      console.error(\"Œì¬•◊ú [Knowaa] Search Hotels Error:\", error)\r\n      throw error\r\n    }\r\n  }\r\n\r\n  /**\r\n   * STEP 2: Pre-Book\r\n   * POST /api/hotels/PreBook\r\n   */\r\n  async preBook(params: { jsonRequest: string }): Promise<PreBookResponse> {\r\n    try {\r\n      const headers = await this.getAuthHeaders()\r\n\r\n      const body = {\r\n        jsonRequest: params.jsonRequest,\r\n      }\r\n\r\n      console.log(\"‚â°∆í◊£◊õ [Knowaa] Pre-booking room...\")\r\n\r\n      const response = await this.client.post(\"/api/hotels/PreBook\", body, {\r\n        headers,\r\n      })\r\n\r\n      if (response.status === 204) {\r\n        return {\r\n          success: true,\r\n          preBookId: 0,\r\n          token: \"\",\r\n          status: \"done\",\r\n          priceConfirmed: 0,\r\n          currency: \"USD\",\r\n          requestJson: params.jsonRequest,\r\n          responseJson: \"\",\r\n        }\r\n      }\r\n\r\n      const token = response.data?.content?.services?.hotels?.[0]?.token || response.data?.token || \"\"\r\n      const preBookId = response.data?.opportunityId || response.data?.preBookId || response.data?.id || 0\r\n      const priceConfirmed = response.data?.content?.services?.hotels?.[0]?.price?.amount || 0\r\n      const currency = response.data?.content?.services?.hotels?.[0]?.price?.currency || \"USD\"\r\n\r\n      console.log(`Œì¬£◊ï [Knowaa] Pre-book successful: ID ${preBookId}`)\r\n\r\n      return {\r\n        success: true,\r\n        preBookId,\r\n        token,\r\n        status: response.data?.status || \"done\",\r\n        priceConfirmed,\r\n        currency,\r\n        requestJson: params.jsonRequest,\r\n        responseJson: response.data,\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Œì¬•◊ú [Knowaa] Pre-Book Error:\", error)\r\n      throw error\r\n    }\r\n  }\r\n\r\n  /**\r\n   * STEP 3: Book\r\n   * POST /api/hotels/Book\r\n   */\r\n  async book(params: { jsonRequest: string }): Promise<BookResponse> {\r\n    try {\r\n      const headers = await this.getAuthHeaders()\r\n\r\n      const body = {\r\n        jsonRequest: params.jsonRequest,\r\n      }\r\n\r\n      console.log(\"‚â°∆í◊û¬Ω [Knowaa] Booking room...\")\r\n\r\n      const response = await this.client.post(\"/api/hotels/Book\", body, {\r\n        headers,\r\n      })\r\n\r\n      const bookingId = response.data?.content?.bookingID || response.data?.bookingId || \"\"\r\n      const supplierReference = response.data?.content?.services?.[0]?.supplier?.reference || \"\"\r\n      const status = response.data?.status || \"confirmed\"\r\n\r\n      console.log(`Œì¬£◊ï [Knowaa] Booking confirmed: ${bookingId}`)\r\n\r\n      return {\r\n        success: true,\r\n        bookingId,\r\n        supplierReference,\r\n        status,\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Œì¬•◊ú [Knowaa] Book Error:\", error)\r\n      throw error\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Transform Medici API search response to HotelSearchResult[]\r\n   */\r\n  private transformSearchResults(response: any): HotelSearchResult[] {\r\n    const hotelMap = new Map<string, HotelSearchResult>()\r\n\r\n    const items = response?.items || []\r\n\r\n    for (const item of items) {\r\n      if (!item.name) continue\r\n\r\n      const hotelId = String(item.id || item.hotelId || \"0\")\r\n      const roomKey = `${hotelId}-${item.name}`\r\n\r\n      if (!hotelMap.has(roomKey)) {\r\n        hotelMap.set(roomKey, {\r\n          hotelId: Number(hotelId),\r\n          hotelName: item.items?.[0]?.hotelName || item.name || \"Unknown\",\r\n          city: item.city || \"Unknown\",\r\n          stars: item.stars || 0,\r\n          address: item.address || \"\",\r\n          description: item.description || \"\",\r\n          hotelImage: item.imageUrl || \"\",\r\n          images: item.images?.map((img: any) => img.url || \"\") || [],\r\n          location: item.city || \"\",\r\n          facilities: item.facilities?.list || [],\r\n          rooms: [],\r\n        })\r\n      }\r\n\r\n      const hotel = hotelMap.get(roomKey)!\r\n\r\n      // Add rooms\r\n      if (item.items && Array.isArray(item.items)) {\r\n        for (const roomItem of item.items) {\r\n          const price = item.price?.amount || item.netPrice?.amount || 0\r\n\r\n          hotel.rooms.push({\r\n            roomId: roomItem.code || `${hotelId}-room-${Math.random()}`,\r\n            roomName: roomItem.name || \"Standard\",\r\n            roomCategory: roomItem.category || \"standard\",\r\n            categoryId: 1,\r\n            roomImage: \"\",\r\n            images: [],\r\n            bedding: roomItem.bedding || \"double\",\r\n            board: roomItem.board || \"RO\",\r\n            boardId: 1,\r\n            boardType: roomItem.boardType || \"RO\",\r\n            maxOccupancy: roomItem.pax?.adults || 2,\r\n            size: 0,\r\n            view: \"\",\r\n            amenities: [],\r\n            price,\r\n            buyPrice: price,\r\n            originalPrice: price > 0 ? Math.round(price * 1.15) : 0,\r\n            currency: item.price?.currency || \"USD\",\r\n            cancellationPolicy: \"refundable\",\r\n            available: roomItem.quantity?.max || 1,\r\n            requestJson: item.code,\r\n            pax: roomItem.pax || { adults: 2, children: [] },\r\n          })\r\n        }\r\n      }\r\n    }\r\n\r\n    return Array.from(hotelMap.values())\r\n  }\r\n}\r\n\r\n// =====================\r\n// SINGLETON INSTANCE\r\n// =====================\r\n\r\nexport const knowaaClient = new KnowaaMediciClient()\r\n\r\n// =====================\r\n// HELPER FUNCTIONS\r\n// =====================\r\n\r\n/**\r\n * Clear token cache (useful for testing or manual refresh)\r\n */\r\nexport function clearTokenCache() {\r\n  tokenCache = null\r\n  console.log(\"‚â°∆í◊§◊î Token cache cleared\")\r\n}\r\n\r\n/**\r\n * Get current token cache status\r\n */\r\nexport function getTokenCacheStatus() {\r\n  if (!tokenCache) {\r\n    return { cached: false, token: null, expiresIn: null }\r\n  }\r\n\r\n  const expiresIn = tokenCache.expiresAt - Date.now()\r\n  return {\r\n    cached: true,\r\n    token: tokenCache.token?.substring(0, 20) + \"...\", // Only show first 20 chars\r\n    expiresIn: expiresIn > 0 ? Math.floor(expiresIn / 1000) + \"s\" : \"expired\",\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1427, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/97250/Desktop/booking%20engine/v0-bookinengine/app/api/test-knowaa/route.ts"],"sourcesContent":["import { type NextRequest, NextResponse } from \"next/server\"\r\nimport { mediciApi } from \"@/lib/api/medici-client\"\r\nimport { getTokenCacheStatus } from \"@/lib/api/knowaa-client\"\r\n\r\n/**\r\n * Test Knowaa/Medici API search using working client\r\n * GET /api/test-knowaa?action=search&city=Tel%20Aviv&dateFrom=2025-02-01&dateTo=2025-02-05\r\n */\r\nexport async function GET(request: NextRequest) {\r\n  try {\r\n    const { searchParams } = new URL(request.url)\r\n    const action = searchParams.get(\"action\") || \"status\"\r\n    const city = searchParams.get(\"city\") || \"Tel Aviv\"\r\n    const dateFrom = searchParams.get(\"dateFrom\") || \"2025-02-01\"\r\n    const dateTo = searchParams.get(\"dateTo\") || \"2025-02-05\"\r\n    const hotelName = searchParams.get(\"hotelName\")\r\n\r\n    console.log(`\\n‚â°∆í◊™◊ê [Knowaa Test] Action: ${action}`)\r\n\r\n    if (action === \"status\") {\r\n      const cacheStatus = getTokenCacheStatus()\r\n      return NextResponse.json({\r\n        message: \"Knowaa API Integration Status\",\r\n        timestamp: new Date().toISOString(),\r\n        tokenCache: cacheStatus,\r\n        endpoints: {\r\n          search: \"/api/test-knowaa?action=search&city=Tel%20Aviv&dateFrom=2025-02-01&dateTo=2025-02-05\",\r\n          searchByHotel: \"/api/test-knowaa?action=search&hotelName=Scarlet&dateFrom=2025-02-01&dateTo=2025-02-05\",\r\n        },\r\n      })\r\n    }\r\n\r\n    if (action === \"search\") {\r\n      console.log(`\\n‚â°∆í◊§◊ù Searching: ${hotelName ? `Hotel: ${hotelName}` : `City: ${city}`}`)\r\n\r\n      // Use existing mediciApi client which works\r\n      const results = await mediciApi.searchHotels({\r\n        dateFrom,\r\n        dateTo,\r\n        hotelName: hotelName || undefined,\r\n        city: hotelName ? undefined : city,\r\n        adults: 2,\r\n      })\r\n\r\n      return NextResponse.json({\r\n        success: true,\r\n        count: results.length,\r\n        dateRange: { dateFrom, dateTo },\r\n        query: hotelName ? { hotelName } : { city },\r\n        hotels: results.map((h) => ({\r\n          id: h.hotelId,\r\n          name: h.hotelName,\r\n          city: h.city,\r\n          stars: h.stars,\r\n          rooms: h.rooms.length,\r\n        })),\r\n        fullResults: results,\r\n      })\r\n    }\r\n\r\n    return NextResponse.json({ error: \"Unknown action\" }, { status: 400 })\r\n  } catch (error: any) {\r\n    console.error(\"Œì¬•◊ú [Knowaa Test] Error:\", error.message)\r\n    return NextResponse.json(\r\n      {\r\n        error: error.message || \"Test failed\",\r\n        details: error.response?.data || error.toString(),\r\n      },\r\n      { status: 500 }\r\n    )\r\n  }\r\n}\r\n\r\n/**\r\n * POST for search with custom body\r\n */\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const body = await request.json()\r\n    const { action = \"search\", ...params } = body\r\n\r\n    console.log(`\\n‚â°∆í◊™◊ê [Knowaa API POST] Action: ${action}`)\r\n\r\n    if (action === \"search\") {\r\n      const results = await knowaaClient.searchHotels({\r\n        dateFrom: params.dateFrom || \"2025-02-01\",\r\n        dateTo: params.dateTo || \"2025-02-05\",\r\n        hotelName: params.hotelName,\r\n        city: params.city || \"Tel Aviv\",\r\n        adults: params.adults || 2,\r\n        stars: params.stars,\r\n        limit: params.limit,\r\n      })\r\n\r\n      return NextResponse.json({\r\n        success: true,\r\n        count: results.length,\r\n        data: results,\r\n      })\r\n    }\r\n\r\n    if (action === \"prebook\") {\r\n      const result = await knowaaClient.preBook({\r\n        jsonRequest: params.jsonRequest,\r\n      })\r\n\r\n      return NextResponse.json({\r\n        success: result.success,\r\n        preBookId: result.preBookId,\r\n        token: result.token,\r\n        status: result.status,\r\n        price: result.priceConfirmed,\r\n      })\r\n    }\r\n\r\n    if (action === \"book\") {\r\n      const result = await knowaaClient.book({\r\n        jsonRequest: params.jsonRequest,\r\n      })\r\n\r\n      return NextResponse.json({\r\n        success: result.success,\r\n        bookingId: result.bookingId,\r\n        status: result.status,\r\n      })\r\n    }\r\n\r\n    return NextResponse.json({ error: \"Unknown action\" }, { status: 400 })\r\n  } catch (error: any) {\r\n    console.error(\"Œì¬•◊ú [Knowaa API POST] Error:\", error.message)\r\n    return NextResponse.json(\r\n      {\r\n        error: error.message || \"Request failed\",\r\n      },\r\n      { status: 500 }\r\n    )\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}