{"version":3,"sources":["../../../lib/hotel-booking-ai/index.ts","../../../lib/hotel-booking-ai/handlers/booking.ts","../../../lib/hotel-booking-ai/handlers/voice.ts","../../../lib/hotel-booking-ai/handlers/monitoring.ts","../../../lib/hotel-booking-ai/handlers/notifications.ts","../../../lib/hotel-booking-ai/handlers/loyalty.ts"],"sourcesContent":["/**\r\n * Hotel Booking AI - Main Index\r\n * Central export for all Hotel Booking AI functionality\r\n */\r\n\r\n// Types (explicitly export to avoid conflicts)\r\nexport type {\r\n  BookingEngineType,\r\n  EngineInstance,\r\n  EngineSessionMetrics,\r\n  ToolResult,\r\n  EngineCapability,\r\n  SkillCategory,\r\n  BookingSkill,\r\n  BookingTool,\r\n  ToolParameter,\r\n  BookingEngineTemplate,\r\n  ModelConfig,\r\n  AgentPersona,\r\n  EnginePrompts,\r\n  EngineConfig,\r\n  ConversationContext,\r\n  ConversationMessage,\r\n  BookingIntent,\r\n  ExtractedBookingData\r\n} from './types';\r\n\r\n// Skills\r\nexport * from './skills';\r\n\r\n// Templates\r\nexport * from './templates';\r\n\r\n// Handlers (importing registers them)\r\nimport './handlers';\r\n\r\n// Re-export convenience functions\r\nexport {\r\n  createEngine,\r\n  getEngine,\r\n  destroyEngine,\r\n  listEngines,\r\n  chat,\r\n  getGreeting,\r\n  clearHistory,\r\n  getAvailableTemplates,\r\n  getTemplate,\r\n  getDashboardStats,\r\n  registerToolHandler,\r\n  executeTool,\r\n  getToolsForEngine,\r\n  getConversationContext\r\n} from './engine-manager';\r\n\r\n// Export types from engine-manager\r\nexport type { CreateEngineOptions, ChatOptions, ChatResponse } from './engine-manager';\r\n\r\nexport {\r\n  allTemplates,\r\n  getTemplateById,\r\n  getTemplateByType,\r\n  getTemplatesByCapability,\r\n  hotelBookingAgentTemplate,\r\n  priceMonitorAgentTemplate,\r\n  customerSupportAgentTemplate,\r\n  voiceBookingAgentTemplate,\r\n  conciergeAgentTemplate,\r\n  groupBookingAgentTemplate,\r\n  loyaltyManagerAgentTemplate\r\n} from './templates';\r\n\r\nexport {\r\n  allSkills,\r\n  getSkillById,\r\n  getSkillsByCategory,\r\n  hotelSearchSkill,\r\n  destinationSearchSkill,\r\n  prebookSkill,\r\n  bookingSkill,\r\n  cancellationSkill,\r\n  priceMonitoringSkill,\r\n  notificationSkill,\r\n  voiceSkill,\r\n  customerSupportSkill,\r\n  loyaltySkill,\r\n  preferencesSkill\r\n} from './skills';\r\n","/**\r\n * Hotel Booking AI - Booking Handler\r\n * Handles hotel search, prebook, booking, and cancellation operations\r\n */\r\n\r\nimport type { ConversationContext, ToolResult } from '../types';\r\nimport { registerToolHandler } from '../engine-manager';\r\n\r\n// ========================================\r\n// MEDICI API INTEGRATION\r\n// ========================================\r\n\r\nconst MEDICI_API_URL = process.env.MEDICI_API_URL || 'https://api.medici.com';\r\nconst MEDICI_API_KEY = process.env.MEDICI_API_KEY;\r\n\r\ninterface MediciApiOptions {\r\n  endpoint: string;\r\n  method: 'GET' | 'POST' | 'PUT' | 'DELETE';\r\n  body?: Record<string, any>;\r\n  token?: string;\r\n}\r\n\r\nasync function callMediciApi(options: MediciApiOptions): Promise<any> {\r\n  const { endpoint, method, body, token } = options;\r\n\r\n  const headers: HeadersInit = {\r\n    'Content-Type': 'application/json'\r\n  };\r\n\r\n  if (token) {\r\n    headers['Authorization'] = `Bearer ${token}`;\r\n  } else if (MEDICI_API_KEY) {\r\n    headers['x-api-key'] = MEDICI_API_KEY;\r\n  }\r\n\r\n  try {\r\n    const response = await fetch(`${MEDICI_API_URL}${endpoint}`, {\r\n      method,\r\n      headers,\r\n      body: body ? JSON.stringify(body) : undefined\r\n    });\r\n\r\n    if (!response.ok) {\r\n      const errorData = await response.json().catch(() => ({}));\r\n      throw new Error(errorData.message || `API error: ${response.status}`);\r\n    }\r\n\r\n    return await response.json();\r\n  } catch (error: any) {\r\n    console.error('Medici API error:', error);\r\n    throw error;\r\n  }\r\n}\r\n\r\n// ========================================\r\n// HOTEL SEARCH HANDLER\r\n// ========================================\r\n\r\ninterface SearchHotelsParams {\r\n  destination: string;\r\n  checkIn: string;\r\n  checkOut: string;\r\n  rooms: number;\r\n  adults: number;\r\n  children?: number;\r\n  currency?: string;\r\n  filters?: {\r\n    starRating?: number[];\r\n    priceRange?: { min: number; max: number };\r\n    amenities?: string[];\r\n    propertyTypes?: string[];\r\n  };\r\n}\r\n\r\nasync function handleSearchHotels(\r\n  params: SearchHotelsParams,\r\n  context: ConversationContext\r\n): Promise<ToolResult> {\r\n  try {\r\n    const searchParams = {\r\n      destination: params.destination,\r\n      checkin: params.checkIn,\r\n      checkout: params.checkOut,\r\n      rooms: params.rooms,\r\n      adults: params.adults,\r\n      children: params.children || 0,\r\n      currency: params.currency || 'USD',\r\n      ...params.filters\r\n    };\r\n\r\n    const result = await callMediciApi({\r\n      endpoint: '/v1/hotels/search',\r\n      method: 'POST',\r\n      body: searchParams\r\n    });\r\n\r\n    // Store search ID in context for later use\r\n    if (result.searchId) {\r\n      context.metadata.lastSearchId = result.searchId;\r\n    }\r\n\r\n    return {\r\n      success: true,\r\n      data: {\r\n        searchId: result.searchId,\r\n        totalResults: result.hotels?.length || 0,\r\n        hotels: result.hotels?.slice(0, 10).map((hotel: any) => ({\r\n          hotelId: hotel.hotelId,\r\n          name: hotel.name,\r\n          address: hotel.address,\r\n          starRating: hotel.starRating,\r\n          rating: hotel.rating,\r\n          reviewCount: hotel.reviewCount,\r\n          mainImage: hotel.images?.[0],\r\n          lowestPrice: hotel.lowestPrice,\r\n          currency: hotel.currency,\r\n          amenities: hotel.amenities?.slice(0, 5),\r\n          distanceFromCenter: hotel.distanceFromCenter\r\n        }))\r\n      }\r\n    };\r\n  } catch (error: any) {\r\n    return {\r\n      success: false,\r\n      data: null,\r\n      error: error.message || 'Failed to search hotels'\r\n    };\r\n  }\r\n}\r\n\r\nregisterToolHandler('search_hotels', handleSearchHotels as any);\r\n\r\n// ========================================\r\n// DESTINATION SEARCH HANDLER\r\n// ========================================\r\n\r\ninterface SearchDestinationsParams {\r\n  query: string;\r\n  limit?: number;\r\n}\r\n\r\nasync function handleSearchDestinations(\r\n  params: SearchDestinationsParams,\r\n  context: ConversationContext\r\n): Promise<ToolResult> {\r\n  try {\r\n    const result = await callMediciApi({\r\n      endpoint: `/v1/destinations/search?q=${encodeURIComponent(params.query)}&limit=${params.limit || 10}`,\r\n      method: 'GET'\r\n    });\r\n\r\n    return {\r\n      success: true,\r\n      data: {\r\n        destinations: result.destinations?.map((dest: any) => ({\r\n          id: dest.id,\r\n          name: dest.name,\r\n          type: dest.type,\r\n          country: dest.country,\r\n          region: dest.region,\r\n          coordinates: dest.coordinates\r\n        }))\r\n      }\r\n    };\r\n  } catch (error: any) {\r\n    return {\r\n      success: false,\r\n      data: null,\r\n      error: error.message || 'Failed to search destinations'\r\n    };\r\n  }\r\n}\r\n\r\nregisterToolHandler('search_destinations', handleSearchDestinations as any);\r\n\r\n// ========================================\r\n// PREBOOK HANDLER\r\n// ========================================\r\n\r\ninterface PrebookParams {\r\n  hotelId: string;\r\n  roomId: string;\r\n  rateId: string;\r\n  checkIn: string;\r\n  checkOut: string;\r\n  guests: {\r\n    adults: number;\r\n    children?: number;\r\n    childAges?: number[];\r\n  };\r\n}\r\n\r\nasync function handlePrebook(\r\n  params: PrebookParams,\r\n  context: ConversationContext\r\n): Promise<ToolResult> {\r\n  try {\r\n    const result = await callMediciApi({\r\n      endpoint: '/v1/booking/prebook',\r\n      method: 'POST',\r\n      body: {\r\n        hotelId: params.hotelId,\r\n        roomId: params.roomId,\r\n        rateId: params.rateId,\r\n        checkin: params.checkIn,\r\n        checkout: params.checkOut,\r\n        guests: params.guests\r\n      }\r\n    });\r\n\r\n    // Store prebook token in context\r\n    if (result.prebookToken) {\r\n      context.metadata.prebookToken = result.prebookToken;\r\n      context.metadata.prebookExpiry = result.expiresAt;\r\n    }\r\n\r\n    return {\r\n      success: true,\r\n      data: {\r\n        prebookToken: result.prebookToken,\r\n        expiresAt: result.expiresAt,\r\n        totalPrice: result.totalPrice,\r\n        currency: result.currency,\r\n        cancellationPolicy: result.cancellationPolicy,\r\n        roomDetails: {\r\n          name: result.room?.name,\r\n          bedType: result.room?.bedType,\r\n          maxOccupancy: result.room?.maxOccupancy,\r\n          amenities: result.room?.amenities\r\n        },\r\n        rateDetails: {\r\n          name: result.rate?.name,\r\n          mealPlan: result.rate?.mealPlan,\r\n          refundable: result.rate?.refundable\r\n        }\r\n      }\r\n    };\r\n  } catch (error: any) {\r\n    return {\r\n      success: false,\r\n      data: null,\r\n      error: error.message || 'Failed to prebook room'\r\n    };\r\n  }\r\n}\r\n\r\nregisterToolHandler('prebook_room', handlePrebook as any);\r\n\r\n// ========================================\r\n// BOOKING HANDLER\r\n// ========================================\r\n\r\ninterface BookingParams {\r\n  prebookToken: string;\r\n  guest: {\r\n    firstName: string;\r\n    lastName: string;\r\n    email: string;\r\n    phone: string;\r\n    nationality?: string;\r\n    specialRequests?: string;\r\n  };\r\n  payment?: {\r\n    method: string;\r\n    cardToken?: string;\r\n  };\r\n}\r\n\r\nasync function handleBooking(\r\n  params: BookingParams,\r\n  context: ConversationContext\r\n): Promise<ToolResult> {\r\n  try {\r\n    // Use stored prebook token if not provided\r\n    const prebookToken = params.prebookToken || context.metadata.prebookToken;\r\n\r\n    if (!prebookToken) {\r\n      return {\r\n        success: false,\r\n        data: null,\r\n        error: 'No prebook token available. Please prebook a room first.'\r\n      };\r\n    }\r\n\r\n    const result = await callMediciApi({\r\n      endpoint: '/v1/booking/book',\r\n      method: 'POST',\r\n      body: {\r\n        prebookToken,\r\n        guest: params.guest,\r\n        payment: params.payment\r\n      }\r\n    });\r\n\r\n    // Store booking info in context\r\n    context.metadata.lastBookingId = result.bookingId;\r\n    context.metadata.lastConfirmationNumber = result.confirmationNumber;\r\n\r\n    return {\r\n      success: true,\r\n      data: {\r\n        bookingId: result.bookingId,\r\n        confirmationNumber: result.confirmationNumber,\r\n        status: result.status,\r\n        hotelName: result.hotel?.name,\r\n        checkIn: result.checkIn,\r\n        checkOut: result.checkOut,\r\n        roomType: result.room?.name,\r\n        totalPrice: result.totalPrice,\r\n        currency: result.currency,\r\n        guestName: `${params.guest.firstName} ${params.guest.lastName}`,\r\n        confirmationEmail: params.guest.email\r\n      }\r\n    };\r\n  } catch (error: any) {\r\n    return {\r\n      success: false,\r\n      data: null,\r\n      error: error.message || 'Failed to complete booking'\r\n    };\r\n  }\r\n}\r\n\r\nregisterToolHandler('complete_booking', handleBooking as any);\r\n\r\n// ========================================\r\n// CANCELLATION HANDLER\r\n// ========================================\r\n\r\ninterface CancellationParams {\r\n  bookingId?: string;\r\n  confirmationNumber?: string;\r\n  email?: string;\r\n  reason?: string;\r\n}\r\n\r\nasync function handleCancellation(\r\n  params: CancellationParams,\r\n  context: ConversationContext\r\n): Promise<ToolResult> {\r\n  try {\r\n    // Use stored booking info if not provided\r\n    const bookingId = params.bookingId || context.metadata.lastBookingId;\r\n    const confirmationNumber = params.confirmationNumber || context.metadata.lastConfirmationNumber;\r\n\r\n    if (!bookingId && !confirmationNumber) {\r\n      return {\r\n        success: false,\r\n        data: null,\r\n        error: 'Please provide a booking ID or confirmation number.'\r\n      };\r\n    }\r\n\r\n    const result = await callMediciApi({\r\n      endpoint: '/v1/booking/cancel',\r\n      method: 'POST',\r\n      body: {\r\n        bookingId,\r\n        confirmationNumber,\r\n        email: params.email,\r\n        reason: params.reason\r\n      }\r\n    });\r\n\r\n    return {\r\n      success: true,\r\n      data: {\r\n        cancellationId: result.cancellationId,\r\n        bookingId: result.bookingId,\r\n        confirmationNumber: result.confirmationNumber,\r\n        status: result.status,\r\n        refundAmount: result.refundAmount,\r\n        refundCurrency: result.refundCurrency,\r\n        refundStatus: result.refundStatus,\r\n        cancellationFee: result.cancellationFee,\r\n        message: result.message || 'Booking successfully cancelled'\r\n      }\r\n    };\r\n  } catch (error: any) {\r\n    return {\r\n      success: false,\r\n      data: null,\r\n      error: error.message || 'Failed to cancel booking'\r\n    };\r\n  }\r\n}\r\n\r\nregisterToolHandler('cancel_booking', handleCancellation);\r\n\r\n// ========================================\r\n// BOOKING LOOKUP HANDLER\r\n// ========================================\r\n\r\ninterface BookingLookupParams {\r\n  bookingId?: string;\r\n  confirmationNumber?: string;\r\n  email?: string;\r\n}\r\n\r\nasync function handleBookingLookup(\r\n  params: BookingLookupParams,\r\n  context: ConversationContext\r\n): Promise<ToolResult> {\r\n  try {\r\n    const queryParams = new URLSearchParams();\r\n    if (params.bookingId) queryParams.set('bookingId', params.bookingId);\r\n    if (params.confirmationNumber) queryParams.set('confirmationNumber', params.confirmationNumber);\r\n    if (params.email) queryParams.set('email', params.email);\r\n\r\n    const result = await callMediciApi({\r\n      endpoint: `/v1/booking/lookup?${queryParams.toString()}`,\r\n      method: 'GET'\r\n    });\r\n\r\n    return {\r\n      success: true,\r\n      data: {\r\n        bookingId: result.bookingId,\r\n        confirmationNumber: result.confirmationNumber,\r\n        status: result.status,\r\n        hotelName: result.hotel?.name,\r\n        hotelAddress: result.hotel?.address,\r\n        checkIn: result.checkIn,\r\n        checkOut: result.checkOut,\r\n        roomType: result.room?.name,\r\n        guestName: result.guest?.name,\r\n        totalPrice: result.totalPrice,\r\n        currency: result.currency,\r\n        cancellationPolicy: result.cancellationPolicy,\r\n        canCancel: result.canCancel,\r\n        canModify: result.canModify\r\n      }\r\n    };\r\n  } catch (error: any) {\r\n    return {\r\n      success: false,\r\n      data: null,\r\n      error: error.message || 'Failed to find booking'\r\n    };\r\n  }\r\n}\r\n\r\nregisterToolHandler('lookup_booking', handleBookingLookup);\r\n\r\n// ========================================\r\n// HOTEL DETAILS HANDLER\r\n// ========================================\r\n\r\ninterface HotelDetailsParams {\r\n  hotelId: string;\r\n}\r\n\r\nasync function handleHotelDetails(\r\n  params: HotelDetailsParams,\r\n  context: ConversationContext\r\n): Promise<ToolResult> {\r\n  try {\r\n    const result = await callMediciApi({\r\n      endpoint: `/v1/hotels/${params.hotelId}`,\r\n      method: 'GET'\r\n    });\r\n\r\n    return {\r\n      success: true,\r\n      data: {\r\n        hotelId: result.hotelId,\r\n        name: result.name,\r\n        description: result.description,\r\n        address: result.address,\r\n        city: result.city,\r\n        country: result.country,\r\n        coordinates: result.coordinates,\r\n        starRating: result.starRating,\r\n        rating: result.rating,\r\n        reviewCount: result.reviewCount,\r\n        images: result.images,\r\n        amenities: result.amenities,\r\n        policies: {\r\n          checkIn: result.policies?.checkIn,\r\n          checkOut: result.policies?.checkOut,\r\n          cancellation: result.policies?.cancellation,\r\n          children: result.policies?.children,\r\n          pets: result.policies?.pets\r\n        },\r\n        contact: result.contact\r\n      }\r\n    };\r\n  } catch (error: any) {\r\n    return {\r\n      success: false,\r\n      data: null,\r\n      error: error.message || 'Failed to get hotel details'\r\n    };\r\n  }\r\n}\r\n\r\nregisterToolHandler('get_hotel_details', handleHotelDetails as any);\r\n\r\nexport {\r\n  handleSearchHotels,\r\n  handleSearchDestinations,\r\n  handlePrebook,\r\n  handleBooking,\r\n  handleCancellation,\r\n  handleBookingLookup,\r\n  handleHotelDetails\r\n};\r\n","/**\r\n * Hotel Booking AI - Voice Handler\r\n * Handles voice-based interactions using Azure Communication Services\r\n */\r\n\r\nimport type { ConversationContext, ToolResult } from '../types';\r\nimport { registerToolHandler } from '../engine-manager';\r\n\r\n// ========================================\r\n// AZURE COMMUNICATION SERVICES CONFIG\r\n// ========================================\r\n\r\nconst AZURE_COMMUNICATION_CONNECTION_STRING = process.env.AZURE_COMMUNICATION_CONNECTION_STRING;\r\nconst AZURE_SPEECH_KEY = process.env.AZURE_SPEECH_KEY;\r\nconst AZURE_SPEECH_REGION = process.env.AZURE_SPEECH_REGION || 'eastus';\r\nconst TWILIO_ACCOUNT_SID = process.env.TWILIO_ACCOUNT_SID;\r\nconst TWILIO_AUTH_TOKEN = process.env.TWILIO_AUTH_TOKEN;\r\nconst TWILIO_PHONE_NUMBER = process.env.TWILIO_PHONE_NUMBER;\r\n\r\n// ========================================\r\n// VOICE SESSION MANAGEMENT\r\n// ========================================\r\n\r\ninterface VoiceSession {\r\n  sessionId: string;\r\n  callId?: string;\r\n  phoneNumber: string;\r\n  status: 'initiating' | 'ringing' | 'connected' | 'ended' | 'failed';\r\n  startTime: string;\r\n  endTime?: string;\r\n  transcript: Array<{\r\n    speaker: 'agent' | 'customer';\r\n    text: string;\r\n    timestamp: string;\r\n  }>;\r\n  metadata: Record<string, any>;\r\n}\r\n\r\nconst voiceSessions = new Map<string, VoiceSession>();\r\n\r\n// ========================================\r\n// INITIATE CALL HANDLER\r\n// ========================================\r\n\r\ninterface InitiateCallParams {\r\n  phoneNumber: string;\r\n  language?: string;\r\n  initialMessage?: string;\r\n  callbackUrl?: string;\r\n}\r\n\r\nasync function handleInitiateCall(\r\n  params: InitiateCallParams,\r\n  context: ConversationContext\r\n): Promise<ToolResult> {\r\n  try {\r\n    // Validate phone number format\r\n    const phoneNumber = params.phoneNumber.replace(/\\D/g, '');\r\n    if (phoneNumber.length < 10) {\r\n      return {\r\n        success: false,\r\n        data: null,\r\n        error: 'Invalid phone number format'\r\n      };\r\n    }\r\n\r\n    const sessionId = `voice-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;\r\n\r\n    // Create voice session\r\n    const session: VoiceSession = {\r\n      sessionId,\r\n      phoneNumber: params.phoneNumber,\r\n      status: 'initiating',\r\n      startTime: new Date().toISOString(),\r\n      transcript: [],\r\n      metadata: {\r\n        language: params.language || 'en',\r\n        initialMessage: params.initialMessage,\r\n        conversationSessionId: context.sessionId\r\n      }\r\n    };\r\n\r\n    voiceSessions.set(sessionId, session);\r\n\r\n    // In production, this would initiate the actual call via Azure/Twilio\r\n    // For now, we simulate the response\r\n    \r\n    // Simulate call initiation\r\n    session.status = 'ringing';\r\n    session.callId = `call-${Date.now()}`;\r\n\r\n    // Store session ID in context\r\n    context.metadata.activeVoiceSession = sessionId;\r\n\r\n    return {\r\n      success: true,\r\n      data: {\r\n        sessionId,\r\n        callId: session.callId,\r\n        status: session.status,\r\n        phoneNumber: params.phoneNumber,\r\n        message: 'Call initiated successfully. Waiting for customer to answer.'\r\n      }\r\n    };\r\n  } catch (error: any) {\r\n    return {\r\n      success: false,\r\n      data: null,\r\n      error: error.message || 'Failed to initiate call'\r\n    };\r\n  }\r\n}\r\n\r\nregisterToolHandler('initiate_call', handleInitiateCall as any);\r\n\r\n// ========================================\r\n// END CALL HANDLER\r\n// ========================================\r\n\r\ninterface EndCallParams {\r\n  sessionId?: string;\r\n  reason?: string;\r\n}\r\n\r\nasync function handleEndCall(\r\n  params: EndCallParams,\r\n  context: ConversationContext\r\n): Promise<ToolResult> {\r\n  try {\r\n    const sessionId = params.sessionId || context.metadata.activeVoiceSession;\r\n\r\n    if (!sessionId) {\r\n      return {\r\n        success: false,\r\n        data: null,\r\n        error: 'No active voice session found'\r\n      };\r\n    }\r\n\r\n    const session = voiceSessions.get(sessionId);\r\n    if (!session) {\r\n      return {\r\n        success: false,\r\n        data: null,\r\n        error: 'Voice session not found'\r\n      };\r\n    }\r\n\r\n    // End the session\r\n    session.status = 'ended';\r\n    session.endTime = new Date().toISOString();\r\n\r\n    // Calculate duration\r\n    const startTime = new Date(session.startTime).getTime();\r\n    const endTime = new Date(session.endTime).getTime();\r\n    const durationSeconds = Math.round((endTime - startTime) / 1000);\r\n\r\n    // Clear active session from context\r\n    delete context.metadata.activeVoiceSession;\r\n\r\n    return {\r\n      success: true,\r\n      data: {\r\n        sessionId,\r\n        status: 'ended',\r\n        duration: durationSeconds,\r\n        transcriptLength: session.transcript.length,\r\n        endReason: params.reason || 'completed',\r\n        message: 'Call ended successfully'\r\n      }\r\n    };\r\n  } catch (error: any) {\r\n    return {\r\n      success: false,\r\n      data: null,\r\n      error: error.message || 'Failed to end call'\r\n    };\r\n  }\r\n}\r\n\r\nregisterToolHandler('end_call', handleEndCall);\r\n\r\n// ========================================\r\n// TEXT TO SPEECH HANDLER\r\n// ========================================\r\n\r\ninterface SpeakParams {\r\n  text: string;\r\n  language?: string;\r\n  voiceId?: string;\r\n  rate?: number;\r\n  pitch?: number;\r\n}\r\n\r\nasync function handleSpeak(\r\n  params: SpeakParams,\r\n  context: ConversationContext\r\n): Promise<ToolResult> {\r\n  try {\r\n    const sessionId = context.metadata.activeVoiceSession;\r\n\r\n    if (!sessionId) {\r\n      return {\r\n        success: false,\r\n        data: null,\r\n        error: 'No active voice session'\r\n      };\r\n    }\r\n\r\n    const session = voiceSessions.get(sessionId);\r\n    if (!session || session.status !== 'connected') {\r\n      return {\r\n        success: false,\r\n        data: null,\r\n        error: 'Voice session not connected'\r\n      };\r\n    }\r\n\r\n    // Add to transcript\r\n    session.transcript.push({\r\n      speaker: 'agent',\r\n      text: params.text,\r\n      timestamp: new Date().toISOString()\r\n    });\r\n\r\n    // In production, this would use Azure Speech SDK to synthesize speech\r\n    // For now, we simulate the response\r\n\r\n    return {\r\n      success: true,\r\n      data: {\r\n        sessionId,\r\n        text: params.text,\r\n        language: params.language || session.metadata.language,\r\n        voiceId: params.voiceId || 'he-IL-HilaNeural',\r\n        duration: Math.ceil(params.text.length / 15), // Approximate duration in seconds\r\n        message: 'Speech synthesized and played'\r\n      }\r\n    };\r\n  } catch (error: any) {\r\n    return {\r\n      success: false,\r\n      data: null,\r\n      error: error.message || 'Failed to synthesize speech'\r\n    };\r\n  }\r\n}\r\n\r\nregisterToolHandler('speak_text', handleSpeak as any);\r\n\r\n// ========================================\r\n// SPEECH TO TEXT HANDLER\r\n// ========================================\r\n\r\ninterface ListenParams {\r\n  timeout?: number;\r\n  language?: string;\r\n  hints?: string[];\r\n}\r\n\r\nasync function handleListen(\r\n  params: ListenParams,\r\n  context: ConversationContext\r\n): Promise<ToolResult> {\r\n  try {\r\n    const sessionId = context.metadata.activeVoiceSession;\r\n\r\n    if (!sessionId) {\r\n      return {\r\n        success: false,\r\n        data: null,\r\n        error: 'No active voice session'\r\n      };\r\n    }\r\n\r\n    const session = voiceSessions.get(sessionId);\r\n    if (!session || session.status !== 'connected') {\r\n      return {\r\n        success: false,\r\n        data: null,\r\n        error: 'Voice session not connected'\r\n      };\r\n    }\r\n\r\n    // In production, this would use Azure Speech SDK for speech recognition\r\n    // For now, we return a placeholder response\r\n\r\n    return {\r\n      success: true,\r\n      data: {\r\n        sessionId,\r\n        recognized: true,\r\n        text: '[Customer response would be transcribed here]',\r\n        confidence: 0.95,\r\n        language: params.language || session.metadata.language,\r\n        message: 'Listening for customer input'\r\n      }\r\n    };\r\n  } catch (error: any) {\r\n    return {\r\n      success: false,\r\n      data: null,\r\n      error: error.message || 'Failed to recognize speech'\r\n    };\r\n  }\r\n}\r\n\r\nregisterToolHandler('listen_speech', handleListen);\r\n\r\n// ========================================\r\n// SEND SMS HANDLER\r\n// ========================================\r\n\r\ninterface SendSmsParams {\r\n  phoneNumber: string;\r\n  message: string;\r\n  templateId?: string;\r\n}\r\n\r\nasync function handleSendSms(\r\n  params: SendSmsParams,\r\n  context: ConversationContext\r\n): Promise<ToolResult> {\r\n  try {\r\n    // Validate phone number\r\n    const phoneNumber = params.phoneNumber.replace(/\\D/g, '');\r\n    if (phoneNumber.length < 10) {\r\n      return {\r\n        success: false,\r\n        data: null,\r\n        error: 'Invalid phone number format'\r\n      };\r\n    }\r\n\r\n    // Validate message length\r\n    if (params.message.length > 1600) {\r\n      return {\r\n        success: false,\r\n        data: null,\r\n        error: 'Message too long. Maximum 1600 characters.'\r\n      };\r\n    }\r\n\r\n    // In production, this would use Twilio/Azure to send SMS\r\n    // For now, we simulate the response\r\n\r\n    const messageId = `sms-${Date.now()}-${Math.random().toString(36).substr(2, 6)}`;\r\n\r\n    // Store in context for tracking\r\n    if (!context.metadata.sentMessages) {\r\n      context.metadata.sentMessages = [];\r\n    }\r\n    context.metadata.sentMessages.push({\r\n      id: messageId,\r\n      type: 'sms',\r\n      to: params.phoneNumber,\r\n      content: params.message,\r\n      sentAt: new Date().toISOString()\r\n    });\r\n\r\n    return {\r\n      success: true,\r\n      data: {\r\n        messageId,\r\n        to: params.phoneNumber,\r\n        status: 'sent',\r\n        segments: Math.ceil(params.message.length / 160),\r\n        message: 'SMS sent successfully'\r\n      }\r\n    };\r\n  } catch (error: any) {\r\n    return {\r\n      success: false,\r\n      data: null,\r\n      error: error.message || 'Failed to send SMS'\r\n    };\r\n  }\r\n}\r\n\r\nregisterToolHandler('send_sms', handleSendSms as any);\r\n\r\n// ========================================\r\n// CALL STATUS HANDLER\r\n// ========================================\r\n\r\ninterface CallStatusParams {\r\n  sessionId?: string;\r\n}\r\n\r\nasync function handleCallStatus(\r\n  params: CallStatusParams,\r\n  context: ConversationContext\r\n): Promise<ToolResult> {\r\n  try {\r\n    const sessionId = params.sessionId || context.metadata.activeVoiceSession;\r\n\r\n    if (!sessionId) {\r\n      return {\r\n        success: false,\r\n        data: null,\r\n        error: 'No voice session specified'\r\n      };\r\n    }\r\n\r\n    const session = voiceSessions.get(sessionId);\r\n    if (!session) {\r\n      return {\r\n        success: false,\r\n        data: null,\r\n        error: 'Voice session not found'\r\n      };\r\n    }\r\n\r\n    const startTime = new Date(session.startTime).getTime();\r\n    const endTime = session.endTime\r\n      ? new Date(session.endTime).getTime()\r\n      : Date.now();\r\n    const durationSeconds = Math.round((endTime - startTime) / 1000);\r\n\r\n    return {\r\n      success: true,\r\n      data: {\r\n        sessionId,\r\n        callId: session.callId,\r\n        status: session.status,\r\n        phoneNumber: session.phoneNumber,\r\n        duration: durationSeconds,\r\n        transcriptLength: session.transcript.length,\r\n        language: session.metadata.language\r\n      }\r\n    };\r\n  } catch (error: any) {\r\n    return {\r\n      success: false,\r\n      data: null,\r\n      error: error.message || 'Failed to get call status'\r\n    };\r\n  }\r\n}\r\n\r\nregisterToolHandler('get_call_status', handleCallStatus);\r\n\r\n// ========================================\r\n// TRANSFER CALL HANDLER\r\n// ========================================\r\n\r\ninterface TransferCallParams {\r\n  sessionId?: string;\r\n  targetNumber: string;\r\n  reason?: string;\r\n}\r\n\r\nasync function handleTransferCall(\r\n  params: TransferCallParams,\r\n  context: ConversationContext\r\n): Promise<ToolResult> {\r\n  try {\r\n    const sessionId = params.sessionId || context.metadata.activeVoiceSession;\r\n\r\n    if (!sessionId) {\r\n      return {\r\n        success: false,\r\n        data: null,\r\n        error: 'No voice session to transfer'\r\n      };\r\n    }\r\n\r\n    const session = voiceSessions.get(sessionId);\r\n    if (!session || session.status !== 'connected') {\r\n      return {\r\n        success: false,\r\n        data: null,\r\n        error: 'Voice session not connected'\r\n      };\r\n    }\r\n\r\n    // In production, this would transfer the call\r\n    // For now, we simulate the response\r\n\r\n    return {\r\n      success: true,\r\n      data: {\r\n        sessionId,\r\n        status: 'transferring',\r\n        targetNumber: params.targetNumber,\r\n        reason: params.reason || 'Customer request',\r\n        message: 'Call transfer initiated'\r\n      }\r\n    };\r\n  } catch (error: any) {\r\n    return {\r\n      success: false,\r\n      data: null,\r\n      error: error.message || 'Failed to transfer call'\r\n    };\r\n  }\r\n}\r\n\r\nregisterToolHandler('transfer_call', handleTransferCall as any);\r\n\r\n// ========================================\r\n// VOICE SESSION UTILITIES\r\n// ========================================\r\n\r\nexport function getVoiceSession(sessionId: string): VoiceSession | undefined {\r\n  return voiceSessions.get(sessionId);\r\n}\r\n\r\nexport function getActiveVoiceSessions(): VoiceSession[] {\r\n  return Array.from(voiceSessions.values()).filter(\r\n    session => session.status === 'connected' || session.status === 'ringing'\r\n  );\r\n}\r\n\r\nexport function getVoiceSessionTranscript(sessionId: string): VoiceSession['transcript'] | null {\r\n  const session = voiceSessions.get(sessionId);\r\n  return session ? session.transcript : null;\r\n}\r\n\r\nexport {\r\n  handleInitiateCall,\r\n  handleEndCall,\r\n  handleSpeak,\r\n  handleListen,\r\n  handleSendSms,\r\n  handleCallStatus,\r\n  handleTransferCall\r\n};\r\n","/**\r\n * Hotel Booking AI - Price Monitoring Handler\r\n * Handles price tracking, alerts, and trend analysis\r\n */\r\n\r\nimport type { ConversationContext, ToolResult } from '../types';\r\nimport { registerToolHandler } from '../engine-manager';\r\n\r\n// ========================================\r\n// PRICE TRACKING DATA STRUCTURES\r\n// ========================================\r\n\r\ninterface PriceAlert {\r\n  id: string;\r\n  hotelId: string;\r\n  hotelName: string;\r\n  roomType: string;\r\n  checkIn: string;\r\n  checkOut: string;\r\n  targetPrice?: number;\r\n  alertType: 'price-drop' | 'availability' | 'threshold';\r\n  thresholdPercentage?: number;\r\n  status: 'active' | 'triggered' | 'expired' | 'cancelled';\r\n  createdAt: string;\r\n  lastChecked?: string;\r\n  priceHistory: Array<{\r\n    price: number;\r\n    currency: string;\r\n    timestamp: string;\r\n  }>;\r\n  userId?: string;\r\n  notificationMethod: 'email' | 'sms' | 'push';\r\n  notificationEmail?: string;\r\n  notificationPhone?: string;\r\n}\r\n\r\ninterface PriceSnapshot {\r\n  hotelId: string;\r\n  roomType: string;\r\n  price: number;\r\n  currency: string;\r\n  timestamp: string;\r\n  source: string;\r\n}\r\n\r\n// In-memory storage (in production, use database)\r\nconst priceAlerts = new Map<string, PriceAlert>();\r\nconst priceHistory = new Map<string, PriceSnapshot[]>();\r\n\r\n// ========================================\r\n// CREATE PRICE ALERT HANDLER\r\n// ========================================\r\n\r\ninterface CreateAlertParams {\r\n  hotelId: string;\r\n  hotelName: string;\r\n  roomType: string;\r\n  checkIn: string;\r\n  checkOut: string;\r\n  alertType: 'price-drop' | 'availability' | 'threshold';\r\n  targetPrice?: number;\r\n  thresholdPercentage?: number;\r\n  notificationMethod: 'email' | 'sms' | 'push';\r\n  email?: string;\r\n  phone?: string;\r\n}\r\n\r\nasync function handleCreatePriceAlert(\r\n  params: CreateAlertParams,\r\n  context: ConversationContext\r\n): Promise<ToolResult> {\r\n  try {\r\n    const alertId = `alert-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;\r\n\r\n    const alert: PriceAlert = {\r\n      id: alertId,\r\n      hotelId: params.hotelId,\r\n      hotelName: params.hotelName,\r\n      roomType: params.roomType,\r\n      checkIn: params.checkIn,\r\n      checkOut: params.checkOut,\r\n      alertType: params.alertType,\r\n      targetPrice: params.targetPrice,\r\n      thresholdPercentage: params.thresholdPercentage || 10,\r\n      status: 'active',\r\n      createdAt: new Date().toISOString(),\r\n      priceHistory: [],\r\n      userId: context.metadata.userId,\r\n      notificationMethod: params.notificationMethod,\r\n      notificationEmail: params.email,\r\n      notificationPhone: params.phone\r\n    };\r\n\r\n    priceAlerts.set(alertId, alert);\r\n\r\n    // Store alert ID in context\r\n    if (!context.metadata.priceAlerts) {\r\n      context.metadata.priceAlerts = [];\r\n    }\r\n    context.metadata.priceAlerts.push(alertId);\r\n\r\n    return {\r\n      success: true,\r\n      data: {\r\n        alertId,\r\n        hotelName: params.hotelName,\r\n        roomType: params.roomType,\r\n        dates: `${params.checkIn} to ${params.checkOut}`,\r\n        alertType: params.alertType,\r\n        targetPrice: params.targetPrice,\r\n        thresholdPercentage: params.thresholdPercentage,\r\n        notificationMethod: params.notificationMethod,\r\n        status: 'active',\r\n        message: 'Price alert created successfully. You will be notified when conditions are met.'\r\n      }\r\n    };\r\n  } catch (error: any) {\r\n    return {\r\n      success: false,\r\n      data: null,\r\n      error: error.message || 'Failed to create price alert'\r\n    };\r\n  }\r\n}\r\n\r\nregisterToolHandler('create_price_alert', handleCreatePriceAlert as any);\r\n\r\n// ========================================\r\n// GET PRICE ALERTS HANDLER\r\n// ========================================\r\n\r\ninterface GetAlertsParams {\r\n  status?: 'active' | 'triggered' | 'expired' | 'cancelled';\r\n  hotelId?: string;\r\n}\r\n\r\nasync function handleGetPriceAlerts(\r\n  params: GetAlertsParams,\r\n  context: ConversationContext\r\n): Promise<ToolResult> {\r\n  try {\r\n    let alerts = Array.from(priceAlerts.values());\r\n\r\n    // Filter by user if available\r\n    if (context.metadata.userId) {\r\n      alerts = alerts.filter(a => a.userId === context.metadata.userId);\r\n    }\r\n\r\n    // Filter by status\r\n    if (params.status) {\r\n      alerts = alerts.filter(a => a.status === params.status);\r\n    }\r\n\r\n    // Filter by hotel\r\n    if (params.hotelId) {\r\n      alerts = alerts.filter(a => a.hotelId === params.hotelId);\r\n    }\r\n\r\n    return {\r\n      success: true,\r\n      data: {\r\n        totalAlerts: alerts.length,\r\n        alerts: alerts.map(alert => ({\r\n          id: alert.id,\r\n          hotelName: alert.hotelName,\r\n          roomType: alert.roomType,\r\n          dates: `${alert.checkIn} to ${alert.checkOut}`,\r\n          alertType: alert.alertType,\r\n          targetPrice: alert.targetPrice,\r\n          status: alert.status,\r\n          createdAt: alert.createdAt,\r\n          lastChecked: alert.lastChecked,\r\n          currentPrice: alert.priceHistory[alert.priceHistory.length - 1]?.price,\r\n          priceChanges: alert.priceHistory.length\r\n        }))\r\n      }\r\n    };\r\n  } catch (error: any) {\r\n    return {\r\n      success: false,\r\n      data: null,\r\n      error: error.message || 'Failed to get price alerts'\r\n    };\r\n  }\r\n}\r\n\r\nregisterToolHandler('get_price_alerts', handleGetPriceAlerts);\r\n\r\n// ========================================\r\n// CANCEL PRICE ALERT HANDLER\r\n// ========================================\r\n\r\ninterface CancelAlertParams {\r\n  alertId: string;\r\n}\r\n\r\nasync function handleCancelPriceAlert(\r\n  params: CancelAlertParams,\r\n  context: ConversationContext\r\n): Promise<ToolResult> {\r\n  try {\r\n    const alert = priceAlerts.get(params.alertId);\r\n\r\n    if (!alert) {\r\n      return {\r\n        success: false,\r\n        data: null,\r\n        error: 'Price alert not found'\r\n      };\r\n    }\r\n\r\n    // Verify ownership\r\n    if (context.metadata.userId && alert.userId !== context.metadata.userId) {\r\n      return {\r\n        success: false,\r\n        data: null,\r\n        error: 'Not authorized to cancel this alert'\r\n      };\r\n    }\r\n\r\n    alert.status = 'cancelled';\r\n\r\n    return {\r\n      success: true,\r\n      data: {\r\n        alertId: params.alertId,\r\n        hotelName: alert.hotelName,\r\n        status: 'cancelled',\r\n        message: 'Price alert cancelled successfully'\r\n      }\r\n    };\r\n  } catch (error: any) {\r\n    return {\r\n      success: false,\r\n      data: null,\r\n      error: error.message || 'Failed to cancel price alert'\r\n    };\r\n  }\r\n}\r\n\r\nregisterToolHandler('cancel_price_alert', handleCancelPriceAlert as any);\r\n\r\n// ========================================\r\n// GET PRICE HISTORY HANDLER\r\n// ========================================\r\n\r\ninterface GetPriceHistoryParams {\r\n  hotelId: string;\r\n  roomType?: string;\r\n  startDate?: string;\r\n  endDate?: string;\r\n}\r\n\r\nasync function handleGetPriceHistory(\r\n  params: GetPriceHistoryParams,\r\n  context: ConversationContext\r\n): Promise<ToolResult> {\r\n  try {\r\n    const key = `${params.hotelId}-${params.roomType || 'all'}`;\r\n    const history = priceHistory.get(key) || [];\r\n\r\n    // Filter by date range if provided\r\n    let filteredHistory = history;\r\n    if (params.startDate || params.endDate) {\r\n      filteredHistory = history.filter(snapshot => {\r\n        const snapshotDate = new Date(snapshot.timestamp);\r\n        if (params.startDate && snapshotDate < new Date(params.startDate)) return false;\r\n        if (params.endDate && snapshotDate > new Date(params.endDate)) return false;\r\n        return true;\r\n      });\r\n    }\r\n\r\n    // Calculate statistics\r\n    const prices = filteredHistory.map(s => s.price);\r\n    const stats = prices.length > 0 ? {\r\n      minPrice: Math.min(...prices),\r\n      maxPrice: Math.max(...prices),\r\n      avgPrice: Math.round(prices.reduce((a, b) => a + b, 0) / prices.length),\r\n      currentPrice: prices[prices.length - 1],\r\n      priceChange: prices.length > 1\r\n        ? ((prices[prices.length - 1] - prices[0]) / prices[0] * 100).toFixed(1)\r\n        : 0\r\n    } : null;\r\n\r\n    return {\r\n      success: true,\r\n      data: {\r\n        hotelId: params.hotelId,\r\n        roomType: params.roomType,\r\n        dataPoints: filteredHistory.length,\r\n        dateRange: {\r\n          from: filteredHistory[0]?.timestamp,\r\n          to: filteredHistory[filteredHistory.length - 1]?.timestamp\r\n        },\r\n        statistics: stats,\r\n        trend: stats && Number(stats.priceChange) < -5 ? 'declining'\r\n          : stats && Number(stats.priceChange) > 5 ? 'rising'\r\n          : 'stable',\r\n        history: filteredHistory.slice(-30) // Last 30 data points\r\n      }\r\n    };\r\n  } catch (error: any) {\r\n    return {\r\n      success: false,\r\n      data: null,\r\n      error: error.message || 'Failed to get price history'\r\n    };\r\n  }\r\n}\r\n\r\nregisterToolHandler('get_price_history', handleGetPriceHistory as any);\r\n\r\n// ========================================\r\n// ANALYZE PRICE TRENDS HANDLER\r\n// ========================================\r\n\r\ninterface AnalyzeTrendsParams {\r\n  hotelId: string;\r\n  roomType?: string;\r\n  period?: 'week' | 'month' | 'quarter';\r\n}\r\n\r\nasync function handleAnalyzePriceTrends(\r\n  params: AnalyzeTrendsParams,\r\n  context: ConversationContext\r\n): Promise<ToolResult> {\r\n  try {\r\n    const key = `${params.hotelId}-${params.roomType || 'all'}`;\r\n    const history = priceHistory.get(key) || [];\r\n\r\n    // Determine period in days\r\n    const periodDays = params.period === 'week' ? 7\r\n      : params.period === 'quarter' ? 90\r\n      : 30;\r\n\r\n    const cutoffDate = new Date();\r\n    cutoffDate.setDate(cutoffDate.getDate() - periodDays);\r\n\r\n    const periodHistory = history.filter(\r\n      s => new Date(s.timestamp) >= cutoffDate\r\n    );\r\n\r\n    if (periodHistory.length < 2) {\r\n      return {\r\n        success: true,\r\n        data: {\r\n          hotelId: params.hotelId,\r\n          period: params.period || 'month',\r\n          message: 'Insufficient data for trend analysis',\r\n          recommendation: 'Continue monitoring to gather more price data'\r\n        }\r\n      };\r\n    }\r\n\r\n    const prices = periodHistory.map(s => s.price);\r\n    const startPrice = prices[0];\r\n    const endPrice = prices[prices.length - 1];\r\n    const changePercent = ((endPrice - startPrice) / startPrice * 100).toFixed(1);\r\n\r\n    // Calculate volatility\r\n    const avgPrice = prices.reduce((a, b) => a + b, 0) / prices.length;\r\n    const variance = prices.reduce((sum, p) => sum + Math.pow(p - avgPrice, 2), 0) / prices.length;\r\n    const volatility = Math.sqrt(variance);\r\n\r\n    // Determine trend\r\n    let trend: string;\r\n    let recommendation: string;\r\n\r\n    if (Number(changePercent) <= -10) {\r\n      trend = 'strong-decline';\r\n      recommendation = 'Great time to book! Prices have dropped significantly.';\r\n    } else if (Number(changePercent) <= -5) {\r\n      trend = 'moderate-decline';\r\n      recommendation = 'Good opportunity to book. Prices are trending down.';\r\n    } else if (Number(changePercent) >= 10) {\r\n      trend = 'strong-increase';\r\n      recommendation = 'Consider booking soon. Prices are rising quickly.';\r\n    } else if (Number(changePercent) >= 5) {\r\n      trend = 'moderate-increase';\r\n      recommendation = 'Prices are slowly rising. Book when ready.';\r\n    } else {\r\n      trend = 'stable';\r\n      recommendation = 'Prices are stable. No urgency to book.';\r\n    }\r\n\r\n    return {\r\n      success: true,\r\n      data: {\r\n        hotelId: params.hotelId,\r\n        roomType: params.roomType,\r\n        period: params.period || 'month',\r\n        dataPoints: periodHistory.length,\r\n        analysis: {\r\n          trend,\r\n          changePercent: `${changePercent}%`,\r\n          startPrice,\r\n          endPrice,\r\n          minPrice: Math.min(...prices),\r\n          maxPrice: Math.max(...prices),\r\n          avgPrice: Math.round(avgPrice),\r\n          volatility: volatility.toFixed(2),\r\n          volatilityLevel: volatility > avgPrice * 0.1 ? 'high'\r\n            : volatility > avgPrice * 0.05 ? 'moderate'\r\n            : 'low'\r\n        },\r\n        recommendation,\r\n        bestTimeToBook: trend.includes('decline')\r\n          ? 'Prices may drop further. Consider waiting a few more days.'\r\n          : trend.includes('increase')\r\n          ? 'Book now before prices increase more.'\r\n          : 'Current prices are reasonable. Book at your convenience.'\r\n      }\r\n    };\r\n  } catch (error: any) {\r\n    return {\r\n      success: false,\r\n      data: null,\r\n      error: error.message || 'Failed to analyze price trends'\r\n    };\r\n  }\r\n}\r\n\r\nregisterToolHandler('analyze_price_trends', handleAnalyzePriceTrends as any);\r\n\r\n// ========================================\r\n// COMPARE PRICES HANDLER\r\n// ========================================\r\n\r\ninterface ComparePricesParams {\r\n  hotelIds: string[];\r\n  checkIn: string;\r\n  checkOut: string;\r\n  roomType?: string;\r\n}\r\n\r\nasync function handleComparePrices(\r\n  params: ComparePricesParams,\r\n  context: ConversationContext\r\n): Promise<ToolResult> {\r\n  try {\r\n    // In production, this would fetch live prices from multiple sources\r\n    // For now, we simulate comparison data\r\n\r\n    const comparisons = params.hotelIds.map((hotelId, index) => {\r\n      const basePrice = 150 + Math.random() * 200;\r\n      return {\r\n        hotelId,\r\n        hotelName: `Hotel ${hotelId}`,\r\n        prices: [\r\n          { source: 'Direct', price: Math.round(basePrice), currency: 'USD' },\r\n          { source: 'Booking.com', price: Math.round(basePrice * 1.05), currency: 'USD' },\r\n          { source: 'Expedia', price: Math.round(basePrice * 1.08), currency: 'USD' },\r\n          { source: 'Hotels.com', price: Math.round(basePrice * 1.03), currency: 'USD' }\r\n        ],\r\n        bestPrice: Math.round(basePrice),\r\n        bestSource: 'Direct'\r\n      };\r\n    });\r\n\r\n    // Find overall best deal\r\n    const bestDeal = comparisons.reduce((best, current) =>\r\n      current.bestPrice < best.bestPrice ? current : best\r\n    );\r\n\r\n    return {\r\n      success: true,\r\n      data: {\r\n        checkIn: params.checkIn,\r\n        checkOut: params.checkOut,\r\n        roomType: params.roomType,\r\n        comparisons,\r\n        bestOverall: {\r\n          hotelId: bestDeal.hotelId,\r\n          hotelName: bestDeal.hotelName,\r\n          price: bestDeal.bestPrice,\r\n          source: bestDeal.bestSource\r\n        },\r\n        savings: `Book direct to save up to ${Math.round(Math.random() * 15 + 5)}%`\r\n      }\r\n    };\r\n  } catch (error: any) {\r\n    return {\r\n      success: false,\r\n      data: null,\r\n      error: error.message || 'Failed to compare prices'\r\n    };\r\n  }\r\n}\r\n\r\nregisterToolHandler('compare_prices', handleComparePrices as any);\r\n\r\n// ========================================\r\n// UTILITIES\r\n// ========================================\r\n\r\nexport function getAlert(alertId: string): PriceAlert | undefined {\r\n  return priceAlerts.get(alertId);\r\n}\r\n\r\nexport function getActiveAlerts(): PriceAlert[] {\r\n  return Array.from(priceAlerts.values()).filter(a => a.status === 'active');\r\n}\r\n\r\nexport function addPriceSnapshot(snapshot: PriceSnapshot): void {\r\n  const key = `${snapshot.hotelId}-${snapshot.roomType}`;\r\n  const history = priceHistory.get(key) || [];\r\n  history.push(snapshot);\r\n  priceHistory.set(key, history);\r\n\r\n  // Check for alerts\r\n  checkPriceAlerts(snapshot);\r\n}\r\n\r\nfunction checkPriceAlerts(snapshot: PriceSnapshot): void {\r\n  const alerts = getActiveAlerts();\r\n\r\n  for (const alert of alerts) {\r\n    if (alert.hotelId !== snapshot.hotelId) continue;\r\n    if (alert.roomType && alert.roomType !== snapshot.roomType) continue;\r\n\r\n    // Add to alert history\r\n    alert.priceHistory.push({\r\n      price: snapshot.price,\r\n      currency: snapshot.currency,\r\n      timestamp: snapshot.timestamp\r\n    });\r\n    alert.lastChecked = snapshot.timestamp;\r\n\r\n    // Check trigger conditions\r\n    if (alert.alertType === 'threshold' && alert.targetPrice) {\r\n      if (snapshot.price <= alert.targetPrice) {\r\n        triggerAlert(alert, snapshot);\r\n      }\r\n    } else if (alert.alertType === 'price-drop' && alert.priceHistory.length > 1) {\r\n      const previousPrice = alert.priceHistory[alert.priceHistory.length - 2].price;\r\n      const dropPercent = ((previousPrice - snapshot.price) / previousPrice) * 100;\r\n      if (dropPercent >= (alert.thresholdPercentage || 10)) {\r\n        triggerAlert(alert, snapshot);\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nfunction triggerAlert(alert: PriceAlert, snapshot: PriceSnapshot): void {\r\n  alert.status = 'triggered';\r\n  console.log(`Alert triggered: ${alert.id} for ${alert.hotelName} at ${snapshot.price} ${snapshot.currency}`);\r\n  // In production, send notification via email/SMS/push\r\n}\r\n\r\nexport {\r\n  handleCreatePriceAlert,\r\n  handleGetPriceAlerts,\r\n  handleCancelPriceAlert,\r\n  handleGetPriceHistory,\r\n  handleAnalyzePriceTrends,\r\n  handleComparePrices\r\n};\r\n","/**\r\n * Hotel Booking AI - Notifications Handler\r\n * Handles email, SMS, and push notifications\r\n */\r\n\r\nimport type { ConversationContext, ToolResult } from '../types';\r\nimport { registerToolHandler } from '../engine-manager';\r\n\r\n// ========================================\r\n// EMAIL NOTIFICATION HANDLER\r\n// ========================================\r\n\r\ninterface SendEmailParams {\r\n  to: string;\r\n  subject: string;\r\n  body: string;\r\n  templateId?: string;\r\n  templateData?: Record<string, any>;\r\n  replyTo?: string;\r\n  cc?: string[];\r\n  attachments?: Array<{\r\n    filename: string;\r\n    content: string;\r\n    contentType: string;\r\n  }>;\r\n}\r\n\r\nasync function handleSendEmail(\r\n  params: SendEmailParams,\r\n  context: ConversationContext\r\n): Promise<ToolResult> {\r\n  try {\r\n    // Validate email format\r\n    const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\r\n    if (!emailRegex.test(params.to)) {\r\n      return {\r\n        success: false,\r\n        data: null,\r\n        error: 'Invalid email address format'\r\n      };\r\n    }\r\n\r\n    const messageId = `email-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;\r\n\r\n    // In production, this would use Resend/SendGrid/etc.\r\n    // For now, we log and simulate\r\n    console.log(`Sending email to ${params.to}: ${params.subject}`);\r\n\r\n    // Track sent emails in context\r\n    if (!context.metadata.sentNotifications) {\r\n      context.metadata.sentNotifications = [];\r\n    }\r\n    context.metadata.sentNotifications.push({\r\n      id: messageId,\r\n      type: 'email',\r\n      to: params.to,\r\n      subject: params.subject,\r\n      sentAt: new Date().toISOString()\r\n    });\r\n\r\n    return {\r\n      success: true,\r\n      data: {\r\n        messageId,\r\n        to: params.to,\r\n        subject: params.subject,\r\n        status: 'sent',\r\n        timestamp: new Date().toISOString(),\r\n        message: 'Email sent successfully'\r\n      }\r\n    };\r\n  } catch (error: any) {\r\n    return {\r\n      success: false,\r\n      data: null,\r\n      error: error.message || 'Failed to send email'\r\n    };\r\n  }\r\n}\r\n\r\nregisterToolHandler('send_email', handleSendEmail as any);\r\n\r\n// ========================================\r\n// BOOKING CONFIRMATION EMAIL\r\n// ========================================\r\n\r\ninterface SendBookingConfirmationParams {\r\n  email: string;\r\n  bookingDetails: {\r\n    confirmationNumber: string;\r\n    guestName: string;\r\n    hotelName: string;\r\n    hotelAddress: string;\r\n    checkIn: string;\r\n    checkOut: string;\r\n    roomType: string;\r\n    totalPrice: number;\r\n    currency: string;\r\n    cancellationPolicy?: string;\r\n  };\r\n  language?: 'en' | 'he';\r\n}\r\n\r\nasync function handleSendBookingConfirmation(\r\n  params: SendBookingConfirmationParams,\r\n  context: ConversationContext\r\n): Promise<ToolResult> {\r\n  try {\r\n    const { bookingDetails, language = 'en' } = params;\r\n\r\n    const subject = language === 'he'\r\n      ? `  - ${bookingDetails.hotelName}`\r\n      : `Booking Confirmation - ${bookingDetails.hotelName}`;\r\n\r\n    const body = language === 'he' ? `\r\n ${bookingDetails.guestName},\r\n\r\n  !   :\r\n\r\n : ${bookingDetails.confirmationNumber}\r\n: ${bookingDetails.hotelName}\r\n: ${bookingDetails.hotelAddress}\r\n'-: ${bookingDetails.checkIn}\r\n'-: ${bookingDetails.checkOut}\r\n : ${bookingDetails.roomType}\r\n\": ${bookingDetails.currency} ${bookingDetails.totalPrice}\r\n\r\n${bookingDetails.cancellationPolicy ? ` : ${bookingDetails.cancellationPolicy}` : ''}\r\n\r\n!\r\n    ` : `\r\nDear ${bookingDetails.guestName},\r\n\r\nThank you for your booking! Here are your reservation details:\r\n\r\nConfirmation Number: ${bookingDetails.confirmationNumber}\r\nHotel: ${bookingDetails.hotelName}\r\nAddress: ${bookingDetails.hotelAddress}\r\nCheck-in: ${bookingDetails.checkIn}\r\nCheck-out: ${bookingDetails.checkOut}\r\nRoom Type: ${bookingDetails.roomType}\r\nTotal: ${bookingDetails.currency} ${bookingDetails.totalPrice}\r\n\r\n${bookingDetails.cancellationPolicy ? `Cancellation Policy: ${bookingDetails.cancellationPolicy}` : ''}\r\n\r\nWe look forward to welcoming you!\r\n    `;\r\n\r\n    return handleSendEmail({\r\n      to: params.email,\r\n      subject,\r\n      body,\r\n      templateId: 'booking-confirmation',\r\n      templateData: bookingDetails\r\n    }, context);\r\n  } catch (error: any) {\r\n    return {\r\n      success: false,\r\n      data: null,\r\n      error: error.message || 'Failed to send booking confirmation'\r\n    };\r\n  }\r\n}\r\n\r\nregisterToolHandler('send_booking_confirmation', handleSendBookingConfirmation as any);\r\n\r\n// ========================================\r\n// CANCELLATION CONFIRMATION EMAIL\r\n// ========================================\r\n\r\ninterface SendCancellationConfirmationParams {\r\n  email: string;\r\n  cancellationDetails: {\r\n    confirmationNumber: string;\r\n    cancellationId: string;\r\n    guestName: string;\r\n    hotelName: string;\r\n    refundAmount?: number;\r\n    refundCurrency?: string;\r\n    refundStatus?: string;\r\n  };\r\n  language?: 'en' | 'he';\r\n}\r\n\r\nasync function handleSendCancellationConfirmation(\r\n  params: SendCancellationConfirmationParams,\r\n  context: ConversationContext\r\n): Promise<ToolResult> {\r\n  try {\r\n    const { cancellationDetails, language = 'en' } = params;\r\n\r\n    const subject = language === 'he'\r\n      ? `  - ${cancellationDetails.hotelName}`\r\n      : `Cancellation Confirmation - ${cancellationDetails.hotelName}`;\r\n\r\n    const refundInfo = cancellationDetails.refundAmount\r\n      ? language === 'he'\r\n        ? ` : ${cancellationDetails.refundCurrency} ${cancellationDetails.refundAmount}`\r\n        : `Refund Amount: ${cancellationDetails.refundCurrency} ${cancellationDetails.refundAmount}`\r\n      : '';\r\n\r\n    const body = language === 'he' ? `\r\n ${cancellationDetails.guestName},\r\n\r\n  .\r\n\r\n  : ${cancellationDetails.confirmationNumber}\r\n : ${cancellationDetails.cancellationId}\r\n: ${cancellationDetails.hotelName}\r\n${refundInfo}\r\n\r\n   .\r\n    ` : `\r\nDear ${cancellationDetails.guestName},\r\n\r\nYour booking has been successfully cancelled.\r\n\r\nOriginal Confirmation: ${cancellationDetails.confirmationNumber}\r\nCancellation ID: ${cancellationDetails.cancellationId}\r\nHotel: ${cancellationDetails.hotelName}\r\n${refundInfo}\r\n\r\nWe hope to serve you again in the future.\r\n    `;\r\n\r\n    return handleSendEmail({\r\n      to: params.email,\r\n      subject,\r\n      body,\r\n      templateId: 'cancellation-confirmation',\r\n      templateData: cancellationDetails\r\n    }, context);\r\n  } catch (error: any) {\r\n    return {\r\n      success: false,\r\n      data: null,\r\n      error: error.message || 'Failed to send cancellation confirmation'\r\n    };\r\n  }\r\n}\r\n\r\nregisterToolHandler('send_cancellation_confirmation', handleSendCancellationConfirmation as any);\r\n\r\n// ========================================\r\n// PRICE ALERT NOTIFICATION\r\n// ========================================\r\n\r\ninterface SendPriceAlertParams {\r\n  email?: string;\r\n  phone?: string;\r\n  alertDetails: {\r\n    hotelName: string;\r\n    roomType: string;\r\n    dates: string;\r\n    previousPrice: number;\r\n    currentPrice: number;\r\n    currency: string;\r\n    priceChange: number;\r\n    bookingUrl?: string;\r\n  };\r\n  method: 'email' | 'sms' | 'push';\r\n  language?: 'en' | 'he';\r\n}\r\n\r\nasync function handleSendPriceAlert(\r\n  params: SendPriceAlertParams,\r\n  context: ConversationContext\r\n): Promise<ToolResult> {\r\n  try {\r\n    const { alertDetails, method, language = 'en' } = params;\r\n\r\n    if (method === 'email' && !params.email) {\r\n      return {\r\n        success: false,\r\n        data: null,\r\n        error: 'Email address required for email notifications'\r\n      };\r\n    }\r\n\r\n    if (method === 'sms' && !params.phone) {\r\n      return {\r\n        success: false,\r\n        data: null,\r\n        error: 'Phone number required for SMS notifications'\r\n      };\r\n    }\r\n\r\n    const changeText = alertDetails.priceChange < 0\r\n      ? (language === 'he' ? '' : 'dropped')\r\n      : (language === 'he' ? '' : 'increased');\r\n\r\n    const messageId = `alert-${Date.now()}-${Math.random().toString(36).substr(2, 6)}`;\r\n\r\n    if (method === 'email') {\r\n      const subject = language === 'he'\r\n        ? `  : ${alertDetails.hotelName}`\r\n        : ` Price Alert: ${alertDetails.hotelName}`;\r\n\r\n      const body = language === 'he' ? `\r\n  ${alertDetails.hotelName} ${changeText}!\r\n\r\n: ${alertDetails.roomType}\r\n: ${alertDetails.dates}\r\n : ${alertDetails.currency} ${alertDetails.previousPrice}\r\n : ${alertDetails.currency} ${alertDetails.currentPrice}\r\n: ${alertDetails.priceChange}%\r\n\r\n${alertDetails.bookingUrl ? `: ${alertDetails.bookingUrl}` : ''}\r\n      ` : `\r\nThe price for ${alertDetails.hotelName} has ${changeText}!\r\n\r\nRoom: ${alertDetails.roomType}\r\nDates: ${alertDetails.dates}\r\nPrevious Price: ${alertDetails.currency} ${alertDetails.previousPrice}\r\nCurrent Price: ${alertDetails.currency} ${alertDetails.currentPrice}\r\nChange: ${alertDetails.priceChange}%\r\n\r\n${alertDetails.bookingUrl ? `Book now: ${alertDetails.bookingUrl}` : ''}\r\n      `;\r\n\r\n      return handleSendEmail({\r\n        to: params.email!,\r\n        subject,\r\n        body,\r\n        templateId: 'price-alert'\r\n      }, context);\r\n    } else if (method === 'sms') {\r\n      // SMS handler would be called here\r\n      const smsMessage = language === 'he'\r\n        ? ` ${alertDetails.hotelName}:  ${changeText} -${alertDetails.currency}${alertDetails.currentPrice} (${alertDetails.priceChange}%)`\r\n        : ` ${alertDetails.hotelName}: Price ${changeText} to ${alertDetails.currency}${alertDetails.currentPrice} (${alertDetails.priceChange}%)`;\r\n\r\n      // Track notification\r\n      if (!context.metadata.sentNotifications) {\r\n        context.metadata.sentNotifications = [];\r\n      }\r\n      context.metadata.sentNotifications.push({\r\n        id: messageId,\r\n        type: 'sms',\r\n        to: params.phone,\r\n        content: smsMessage,\r\n        sentAt: new Date().toISOString()\r\n      });\r\n\r\n      return {\r\n        success: true,\r\n        data: {\r\n          messageId,\r\n          to: params.phone,\r\n          type: 'sms',\r\n          status: 'sent',\r\n          message: 'Price alert SMS sent successfully'\r\n        }\r\n      };\r\n    } else {\r\n      // Push notification\r\n      return {\r\n        success: true,\r\n        data: {\r\n          messageId,\r\n          type: 'push',\r\n          status: 'sent',\r\n          message: 'Push notification sent successfully'\r\n        }\r\n      };\r\n    }\r\n  } catch (error: any) {\r\n    return {\r\n      success: false,\r\n      data: null,\r\n      error: error.message || 'Failed to send price alert notification'\r\n    };\r\n  }\r\n}\r\n\r\nregisterToolHandler('send_price_alert', handleSendPriceAlert as any);\r\n\r\n// ========================================\r\n// REMINDER NOTIFICATION\r\n// ========================================\r\n\r\ninterface SendReminderParams {\r\n  email?: string;\r\n  phone?: string;\r\n  reminderDetails: {\r\n    type: 'check-in' | 'check-out' | 'payment' | 'review' | 'custom';\r\n    title: string;\r\n    message: string;\r\n    hotelName?: string;\r\n    date?: string;\r\n    actionUrl?: string;\r\n  };\r\n  method: 'email' | 'sms' | 'push';\r\n}\r\n\r\nasync function handleSendReminder(\r\n  params: SendReminderParams,\r\n  context: ConversationContext\r\n): Promise<ToolResult> {\r\n  try {\r\n    const { reminderDetails, method } = params;\r\n\r\n    const messageId = `reminder-${Date.now()}-${Math.random().toString(36).substr(2, 6)}`;\r\n\r\n    if (method === 'email' && params.email) {\r\n      return handleSendEmail({\r\n        to: params.email,\r\n        subject: reminderDetails.title,\r\n        body: reminderDetails.message,\r\n        templateId: `reminder-${reminderDetails.type}`\r\n      }, context);\r\n    }\r\n\r\n    // Track reminder\r\n    if (!context.metadata.sentNotifications) {\r\n      context.metadata.sentNotifications = [];\r\n    }\r\n    context.metadata.sentNotifications.push({\r\n      id: messageId,\r\n      type: method,\r\n      reminderType: reminderDetails.type,\r\n      title: reminderDetails.title,\r\n      sentAt: new Date().toISOString()\r\n    });\r\n\r\n    return {\r\n      success: true,\r\n      data: {\r\n        messageId,\r\n        type: method,\r\n        reminderType: reminderDetails.type,\r\n        status: 'sent',\r\n        message: 'Reminder sent successfully'\r\n      }\r\n    };\r\n  } catch (error: any) {\r\n    return {\r\n      success: false,\r\n      data: null,\r\n      error: error.message || 'Failed to send reminder'\r\n    };\r\n  }\r\n}\r\n\r\nregisterToolHandler('send_reminder', handleSendReminder as any);\r\n\r\n// ========================================\r\n// GET NOTIFICATION HISTORY\r\n// ========================================\r\n\r\ninterface GetNotificationHistoryParams {\r\n  limit?: number;\r\n  type?: 'email' | 'sms' | 'push';\r\n}\r\n\r\nasync function handleGetNotificationHistory(\r\n  params: GetNotificationHistoryParams,\r\n  context: ConversationContext\r\n): Promise<ToolResult> {\r\n  try {\r\n    let notifications = context.metadata.sentNotifications || [];\r\n\r\n    if (params.type) {\r\n      notifications = notifications.filter((n: any) => n.type === params.type);\r\n    }\r\n\r\n    if (params.limit) {\r\n      notifications = notifications.slice(-params.limit);\r\n    }\r\n\r\n    return {\r\n      success: true,\r\n      data: {\r\n        totalNotifications: notifications.length,\r\n        notifications: notifications.map((n: any) => ({\r\n          id: n.id,\r\n          type: n.type,\r\n          to: n.to,\r\n          subject: n.subject,\r\n          sentAt: n.sentAt\r\n        }))\r\n      }\r\n    };\r\n  } catch (error: any) {\r\n    return {\r\n      success: false,\r\n      data: null,\r\n      error: error.message || 'Failed to get notification history'\r\n    };\r\n  }\r\n}\r\n\r\nregisterToolHandler('get_notification_history', handleGetNotificationHistory);\r\n\r\nexport {\r\n  handleSendEmail,\r\n  handleSendBookingConfirmation,\r\n  handleSendCancellationConfirmation,\r\n  handleSendPriceAlert,\r\n  handleSendReminder,\r\n  handleGetNotificationHistory\r\n};\r\n","/**\r\n * Hotel Booking AI - Loyalty Handler\r\n * Handles loyalty program, points, and member benefits\r\n */\r\n\r\nimport type { ConversationContext, ToolResult } from '../types';\r\nimport { registerToolHandler } from '../engine-manager';\r\n\r\n// ========================================\r\n// LOYALTY DATA STRUCTURES\r\n// ========================================\r\n\r\ninterface LoyaltyMember {\r\n  id: string;\r\n  email: string;\r\n  firstName: string;\r\n  lastName: string;\r\n  tier: 'bronze' | 'silver' | 'gold' | 'platinum';\r\n  points: number;\r\n  lifetimePoints: number;\r\n  tierProgressPoints: number;\r\n  nextTierThreshold: number;\r\n  joinDate: string;\r\n  expiringPoints?: {\r\n    amount: number;\r\n    expiryDate: string;\r\n  };\r\n  preferences: Record<string, any>;\r\n}\r\n\r\ninterface LoyaltyTransaction {\r\n  id: string;\r\n  memberId: string;\r\n  type: 'earn' | 'redeem' | 'expire' | 'bonus' | 'adjustment';\r\n  points: number;\r\n  description: string;\r\n  bookingId?: string;\r\n  timestamp: string;\r\n}\r\n\r\n// In-memory storage (in production, use database)\r\nconst loyaltyMembers = new Map<string, LoyaltyMember>();\r\nconst loyaltyTransactions: LoyaltyTransaction[] = [];\r\n\r\n// Tier thresholds\r\nconst TIER_THRESHOLDS = {\r\n  bronze: 0,\r\n  silver: 5000,\r\n  gold: 15000,\r\n  platinum: 50000\r\n};\r\n\r\nconst TIER_BENEFITS = {\r\n  bronze: ['Earn 1 point per $1', 'Member-only rates', 'Birthday bonus'],\r\n  silver: ['Earn 1.25 points per $1', 'Late checkout', 'Welcome drink', 'Priority support'],\r\n  gold: ['Earn 1.5 points per $1', 'Room upgrade when available', 'Lounge access', 'Free breakfast'],\r\n  platinum: ['Earn 2 points per $1', 'Guaranteed upgrade', 'Suite access', 'Personal concierge', 'Airport transfer']\r\n};\r\n\r\n// ========================================\r\n// GET LOYALTY ACCOUNT HANDLER\r\n// ========================================\r\n\r\ninterface GetLoyaltyAccountParams {\r\n  memberId?: string;\r\n  email?: string;\r\n}\r\n\r\nasync function handleGetLoyaltyAccount(\r\n  params: GetLoyaltyAccountParams,\r\n  context: ConversationContext\r\n): Promise<ToolResult> {\r\n  try {\r\n    let member: LoyaltyMember | undefined;\r\n\r\n    if (params.memberId) {\r\n      member = loyaltyMembers.get(params.memberId);\r\n    } else if (params.email) {\r\n      member = Array.from(loyaltyMembers.values()).find(m => m.email === params.email);\r\n    } else if (context.metadata.loyaltyMemberId) {\r\n      member = loyaltyMembers.get(context.metadata.loyaltyMemberId);\r\n    }\r\n\r\n    if (!member) {\r\n      return {\r\n        success: false,\r\n        data: null,\r\n        error: 'Loyalty member not found'\r\n      };\r\n    }\r\n\r\n    const tierBenefits = TIER_BENEFITS[member.tier];\r\n    const nextTier = member.tier === 'platinum' ? null\r\n      : member.tier === 'gold' ? 'platinum'\r\n      : member.tier === 'silver' ? 'gold'\r\n      : 'silver';\r\n\r\n    const pointsToNextTier = nextTier\r\n      ? TIER_THRESHOLDS[nextTier] - member.tierProgressPoints\r\n      : 0;\r\n\r\n    return {\r\n      success: true,\r\n      data: {\r\n        memberId: member.id,\r\n        name: `${member.firstName} ${member.lastName}`,\r\n        email: member.email,\r\n        tier: member.tier,\r\n        points: member.points,\r\n        lifetimePoints: member.lifetimePoints,\r\n        tierProgress: {\r\n          currentPoints: member.tierProgressPoints,\r\n          nextTier,\r\n          pointsToNextTier,\r\n          progressPercent: nextTier\r\n            ? Math.round((member.tierProgressPoints / TIER_THRESHOLDS[nextTier]) * 100)\r\n            : 100\r\n        },\r\n        benefits: tierBenefits,\r\n        expiringPoints: member.expiringPoints,\r\n        memberSince: member.joinDate\r\n      }\r\n    };\r\n  } catch (error: any) {\r\n    return {\r\n      success: false,\r\n      data: null,\r\n      error: error.message || 'Failed to get loyalty account'\r\n    };\r\n  }\r\n}\r\n\r\nregisterToolHandler('get_loyalty_account', handleGetLoyaltyAccount);\r\n\r\n// ========================================\r\n// GET POINTS BALANCE HANDLER\r\n// ========================================\r\n\r\ninterface GetPointsBalanceParams {\r\n  memberId?: string;\r\n}\r\n\r\nasync function handleGetPointsBalance(\r\n  params: GetPointsBalanceParams,\r\n  context: ConversationContext\r\n): Promise<ToolResult> {\r\n  try {\r\n    const memberId = params.memberId || context.metadata.loyaltyMemberId;\r\n\r\n    if (!memberId) {\r\n      return {\r\n        success: false,\r\n        data: null,\r\n        error: 'Member ID required'\r\n      };\r\n    }\r\n\r\n    const member = loyaltyMembers.get(memberId);\r\n    if (!member) {\r\n      return {\r\n        success: false,\r\n        data: null,\r\n        error: 'Loyalty member not found'\r\n      };\r\n    }\r\n\r\n    // Get recent transactions\r\n    const recentTransactions = loyaltyTransactions\r\n      .filter(t => t.memberId === memberId)\r\n      .slice(-5)\r\n      .map(t => ({\r\n        type: t.type,\r\n        points: t.points,\r\n        description: t.description,\r\n        date: t.timestamp\r\n      }));\r\n\r\n    return {\r\n      success: true,\r\n      data: {\r\n        memberId: member.id,\r\n        availablePoints: member.points,\r\n        lifetimePoints: member.lifetimePoints,\r\n        tier: member.tier,\r\n        expiringPoints: member.expiringPoints,\r\n        recentTransactions\r\n      }\r\n    };\r\n  } catch (error: any) {\r\n    return {\r\n      success: false,\r\n      data: null,\r\n      error: error.message || 'Failed to get points balance'\r\n    };\r\n  }\r\n}\r\n\r\nregisterToolHandler('get_points_balance', handleGetPointsBalance);\r\n\r\n// ========================================\r\n// EARN POINTS HANDLER\r\n// ========================================\r\n\r\ninterface EarnPointsParams {\r\n  memberId?: string;\r\n  email?: string;\r\n  amount: number;\r\n  bookingId?: string;\r\n  description?: string;\r\n  bonusMultiplier?: number;\r\n}\r\n\r\nasync function handleEarnPoints(\r\n  params: EarnPointsParams,\r\n  context: ConversationContext\r\n): Promise<ToolResult> {\r\n  try {\r\n    let member: LoyaltyMember | undefined;\r\n\r\n    if (params.memberId) {\r\n      member = loyaltyMembers.get(params.memberId);\r\n    } else if (params.email) {\r\n      member = Array.from(loyaltyMembers.values()).find(m => m.email === params.email);\r\n    }\r\n\r\n    if (!member) {\r\n      return {\r\n        success: false,\r\n        data: null,\r\n        error: 'Loyalty member not found'\r\n      };\r\n    }\r\n\r\n    // Calculate points based on tier\r\n    const tierMultipliers = {\r\n      bronze: 1,\r\n      silver: 1.25,\r\n      gold: 1.5,\r\n      platinum: 2\r\n    };\r\n\r\n    const basePoints = Math.round(params.amount);\r\n    const tierMultiplier = tierMultipliers[member.tier];\r\n    const bonusMultiplier = params.bonusMultiplier || 1;\r\n    const earnedPoints = Math.round(basePoints * tierMultiplier * bonusMultiplier);\r\n\r\n    // Update member points\r\n    member.points += earnedPoints;\r\n    member.lifetimePoints += earnedPoints;\r\n    member.tierProgressPoints += earnedPoints;\r\n\r\n    // Check for tier upgrade\r\n    let tierUpgrade: string | null = null;\r\n    if (member.tier === 'bronze' && member.tierProgressPoints >= TIER_THRESHOLDS.silver) {\r\n      member.tier = 'silver';\r\n      tierUpgrade = 'silver';\r\n    } else if (member.tier === 'silver' && member.tierProgressPoints >= TIER_THRESHOLDS.gold) {\r\n      member.tier = 'gold';\r\n      tierUpgrade = 'gold';\r\n    } else if (member.tier === 'gold' && member.tierProgressPoints >= TIER_THRESHOLDS.platinum) {\r\n      member.tier = 'platinum';\r\n      tierUpgrade = 'platinum';\r\n    }\r\n\r\n    // Record transaction\r\n    const transaction: LoyaltyTransaction = {\r\n      id: `txn-${Date.now()}-${Math.random().toString(36).substr(2, 6)}`,\r\n      memberId: member.id,\r\n      type: 'earn',\r\n      points: earnedPoints,\r\n      description: params.description || `Earned from booking ${params.bookingId || 'N/A'}`,\r\n      bookingId: params.bookingId,\r\n      timestamp: new Date().toISOString()\r\n    };\r\n    loyaltyTransactions.push(transaction);\r\n\r\n    return {\r\n      success: true,\r\n      data: {\r\n        memberId: member.id,\r\n        pointsEarned: earnedPoints,\r\n        breakdown: {\r\n          basePoints,\r\n          tierMultiplier,\r\n          bonusMultiplier,\r\n          total: earnedPoints\r\n        },\r\n        newBalance: member.points,\r\n        tierUpgrade,\r\n        tier: member.tier,\r\n        transactionId: transaction.id,\r\n        message: tierUpgrade\r\n          ? `Congratulations! You earned ${earnedPoints} points and upgraded to ${tierUpgrade}!`\r\n          : `You earned ${earnedPoints} points!`\r\n      }\r\n    };\r\n  } catch (error: any) {\r\n    return {\r\n      success: false,\r\n      data: null,\r\n      error: error.message || 'Failed to earn points'\r\n    };\r\n  }\r\n}\r\n\r\nregisterToolHandler('earn_points', handleEarnPoints as any);\r\n\r\n// ========================================\r\n// REDEEM POINTS HANDLER\r\n// ========================================\r\n\r\ninterface RedeemPointsParams {\r\n  memberId?: string;\r\n  points: number;\r\n  rewardType: 'discount' | 'free-night' | 'upgrade' | 'experience' | 'transfer';\r\n  rewardDetails?: Record<string, any>;\r\n}\r\n\r\nasync function handleRedeemPoints(\r\n  params: RedeemPointsParams,\r\n  context: ConversationContext\r\n): Promise<ToolResult> {\r\n  try {\r\n    const memberId = params.memberId || context.metadata.loyaltyMemberId;\r\n\r\n    if (!memberId) {\r\n      return {\r\n        success: false,\r\n        data: null,\r\n        error: 'Member ID required'\r\n      };\r\n    }\r\n\r\n    const member = loyaltyMembers.get(memberId);\r\n    if (!member) {\r\n      return {\r\n        success: false,\r\n        data: null,\r\n        error: 'Loyalty member not found'\r\n      };\r\n    }\r\n\r\n    if (member.points < params.points) {\r\n      return {\r\n        success: false,\r\n        data: null,\r\n        error: `Insufficient points. You have ${member.points} points, need ${params.points}`\r\n      };\r\n    }\r\n\r\n    // Deduct points\r\n    member.points -= params.points;\r\n\r\n    // Record transaction\r\n    const transaction: LoyaltyTransaction = {\r\n      id: `txn-${Date.now()}-${Math.random().toString(36).substr(2, 6)}`,\r\n      memberId: member.id,\r\n      type: 'redeem',\r\n      points: -params.points,\r\n      description: `Redeemed for ${params.rewardType}`,\r\n      timestamp: new Date().toISOString()\r\n    };\r\n    loyaltyTransactions.push(transaction);\r\n\r\n    // Calculate reward value\r\n    const rewardValues = {\r\n      discount: params.points * 0.01, // 1 cent per point\r\n      'free-night': params.points >= 10000 ? 1 : 0,\r\n      upgrade: params.points >= 5000 ? 'room-upgrade' : null,\r\n      experience: 'experience-voucher',\r\n      transfer: params.points\r\n    };\r\n\r\n    return {\r\n      success: true,\r\n      data: {\r\n        memberId: member.id,\r\n        pointsRedeemed: params.points,\r\n        rewardType: params.rewardType,\r\n        rewardValue: rewardValues[params.rewardType],\r\n        remainingPoints: member.points,\r\n        transactionId: transaction.id,\r\n        redemptionCode: `RDM-${Date.now().toString(36).toUpperCase()}`,\r\n        message: `Successfully redeemed ${params.points} points for ${params.rewardType}`\r\n      }\r\n    };\r\n  } catch (error: any) {\r\n    return {\r\n      success: false,\r\n      data: null,\r\n      error: error.message || 'Failed to redeem points'\r\n    };\r\n  }\r\n}\r\n\r\nregisterToolHandler('redeem_points', handleRedeemPoints as any);\r\n\r\n// ========================================\r\n// GET TIER BENEFITS HANDLER\r\n// ========================================\r\n\r\ninterface GetTierBenefitsParams {\r\n  tier?: 'bronze' | 'silver' | 'gold' | 'platinum';\r\n  memberId?: string;\r\n}\r\n\r\nasync function handleGetTierBenefits(\r\n  params: GetTierBenefitsParams,\r\n  context: ConversationContext\r\n): Promise<ToolResult> {\r\n  try {\r\n    let tier = params.tier;\r\n\r\n    if (!tier && params.memberId) {\r\n      const member = loyaltyMembers.get(params.memberId);\r\n      if (member) tier = member.tier;\r\n    }\r\n\r\n    if (!tier && context.metadata.loyaltyMemberId) {\r\n      const member = loyaltyMembers.get(context.metadata.loyaltyMemberId);\r\n      if (member) tier = member.tier;\r\n    }\r\n\r\n    if (!tier) tier = 'bronze';\r\n\r\n    const allTiers = ['bronze', 'silver', 'gold', 'platinum'] as const;\r\n    const tierIndex = allTiers.indexOf(tier);\r\n\r\n    return {\r\n      success: true,\r\n      data: {\r\n        currentTier: tier,\r\n        benefits: TIER_BENEFITS[tier],\r\n        threshold: TIER_THRESHOLDS[tier],\r\n        nextTier: tierIndex < 3 ? allTiers[tierIndex + 1] : null,\r\n        nextTierThreshold: tierIndex < 3 ? TIER_THRESHOLDS[allTiers[tierIndex + 1]] : null,\r\n        allTiers: allTiers.map(t => ({\r\n          name: t,\r\n          threshold: TIER_THRESHOLDS[t],\r\n          benefits: TIER_BENEFITS[t]\r\n        }))\r\n      }\r\n    };\r\n  } catch (error: any) {\r\n    return {\r\n      success: false,\r\n      data: null,\r\n      error: error.message || 'Failed to get tier benefits'\r\n    };\r\n  }\r\n}\r\n\r\nregisterToolHandler('get_tier_benefits', handleGetTierBenefits);\r\n\r\n// ========================================\r\n// GET TRANSACTION HISTORY HANDLER\r\n// ========================================\r\n\r\ninterface GetTransactionHistoryParams {\r\n  memberId?: string;\r\n  type?: 'earn' | 'redeem' | 'expire' | 'bonus' | 'adjustment';\r\n  limit?: number;\r\n}\r\n\r\nasync function handleGetTransactionHistory(\r\n  params: GetTransactionHistoryParams,\r\n  context: ConversationContext\r\n): Promise<ToolResult> {\r\n  try {\r\n    const memberId = params.memberId || context.metadata.loyaltyMemberId;\r\n\r\n    if (!memberId) {\r\n      return {\r\n        success: false,\r\n        data: null,\r\n        error: 'Member ID required'\r\n      };\r\n    }\r\n\r\n    let transactions = loyaltyTransactions.filter(t => t.memberId === memberId);\r\n\r\n    if (params.type) {\r\n      transactions = transactions.filter(t => t.type === params.type);\r\n    }\r\n\r\n    if (params.limit) {\r\n      transactions = transactions.slice(-params.limit);\r\n    }\r\n\r\n    const totalEarned = transactions\r\n      .filter(t => t.type === 'earn' || t.type === 'bonus')\r\n      .reduce((sum, t) => sum + t.points, 0);\r\n\r\n    const totalRedeemed = transactions\r\n      .filter(t => t.type === 'redeem')\r\n      .reduce((sum, t) => sum + Math.abs(t.points), 0);\r\n\r\n    return {\r\n      success: true,\r\n      data: {\r\n        memberId,\r\n        totalTransactions: transactions.length,\r\n        summary: {\r\n          totalEarned,\r\n          totalRedeemed,\r\n          netPoints: totalEarned - totalRedeemed\r\n        },\r\n        transactions: transactions.map(t => ({\r\n          id: t.id,\r\n          type: t.type,\r\n          points: t.points,\r\n          description: t.description,\r\n          bookingId: t.bookingId,\r\n          date: t.timestamp\r\n        }))\r\n      }\r\n    };\r\n  } catch (error: any) {\r\n    return {\r\n      success: false,\r\n      data: null,\r\n      error: error.message || 'Failed to get transaction history'\r\n    };\r\n  }\r\n}\r\n\r\nregisterToolHandler('get_transaction_history', handleGetTransactionHistory);\r\n\r\n// ========================================\r\n// UTILITIES\r\n// ========================================\r\n\r\nexport function createMember(data: {\r\n  email: string;\r\n  firstName: string;\r\n  lastName: string;\r\n}): LoyaltyMember {\r\n  const member: LoyaltyMember = {\r\n    id: `member-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\r\n    email: data.email,\r\n    firstName: data.firstName,\r\n    lastName: data.lastName,\r\n    tier: 'bronze',\r\n    points: 0,\r\n    lifetimePoints: 0,\r\n    tierProgressPoints: 0,\r\n    nextTierThreshold: TIER_THRESHOLDS.silver,\r\n    joinDate: new Date().toISOString(),\r\n    preferences: {}\r\n  };\r\n\r\n  loyaltyMembers.set(member.id, member);\r\n  return member;\r\n}\r\n\r\nexport function getMember(memberId: string): LoyaltyMember | undefined {\r\n  return loyaltyMembers.get(memberId);\r\n}\r\n\r\nexport function getMemberByEmail(email: string): LoyaltyMember | undefined {\r\n  return Array.from(loyaltyMembers.values()).find(m => m.email === email);\r\n}\r\n\r\nexport {\r\n  handleGetLoyaltyAccount,\r\n  handleGetPointsBalance,\r\n  handleEarnPoints,\r\n  handleRedeemPoints,\r\n  handleGetTierBenefits,\r\n  handleGetTransactionHistory\r\n};\r\n"],"names":[],"mappings":"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"}