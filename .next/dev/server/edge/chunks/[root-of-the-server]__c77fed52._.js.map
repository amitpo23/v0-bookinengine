{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 16, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/v0-bookinengine/middleware.ts"],"sourcesContent":["import type { NextRequest } from 'next/server'\r\nimport { NextResponse } from 'next/server'\r\n\r\n// Rate limiting using in-memory store (for production, use Redis)\r\nconst rateLimitStore = new Map<string, { count: number; resetTime: number }>()\r\n\r\nconst RATE_LIMIT = {\r\n  windowMs: 60 * 1000, // 1 minute\r\n  maxRequests: 100, // 100 requests per minute\r\n}\r\n\r\nfunction getClientId(request: NextRequest): string {\r\n  // Get IP from various headers (for production behind proxy)\r\n  const forwarded = request.headers.get('x-forwarded-for')\r\n  const realIp = request.headers.get('x-real-ip')\r\n  const ip = forwarded?.split(',')[0] || realIp || 'unknown'\r\n  return ip\r\n}\r\n\r\nfunction checkRateLimit(clientId: string): boolean {\r\n  const now = Date.now()\r\n  const client = rateLimitStore.get(clientId)\r\n\r\n  if (!client || now > client.resetTime) {\r\n    // New window\r\n    rateLimitStore.set(clientId, {\r\n      count: 1,\r\n      resetTime: now + RATE_LIMIT.windowMs,\r\n    })\r\n    return true\r\n  }\r\n\r\n  if (client.count >= RATE_LIMIT.maxRequests) {\r\n    return false // Rate limit exceeded\r\n  }\r\n\r\n  client.count++\r\n  return true\r\n}\r\n\r\n// Cleanup old entries every 5 minutes\r\nsetInterval(() => {\r\n  const now = Date.now()\r\n  for (const [key, value] of rateLimitStore.entries()) {\r\n    if (now > value.resetTime) {\r\n      rateLimitStore.delete(key)\r\n    }\r\n  }\r\n}, 5 * 60 * 1000)\r\n\r\nexport function middleware(request: NextRequest) {\r\n  const response = NextResponse.next()\r\n\r\n  // Security Headers\r\n  response.headers.set('X-DNS-Prefetch-Control', 'on')\r\n  response.headers.set('X-Frame-Options', 'SAMEORIGIN')\r\n  response.headers.set('X-Content-Type-Options', 'nosniff')\r\n  response.headers.set('Referrer-Policy', 'origin-when-cross-origin')\r\n  response.headers.set(\r\n    'Permissions-Policy',\r\n    'camera=(), microphone=(), geolocation=()'\r\n  )\r\n\r\n  // Rate Limiting (for API routes)\r\n  if (request.nextUrl.pathname.startsWith('/api/')) {\r\n    const clientId = getClientId(request)\r\n    \r\n    if (!checkRateLimit(clientId)) {\r\n      return new NextResponse(\r\n        JSON.stringify({\r\n          error: 'Too many requests',\r\n          message: 'אתה מבצע יותר מדי בקשות. נסה שוב בעוד דקה.',\r\n        }),\r\n        {\r\n          status: 429,\r\n          headers: {\r\n            'Content-Type': 'application/json',\r\n            'Retry-After': '60',\r\n          },\r\n        }\r\n      )\r\n    }\r\n  }\r\n\r\n  // CSRF Protection for state-changing methods\r\n  if (['POST', 'PUT', 'DELETE', 'PATCH'].includes(request.method)) {\r\n    const origin = request.headers.get('origin')\r\n    const host = request.headers.get('host')\r\n    \r\n    // Allow same-origin requests\r\n    if (origin && host && new URL(origin).host !== host) {\r\n      // In production, verify CSRF token\r\n      const csrfToken = request.headers.get('x-csrf-token')\r\n      if (!csrfToken && request.nextUrl.pathname.startsWith('/api/')) {\r\n        return new NextResponse(\r\n          JSON.stringify({\r\n            error: 'CSRF token missing',\r\n            message: 'בקשה לא חוקית',\r\n          }),\r\n          {\r\n            status: 403,\r\n            headers: {\r\n              'Content-Type': 'application/json',\r\n            },\r\n          }\r\n        )\r\n      }\r\n    }\r\n  }\r\n\r\n  return response\r\n}\r\n\r\nexport const config = {\r\n  matcher: [\r\n    /*\r\n     * Match all request paths except for the ones starting with:\r\n     * - _next/static (static files)\r\n     * - _next/image (image optimization files)\r\n     * - favicon.ico (favicon file)\r\n     */\r\n    '/((?!_next/static|_next/image|favicon.ico).*)',\r\n  ],\r\n}\r\n"],"names":[],"mappings":";;;;;;AACA;AAAA;;AAEA,kEAAkE;AAClE,MAAM,iBAAiB,IAAI;AAE3B,MAAM,aAAa;IACjB,UAAU,KAAK;IACf,aAAa;AACf;AAEA,SAAS,YAAY,OAAoB;IACvC,4DAA4D;IAC5D,MAAM,YAAY,QAAQ,OAAO,CAAC,GAAG,CAAC;IACtC,MAAM,SAAS,QAAQ,OAAO,CAAC,GAAG,CAAC;IACnC,MAAM,KAAK,WAAW,MAAM,IAAI,CAAC,EAAE,IAAI,UAAU;IACjD,OAAO;AACT;AAEA,SAAS,eAAe,QAAgB;IACtC,MAAM,MAAM,KAAK,GAAG;IACpB,MAAM,SAAS,eAAe,GAAG,CAAC;IAElC,IAAI,CAAC,UAAU,MAAM,OAAO,SAAS,EAAE;QACrC,aAAa;QACb,eAAe,GAAG,CAAC,UAAU;YAC3B,OAAO;YACP,WAAW,MAAM,WAAW,QAAQ;QACtC;QACA,OAAO;IACT;IAEA,IAAI,OAAO,KAAK,IAAI,WAAW,WAAW,EAAE;QAC1C,OAAO,MAAM,sBAAsB;;IACrC;IAEA,OAAO,KAAK;IACZ,OAAO;AACT;AAEA,sCAAsC;AACtC,YAAY;IACV,MAAM,MAAM,KAAK,GAAG;IACpB,KAAK,MAAM,CAAC,KAAK,MAAM,IAAI,eAAe,OAAO,GAAI;QACnD,IAAI,MAAM,MAAM,SAAS,EAAE;YACzB,eAAe,MAAM,CAAC;QACxB;IACF;AACF,GAAG,IAAI,KAAK;AAEL,SAAS,WAAW,OAAoB;IAC7C,MAAM,WAAW,sNAAY,CAAC,IAAI;IAElC,mBAAmB;IACnB,SAAS,OAAO,CAAC,GAAG,CAAC,0BAA0B;IAC/C,SAAS,OAAO,CAAC,GAAG,CAAC,mBAAmB;IACxC,SAAS,OAAO,CAAC,GAAG,CAAC,0BAA0B;IAC/C,SAAS,OAAO,CAAC,GAAG,CAAC,mBAAmB;IACxC,SAAS,OAAO,CAAC,GAAG,CAClB,sBACA;IAGF,iCAAiC;IACjC,IAAI,QAAQ,OAAO,CAAC,QAAQ,CAAC,UAAU,CAAC,UAAU;QAChD,MAAM,WAAW,YAAY;QAE7B,IAAI,CAAC,eAAe,WAAW;YAC7B,OAAO,IAAI,sNAAY,CACrB,KAAK,SAAS,CAAC;gBACb,OAAO;gBACP,SAAS;YACX,IACA;gBACE,QAAQ;gBACR,SAAS;oBACP,gBAAgB;oBAChB,eAAe;gBACjB;YACF;QAEJ;IACF;IAEA,6CAA6C;IAC7C,IAAI;QAAC;QAAQ;QAAO;QAAU;KAAQ,CAAC,QAAQ,CAAC,QAAQ,MAAM,GAAG;QAC/D,MAAM,SAAS,QAAQ,OAAO,CAAC,GAAG,CAAC;QACnC,MAAM,OAAO,QAAQ,OAAO,CAAC,GAAG,CAAC;QAEjC,6BAA6B;QAC7B,IAAI,UAAU,QAAQ,IAAI,IAAI,QAAQ,IAAI,KAAK,MAAM;YACnD,mCAAmC;YACnC,MAAM,YAAY,QAAQ,OAAO,CAAC,GAAG,CAAC;YACtC,IAAI,CAAC,aAAa,QAAQ,OAAO,CAAC,QAAQ,CAAC,UAAU,CAAC,UAAU;gBAC9D,OAAO,IAAI,sNAAY,CACrB,KAAK,SAAS,CAAC;oBACb,OAAO;oBACP,SAAS;gBACX,IACA;oBACE,QAAQ;oBACR,SAAS;wBACP,gBAAgB;oBAClB;gBACF;YAEJ;QACF;IACF;IAEA,OAAO;AACT;AAEO,MAAM,SAAS;IACpB,SAAS;QACP;;;;;KAKC,GACD;KACD;AACH"}}]
}