{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 16, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/middleware.ts"],"sourcesContent":["import type { NextRequest } from 'next/server'\nimport { NextResponse } from 'next/server'\n\n// Rate limiting using in-memory store (for production, use Redis)\nconst rateLimitStore = new Map<string, { count: number; resetTime: number }>()\n\nconst RATE_LIMIT = {\n  windowMs: 60 * 1000, // 1 minute\n  maxRequests: 100, // 100 requests per minute\n}\n\nfunction getClientId(request: NextRequest): string {\n  // Get IP from various headers (for production behind proxy)\n  const forwarded = request.headers.get('x-forwarded-for')\n  const realIp = request.headers.get('x-real-ip')\n  const ip = forwarded?.split(',')[0] || realIp || 'unknown'\n  return ip\n}\n\nfunction checkRateLimit(clientId: string): boolean {\n  const now = Date.now()\n  const client = rateLimitStore.get(clientId)\n\n  if (!client || now > client.resetTime) {\n    // New window\n    rateLimitStore.set(clientId, {\n      count: 1,\n      resetTime: now + RATE_LIMIT.windowMs,\n    })\n    return true\n  }\n\n  if (client.count >= RATE_LIMIT.maxRequests) {\n    return false // Rate limit exceeded\n  }\n\n  client.count++\n  return true\n}\n\n// Cleanup old entries every 5 minutes\nsetInterval(() => {\n  const now = Date.now()\n  for (const [key, value] of rateLimitStore.entries()) {\n    if (now > value.resetTime) {\n      rateLimitStore.delete(key)\n    }\n  }\n}, 5 * 60 * 1000)\n\nexport function middleware(request: NextRequest) {\n  const response = NextResponse.next()\n\n  // Security Headers\n  response.headers.set('X-DNS-Prefetch-Control', 'on')\n  response.headers.set('X-Frame-Options', 'SAMEORIGIN')\n  response.headers.set('X-Content-Type-Options', 'nosniff')\n  response.headers.set('Referrer-Policy', 'origin-when-cross-origin')\n  response.headers.set(\n    'Permissions-Policy',\n    'camera=(), microphone=(), geolocation=()'\n  )\n\n  // Rate Limiting (for API routes)\n  if (request.nextUrl.pathname.startsWith('/api/')) {\n    const clientId = getClientId(request)\n    \n    if (!checkRateLimit(clientId)) {\n      return new NextResponse(\n        JSON.stringify({\n          error: 'Too many requests',\n          message: 'אתה מבצע יותר מדי בקשות. נסה שוב בעוד דקה.',\n        }),\n        {\n          status: 429,\n          headers: {\n            'Content-Type': 'application/json',\n            'Retry-After': '60',\n          },\n        }\n      )\n    }\n  }\n\n  // CSRF Protection for state-changing methods\n  if (['POST', 'PUT', 'DELETE', 'PATCH'].includes(request.method)) {\n    const origin = request.headers.get('origin')\n    const host = request.headers.get('host')\n    \n    // Allow same-origin requests\n    if (origin && host && new URL(origin).host !== host) {\n      // In production, verify CSRF token\n      const csrfToken = request.headers.get('x-csrf-token')\n      if (!csrfToken && request.nextUrl.pathname.startsWith('/api/')) {\n        return new NextResponse(\n          JSON.stringify({\n            error: 'CSRF token missing',\n            message: 'בקשה לא חוקית',\n          }),\n          {\n            status: 403,\n            headers: {\n              'Content-Type': 'application/json',\n            },\n          }\n        )\n      }\n    }\n  }\n\n  return response\n}\n\nexport const config = {\n  matcher: [\n    /*\n     * Match all request paths except for the ones starting with:\n     * - _next/static (static files)\n     * - _next/image (image optimization files)\n     * - favicon.ico (favicon file)\n     */\n    '/((?!_next/static|_next/image|favicon.ico).*)',\n  ],\n}\n"],"names":[],"mappings":";;;;;;AACA;AAAA;;AAEA,kEAAkE;AAClE,MAAM,iBAAiB,IAAI;AAE3B,MAAM,aAAa;IACjB,UAAU,KAAK;IACf,aAAa;AACf;AAEA,SAAS,YAAY,OAAoB;IACvC,4DAA4D;IAC5D,MAAM,YAAY,QAAQ,OAAO,CAAC,GAAG,CAAC;IACtC,MAAM,SAAS,QAAQ,OAAO,CAAC,GAAG,CAAC;IACnC,MAAM,KAAK,WAAW,MAAM,IAAI,CAAC,EAAE,IAAI,UAAU;IACjD,OAAO;AACT;AAEA,SAAS,eAAe,QAAgB;IACtC,MAAM,MAAM,KAAK,GAAG;IACpB,MAAM,SAAS,eAAe,GAAG,CAAC;IAElC,IAAI,CAAC,UAAU,MAAM,OAAO,SAAS,EAAE;QACrC,aAAa;QACb,eAAe,GAAG,CAAC,UAAU;YAC3B,OAAO;YACP,WAAW,MAAM,WAAW,QAAQ;QACtC;QACA,OAAO;IACT;IAEA,IAAI,OAAO,KAAK,IAAI,WAAW,WAAW,EAAE;QAC1C,OAAO,MAAM,sBAAsB;;IACrC;IAEA,OAAO,KAAK;IACZ,OAAO;AACT;AAEA,sCAAsC;AACtC,YAAY;IACV,MAAM,MAAM,KAAK,GAAG;IACpB,KAAK,MAAM,CAAC,KAAK,MAAM,IAAI,eAAe,OAAO,GAAI;QACnD,IAAI,MAAM,MAAM,SAAS,EAAE;YACzB,eAAe,MAAM,CAAC;QACxB;IACF;AACF,GAAG,IAAI,KAAK;AAEL,SAAS,WAAW,OAAoB;IAC7C,MAAM,WAAW,gMAAY,CAAC,IAAI;IAElC,mBAAmB;IACnB,SAAS,OAAO,CAAC,GAAG,CAAC,0BAA0B;IAC/C,SAAS,OAAO,CAAC,GAAG,CAAC,mBAAmB;IACxC,SAAS,OAAO,CAAC,GAAG,CAAC,0BAA0B;IAC/C,SAAS,OAAO,CAAC,GAAG,CAAC,mBAAmB;IACxC,SAAS,OAAO,CAAC,GAAG,CAClB,sBACA;IAGF,iCAAiC;IACjC,IAAI,QAAQ,OAAO,CAAC,QAAQ,CAAC,UAAU,CAAC,UAAU;QAChD,MAAM,WAAW,YAAY;QAE7B,IAAI,CAAC,eAAe,WAAW;YAC7B,OAAO,IAAI,gMAAY,CACrB,KAAK,SAAS,CAAC;gBACb,OAAO;gBACP,SAAS;YACX,IACA;gBACE,QAAQ;gBACR,SAAS;oBACP,gBAAgB;oBAChB,eAAe;gBACjB;YACF;QAEJ;IACF;IAEA,6CAA6C;IAC7C,IAAI;QAAC;QAAQ;QAAO;QAAU;KAAQ,CAAC,QAAQ,CAAC,QAAQ,MAAM,GAAG;QAC/D,MAAM,SAAS,QAAQ,OAAO,CAAC,GAAG,CAAC;QACnC,MAAM,OAAO,QAAQ,OAAO,CAAC,GAAG,CAAC;QAEjC,6BAA6B;QAC7B,IAAI,UAAU,QAAQ,IAAI,IAAI,QAAQ,IAAI,KAAK,MAAM;YACnD,mCAAmC;YACnC,MAAM,YAAY,QAAQ,OAAO,CAAC,GAAG,CAAC;YACtC,IAAI,CAAC,aAAa,QAAQ,OAAO,CAAC,QAAQ,CAAC,UAAU,CAAC,UAAU;gBAC9D,OAAO,IAAI,gMAAY,CACrB,KAAK,SAAS,CAAC;oBACb,OAAO;oBACP,SAAS;gBACX,IACA;oBACE,QAAQ;oBACR,SAAS;wBACP,gBAAgB;oBAClB;gBACF;YAEJ;QACF;IACF;IAEA,OAAO;AACT;AAEO,MAAM,SAAS;IACpB,SAAS;QACP;;;;;KAKC,GACD;KACD;AACH"}}]
}