{"version":3,"sources":["../../../node_modules/next/src/server/route-modules/app-page/module.compiled.js","../../../node_modules/next/src/server/route-modules/app-page/vendored/rsc/react.ts","../../../node_modules/node-domexception/index.js","../../../lib/ai-engines/handlers/payment.ts","../../../lib/ai-engines/handlers/monitoring.ts","../../../lib/ai-engines/handlers/voice.ts","../../../lib/ai-engines/handlers/refund.ts","../../../lib/ai-engines/handlers/insurance.ts","../../../lib/ai-engines/handlers/whatsapp.ts","../../../lib/ai-engines/handlers/abandoned-cart.ts","../../../lib/ai-engines/handlers/booking.ts","../../../lib/ai-engines/handlers/fraud.ts","../../../lib/ai-engines/handlers/reviews.ts","../../../lib/ai-engines/handlers/demand-forecasting.ts","../../../lib/ai-engines/handlers/invoice.ts","../../../lib/ai-engines/handlers/revenue-dashboard.ts"],"sourcesContent":["if (process.env.NEXT_RUNTIME === 'edge') {\n  module.exports = require('next/dist/server/route-modules/app-page/module.js')\n} else {\n  if (process.env.__NEXT_EXPERIMENTAL_REACT) {\n    if (process.env.NODE_ENV === 'development') {\n      if (process.env.TURBOPACK) {\n        module.exports = require('next/dist/compiled/next-server/app-page-turbo-experimental.runtime.dev.js')\n      } else {\n        module.exports = require('next/dist/compiled/next-server/app-page-experimental.runtime.dev.js')\n      }\n    } else {\n      if (process.env.TURBOPACK) {\n        module.exports = require('next/dist/compiled/next-server/app-page-turbo-experimental.runtime.prod.js')\n      } else {\n        module.exports = require('next/dist/compiled/next-server/app-page-experimental.runtime.prod.js')\n      }\n    }\n  } else {\n    if (process.env.NODE_ENV === 'development') {\n      if (process.env.TURBOPACK) {\n        module.exports = require('next/dist/compiled/next-server/app-page-turbo.runtime.dev.js')\n      } else {\n        module.exports = require('next/dist/compiled/next-server/app-page.runtime.dev.js')\n      }\n    } else {\n      if (process.env.TURBOPACK) {\n        module.exports = require('next/dist/compiled/next-server/app-page-turbo.runtime.prod.js')\n      } else {\n        module.exports = require('next/dist/compiled/next-server/app-page.runtime.prod.js')\n      }\n    }\n  }\n}\n","module.exports = (\n  require('../../module.compiled') as typeof import('../../module.compiled')\n).vendored['react-rsc']!.React\n","/*! node-domexception. MIT License. Jimmy Wärting <https://jimmy.warting.se/opensource> */\n\nif (!globalThis.DOMException) {\n  try {\n    const { MessageChannel } = require('worker_threads'),\n    port = new MessageChannel().port1,\n    ab = new ArrayBuffer()\n    port.postMessage(ab, [ab, ab])\n  } catch (err) {\n    err.constructor.name === 'DOMException' && (\n      globalThis.DOMException = err.constructor\n    )\n  }\n}\n\nmodule.exports = globalThis.DOMException\n","/**\n * Payment Handler\n * Stripe integration for processing booking payments\n */\n\nimport Stripe from \"stripe\"\n\n// Initialize Stripe\nconst stripe = new Stripe(process.env.STRIPE_SECRET_KEY || \"\", {\n  apiVersion: \"2025-11-17.clover\",\n})\n\n// Types\nexport interface PaymentContext {\n  userId?: string\n  sessionId?: string\n  locale?: string\n}\n\nexport interface PaymentIntent {\n  id: string\n  clientSecret: string\n  amount: number\n  currency: string\n  status: string\n  bookingId?: string\n  customerId?: string\n}\n\nexport interface PaymentResult {\n  success: boolean\n  paymentId?: string\n  status?: string\n  error?: string\n  requiresAction?: boolean\n  actionUrl?: string\n  receiptUrl?: string\n}\n\n/**\n * Create a Stripe payment intent for a booking\n */\nexport async function createPaymentIntent(\n  params: {\n    bookingId: string\n    amount: number\n    currency: string\n    customerEmail: string\n    customerName?: string\n    description?: string\n    metadata?: Record<string, string>\n  },\n  context?: PaymentContext\n): Promise<PaymentIntent> {\n  console.log(\"[Payment] Creating payment intent\", { bookingId: params.bookingId, amount: params.amount })\n\n  try {\n    // Create or retrieve Stripe customer\n    let customerId: string | undefined\n    \n    const existingCustomers = await stripe.customers.list({\n      email: params.customerEmail,\n      limit: 1,\n    })\n\n    if (existingCustomers.data.length > 0) {\n      customerId = existingCustomers.data[0].id\n    } else {\n      const customer = await stripe.customers.create({\n        email: params.customerEmail,\n        name: params.customerName,\n        metadata: {\n          source: \"booking-engine\",\n          bookingId: params.bookingId,\n        },\n      })\n      customerId = customer.id\n    }\n\n    // Create payment intent\n    const paymentIntent = await stripe.paymentIntents.create({\n      amount: params.amount, // Amount in cents\n      currency: params.currency.toLowerCase(),\n      customer: customerId,\n      description: params.description || `Booking ${params.bookingId}`,\n      metadata: {\n        bookingId: params.bookingId,\n        customerEmail: params.customerEmail,\n        ...params.metadata,\n      },\n      automatic_payment_methods: {\n        enabled: true,\n      },\n      // Enable 3D Secure when required\n      payment_method_options: {\n        card: {\n          request_three_d_secure: \"automatic\",\n        },\n      },\n    })\n\n    console.log(\"[Payment] Payment intent created\", { id: paymentIntent.id, status: paymentIntent.status })\n\n    return {\n      id: paymentIntent.id,\n      clientSecret: paymentIntent.client_secret || \"\",\n      amount: paymentIntent.amount,\n      currency: paymentIntent.currency,\n      status: paymentIntent.status,\n      bookingId: params.bookingId,\n      customerId,\n    }\n  } catch (error: any) {\n    console.error(\"[Payment] Failed to create payment intent\", error.message)\n    throw new Error(`Payment intent creation failed: ${error.message}`)\n  }\n}\n\n/**\n * Process a payment using an existing payment intent\n */\nexport async function processPayment(\n  params: {\n    paymentIntentId: string\n    paymentMethodId: string\n    returnUrl?: string\n  },\n  context?: PaymentContext\n): Promise<PaymentResult> {\n  console.log(\"[Payment] Processing payment\", { paymentIntentId: params.paymentIntentId })\n\n  try {\n    const paymentIntent = await stripe.paymentIntents.confirm(params.paymentIntentId, {\n      payment_method: params.paymentMethodId,\n      return_url: params.returnUrl || `${process.env.NEXT_PUBLIC_APP_URL || \"https://v0-bookinengine.vercel.app\"}/booking/complete`,\n    })\n\n    const result: PaymentResult = {\n      success: paymentIntent.status === \"succeeded\",\n      paymentId: paymentIntent.id,\n      status: paymentIntent.status,\n    }\n\n    // Check if 3D Secure is required\n    if (paymentIntent.status === \"requires_action\" && paymentIntent.next_action?.type === \"redirect_to_url\") {\n      result.requiresAction = true\n      result.actionUrl = paymentIntent.next_action.redirect_to_url?.url || undefined\n    }\n\n    console.log(\"[Payment] Payment processed\", { id: paymentIntent.id, status: paymentIntent.status })\n\n    return result\n  } catch (error: any) {\n    console.error(\"[Payment] Payment processing failed\", error.message)\n    return {\n      success: false,\n      paymentId: params.paymentIntentId,\n      error: error.message,\n    }\n  }\n}\n\n/**\n * Verify a payment was successful\n */\nexport async function verifyPayment(\n  params: { paymentIntentId: string },\n  context?: PaymentContext\n): Promise<{\n  verified: boolean\n  status: string\n  amount?: number\n  currency?: string\n  bookingId?: string\n  error?: string\n}> {\n  try {\n    const paymentIntent = await stripe.paymentIntents.retrieve(params.paymentIntentId)\n\n    return {\n      verified: paymentIntent.status === \"succeeded\",\n      status: paymentIntent.status,\n      amount: paymentIntent.amount,\n      currency: paymentIntent.currency,\n      bookingId: paymentIntent.metadata.bookingId,\n    }\n  } catch (error: any) {\n    console.error(\"[Payment] Payment verification failed\", error.message)\n    return {\n      verified: false,\n      status: \"error\",\n      error: error.message,\n    }\n  }\n}\n\n/**\n * Get current status of a payment\n */\nexport async function getPaymentStatus(\n  params: { paymentIntentId: string },\n  context?: PaymentContext\n): Promise<{\n  id: string\n  status: string\n  amount: number\n  currency: string\n  created: Date\n  paymentMethod?: string\n  receiptUrl?: string\n  bookingId?: string\n}> {\n  try {\n    const paymentIntent = await stripe.paymentIntents.retrieve(params.paymentIntentId, {\n      expand: [\"latest_charge\"],\n    })\n\n    const charge = paymentIntent.latest_charge as Stripe.Charge | null\n\n    return {\n      id: paymentIntent.id,\n      status: paymentIntent.status,\n      amount: paymentIntent.amount,\n      currency: paymentIntent.currency,\n      created: new Date(paymentIntent.created * 1000),\n      paymentMethod: typeof paymentIntent.payment_method === \"string\" \n        ? paymentIntent.payment_method \n        : paymentIntent.payment_method?.id,\n      receiptUrl: charge?.receipt_url || undefined,\n      bookingId: paymentIntent.metadata.bookingId,\n    }\n  } catch (error: any) {\n    console.error(\"[Payment] Failed to get payment status\", error.message)\n    throw error\n  }\n}\n\n/**\n * Cancel a pending payment intent\n */\nexport async function cancelPayment(\n  params: {\n    paymentIntentId: string\n    reason?: string\n  },\n  context?: PaymentContext\n): Promise<{ success: boolean; error?: string }> {\n  try {\n    await stripe.paymentIntents.cancel(params.paymentIntentId, {\n      cancellation_reason: \"requested_by_customer\",\n    })\n\n    console.log(\"[Payment] Payment cancelled\", { id: params.paymentIntentId, reason: params.reason })\n\n    return { success: true }\n  } catch (error: any) {\n    console.error(\"[Payment] Failed to cancel payment\", error.message)\n    return { success: false, error: error.message }\n  }\n}\n\n/**\n * Get list of payments for a booking\n */\nexport async function getBookingPayments(\n  params: { bookingId: string },\n  context?: PaymentContext\n): Promise<PaymentIntent[]> {\n  try {\n    const paymentIntents = await stripe.paymentIntents.search({\n      query: `metadata[\"bookingId\"]:\"${params.bookingId}\"`,\n      limit: 10,\n    })\n\n    return paymentIntents.data.map(pi => ({\n      id: pi.id,\n      clientSecret: pi.client_secret || \"\",\n      amount: pi.amount,\n      currency: pi.currency,\n      status: pi.status,\n      bookingId: params.bookingId,\n      customerId: typeof pi.customer === \"string\" ? pi.customer : pi.customer?.id,\n    }))\n  } catch (error: any) {\n    console.error(\"[Payment] Failed to get booking payments\", error.message)\n    return []\n  }\n}\n\n// Export handlers map for registry\nexport const paymentHandlers = {\n  createPaymentIntent,\n  processPayment,\n  verifyPayment,\n  getPaymentStatus,\n  cancelPayment,\n  getBookingPayments,\n}\n","/**\n * Monitoring Handlers\n * Tool handlers for price monitoring and tracking\n * Based on: hotel-price-monitor scraping capabilities\n */\n\nimport type { ConversationContext } from '../types';\n\n// ========================================\n// TRACK HOTEL PRICE\n// ========================================\n\ninterface TrackHotelPriceParams {\n  hotelUrl: string;\n  checkIn: string;\n  checkOut: string;\n  targetPrice?: number;\n  notifyEmail?: string;\n}\n\ninterface TrackingResult {\n  success: boolean;\n  trackingId: string;\n  hotelName: string;\n  currentPrice: number;\n  currency: string;\n  targetPrice?: number;\n  checkInterval: string;\n  notificationSettings: {\n    email?: string;\n    priceDropThreshold: number;\n  };\n  nextCheck: Date;\n}\n\nexport async function trackHotelPrice(\n  params: TrackHotelPriceParams,\n  context: ConversationContext\n): Promise<TrackingResult> {\n  console.log(`[MonitoringHandler] Starting price tracking for:`, params.hotelUrl);\n\n  try {\n    // Validate URL (Booking.com format)\n    if (!params.hotelUrl.includes('booking.com')) {\n      throw new Error('Currently only Booking.com URLs are supported');\n    }\n\n    // Extract hotel info from URL (in production, use scraper)\n    const hotelName = extractHotelNameFromUrl(params.hotelUrl);\n\n    const trackingId = `track-${Date.now()}-${Math.random().toString(36).substr(2, 8)}`;\n\n    // In production, would initialize scraping job:\n    // const scraper = new BookingComScraper();\n    // await scraper.initializeTracking({\n    //   url: params.hotelUrl,\n    //   checkIn: params.checkIn,\n    //   checkOut: params.checkOut,\n    //   trackingId\n    // });\n\n    // Mock current price\n    const currentPrice = Math.floor(Math.random() * 300) + 100;\n\n    const result: TrackingResult = {\n      success: true,\n      trackingId,\n      hotelName,\n      currentPrice,\n      currency: 'USD',\n      targetPrice: params.targetPrice,\n      checkInterval: 'Every 6 hours',\n      notificationSettings: {\n        email: params.notifyEmail,\n        priceDropThreshold: params.targetPrice ? 0 : 10 // Alert on any drop below target, or 10% otherwise\n      },\n      nextCheck: new Date(Date.now() + 6 * 60 * 60 * 1000)\n    };\n\n    // Store tracking in context\n    if (context) {\n      context.metadata = {\n        ...context.metadata,\n        priceTracking: [\n          ...(context.metadata?.priceTracking || []),\n          {\n            trackingId,\n            hotelUrl: params.hotelUrl,\n            hotelName,\n            startedAt: new Date()\n          }\n        ]\n      };\n    }\n\n    return result;\n  } catch (error: any) {\n    console.error(`[MonitoringHandler] Track price error:`, error);\n    throw new Error(`Failed to start price tracking: ${error.message}`);\n  }\n}\n\nfunction extractHotelNameFromUrl(url: string): string {\n  try {\n    const match = url.match(/hotel\\/([^/]+)/);\n    if (match) {\n      return match[1]\n        .replace(/-/g, ' ')\n        .replace(/\\b\\w/g, l => l.toUpperCase());\n    }\n  } catch {}\n  return 'Unknown Hotel';\n}\n\n// ========================================\n// GET PRICE HISTORY\n// ========================================\n\ninterface GetPriceHistoryParams {\n  hotelId: string;\n  dateFrom: string;\n  dateTo: string;\n}\n\ninterface PriceHistoryEntry {\n  date: string;\n  price: number;\n  currency: string;\n  availability: 'available' | 'limited' | 'sold_out';\n  source: string;\n}\n\ninterface PriceHistoryResult {\n  hotelId: string;\n  hotelName: string;\n  dateRange: {\n    from: string;\n    to: string;\n  };\n  history: PriceHistoryEntry[];\n  statistics: {\n    minPrice: number;\n    maxPrice: number;\n    avgPrice: number;\n    currentPrice: number;\n    priceChange: number;\n    priceChangePercent: number;\n  };\n}\n\nexport async function getPriceHistory(\n  params: GetPriceHistoryParams,\n  context: ConversationContext\n): Promise<PriceHistoryResult> {\n  console.log(`[MonitoringHandler] Getting price history for hotel:`, params.hotelId);\n\n  try {\n    // Generate mock historical data\n    const startDate = new Date(params.dateFrom);\n    const endDate = new Date(params.dateTo);\n    const days = Math.ceil((endDate.getTime() - startDate.getTime()) / (1000 * 60 * 60 * 24));\n\n    const history: PriceHistoryEntry[] = [];\n    let basePrice = 250;\n\n    for (let i = 0; i <= days; i++) {\n      const date = new Date(startDate);\n      date.setDate(date.getDate() + i);\n\n      // Simulate price fluctuations\n      const fluctuation = (Math.random() - 0.5) * 40;\n      const weekendMultiplier = (date.getDay() === 5 || date.getDay() === 6) ? 1.2 : 1;\n      const price = Math.round((basePrice + fluctuation) * weekendMultiplier);\n\n      history.push({\n        date: date.toISOString().split('T')[0],\n        price,\n        currency: 'USD',\n        availability: price < 300 ? 'available' : price < 350 ? 'limited' : 'sold_out',\n        source: 'booking.com'\n      });\n    }\n\n    const prices = history.map(h => h.price);\n    const minPrice = Math.min(...prices);\n    const maxPrice = Math.max(...prices);\n    const avgPrice = Math.round(prices.reduce((a, b) => a + b, 0) / prices.length);\n    const currentPrice = prices[prices.length - 1];\n    const firstPrice = prices[0];\n\n    return {\n      hotelId: params.hotelId,\n      hotelName: 'Sample Hotel Dubai',\n      dateRange: {\n        from: params.dateFrom,\n        to: params.dateTo\n      },\n      history,\n      statistics: {\n        minPrice,\n        maxPrice,\n        avgPrice,\n        currentPrice,\n        priceChange: currentPrice - firstPrice,\n        priceChangePercent: Math.round(((currentPrice - firstPrice) / firstPrice) * 100)\n      }\n    };\n  } catch (error: any) {\n    console.error(`[MonitoringHandler] Price history error:`, error);\n    throw new Error(`Failed to get price history: ${error.message}`);\n  }\n}\n\n// ========================================\n// ANALYZE PRICE TRENDS\n// ========================================\n\ninterface AnalyzePriceTrendsParams {\n  hotelId: string;\n  travelDates: {\n    from: string;\n    to: string;\n  };\n}\n\ninterface TrendAnalysisResult {\n  hotelId: string;\n  hotelName: string;\n  travelDates: {\n    from: string;\n    to: string;\n  };\n  currentTrend: 'rising' | 'falling' | 'stable';\n  trendStrength: number; // 0-100\n  prediction: {\n    direction: 'up' | 'down' | 'stable';\n    confidence: number;\n    expectedChange: number;\n    optimalBookingWindow: {\n      from: string;\n      to: string;\n    };\n  };\n  insights: string[];\n  recommendations: string[];\n  competitorComparison?: {\n    hotelName: string;\n    priceDifference: number;\n    rating: number;\n  }[];\n}\n\nexport async function analyzePriceTrends(\n  params: AnalyzePriceTrendsParams,\n  context: ConversationContext\n): Promise<TrendAnalysisResult> {\n  console.log(`[MonitoringHandler] Analyzing price trends for:`, params.hotelId);\n\n  try {\n    // Calculate days until travel\n    const travelDate = new Date(params.travelDates.from);\n    const daysUntilTravel = Math.ceil((travelDate.getTime() - Date.now()) / (1000 * 60 * 60 * 24));\n\n    // Determine trend based on various factors (mocked)\n    const trends = ['rising', 'falling', 'stable'] as const;\n    const currentTrend = trends[Math.floor(Math.random() * 3)];\n    const trendStrength = Math.floor(Math.random() * 60) + 20;\n\n    // Generate insights based on analysis\n    const insights: string[] = [];\n    const recommendations: string[] = [];\n\n    if (currentTrend === 'falling') {\n      insights.push('Prices have dropped 12% over the past 2 weeks');\n      insights.push('Historically, prices for these dates bottom out 3 weeks before check-in');\n      recommendations.push('Wait 1-2 more weeks before booking to catch the lowest price');\n    } else if (currentTrend === 'rising') {\n      insights.push('Prices have increased 8% in the last week');\n      insights.push('There\\'s an event in the area driving up demand');\n      recommendations.push('Book soon to lock in current prices');\n      recommendations.push('Consider flexible dates 1 week earlier for better rates');\n    } else {\n      insights.push('Prices have remained stable for the past month');\n      insights.push('Current price is close to the 90-day average');\n      recommendations.push('This is a good time to book - prices are fair');\n    }\n\n    // Add weekend insight\n    const dayOfWeek = travelDate.getDay();\n    if (dayOfWeek === 5 || dayOfWeek === 6) {\n      insights.push('Weekend check-in typically costs 15-20% more');\n      recommendations.push('Consider Thursday or Sunday check-in for savings');\n    }\n\n    // Add seasonality insight\n    const month = travelDate.getMonth();\n    if (month >= 10 || month <= 2) {\n      insights.push('This is high season in Dubai - expect premium pricing');\n    }\n\n    return {\n      hotelId: params.hotelId,\n      hotelName: 'Sample Hotel Dubai',\n      travelDates: params.travelDates,\n      currentTrend,\n      trendStrength,\n      prediction: {\n        direction: currentTrend === 'rising' ? 'up' : currentTrend === 'falling' ? 'down' : 'stable',\n        confidence: trendStrength + 20,\n        expectedChange: currentTrend === 'rising' ? 8 : currentTrend === 'falling' ? -10 : 0,\n        optimalBookingWindow: {\n          from: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],\n          to: new Date(Date.now() + 14 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]\n        }\n      },\n      insights,\n      recommendations,\n      competitorComparison: [\n        { hotelName: 'Similar Hotel A', priceDifference: -25, rating: 8.7 },\n        { hotelName: 'Similar Hotel B', priceDifference: +40, rating: 9.1 },\n        { hotelName: 'Similar Hotel C', priceDifference: -10, rating: 8.5 }\n      ]\n    };\n  } catch (error: any) {\n    console.error(`[MonitoringHandler] Trend analysis error:`, error);\n    throw new Error(`Failed to analyze price trends: ${error.message}`);\n  }\n}\n\n// ========================================\n// SCRAPER UTILITIES (Based on hotel-price-monitor)\n// ========================================\n\nexport interface ScraperConfig {\n  headless?: boolean;\n  proxy?: string;\n  userAgent?: string;\n  timeout?: number;\n}\n\nexport interface ScrapedPrice {\n  hotelName: string;\n  roomType: string;\n  price: number;\n  currency: string;\n  originalPrice?: number;\n  discount?: number;\n  cancellationPolicy: string;\n  boardType: string;\n  scrapedAt: Date;\n}\n\n/**\n * Placeholder for Booking.com scraper\n * In production, this would use Playwright to scrape prices\n */\nexport async function scrapeBookingComPrices(\n  url: string,\n  checkIn: string,\n  checkOut: string,\n  config?: ScraperConfig\n): Promise<ScrapedPrice[]> {\n  console.log(`[MonitoringHandler] Scraping prices from: ${url}`);\n\n  // In production:\n  // const browser = await chromium.launch({ headless: config?.headless ?? true });\n  // const page = await browser.newPage();\n  // await page.goto(url);\n  // ... scraping logic\n\n  // Mock response\n  return [\n    {\n      hotelName: extractHotelNameFromUrl(url),\n      roomType: 'Deluxe Room',\n      price: 289,\n      currency: 'USD',\n      originalPrice: 340,\n      discount: 15,\n      cancellationPolicy: 'Free cancellation',\n      boardType: 'Breakfast included',\n      scrapedAt: new Date()\n    },\n    {\n      hotelName: extractHotelNameFromUrl(url),\n      roomType: 'Suite',\n      price: 489,\n      currency: 'USD',\n      cancellationPolicy: 'Non-refundable',\n      boardType: 'Room only',\n      scrapedAt: new Date()\n    }\n  ];\n}\n\n// Export all handlers\nexport const monitoringHandlers = {\n  trackHotelPrice,\n  getPriceHistory,\n  analyzePriceTrends,\n  scrapeBookingComPrices\n};\n","/**\n * Voice Handlers\n * Tool handlers for voice interaction, call management, and TTS/STT\n * Based on: call-center-ai Azure Communication Services integration\n */\n\nimport type { ConversationContext } from '../types';\n\n// Azure Communication Services config (from environment)\nconst ACS_CONNECTION_STRING = process.env.ACS_CONNECTION_STRING || '';\nconst ACS_PHONE_NUMBER = process.env.ACS_PHONE_NUMBER || '';\nconst AZURE_SPEECH_KEY = process.env.AZURE_SPEECH_KEY || '';\nconst AZURE_SPEECH_REGION = process.env.AZURE_SPEECH_REGION || 'westeurope';\n\n// ========================================\n// INITIATE CALL\n// ========================================\n\ninterface InitiateCallParams {\n  phoneNumber: string;\n  purpose: string;\n  language?: string;\n}\n\ninterface CallResult {\n  success: boolean;\n  callId: string;\n  status: 'initiated' | 'ringing' | 'connected' | 'failed';\n  fromNumber: string;\n  toNumber: string;\n  startedAt: Date;\n  estimatedDuration?: number;\n}\n\nexport async function initiateCall(\n  params: InitiateCallParams,\n  context: ConversationContext\n): Promise<CallResult> {\n  console.log(`[VoiceHandler] Initiating call to ${params.phoneNumber}`);\n\n  try {\n    // Validate phone number format (E.164)\n    const phoneRegex = /^\\+[1-9]\\d{1,14}$/;\n    if (!phoneRegex.test(params.phoneNumber)) {\n      throw new Error('Invalid phone number format. Use E.164 format (e.g., +972501234567)');\n    }\n\n    // In production, use Azure Communication Services\n    // const client = new CallAutomationClient(ACS_CONNECTION_STRING);\n    // const callConnection = await client.createCall(\n    //   { phoneNumber: params.phoneNumber },\n    //   { phoneNumber: ACS_PHONE_NUMBER },\n    //   'https://your-callback-url/events'\n    // );\n\n    const callId = `call-${Date.now()}-${Math.random().toString(36).substr(2, 8)}`;\n\n    // Store call context\n    if (context) {\n      context.metadata = {\n        ...context.metadata,\n        activeCall: {\n          callId,\n          phoneNumber: params.phoneNumber,\n          purpose: params.purpose,\n          language: params.language || 'he-IL',\n          startedAt: new Date()\n        }\n      };\n    }\n\n    return {\n      success: true,\n      callId,\n      status: 'initiated',\n      fromNumber: ACS_PHONE_NUMBER || '+972-XX-XXXXXXX',\n      toNumber: params.phoneNumber,\n      startedAt: new Date()\n    };\n  } catch (error: any) {\n    console.error(`[VoiceHandler] Call initiation error:`, error);\n    throw new Error(`Failed to initiate call: ${error.message}`);\n  }\n}\n\n// ========================================\n// TRANSFER TO HUMAN\n// ========================================\n\ninterface TransferParams {\n  reason: string;\n  agentQueue?: string;\n}\n\ninterface TransferResult {\n  success: boolean;\n  transferId: string;\n  targetQueue: string;\n  estimatedWaitTime: number;\n  message: string;\n}\n\nexport async function transferToHuman(\n  params: TransferParams,\n  context: ConversationContext\n): Promise<TransferResult> {\n  console.log(`[VoiceHandler] Transferring to human agent:`, params);\n\n  try {\n    // Determine target queue based on reason or specified queue\n    const queue = params.agentQueue || determineQueueFromReason(params.reason);\n\n    // Get estimated wait time (mock)\n    const estimatedWait = Math.floor(Math.random() * 5) + 1; // 1-5 minutes\n\n    const transferId = `xfer-${Date.now()}-${Math.random().toString(36).substr(2, 6)}`;\n\n    // Update context\n    if (context) {\n      context.metadata = {\n        ...context.metadata,\n        transferredToHuman: {\n          transferId,\n          reason: params.reason,\n          queue,\n          transferredAt: new Date()\n        }\n      };\n    }\n\n    return {\n      success: true,\n      transferId,\n      targetQueue: queue,\n      estimatedWaitTime: estimatedWait,\n      message: `Transferring you to our ${queue} team. Estimated wait time: ${estimatedWait} minutes.`\n    };\n  } catch (error: any) {\n    console.error(`[VoiceHandler] Transfer error:`, error);\n    throw new Error(`Transfer failed: ${error.message}`);\n  }\n}\n\nfunction determineQueueFromReason(reason: string): string {\n  const reasonLower = reason.toLowerCase();\n  \n  if (reasonLower.includes('billing') || reasonLower.includes('payment') || reasonLower.includes('refund')) {\n    return 'billing-support';\n  }\n  if (reasonLower.includes('cancel') || reasonLower.includes('modify') || reasonLower.includes('change')) {\n    return 'booking-modifications';\n  }\n  if (reasonLower.includes('complaint') || reasonLower.includes('problem') || reasonLower.includes('issue')) {\n    return 'customer-care';\n  }\n  if (reasonLower.includes('group') || reasonLower.includes('corporate') || reasonLower.includes('business')) {\n    return 'corporate-sales';\n  }\n  \n  return 'general-support';\n}\n\n// ========================================\n// SEND CALL SUMMARY SMS\n// ========================================\n\ninterface SendCallSummarySmsParams {\n  phoneNumber: string;\n  summary: string;\n}\n\ninterface SmsResult {\n  success: boolean;\n  messageId: string;\n  to: string;\n  status: 'sent' | 'delivered' | 'failed';\n  sentAt: Date;\n}\n\nexport async function sendCallSummarySms(\n  params: SendCallSummarySmsParams,\n  context: ConversationContext\n): Promise<SmsResult> {\n  console.log(`[VoiceHandler] Sending call summary SMS to ${params.phoneNumber}`);\n\n  try {\n    // Validate phone number\n    const phoneRegex = /^\\+[1-9]\\d{1,14}$/;\n    if (!phoneRegex.test(params.phoneNumber)) {\n      throw new Error('Invalid phone number format');\n    }\n\n    // Truncate summary if too long for SMS\n    const maxLength = 160 * 3; // Allow up to 3 SMS segments\n    const truncatedSummary = params.summary.length > maxLength\n      ? params.summary.substring(0, maxLength - 3) + '...'\n      : params.summary;\n\n    // In production, use Azure Communication Services SMS\n    // const client = new SmsClient(ACS_CONNECTION_STRING);\n    // const response = await client.send({\n    //   from: ACS_PHONE_NUMBER,\n    //   to: [params.phoneNumber],\n    //   message: truncatedSummary\n    // });\n\n    const messageId = `sms-${Date.now()}-${Math.random().toString(36).substr(2, 8)}`;\n\n    return {\n      success: true,\n      messageId,\n      to: params.phoneNumber,\n      status: 'sent',\n      sentAt: new Date()\n    };\n  } catch (error: any) {\n    console.error(`[VoiceHandler] SMS error:`, error);\n    throw new Error(`Failed to send SMS: ${error.message}`);\n  }\n}\n\n// ========================================\n// TEXT TO SPEECH\n// ========================================\n\ninterface TextToSpeechParams {\n  text: string;\n  voice?: string;\n  language?: string;\n  speed?: number;\n  pitch?: number;\n}\n\ninterface TtsResult {\n  success: boolean;\n  audioUrl?: string;\n  audioBase64?: string;\n  duration: number;\n  format: string;\n}\n\nexport async function textToSpeech(\n  params: TextToSpeechParams,\n  context: ConversationContext\n): Promise<TtsResult> {\n  console.log(`[VoiceHandler] Converting text to speech:`, params.text.substring(0, 50));\n\n  try {\n    const voice = params.voice || 'he-IL-HilaNeural';\n    const speed = params.speed || 1.0;\n\n    // In production, use Azure Cognitive Services Speech SDK\n    // const speechConfig = sdk.SpeechConfig.fromSubscription(AZURE_SPEECH_KEY, AZURE_SPEECH_REGION);\n    // speechConfig.speechSynthesisVoiceName = voice;\n    // const synthesizer = new sdk.SpeechSynthesizer(speechConfig);\n    // const result = await synthesizer.speakTextAsync(params.text);\n\n    // Mock response\n    const estimatedDuration = params.text.split(' ').length * 0.4; // ~0.4 seconds per word\n\n    return {\n      success: true,\n      audioUrl: `/api/tts/audio-${Date.now()}.mp3`,\n      duration: estimatedDuration,\n      format: 'audio/mpeg'\n    };\n  } catch (error: any) {\n    console.error(`[VoiceHandler] TTS error:`, error);\n    throw new Error(`Text-to-speech failed: ${error.message}`);\n  }\n}\n\n// ========================================\n// SPEECH TO TEXT\n// ========================================\n\ninterface SpeechToTextParams {\n  audioUrl?: string;\n  audioBase64?: string;\n  language?: string;\n}\n\ninterface SttResult {\n  success: boolean;\n  text: string;\n  confidence: number;\n  language: string;\n  duration: number;\n  alternatives?: Array<{ text: string; confidence: number }>;\n}\n\nexport async function speechToText(\n  params: SpeechToTextParams,\n  context: ConversationContext\n): Promise<SttResult> {\n  console.log(`[VoiceHandler] Converting speech to text`);\n\n  try {\n    const language = params.language || 'he-IL';\n\n    // In production, use Azure Cognitive Services Speech SDK\n    // const speechConfig = sdk.SpeechConfig.fromSubscription(AZURE_SPEECH_KEY, AZURE_SPEECH_REGION);\n    // speechConfig.speechRecognitionLanguage = language;\n    // const recognizer = new sdk.SpeechRecognizer(speechConfig, audioConfig);\n    // const result = await recognizer.recognizeOnceAsync();\n\n    // Mock response\n    return {\n      success: true,\n      text: 'אני רוצה להזמין חדר במלון בדובאי לשלושה לילות',\n      confidence: 0.95,\n      language,\n      duration: 3.2,\n      alternatives: [\n        { text: 'אני רוצה להזמין חדר במלון בדובאי לשלושה לילות', confidence: 0.95 },\n        { text: 'אני רוצה להזמין חדר במלון ב-דובאי ל-3 לילות', confidence: 0.88 }\n      ]\n    };\n  } catch (error: any) {\n    console.error(`[VoiceHandler] STT error:`, error);\n    throw new Error(`Speech-to-text failed: ${error.message}`);\n  }\n}\n\n// ========================================\n// VOICE ACTIVITY DETECTION\n// ========================================\n\ninterface VadParams {\n  audioChunk: string; // base64\n  sensitivity?: number;\n}\n\ninterface VadResult {\n  isSpeaking: boolean;\n  speechStart?: number;\n  speechEnd?: number;\n  confidence: number;\n}\n\nexport async function detectVoiceActivity(\n  params: VadParams,\n  context: ConversationContext\n): Promise<VadResult> {\n  // In production, use WebRTC VAD or Azure\n  const sensitivity = params.sensitivity || 0.5;\n\n  // Mock response\n  return {\n    isSpeaking: Math.random() > sensitivity,\n    confidence: 0.85 + Math.random() * 0.15\n  };\n}\n\n// ========================================\n// REAL-TIME AUDIO STREAMING\n// ========================================\n\nexport interface RealtimeStreamConfig {\n  callId: string;\n  sttLanguage: string;\n  ttsVoice: string;\n  interimResults: boolean;\n  vadSensitivity: number;\n  silenceTimeout: number;\n}\n\nexport interface RealtimeCallbacks {\n  onSpeechRecognized: (text: string, isFinal: boolean) => void;\n  onAudioGenerated: (audio: ArrayBuffer) => void;\n  onError: (error: Error) => void;\n  onCallEnded: (reason: string) => void;\n}\n\nexport function createRealtimeAudioStream(\n  config: RealtimeStreamConfig,\n  callbacks: RealtimeCallbacks\n): {\n  start: () => Promise<void>;\n  stop: () => Promise<void>;\n  sendAudio: (chunk: ArrayBuffer) => void;\n  sendResponse: (text: string) => Promise<void>;\n} {\n  let isRunning = false;\n\n  return {\n    async start() {\n      console.log(`[VoiceHandler] Starting realtime audio stream for call ${config.callId}`);\n      isRunning = true;\n      \n      // In production:\n      // 1. Open WebSocket connection to Azure Communication Services\n      // 2. Configure Speech SDK for continuous recognition\n      // 3. Set up audio streaming pipeline\n    },\n\n    async stop() {\n      console.log(`[VoiceHandler] Stopping realtime audio stream`);\n      isRunning = false;\n      callbacks.onCallEnded('stream_stopped');\n    },\n\n    sendAudio(chunk: ArrayBuffer) {\n      if (!isRunning) return;\n      // Send audio chunk to Speech SDK for recognition\n    },\n\n    async sendResponse(text: string) {\n      if (!isRunning) return;\n      \n      // Convert text to speech and play to caller\n      const ttsResult = await textToSpeech(\n        { text, voice: config.ttsVoice },\n        {} as ConversationContext\n      );\n      \n      // In production, stream audio to call\n      console.log(`[VoiceHandler] Playing TTS response: ${text.substring(0, 50)}...`);\n    }\n  };\n}\n\n// Export all handlers\nexport const voiceHandlers = {\n  initiateCall,\n  transferToHuman,\n  sendCallSummarySms,\n  textToSpeech,\n  speechToText,\n  detectVoiceActivity,\n  createRealtimeAudioStream\n};\n","/**\n * Refund Handler\n * Stripe integration for processing refunds and cancellations\n */\n\nimport Stripe from \"stripe\"\n\n// Initialize Stripe\nconst stripe = new Stripe(process.env.STRIPE_SECRET_KEY || \"\", {\n  apiVersion: \"2025-11-17.clover\",\n})\n\n// Types\nexport interface RefundContext {\n  userId?: string\n  sessionId?: string\n  isAdmin?: boolean\n}\n\nexport interface RefundResult {\n  success: boolean\n  refundId?: string\n  amount?: number\n  currency?: string\n  status?: string\n  error?: string\n}\n\nexport interface CancellationPolicy {\n  bookingId: string\n  isRefundable: boolean\n  cancellationDeadline: Date | null\n  refundPercentage: number\n  refundAmount: number\n  penaltyAmount: number\n  currency: string\n  policyDescription: string\n  policyDescriptionHe: string\n}\n\n/**\n * Calculate refund amount based on cancellation policy\n */\nexport async function calculateRefundAmount(\n  params: {\n    bookingId: string\n    paymentIntentId: string\n    cancellationDate?: Date\n  },\n  context?: RefundContext\n): Promise<CancellationPolicy> {\n  console.log(\"[Refund] Calculating refund amount\", { bookingId: params.bookingId })\n\n  try {\n    // Get original payment\n    const paymentIntent = await stripe.paymentIntents.retrieve(params.paymentIntentId)\n    const originalAmount = paymentIntent.amount\n    const currency = paymentIntent.currency\n\n    // Get booking metadata to determine policy\n    const checkInDate = paymentIntent.metadata.checkIn \n      ? new Date(paymentIntent.metadata.checkIn) \n      : new Date(Date.now() + 7 * 24 * 60 * 60 * 1000) // Default: 7 days from now\n\n    const cancellationDate = params.cancellationDate || new Date()\n    const daysUntilCheckIn = Math.floor((checkInDate.getTime() - cancellationDate.getTime()) / (1000 * 60 * 60 * 24))\n\n    // Cancellation policy logic\n    let refundPercentage = 0\n    let policyDescription = \"\"\n    let policyDescriptionHe = \"\"\n\n    if (daysUntilCheckIn >= 7) {\n      // Full refund if cancelled 7+ days before\n      refundPercentage = 100\n      policyDescription = \"Full refund - cancelled more than 7 days before check-in\"\n      policyDescriptionHe = \"החזר מלא - ביטול יותר מ-7 ימים לפני הצ'ק-אין\"\n    } else if (daysUntilCheckIn >= 3) {\n      // 50% refund if cancelled 3-7 days before\n      refundPercentage = 50\n      policyDescription = \"50% refund - cancelled 3-7 days before check-in\"\n      policyDescriptionHe = \"החזר של 50% - ביטול 3-7 ימים לפני הצ'ק-אין\"\n    } else if (daysUntilCheckIn >= 1) {\n      // 25% refund if cancelled 1-3 days before\n      refundPercentage = 25\n      policyDescription = \"25% refund - cancelled 1-3 days before check-in\"\n      policyDescriptionHe = \"החזר של 25% - ביטול 1-3 ימים לפני הצ'ק-אין\"\n    } else {\n      // No refund if cancelled on check-in day or after\n      refundPercentage = 0\n      policyDescription = \"No refund - cancelled on or after check-in day\"\n      policyDescriptionHe = \"אין החזר - ביטול ביום הצ'ק-אין או אחריו\"\n    }\n\n    const refundAmount = Math.floor(originalAmount * refundPercentage / 100)\n    const penaltyAmount = originalAmount - refundAmount\n\n    return {\n      bookingId: params.bookingId,\n      isRefundable: refundPercentage > 0,\n      cancellationDeadline: new Date(checkInDate.getTime() - 7 * 24 * 60 * 60 * 1000),\n      refundPercentage,\n      refundAmount,\n      penaltyAmount,\n      currency,\n      policyDescription,\n      policyDescriptionHe,\n    }\n  } catch (error: any) {\n    console.error(\"[Refund] Failed to calculate refund\", error.message)\n    throw new Error(`Failed to calculate refund: ${error.message}`)\n  }\n}\n\n/**\n * Process a full refund\n */\nexport async function processRefund(\n  params: {\n    paymentIntentId: string\n    bookingId: string\n    reason?: string\n  },\n  context?: RefundContext\n): Promise<RefundResult> {\n  console.log(\"[Refund] Processing full refund\", { paymentIntentId: params.paymentIntentId })\n\n  try {\n    // Get payment intent to find the charge\n    const paymentIntent = await stripe.paymentIntents.retrieve(params.paymentIntentId, {\n      expand: [\"latest_charge\"],\n    })\n\n    if (paymentIntent.status !== \"succeeded\") {\n      return {\n        success: false,\n        error: \"Payment has not been completed, cannot refund\",\n      }\n    }\n\n    const charge = paymentIntent.latest_charge as Stripe.Charge\n    if (!charge) {\n      return {\n        success: false,\n        error: \"No charge found for this payment\",\n      }\n    }\n\n    // Create refund\n    const refund = await stripe.refunds.create({\n      charge: charge.id,\n      reason: \"requested_by_customer\",\n      metadata: {\n        bookingId: params.bookingId,\n        originalPaymentIntent: params.paymentIntentId,\n        reason: params.reason || \"Customer requested cancellation\",\n      },\n    })\n\n    console.log(\"[Refund] Refund processed\", { refundId: refund.id, amount: refund.amount })\n\n    return {\n      success: refund.status === \"succeeded\" || refund.status === \"pending\",\n      refundId: refund.id,\n      amount: refund.amount,\n      currency: refund.currency,\n      status: refund.status || \"unknown\",\n    }\n  } catch (error: any) {\n    console.error(\"[Refund] Refund processing failed\", error.message)\n    return {\n      success: false,\n      error: error.message,\n    }\n  }\n}\n\n/**\n * Process a partial refund\n */\nexport async function processPartialRefund(\n  params: {\n    paymentIntentId: string\n    bookingId: string\n    amount: number\n    reason?: string\n  },\n  context?: RefundContext\n): Promise<RefundResult> {\n  console.log(\"[Refund] Processing partial refund\", { \n    paymentIntentId: params.paymentIntentId, \n    amount: params.amount \n  })\n\n  try {\n    // Get payment intent to find the charge\n    const paymentIntent = await stripe.paymentIntents.retrieve(params.paymentIntentId, {\n      expand: [\"latest_charge\"],\n    })\n\n    if (paymentIntent.status !== \"succeeded\") {\n      return {\n        success: false,\n        error: \"Payment has not been completed, cannot refund\",\n      }\n    }\n\n    const charge = paymentIntent.latest_charge as Stripe.Charge\n    if (!charge) {\n      return {\n        success: false,\n        error: \"No charge found for this payment\",\n      }\n    }\n\n    // Validate amount\n    if (params.amount > charge.amount) {\n      return {\n        success: false,\n        error: `Refund amount (${params.amount}) exceeds original charge (${charge.amount})`,\n      }\n    }\n\n    // Create partial refund\n    const refund = await stripe.refunds.create({\n      charge: charge.id,\n      amount: params.amount,\n      reason: \"requested_by_customer\",\n      metadata: {\n        bookingId: params.bookingId,\n        originalPaymentIntent: params.paymentIntentId,\n        reason: params.reason || \"Partial refund requested\",\n        isPartial: \"true\",\n      },\n    })\n\n    console.log(\"[Refund] Partial refund processed\", { refundId: refund.id, amount: refund.amount })\n\n    return {\n      success: refund.status === \"succeeded\" || refund.status === \"pending\",\n      refundId: refund.id,\n      amount: refund.amount,\n      currency: refund.currency,\n      status: refund.status || \"unknown\",\n    }\n  } catch (error: any) {\n    console.error(\"[Refund] Partial refund failed\", error.message)\n    return {\n      success: false,\n      error: error.message,\n    }\n  }\n}\n\n/**\n * Get refund status\n */\nexport async function getRefundStatus(\n  params: { refundId: string },\n  context?: RefundContext\n): Promise<{\n  id: string\n  status: string\n  amount: number\n  currency: string\n  created: Date\n  bookingId?: string\n  reason?: string\n}> {\n  try {\n    const refund = await stripe.refunds.retrieve(params.refundId)\n\n    return {\n      id: refund.id,\n      status: refund.status || \"unknown\",\n      amount: refund.amount,\n      currency: refund.currency,\n      created: new Date(refund.created * 1000),\n      bookingId: refund.metadata?.bookingId,\n      reason: refund.metadata?.reason,\n    }\n  } catch (error: any) {\n    console.error(\"[Refund] Failed to get refund status\", error.message)\n    throw error\n  }\n}\n\n/**\n * List refunds for a booking\n */\nexport async function getBookingRefunds(\n  params: { bookingId: string },\n  context?: RefundContext\n): Promise<RefundResult[]> {\n  try {\n    // Search for refunds by booking ID in metadata\n    const refunds = await stripe.refunds.list({\n      limit: 100,\n    })\n\n    // Filter by booking ID (Stripe doesn't support metadata search on refunds)\n    const bookingRefunds = refunds.data.filter(\n      refund => refund.metadata?.bookingId === params.bookingId\n    )\n\n    return bookingRefunds.map(refund => ({\n      success: refund.status === \"succeeded\",\n      refundId: refund.id,\n      amount: refund.amount,\n      currency: refund.currency,\n      status: refund.status || \"unknown\",\n    }))\n  } catch (error: any) {\n    console.error(\"[Refund] Failed to get booking refunds\", error.message)\n    return []\n  }\n}\n\n/**\n * Auto-refund based on cancellation policy\n */\nexport async function autoRefundWithPolicy(\n  params: {\n    bookingId: string\n    paymentIntentId: string\n    reason?: string\n  },\n  context?: RefundContext\n): Promise<RefundResult & { policy: CancellationPolicy }> {\n  console.log(\"[Refund] Auto-refund with policy\", { bookingId: params.bookingId })\n\n  try {\n    // Calculate refund amount based on policy\n    const policy = await calculateRefundAmount({\n      bookingId: params.bookingId,\n      paymentIntentId: params.paymentIntentId,\n    }, context)\n\n    if (!policy.isRefundable) {\n      return {\n        success: false,\n        error: policy.policyDescription,\n        policy,\n      }\n    }\n\n    // Process the refund\n    const result = await processPartialRefund({\n      paymentIntentId: params.paymentIntentId,\n      bookingId: params.bookingId,\n      amount: policy.refundAmount,\n      reason: params.reason || policy.policyDescription,\n    }, context)\n\n    return {\n      ...result,\n      policy,\n    }\n  } catch (error: any) {\n    console.error(\"[Refund] Auto-refund failed\", error.message)\n    throw error\n  }\n}\n\n// Export handlers map for registry\nexport const refundHandlers = {\n  calculateRefundAmount,\n  processRefund,\n  processPartialRefund,\n  getRefundStatus,\n  getBookingRefunds,\n  autoRefundWithPolicy,\n}\n","/**\n * Travel Insurance Handler\n * Offer and manage travel insurance for bookings\n */\n\n// Types\nexport interface InsuranceContext {\n  userId?: string\n  sessionId?: string\n  locale?: \"en\" | \"he\"\n}\n\nexport interface InsurancePlan {\n  id: string\n  name: string\n  nameHe: string\n  description: string\n  descriptionHe: string\n  coverage: InsuranceCoverage[]\n  pricePerDay: number\n  pricePerPerson: number\n  currency: string\n  provider: string\n  terms: string\n  termsHe: string\n}\n\nexport interface InsuranceCoverage {\n  type: string\n  typeHe: string\n  maxAmount: number\n  currency: string\n  description: string\n  descriptionHe: string\n}\n\nexport interface InsuranceQuote {\n  quoteId: string\n  planId: string\n  planName: string\n  totalPrice: number\n  priceBreakdown: {\n    basePrice: number\n    perDayPrice: number\n    perPersonPrice: number\n    taxes: number\n  }\n  currency: string\n  coverage: InsuranceCoverage[]\n  validUntil: Date\n  bookingId?: string\n}\n\nexport interface InsurancePolicy {\n  policyId: string\n  quoteId: string\n  planId: string\n  bookingId: string\n  customerId: string\n  customerName: string\n  customerEmail: string\n  travelers: string[]\n  startDate: Date\n  endDate: Date\n  totalPrice: number\n  currency: string\n  status: \"active\" | \"cancelled\" | \"expired\" | \"claimed\"\n  policyNumber: string\n  documentUrl?: string\n  createdAt: Date\n}\n\n// Available insurance plans\nconst INSURANCE_PLANS: InsurancePlan[] = [\n  {\n    id: \"basic\",\n    name: \"Basic Travel Protection\",\n    nameHe: \"הגנה בסיסית לנסיעה\",\n    description: \"Essential coverage for trip cancellation and medical emergencies\",\n    descriptionHe: \"כיסוי בסיסי לביטול נסיעה ומצבי חירום רפואיים\",\n    coverage: [\n      {\n        type: \"Trip Cancellation\",\n        typeHe: \"ביטול נסיעה\",\n        maxAmount: 100000,\n        currency: \"USD\",\n        description: \"Reimbursement for prepaid, non-refundable trip costs\",\n        descriptionHe: \"החזר עבור עלויות נסיעה ששולמו מראש ואינן ניתנות להחזר\",\n      },\n      {\n        type: \"Medical Emergency\",\n        typeHe: \"חירום רפואי\",\n        maxAmount: 50000,\n        currency: \"USD\",\n        description: \"Emergency medical treatment abroad\",\n        descriptionHe: \"טיפול רפואי חירום בחו\\\"ל\",\n      },\n      {\n        type: \"Baggage Loss\",\n        typeHe: \"אובדן מזוודות\",\n        maxAmount: 1000,\n        currency: \"USD\",\n        description: \"Coverage for lost or stolen baggage\",\n        descriptionHe: \"כיסוי למזוודות שאבדו או נגנבו\",\n      },\n    ],\n    pricePerDay: 500, // $5/day in cents\n    pricePerPerson: 1000, // $10/person in cents\n    currency: \"USD\",\n    provider: \"TravelGuard\",\n    terms: \"Coverage begins at trip start. Pre-existing conditions excluded.\",\n    termsHe: \"הכיסוי מתחיל עם תחילת הנסיעה. מצבים רפואיים קיימים אינם מכוסים.\",\n  },\n  {\n    id: \"premium\",\n    name: \"Premium Travel Protection\",\n    nameHe: \"הגנה פרימיום לנסיעה\",\n    description: \"Comprehensive coverage including adventure activities and electronics\",\n    descriptionHe: \"כיסוי מקיף כולל פעילויות אתגריות ומכשירים אלקטרוניים\",\n    coverage: [\n      {\n        type: \"Trip Cancellation\",\n        typeHe: \"ביטול נסיעה\",\n        maxAmount: 200000,\n        currency: \"USD\",\n        description: \"Full reimbursement for any reason cancellation\",\n        descriptionHe: \"החזר מלא לביטול מכל סיבה\",\n      },\n      {\n        type: \"Medical Emergency\",\n        typeHe: \"חירום רפואי\",\n        maxAmount: 250000,\n        currency: \"USD\",\n        description: \"Comprehensive medical coverage including evacuation\",\n        descriptionHe: \"כיסוי רפואי מקיף כולל פינוי\",\n      },\n      {\n        type: \"Baggage & Electronics\",\n        typeHe: \"מזוודות ואלקטרוניקה\",\n        maxAmount: 3000,\n        currency: \"USD\",\n        description: \"Coverage for baggage, electronics, and valuables\",\n        descriptionHe: \"כיסוי למזוודות, אלקטרוניקה וחפצי ערך\",\n      },\n      {\n        type: \"Adventure Sports\",\n        typeHe: \"ספורט אתגרי\",\n        maxAmount: 50000,\n        currency: \"USD\",\n        description: \"Coverage for skiing, diving, hiking accidents\",\n        descriptionHe: \"כיסוי לתאונות סקי, צלילה, טיולים\",\n      },\n      {\n        type: \"Trip Delay\",\n        typeHe: \"עיכוב נסיעה\",\n        maxAmount: 500,\n        currency: \"USD\",\n        description: \"Compensation for delays over 6 hours\",\n        descriptionHe: \"פיצוי על עיכובים של מעל 6 שעות\",\n      },\n    ],\n    pricePerDay: 1200, // $12/day\n    pricePerPerson: 2500, // $25/person\n    currency: \"USD\",\n    provider: \"TravelGuard\",\n    terms: \"24/7 assistance hotline. Cancel for any reason up to 48h before.\",\n    termsHe: \"קו חירום 24/7. ביטול מכל סיבה עד 48 שעות לפני.\",\n  },\n  {\n    id: \"family\",\n    name: \"Family Travel Protection\",\n    nameHe: \"הגנת משפחה לנסיעה\",\n    description: \"Specially designed for families with children\",\n    descriptionHe: \"מותאם במיוחד למשפחות עם ילדים\",\n    coverage: [\n      {\n        type: \"Trip Cancellation\",\n        typeHe: \"ביטול נסיעה\",\n        maxAmount: 150000,\n        currency: \"USD\",\n        description: \"Family cancellation coverage\",\n        descriptionHe: \"כיסוי ביטול למשפחה\",\n      },\n      {\n        type: \"Medical Emergency\",\n        typeHe: \"חירום רפואי\",\n        maxAmount: 150000,\n        currency: \"USD\",\n        description: \"Family medical coverage including pediatric care\",\n        descriptionHe: \"כיסוי רפואי למשפחה כולל טיפול ילדים\",\n      },\n      {\n        type: \"Child Care\",\n        typeHe: \"טיפול בילדים\",\n        maxAmount: 5000,\n        currency: \"USD\",\n        description: \"Emergency child care if parent hospitalized\",\n        descriptionHe: \"טיפול חירום בילדים אם ההורה מאושפז\",\n      },\n      {\n        type: \"Baggage Loss\",\n        typeHe: \"אובדן מזוודות\",\n        maxAmount: 2000,\n        currency: \"USD\",\n        description: \"Family baggage coverage\",\n        descriptionHe: \"כיסוי מזוודות למשפחה\",\n      },\n    ],\n    pricePerDay: 800, // $8/day\n    pricePerPerson: 1500, // $15/person, but children under 18 free\n    currency: \"USD\",\n    provider: \"TravelGuard\",\n    terms: \"Children under 18 included free. Max 2 adults, 4 children per policy.\",\n    termsHe: \"ילדים עד גיל 18 ללא תשלום. מקסימום 2 מבוגרים, 4 ילדים לפוליסה.\",\n  },\n]\n\n/**\n * Get available insurance plans\n */\nexport async function getInsurancePlans(\n  params: { destination?: string; tripType?: string },\n  context?: InsuranceContext\n): Promise<InsurancePlan[]> {\n  console.log(\"[Insurance] Getting available plans\", params)\n  \n  // In production, would filter based on destination regulations\n  return INSURANCE_PLANS\n}\n\n/**\n * Get insurance quote for a booking\n */\nexport async function getInsuranceQuote(\n  params: {\n    planId: string\n    bookingId?: string\n    checkIn: string | Date\n    checkOut: string | Date\n    travelers: number\n    childrenUnder18?: number\n  },\n  context?: InsuranceContext\n): Promise<InsuranceQuote> {\n  console.log(\"[Insurance] Generating quote\", { planId: params.planId, travelers: params.travelers })\n\n  const plan = INSURANCE_PLANS.find(p => p.id === params.planId)\n  if (!plan) {\n    throw new Error(`Insurance plan not found: ${params.planId}`)\n  }\n\n  const checkIn = new Date(params.checkIn)\n  const checkOut = new Date(params.checkOut)\n  const days = Math.ceil((checkOut.getTime() - checkIn.getTime()) / (1000 * 60 * 60 * 24))\n\n  // Calculate price\n  let travelers = params.travelers\n  // Family plan: children under 18 are free\n  if (params.planId === \"family\" && params.childrenUnder18) {\n    travelers = Math.max(0, travelers - params.childrenUnder18)\n  }\n\n  const perDayPrice = plan.pricePerDay * days\n  const perPersonPrice = plan.pricePerPerson * travelers\n  const basePrice = perDayPrice + perPersonPrice\n  const taxes = Math.round(basePrice * 0.05) // 5% tax\n  const totalPrice = basePrice + taxes\n\n  const quote: InsuranceQuote = {\n    quoteId: `quote_${Date.now()}_${Math.random().toString(36).substring(2, 8)}`,\n    planId: plan.id,\n    planName: plan.name,\n    totalPrice,\n    priceBreakdown: {\n      basePrice,\n      perDayPrice,\n      perPersonPrice,\n      taxes,\n    },\n    currency: plan.currency,\n    coverage: plan.coverage,\n    validUntil: new Date(Date.now() + 24 * 60 * 60 * 1000), // Valid 24 hours\n    bookingId: params.bookingId,\n  }\n\n  console.log(\"[Insurance] Quote generated\", { quoteId: quote.quoteId, totalPrice })\n\n  return quote\n}\n\n/**\n * Purchase insurance policy\n */\nexport async function purchaseInsurance(\n  params: {\n    quoteId: string\n    bookingId: string\n    customerId: string\n    customerName: string\n    customerEmail: string\n    travelers: string[] // Names of all travelers\n    paymentMethodId?: string\n  },\n  context?: InsuranceContext\n): Promise<InsurancePolicy> {\n  console.log(\"[Insurance] Purchasing policy\", { quoteId: params.quoteId, bookingId: params.bookingId })\n\n  // In production, would:\n  // 1. Verify quote is still valid\n  // 2. Process payment via Stripe\n  // 3. Create policy with insurance provider API\n  // 4. Store in database\n\n  const policy: InsurancePolicy = {\n    policyId: `policy_${Date.now()}_${Math.random().toString(36).substring(2, 8)}`,\n    quoteId: params.quoteId,\n    planId: \"premium\", // Would come from quote\n    bookingId: params.bookingId,\n    customerId: params.customerId,\n    customerName: params.customerName,\n    customerEmail: params.customerEmail,\n    travelers: params.travelers,\n    startDate: new Date(), // Would come from booking\n    endDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000),\n    totalPrice: 5000, // Would come from quote\n    currency: \"USD\",\n    status: \"active\",\n    policyNumber: `TG-${Date.now().toString().slice(-8)}`,\n    createdAt: new Date(),\n  }\n\n  console.log(\"[Insurance] Policy purchased\", { policyId: policy.policyId, policyNumber: policy.policyNumber })\n\n  return policy\n}\n\n/**\n * Get insurance policy details\n */\nexport async function getInsurancePolicy(\n  params: { policyId?: string; bookingId?: string },\n  context?: InsuranceContext\n): Promise<InsurancePolicy | null> {\n  console.log(\"[Insurance] Getting policy\", params)\n  \n  // In production, would fetch from database\n  return null\n}\n\n/**\n * Cancel insurance policy\n */\nexport async function cancelInsurance(\n  params: {\n    policyId: string\n    reason?: string\n  },\n  context?: InsuranceContext\n): Promise<{ success: boolean; refundAmount?: number; error?: string }> {\n  console.log(\"[Insurance] Cancelling policy\", { policyId: params.policyId })\n\n  // In production, would:\n  // 1. Check cancellation policy\n  // 2. Calculate refund based on start date\n  // 3. Process refund\n  // 4. Update policy status\n\n  return {\n    success: true,\n    refundAmount: 4500, // 90% refund example\n  }\n}\n\n/**\n * File insurance claim\n */\nexport async function fileInsuranceClaim(\n  params: {\n    policyId: string\n    claimType: string\n    description: string\n    amount: number\n    documents?: string[] // URLs to uploaded documents\n  },\n  context?: InsuranceContext\n): Promise<{\n  claimId: string\n  status: \"submitted\" | \"under_review\" | \"approved\" | \"rejected\"\n  estimatedProcessingDays: number\n}> {\n  console.log(\"[Insurance] Filing claim\", { policyId: params.policyId, claimType: params.claimType })\n\n  return {\n    claimId: `claim_${Date.now()}_${Math.random().toString(36).substring(2, 8)}`,\n    status: \"submitted\",\n    estimatedProcessingDays: 5,\n  }\n}\n\n/**\n * Get claim status\n */\nexport async function getClaimStatus(\n  params: { claimId: string },\n  context?: InsuranceContext\n): Promise<{\n  claimId: string\n  status: string\n  amount?: number\n  decision?: string\n  updatedAt: Date\n}> {\n  console.log(\"[Insurance] Getting claim status\", { claimId: params.claimId })\n\n  return {\n    claimId: params.claimId,\n    status: \"under_review\",\n    updatedAt: new Date(),\n  }\n}\n\n// Export handlers map for registry\nexport const insuranceHandlers = {\n  getInsurancePlans,\n  getInsuranceQuote,\n  purchaseInsurance,\n  getInsurancePolicy,\n  cancelInsurance,\n  fileInsuranceClaim,\n  getClaimStatus,\n}\n","/**\n * WhatsApp Bot Handler\n * WhatsApp Business API integration for booking notifications and support\n */\n\n// Types\nexport interface WhatsAppContext {\n  userId?: string\n  sessionId?: string\n  locale?: \"en\" | \"he\"\n}\n\nexport interface WhatsAppMessage {\n  messageId: string\n  from: string\n  to: string\n  type: \"text\" | \"template\" | \"image\" | \"document\" | \"interactive\"\n  content: string | WhatsAppTemplate | WhatsAppInteractive\n  timestamp: Date\n  status: \"sent\" | \"delivered\" | \"read\" | \"failed\"\n}\n\nexport interface WhatsAppTemplate {\n  name: string\n  language: string\n  components: {\n    type: \"header\" | \"body\" | \"button\"\n    parameters: { type: string; text?: string; image?: { link: string } }[]\n  }[]\n}\n\nexport interface WhatsAppInteractive {\n  type: \"button\" | \"list\"\n  header?: { type: \"text\"; text: string }\n  body: { text: string }\n  footer?: { text: string }\n  action: {\n    buttons?: { type: \"reply\"; reply: { id: string; title: string } }[]\n    sections?: { title: string; rows: { id: string; title: string; description?: string }[] }[]\n  }\n}\n\nexport interface WhatsAppConversation {\n  conversationId: string\n  customerPhone: string\n  customerName?: string\n  bookingId?: string\n  status: \"active\" | \"resolved\" | \"pending_human\"\n  messages: WhatsAppMessage[]\n  createdAt: Date\n  updatedAt: Date\n  assignedTo?: string\n}\n\n// Message templates\nconst MESSAGE_TEMPLATES = {\n  bookingConfirmation: {\n    name: \"booking_confirmation\",\n    languages: [\"en\", \"he\"],\n  },\n  checkInReminder: {\n    name: \"checkin_reminder\",\n    languages: [\"en\", \"he\"],\n  },\n  paymentReceipt: {\n    name: \"payment_receipt\",\n    languages: [\"en\", \"he\"],\n  },\n  cancellationConfirmation: {\n    name: \"cancellation_confirmation\",\n    languages: [\"en\", \"he\"],\n  },\n}\n\n// In-memory conversation store\nconst conversations: Map<string, WhatsAppConversation> = new Map()\n\n/**\n * Send WhatsApp message\n */\nexport async function sendWhatsAppMessage(\n  params: {\n    to: string\n    type: \"text\" | \"template\" | \"interactive\"\n    content: string | WhatsAppTemplate | WhatsAppInteractive\n  },\n  context?: WhatsAppContext\n): Promise<{ success: boolean; messageId?: string; error?: string }> {\n  console.log(\"[WhatsApp] Sending message\", { to: params.to, type: params.type })\n\n  // Validate phone number\n  const phone = params.to.replace(/\\D/g, \"\")\n  if (phone.length < 10) {\n    return { success: false, error: \"Invalid phone number\" }\n  }\n\n  // In production, would call WhatsApp Business API\n  // const response = await fetch(`https://graph.facebook.com/v17.0/${PHONE_ID}/messages`, {\n  //   method: 'POST',\n  //   headers: { 'Authorization': `Bearer ${WHATSAPP_TOKEN}`, 'Content-Type': 'application/json' },\n  //   body: JSON.stringify({ messaging_product: 'whatsapp', to: phone, type: params.type, ... })\n  // })\n\n  const message: WhatsAppMessage = {\n    messageId: `msg_${Date.now()}_${Math.random().toString(36).substring(2, 8)}`,\n    from: process.env.WHATSAPP_PHONE_ID || \"BUSINESS\",\n    to: phone,\n    type: params.type,\n    content: params.content,\n    timestamp: new Date(),\n    status: \"sent\",\n  }\n\n  console.log(\"[WhatsApp] Message sent\", { messageId: message.messageId })\n\n  return { success: true, messageId: message.messageId }\n}\n\n/**\n * Send booking confirmation via WhatsApp\n */\nexport async function sendBookingConfirmation(\n  params: {\n    phone: string\n    customerName: string\n    bookingId: string\n    hotelName: string\n    checkIn: string | Date\n    checkOut: string | Date\n    confirmationNumber: string\n  },\n  context?: WhatsAppContext\n): Promise<{ success: boolean; messageId?: string; error?: string }> {\n  console.log(\"[WhatsApp] Sending booking confirmation\", { bookingId: params.bookingId })\n\n  const locale = context?.locale || \"en\"\n  const checkIn = new Date(params.checkIn)\n  const checkOut = new Date(params.checkOut)\n\n  const messageText = locale === \"he\"\n    ? `שלום ${params.customerName}! 🎉\n\nההזמנה שלך אושרה!\n\n🏨 ${params.hotelName}\n📅 צ'ק-אין: ${checkIn.toLocaleDateString(\"he-IL\")}\n📅 צ'ק-אאוט: ${checkOut.toLocaleDateString(\"he-IL\")}\n🔢 מספר אישור: ${params.confirmationNumber}\n\nתודה שהזמנת דרכנו!`\n    : `Hello ${params.customerName}! 🎉\n\nYour booking is confirmed!\n\n🏨 ${params.hotelName}\n📅 Check-in: ${checkIn.toLocaleDateString(\"en-US\")}\n📅 Check-out: ${checkOut.toLocaleDateString(\"en-US\")}\n🔢 Confirmation: ${params.confirmationNumber}\n\nThank you for booking with us!`\n\n  return sendWhatsAppMessage({\n    to: params.phone,\n    type: \"text\",\n    content: messageText,\n  }, context)\n}\n\n/**\n * Send check-in reminder\n */\nexport async function sendCheckInReminder(\n  params: {\n    phone: string\n    customerName: string\n    hotelName: string\n    hotelAddress: string\n    checkIn: string | Date\n    confirmationNumber: string\n  },\n  context?: WhatsAppContext\n): Promise<{ success: boolean; messageId?: string; error?: string }> {\n  console.log(\"[WhatsApp] Sending check-in reminder\")\n\n  const locale = context?.locale || \"en\"\n  const checkIn = new Date(params.checkIn)\n\n  const messageText = locale === \"he\"\n    ? `שלום ${params.customerName}! ⏰\n\nתזכורת: הצ'ק-אין שלך מחר!\n\n🏨 ${params.hotelName}\n📍 ${params.hotelAddress}\n📅 ${checkIn.toLocaleDateString(\"he-IL\")}\n🔢 מספר אישור: ${params.confirmationNumber}\n\nנסיעה טובה! 🚗`\n    : `Hello ${params.customerName}! ⏰\n\nReminder: Your check-in is tomorrow!\n\n🏨 ${params.hotelName}\n📍 ${params.hotelAddress}\n📅 ${checkIn.toLocaleDateString(\"en-US\")}\n🔢 Confirmation: ${params.confirmationNumber}\n\nSafe travels! 🚗`\n\n  return sendWhatsAppMessage({\n    to: params.phone,\n    type: \"text\",\n    content: messageText,\n  }, context)\n}\n\n/**\n * Send interactive booking options\n */\nexport async function sendBookingOptions(\n  params: {\n    phone: string\n    customerName: string\n    bookingId: string\n  },\n  context?: WhatsAppContext\n): Promise<{ success: boolean; messageId?: string; error?: string }> {\n  console.log(\"[WhatsApp] Sending booking options\")\n\n  const locale = context?.locale || \"en\"\n\n  const interactive: WhatsAppInteractive = {\n    type: \"button\",\n    body: {\n      text: locale === \"he\"\n        ? `שלום ${params.customerName}, איך אפשר לעזור?`\n        : `Hello ${params.customerName}, how can I help you?`,\n    },\n    action: {\n      buttons: [\n        {\n          type: \"reply\",\n          reply: {\n            id: `view_booking_${params.bookingId}`,\n            title: locale === \"he\" ? \"צפה בהזמנה\" : \"View Booking\",\n          },\n        },\n        {\n          type: \"reply\",\n          reply: {\n            id: `modify_booking_${params.bookingId}`,\n            title: locale === \"he\" ? \"שנה הזמנה\" : \"Modify Booking\",\n          },\n        },\n        {\n          type: \"reply\",\n          reply: {\n            id: `contact_support`,\n            title: locale === \"he\" ? \"דבר עם נציג\" : \"Contact Support\",\n          },\n        },\n      ],\n    },\n  }\n\n  return sendWhatsAppMessage({\n    to: params.phone,\n    type: \"interactive\",\n    content: interactive,\n  }, context)\n}\n\n/**\n * Handle incoming WhatsApp message\n */\nexport async function handleIncomingMessage(\n  params: {\n    from: string\n    messageId: string\n    type: string\n    text?: string\n    buttonId?: string\n  },\n  context?: WhatsAppContext\n): Promise<{\n  response: string\n  action?: string\n  requiresHuman?: boolean\n}> {\n  console.log(\"[WhatsApp] Handling incoming message\", { from: params.from, type: params.type })\n\n  const phone = params.from.replace(/\\D/g, \"\")\n  \n  // Find or create conversation\n  let conversation = Array.from(conversations.values()).find(c => c.customerPhone === phone && c.status === \"active\")\n  \n  if (!conversation) {\n    conversation = {\n      conversationId: `conv_${Date.now()}_${Math.random().toString(36).substring(2, 8)}`,\n      customerPhone: phone,\n      status: \"active\",\n      messages: [],\n      createdAt: new Date(),\n      updatedAt: new Date(),\n    }\n    conversations.set(conversation.conversationId, conversation)\n  }\n\n  // Handle button clicks\n  if (params.buttonId) {\n    if (params.buttonId.startsWith(\"view_booking_\")) {\n      const bookingId = params.buttonId.replace(\"view_booking_\", \"\")\n      return {\n        response: `Here are the details for booking ${bookingId}. I'll send you the full information shortly.`,\n        action: \"fetch_booking_details\",\n      }\n    }\n    \n    if (params.buttonId.startsWith(\"modify_booking_\")) {\n      return {\n        response: \"What would you like to change? You can modify dates, room type, or add special requests.\",\n        action: \"start_modification\",\n      }\n    }\n    \n    if (params.buttonId === \"contact_support\") {\n      conversation.status = \"pending_human\"\n      conversations.set(conversation.conversationId, conversation)\n      return {\n        response: \"I'm connecting you with a human agent. Please wait a moment.\",\n        action: \"transfer_to_human\",\n        requiresHuman: true,\n      }\n    }\n  }\n\n  // Simple intent detection\n  const text = (params.text || \"\").toLowerCase()\n  \n  if (text.includes(\"book\") || text.includes(\"reserve\") || text.includes(\"הזמ\")) {\n    return {\n      response: \"I'd be happy to help you make a booking! Where would you like to stay and for what dates?\",\n      action: \"start_booking\",\n    }\n  }\n  \n  if (text.includes(\"cancel\") || text.includes(\"ביטול\")) {\n    return {\n      response: \"I can help you cancel your booking. Please provide your confirmation number.\",\n      action: \"start_cancellation\",\n    }\n  }\n  \n  if (text.includes(\"help\") || text.includes(\"support\") || text.includes(\"עזר\")) {\n    return {\n      response: \"How can I assist you today? I can help with bookings, modifications, cancellations, or general questions.\",\n      action: \"show_help\",\n    }\n  }\n\n  // Default response\n  return {\n    response: \"Thanks for your message! How can I help you today? Reply with 'help' to see available options.\",\n    action: \"default\",\n  }\n}\n\n/**\n * Get conversation history\n */\nexport async function getConversation(\n  params: { conversationId?: string; phone?: string },\n  context?: WhatsAppContext\n): Promise<WhatsAppConversation | null> {\n  if (params.conversationId) {\n    return conversations.get(params.conversationId) || null\n  }\n  \n  if (params.phone) {\n    const phone = params.phone.replace(/\\D/g, \"\")\n    return Array.from(conversations.values()).find(c => c.customerPhone === phone) || null\n  }\n  \n  return null\n}\n\n/**\n * Transfer conversation to human agent\n */\nexport async function transferToHuman(\n  params: {\n    conversationId: string\n    reason: string\n    priority?: \"low\" | \"medium\" | \"high\"\n  },\n  context?: WhatsAppContext\n): Promise<{ success: boolean; ticketId?: string }> {\n  console.log(\"[WhatsApp] Transferring to human\", { conversationId: params.conversationId })\n\n  const conversation = conversations.get(params.conversationId)\n  if (!conversation) {\n    return { success: false }\n  }\n\n  conversation.status = \"pending_human\"\n  conversations.set(conversation.conversationId, conversation)\n\n  // In production, would create support ticket\n  const ticketId = `ticket_${Date.now()}`\n\n  return { success: true, ticketId }\n}\n\n/**\n * Send bulk notifications\n */\nexport async function sendBulkNotification(\n  params: {\n    phones: string[]\n    templateName: string\n    templateParams: Record<string, string>\n  },\n  context?: WhatsAppContext\n): Promise<{\n  sent: number\n  failed: number\n  errors: { phone: string; error: string }[]\n}> {\n  console.log(\"[WhatsApp] Sending bulk notification\", { \n    count: params.phones.length, \n    template: params.templateName \n  })\n\n  const results = {\n    sent: 0,\n    failed: 0,\n    errors: [] as { phone: string; error: string }[],\n  }\n\n  for (const phone of params.phones) {\n    const result = await sendWhatsAppMessage({\n      to: phone,\n      type: \"text\", // Would use template in production\n      content: `Notification: ${params.templateName}`,\n    }, context)\n\n    if (result.success) {\n      results.sent++\n    } else {\n      results.failed++\n      results.errors.push({ phone, error: result.error || \"Unknown error\" })\n    }\n  }\n\n  return results\n}\n\n/**\n * Get WhatsApp analytics\n */\nexport async function getWhatsAppStats(\n  params: { startDate?: Date; endDate?: Date },\n  context?: WhatsAppContext\n): Promise<{\n  totalConversations: number\n  activeConversations: number\n  messagesReceived: number\n  messagesSent: number\n  averageResponseTime: number\n  humanTransferRate: number\n}> {\n  const allConversations = Array.from(conversations.values())\n  const active = allConversations.filter(c => c.status === \"active\")\n  const humanTransfers = allConversations.filter(c => c.status === \"pending_human\")\n\n  return {\n    totalConversations: allConversations.length,\n    activeConversations: active.length,\n    messagesReceived: allConversations.reduce((sum, c) => sum + c.messages.length, 0),\n    messagesSent: allConversations.reduce((sum, c) => sum + c.messages.filter(m => m.from === \"BUSINESS\").length, 0),\n    averageResponseTime: 30, // seconds - would calculate from actual data\n    humanTransferRate: allConversations.length > 0 \n      ? (humanTransfers.length / allConversations.length) * 100 \n      : 0,\n  }\n}\n\n// Export handlers map for registry\nexport const whatsappHandlers = {\n  sendWhatsAppMessage,\n  sendBookingConfirmation,\n  sendCheckInReminder,\n  sendBookingOptions,\n  handleIncomingMessage,\n  getConversation,\n  transferToHuman,\n  sendBulkNotification,\n  getWhatsAppStats,\n}\n","/**\n * Abandoned Cart Recovery Handler\n * Track and recover abandoned bookings\n */\n\n// Types\nexport interface CartContext {\n  userId?: string\n  sessionId?: string\n  locale?: \"en\" | \"he\"\n}\n\nexport interface AbandonedCart {\n  cartId: string\n  sessionId: string\n  userId?: string\n  customerEmail?: string\n  customerName?: string\n  \n  // Booking details\n  hotelId: string\n  hotelName: string\n  roomCode: string\n  roomType: string\n  checkIn: Date\n  checkOut: Date\n  guests: number\n  totalPrice: number\n  currency: string\n  \n  // Cart state\n  stage: \"search\" | \"room_selected\" | \"prebook\" | \"checkout\" | \"payment\"\n  createdAt: Date\n  updatedAt: Date\n  abandonedAt?: Date\n  \n  // Recovery attempts\n  recoveryAttempts: RecoveryAttempt[]\n  recovered: boolean\n  recoveredAt?: Date\n  \n  // Metadata\n  source?: string\n  device?: string\n  referrer?: string\n}\n\nexport interface RecoveryAttempt {\n  attemptId: string\n  type: \"email\" | \"sms\" | \"push\" | \"whatsapp\"\n  sentAt: Date\n  opened?: boolean\n  clicked?: boolean\n  converted?: boolean\n  discount?: {\n    code: string\n    percentage: number\n    expiresAt: Date\n  }\n}\n\nexport interface CartRecoveryStats {\n  totalAbandoned: number\n  totalRecovered: number\n  recoveryRate: number\n  revenueRecovered: number\n  averageCartValue: number\n  topAbandonmentStages: { stage: string; count: number }[]\n  recoveryByChannel: { channel: string; recovered: number; rate: number }[]\n}\n\n// In-memory store (would use Supabase in production)\nconst abandonedCarts: Map<string, AbandonedCart> = new Map()\n\n// Recovery email templates\nconst RECOVERY_TEMPLATES = {\n  initial: {\n    subject: \"You left something behind! 🏨\",\n    subjectHe: \"שכחת משהו! 🏨\",\n    delay: 1 * 60 * 60 * 1000, // 1 hour\n  },\n  reminder: {\n    subject: \"Your room is still available - but not for long!\",\n    subjectHe: \"החדר שלך עדיין זמין - אבל לא לאורך זמן!\",\n    delay: 24 * 60 * 60 * 1000, // 24 hours\n  },\n  lastChance: {\n    subject: \"Last chance: 10% off your booking\",\n    subjectHe: \"הזדמנות אחרונה: 10% הנחה להזמנה שלך\",\n    delay: 72 * 60 * 60 * 1000, // 72 hours\n    discount: 10,\n  },\n}\n\n/**\n * Track cart activity (called on each booking step)\n */\nexport async function trackCartActivity(\n  params: {\n    sessionId: string\n    userId?: string\n    customerEmail?: string\n    customerName?: string\n    stage: AbandonedCart[\"stage\"]\n    hotelId: string\n    hotelName: string\n    roomCode?: string\n    roomType?: string\n    checkIn: string | Date\n    checkOut: string | Date\n    guests: number\n    totalPrice: number\n    currency: string\n    source?: string\n    device?: string\n  },\n  context?: CartContext\n): Promise<{ cartId: string; isNew: boolean }> {\n  console.log(\"[Cart] Tracking activity\", { sessionId: params.sessionId, stage: params.stage })\n\n  // Find or create cart\n  let cart = Array.from(abandonedCarts.values()).find(c => c.sessionId === params.sessionId)\n  const isNew = !cart\n\n  if (!cart) {\n    cart = {\n      cartId: `cart_${Date.now()}_${Math.random().toString(36).substring(2, 8)}`,\n      sessionId: params.sessionId,\n      userId: params.userId,\n      customerEmail: params.customerEmail,\n      customerName: params.customerName,\n      hotelId: params.hotelId,\n      hotelName: params.hotelName,\n      roomCode: params.roomCode || \"\",\n      roomType: params.roomType || \"\",\n      checkIn: new Date(params.checkIn),\n      checkOut: new Date(params.checkOut),\n      guests: params.guests,\n      totalPrice: params.totalPrice,\n      currency: params.currency,\n      stage: params.stage,\n      createdAt: new Date(),\n      updatedAt: new Date(),\n      recoveryAttempts: [],\n      recovered: false,\n      source: params.source,\n      device: params.device,\n    }\n  } else {\n    // Update existing cart\n    cart.stage = params.stage\n    cart.updatedAt = new Date()\n    cart.customerEmail = params.customerEmail || cart.customerEmail\n    cart.customerName = params.customerName || cart.customerName\n    cart.roomCode = params.roomCode || cart.roomCode\n    cart.roomType = params.roomType || cart.roomType\n    cart.totalPrice = params.totalPrice\n  }\n\n  abandonedCarts.set(cart.cartId, cart)\n\n  return { cartId: cart.cartId, isNew }\n}\n\n/**\n * Mark cart as abandoned (called after inactivity timeout)\n */\nexport async function markCartAbandoned(\n  params: {\n    cartId?: string\n    sessionId?: string\n  },\n  context?: CartContext\n): Promise<{ success: boolean; cartId?: string }> {\n  let cart: AbandonedCart | undefined\n\n  if (params.cartId) {\n    cart = abandonedCarts.get(params.cartId)\n  } else if (params.sessionId) {\n    cart = Array.from(abandonedCarts.values()).find(c => c.sessionId === params.sessionId)\n  }\n\n  if (!cart) {\n    return { success: false }\n  }\n\n  cart.abandonedAt = new Date()\n  abandonedCarts.set(cart.cartId, cart)\n\n  console.log(\"[Cart] Marked as abandoned\", { cartId: cart.cartId, stage: cart.stage })\n\n  return { success: true, cartId: cart.cartId }\n}\n\n/**\n * Get abandoned carts for recovery\n */\nexport async function getAbandonedCarts(\n  params: {\n    minAge?: number // Minimum age in minutes\n    maxAge?: number // Maximum age in hours\n    stage?: AbandonedCart[\"stage\"]\n    hasEmail?: boolean\n    limit?: number\n  },\n  context?: CartContext\n): Promise<AbandonedCart[]> {\n  console.log(\"[Cart] Getting abandoned carts\", params)\n\n  const now = Date.now()\n  const minAgeMs = (params.minAge || 30) * 60 * 1000 // Default 30 minutes\n  const maxAgeMs = (params.maxAge || 72) * 60 * 60 * 1000 // Default 72 hours\n\n  let carts = Array.from(abandonedCarts.values()).filter(cart => {\n    // Must be abandoned\n    if (!cart.abandonedAt) return false\n    \n    // Not already recovered\n    if (cart.recovered) return false\n\n    // Age filter\n    const age = now - cart.abandonedAt.getTime()\n    if (age < minAgeMs || age > maxAgeMs) return false\n\n    // Stage filter\n    if (params.stage && cart.stage !== params.stage) return false\n\n    // Email filter\n    if (params.hasEmail && !cart.customerEmail) return false\n\n    return true\n  })\n\n  // Sort by most recent\n  carts.sort((a, b) => (b.abandonedAt?.getTime() || 0) - (a.abandonedAt?.getTime() || 0))\n\n  // Limit\n  if (params.limit) {\n    carts = carts.slice(0, params.limit)\n  }\n\n  return carts\n}\n\n/**\n * Send recovery email\n */\nexport async function sendRecoveryEmail(\n  params: {\n    cartId: string\n    templateType: \"initial\" | \"reminder\" | \"lastChance\"\n    customMessage?: string\n  },\n  context?: CartContext\n): Promise<{ success: boolean; attemptId?: string; error?: string }> {\n  const cart = abandonedCarts.get(params.cartId)\n  if (!cart) {\n    return { success: false, error: \"Cart not found\" }\n  }\n\n  if (!cart.customerEmail) {\n    return { success: false, error: \"No customer email\" }\n  }\n\n  console.log(\"[Cart] Sending recovery email\", { \n    cartId: params.cartId, \n    template: params.templateType,\n    to: cart.customerEmail \n  })\n\n  const template = RECOVERY_TEMPLATES[params.templateType]\n  const locale = context?.locale || \"en\"\n\n  // Generate discount code for last chance\n  let discount: RecoveryAttempt[\"discount\"]\n  if (params.templateType === \"lastChance\" && \"discount\" in template) {\n    discount = {\n      code: `COMEBACK${cart.cartId.slice(-6).toUpperCase()}`,\n      percentage: template.discount,\n      expiresAt: new Date(Date.now() + 48 * 60 * 60 * 1000), // 48 hours\n    }\n  }\n\n  // Create recovery attempt\n  const attempt: RecoveryAttempt = {\n    attemptId: `attempt_${Date.now()}_${Math.random().toString(36).substring(2, 8)}`,\n    type: \"email\",\n    sentAt: new Date(),\n    discount,\n  }\n\n  // In production, would send actual email via Resend\n  // await sendEmail({ to: cart.customerEmail, subject: locale === \"he\" ? template.subjectHe : template.subject, ... })\n\n  cart.recoveryAttempts.push(attempt)\n  abandonedCarts.set(cart.cartId, cart)\n\n  console.log(\"[Cart] Recovery email sent\", { attemptId: attempt.attemptId })\n\n  return { success: true, attemptId: attempt.attemptId }\n}\n\n/**\n * Mark cart as recovered (when booking completes)\n */\nexport async function markCartRecovered(\n  params: {\n    cartId?: string\n    sessionId?: string\n    bookingId: string\n  },\n  context?: CartContext\n): Promise<{ success: boolean; wasAbandoned: boolean }> {\n  let cart: AbandonedCart | undefined\n\n  if (params.cartId) {\n    cart = abandonedCarts.get(params.cartId)\n  } else if (params.sessionId) {\n    cart = Array.from(abandonedCarts.values()).find(c => c.sessionId === params.sessionId)\n  }\n\n  if (!cart) {\n    return { success: true, wasAbandoned: false }\n  }\n\n  const wasAbandoned = !!cart.abandonedAt\n\n  cart.recovered = true\n  cart.recoveredAt = new Date()\n  abandonedCarts.set(cart.cartId, cart)\n\n  console.log(\"[Cart] Marked as recovered\", { cartId: cart.cartId, wasAbandoned })\n\n  return { success: true, wasAbandoned }\n}\n\n/**\n * Get recovery link for cart\n */\nexport async function getRecoveryLink(\n  params: { cartId: string },\n  context?: CartContext\n): Promise<{ link: string; expiresAt: Date }> {\n  const cart = abandonedCarts.get(params.cartId)\n  if (!cart) {\n    throw new Error(\"Cart not found\")\n  }\n\n  const token = Buffer.from(JSON.stringify({\n    cartId: cart.cartId,\n    exp: Date.now() + 7 * 24 * 60 * 60 * 1000, // 7 days\n  })).toString(\"base64url\")\n\n  const baseUrl = process.env.NEXT_PUBLIC_APP_URL || \"https://v0-bookinengine.vercel.app\"\n\n  return {\n    link: `${baseUrl}/recover?token=${token}`,\n    expiresAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000),\n  }\n}\n\n/**\n * Get cart recovery statistics\n */\nexport async function getRecoveryStats(\n  params: { startDate?: Date; endDate?: Date },\n  context?: CartContext\n): Promise<CartRecoveryStats> {\n  console.log(\"[Cart] Getting recovery stats\")\n\n  const carts = Array.from(abandonedCarts.values())\n  \n  const abandoned = carts.filter(c => c.abandonedAt)\n  const recovered = abandoned.filter(c => c.recovered)\n  \n  const revenueRecovered = recovered.reduce((sum, c) => sum + c.totalPrice, 0)\n  const totalValue = abandoned.reduce((sum, c) => sum + c.totalPrice, 0)\n\n  // Count by stage\n  const stageCounts: Record<string, number> = {}\n  abandoned.forEach(c => {\n    stageCounts[c.stage] = (stageCounts[c.stage] || 0) + 1\n  })\n\n  // Count by channel\n  const channelCounts: Record<string, { total: number; recovered: number }> = {}\n  abandoned.forEach(c => {\n    c.recoveryAttempts.forEach(a => {\n      if (!channelCounts[a.type]) {\n        channelCounts[a.type] = { total: 0, recovered: 0 }\n      }\n      channelCounts[a.type].total++\n      if (c.recovered) {\n        channelCounts[a.type].recovered++\n      }\n    })\n  })\n\n  return {\n    totalAbandoned: abandoned.length,\n    totalRecovered: recovered.length,\n    recoveryRate: abandoned.length > 0 ? (recovered.length / abandoned.length) * 100 : 0,\n    revenueRecovered,\n    averageCartValue: abandoned.length > 0 ? totalValue / abandoned.length : 0,\n    topAbandonmentStages: Object.entries(stageCounts)\n      .map(([stage, count]) => ({ stage, count }))\n      .sort((a, b) => b.count - a.count),\n    recoveryByChannel: Object.entries(channelCounts)\n      .map(([channel, data]) => ({\n        channel,\n        recovered: data.recovered,\n        rate: data.total > 0 ? (data.recovered / data.total) * 100 : 0,\n      })),\n  }\n}\n\n/**\n * Run automated recovery campaign\n */\nexport async function runRecoveryCampaign(\n  params: { dryRun?: boolean },\n  context?: CartContext\n): Promise<{\n  cartsProcessed: number\n  emailsSent: number\n  errors: string[]\n}> {\n  console.log(\"[Cart] Running recovery campaign\", { dryRun: params.dryRun })\n\n  const results = {\n    cartsProcessed: 0,\n    emailsSent: 0,\n    errors: [] as string[],\n  }\n\n  const carts = await getAbandonedCarts({ hasEmail: true }, context)\n\n  for (const cart of carts) {\n    results.cartsProcessed++\n\n    // Determine which template to use based on time\n    const ageHours = (Date.now() - (cart.abandonedAt?.getTime() || 0)) / (1000 * 60 * 60)\n    const attemptCount = cart.recoveryAttempts.filter(a => a.type === \"email\").length\n\n    let templateType: \"initial\" | \"reminder\" | \"lastChance\" | null = null\n\n    if (attemptCount === 0 && ageHours >= 1) {\n      templateType = \"initial\"\n    } else if (attemptCount === 1 && ageHours >= 24) {\n      templateType = \"reminder\"\n    } else if (attemptCount === 2 && ageHours >= 72) {\n      templateType = \"lastChance\"\n    }\n\n    if (templateType && !params.dryRun) {\n      const result = await sendRecoveryEmail({ cartId: cart.cartId, templateType }, context)\n      if (result.success) {\n        results.emailsSent++\n      } else if (result.error) {\n        results.errors.push(`${cart.cartId}: ${result.error}`)\n      }\n    }\n  }\n\n  console.log(\"[Cart] Campaign complete\", results)\n\n  return results\n}\n\n// Export handlers map for registry\nexport const abandonedCartHandlers = {\n  trackCartActivity,\n  markCartAbandoned,\n  getAbandonedCarts,\n  sendRecoveryEmail,\n  markCartRecovered,\n  getRecoveryLink,\n  getRecoveryStats,\n  runRecoveryCampaign,\n}\n","/**\n * Booking Handlers\n * Tool handlers for hotel search, prebook, and booking operations\n * Based on: ai-travel-agent-platform Medici API integration\n */\n\nimport type { ConversationContext } from '../types';\n\nconst MEDICI_API_URL = process.env.MEDICI_API_URL || 'https://api.medicihotels.com';\nconst MEDICI_API_KEY = process.env.MEDICI_API_KEY || '';\n\n// ========================================\n// HOTEL SEARCH\n// ========================================\n\ninterface SearchHotelsParams {\n  destination: string;\n  checkIn: string;\n  checkOut: string;\n  adults: number;\n  children?: number[];\n  stars?: number[];\n  maxPrice?: number;\n  amenities?: string[];\n}\n\ninterface HotelSearchResult {\n  hotelId: string;\n  name: string;\n  stars: number;\n  address: string;\n  imageUrl: string;\n  rating: number;\n  reviewCount: number;\n  rooms: RoomOption[];\n  amenities: string[];\n  distance?: string;\n}\n\ninterface RoomOption {\n  roomCode: string;\n  roomName: string;\n  boardType: string;\n  price: number;\n  originalPrice?: number;\n  currency: string;\n  cancellationPolicy: string;\n  maxOccupancy: number;\n  available: number;\n}\n\nexport async function searchHotels(\n  params: SearchHotelsParams,\n  context: ConversationContext\n): Promise<{ hotels: HotelSearchResult[]; searchId: string; totalResults: number }> {\n  console.log(`[BookingHandler] Searching hotels:`, params);\n\n  try {\n    // Build search request for Medici API\n    const searchRequest = {\n      destination: params.destination,\n      checkIn: params.checkIn,\n      checkOut: params.checkOut,\n      occupancies: [{\n        adults: params.adults,\n        children: params.children?.map(age => ({ age })) || []\n      }],\n      filters: {\n        stars: params.stars,\n        maxPrice: params.maxPrice,\n        amenities: params.amenities\n      }\n    };\n\n    // In production, call actual Medici API\n    // const response = await fetch(`${MEDICI_API_URL}/search`, {\n    //   method: 'POST',\n    //   headers: {\n    //     'Content-Type': 'application/json',\n    //     'Authorization': `Bearer ${MEDICI_API_KEY}`\n    //   },\n    //   body: JSON.stringify(searchRequest)\n    // });\n\n    // For now, return mock data\n    const mockResults: HotelSearchResult[] = [\n      {\n        hotelId: 'htl-dubai-001',\n        name: 'Burj Al Arab Jumeirah',\n        stars: 5,\n        address: 'Jumeirah Beach Road, Dubai, UAE',\n        imageUrl: '/hotels/burj-al-arab.jpg',\n        rating: 9.4,\n        reviewCount: 12543,\n        amenities: ['Spa', 'Pool', 'WiFi', 'Beach Access', 'Restaurant', 'Butler Service'],\n        rooms: [\n          {\n            roomCode: 'room-001',\n            roomName: 'Deluxe Suite',\n            boardType: 'Breakfast Included',\n            price: 2500,\n            originalPrice: 2800,\n            currency: 'USD',\n            cancellationPolicy: 'Free cancellation until 24h before',\n            maxOccupancy: 2,\n            available: 3\n          },\n          {\n            roomCode: 'room-002',\n            roomName: 'Panoramic Suite',\n            boardType: 'Half Board',\n            price: 3800,\n            currency: 'USD',\n            cancellationPolicy: 'Non-refundable',\n            maxOccupancy: 3,\n            available: 1\n          }\n        ]\n      },\n      {\n        hotelId: 'htl-dubai-002',\n        name: 'Atlantis The Palm',\n        stars: 5,\n        address: 'Crescent Road, The Palm, Dubai, UAE',\n        imageUrl: '/hotels/atlantis.jpg',\n        rating: 8.9,\n        reviewCount: 28912,\n        amenities: ['Waterpark', 'Pool', 'WiFi', 'Beach', 'Aquarium', 'Kids Club'],\n        rooms: [\n          {\n            roomCode: 'room-003',\n            roomName: 'Palm Beach Room',\n            boardType: 'Room Only',\n            price: 450,\n            originalPrice: 520,\n            currency: 'USD',\n            cancellationPolicy: 'Free cancellation until 48h before',\n            maxOccupancy: 2,\n            available: 8\n          }\n        ]\n      },\n      {\n        hotelId: 'htl-dubai-003',\n        name: 'Four Seasons Resort Dubai',\n        stars: 5,\n        address: 'Jumeirah Beach, Dubai, UAE',\n        imageUrl: '/hotels/four-seasons.jpg',\n        rating: 9.2,\n        reviewCount: 8234,\n        amenities: ['Spa', 'Pool', 'WiFi', 'Beach', 'Golf', 'Tennis'],\n        rooms: [\n          {\n            roomCode: 'room-004',\n            roomName: 'Premier Room',\n            boardType: 'Breakfast Included',\n            price: 680,\n            currency: 'USD',\n            cancellationPolicy: 'Free cancellation until 72h before',\n            maxOccupancy: 2,\n            available: 5\n          }\n        ]\n      }\n    ];\n\n    // Store search context\n    if (context) {\n      context.bookingData = {\n        ...context.bookingData,\n        lastSearch: {\n          params,\n          timestamp: new Date(),\n          results: mockResults.map(h => ({ hotelId: h.hotelId, name: h.name }))\n        }\n      };\n    }\n\n    return {\n      hotels: mockResults,\n      searchId: `search-${Date.now()}`,\n      totalResults: mockResults.length\n    };\n  } catch (error: any) {\n    console.error(`[BookingHandler] Search error:`, error);\n    throw new Error(`Hotel search failed: ${error.message}`);\n  }\n}\n\n// ========================================\n// PREBOOK ROOM\n// ========================================\n\ninterface PrebookParams {\n  roomCode: string;\n  hotelId: string;\n  checkIn: string;\n  checkOut: string;\n  guests: {\n    adults: number;\n    children?: { age: number }[];\n  };\n}\n\ninterface PrebookResult {\n  success: boolean;\n  token: string;\n  expiresAt: Date;\n  pricing: {\n    roomRate: number;\n    taxes: number;\n    fees: number;\n    total: number;\n    currency: string;\n  };\n  cancellationPolicy: {\n    freeCancellationUntil?: Date;\n    penalties: { from: Date; amount: number }[];\n  };\n  hotelDetails: {\n    hotelId: string;\n    name: string;\n    roomName: string;\n    checkIn: string;\n    checkOut: string;\n    nights: number;\n  };\n}\n\nexport async function prebookRoom(\n  params: PrebookParams,\n  context: ConversationContext\n): Promise<PrebookResult> {\n  console.log(`[BookingHandler] Pre-booking room:`, params);\n\n  try {\n    // Calculate nights\n    const checkIn = new Date(params.checkIn);\n    const checkOut = new Date(params.checkOut);\n    const nights = Math.ceil((checkOut.getTime() - checkIn.getTime()) / (1000 * 60 * 60 * 24));\n\n    // Mock prebook response\n    const result: PrebookResult = {\n      success: true,\n      token: `prebook-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\n      expiresAt: new Date(Date.now() + 30 * 60 * 1000), // 30 minutes\n      pricing: {\n        roomRate: 680 * nights,\n        taxes: 68 * nights,\n        fees: 25,\n        total: (680 + 68) * nights + 25,\n        currency: 'USD'\n      },\n      cancellationPolicy: {\n        freeCancellationUntil: new Date(checkIn.getTime() - 72 * 60 * 60 * 1000),\n        penalties: [\n          { from: new Date(checkIn.getTime() - 72 * 60 * 60 * 1000), amount: 680 },\n          { from: new Date(checkIn.getTime() - 24 * 60 * 60 * 1000), amount: 680 * nights }\n        ]\n      },\n      hotelDetails: {\n        hotelId: params.hotelId,\n        name: 'Four Seasons Resort Dubai',\n        roomName: 'Premier Room',\n        checkIn: params.checkIn,\n        checkOut: params.checkOut,\n        nights\n      }\n    };\n\n    // Store prebook context\n    if (context) {\n      context.bookingData = {\n        ...context.bookingData,\n        prebook: {\n          token: result.token,\n          expiresAt: result.expiresAt,\n          hotelId: params.hotelId,\n          roomCode: params.roomCode,\n          pricing: result.pricing\n        }\n      };\n    }\n\n    return result;\n  } catch (error: any) {\n    console.error(`[BookingHandler] Prebook error:`, error);\n    throw new Error(`Pre-booking failed: ${error.message}`);\n  }\n}\n\n// ========================================\n// BOOK ROOM\n// ========================================\n\ninterface BookRoomParams {\n  token: string;\n  roomCode: string;\n  customer: {\n    firstName: string;\n    lastName: string;\n    email: string;\n    phone: string;\n    address?: {\n      street: string;\n      city: string;\n      country: string;\n      postalCode: string;\n    };\n  };\n  guests: Array<{\n    firstName: string;\n    lastName: string;\n    isLeadGuest?: boolean;\n  }>;\n  specialRequests?: string;\n  paymentMethod?: string;\n}\n\ninterface BookingResult {\n  success: boolean;\n  bookingId: string;\n  confirmationNumber: string;\n  status: 'confirmed' | 'pending' | 'failed';\n  hotelConfirmation?: string;\n  totalPaid: number;\n  currency: string;\n  bookingDetails: {\n    hotelName: string;\n    roomName: string;\n    checkIn: string;\n    checkOut: string;\n    guests: string[];\n    specialRequests?: string;\n  };\n  paymentDetails: {\n    method: string;\n    last4?: string;\n    transactionId: string;\n  };\n  cancellationPolicy: string;\n}\n\nexport async function bookRoom(\n  params: BookRoomParams,\n  context: ConversationContext\n): Promise<BookingResult> {\n  console.log(`[BookingHandler] Completing booking:`, params);\n\n  try {\n    // Validate prebook token\n    if (!context?.bookingData?.prebook?.token || context.bookingData.prebook.token !== params.token) {\n      throw new Error('Invalid or expired prebook token');\n    }\n\n    // Check token expiration\n    if (new Date() > new Date(context.bookingData.prebook.expiresAt)) {\n      throw new Error('Prebook token has expired. Please search again.');\n    }\n\n    // Generate booking confirmation\n    const bookingId = `BK-${Date.now()}-${Math.random().toString(36).substr(2, 6).toUpperCase()}`;\n    const confirmationNumber = `CNF-${Math.random().toString(36).substr(2, 8).toUpperCase()}`;\n\n    const result: BookingResult = {\n      success: true,\n      bookingId,\n      confirmationNumber,\n      status: 'confirmed',\n      hotelConfirmation: `HC-${Math.random().toString(36).substr(2, 6).toUpperCase()}`,\n      totalPaid: context.bookingData.prebook.pricing.total,\n      currency: context.bookingData.prebook.pricing.currency,\n      bookingDetails: {\n        hotelName: 'Four Seasons Resort Dubai',\n        roomName: 'Premier Room',\n        checkIn: context.bookingData.prebook.checkIn || '2024-03-15',\n        checkOut: context.bookingData.prebook.checkOut || '2024-03-18',\n        guests: params.guests.map(g => `${g.firstName} ${g.lastName}`),\n        specialRequests: params.specialRequests\n      },\n      paymentDetails: {\n        method: params.paymentMethod || 'card',\n        last4: '4242',\n        transactionId: `txn-${Date.now()}`\n      },\n      cancellationPolicy: 'Free cancellation until 72 hours before check-in'\n    };\n\n    // Update context with booking result\n    if (context) {\n      context.bookingData = {\n        ...context.bookingData,\n        confirmedBooking: {\n          bookingId,\n          confirmationNumber,\n          status: 'confirmed',\n          bookedAt: new Date()\n        }\n      };\n    }\n\n    return result;\n  } catch (error: any) {\n    console.error(`[BookingHandler] Booking error:`, error);\n    throw new Error(`Booking failed: ${error.message}`);\n  }\n}\n\n// ========================================\n// CANCEL BOOKING\n// ========================================\n\ninterface CancelBookingParams {\n  bookingId: string;\n  reason?: string;\n  force?: boolean;\n}\n\ninterface CancellationResult {\n  success: boolean;\n  cancellationId: string;\n  refundAmount: number;\n  refundCurrency: string;\n  penaltyApplied: number;\n  refundMethod: string;\n  refundEta: string;\n  message: string;\n}\n\nexport async function cancelBooking(\n  params: CancelBookingParams,\n  context: ConversationContext\n): Promise<CancellationResult> {\n  console.log(`[BookingHandler] Cancelling booking:`, params);\n\n  try {\n    // Mock cancellation - check if within free cancellation period\n    const isWithinFreePeriod = Math.random() > 0.3; // 70% chance it's within free period\n\n    const originalAmount = 2244; // Example amount\n    const penaltyAmount = isWithinFreePeriod ? 0 : 680;\n    const refundAmount = originalAmount - penaltyAmount;\n\n    const result: CancellationResult = {\n      success: true,\n      cancellationId: `CAN-${Date.now()}-${Math.random().toString(36).substr(2, 6).toUpperCase()}`,\n      refundAmount,\n      refundCurrency: 'USD',\n      penaltyApplied: penaltyAmount,\n      refundMethod: 'Original payment method',\n      refundEta: '5-7 business days',\n      message: isWithinFreePeriod \n        ? 'Your booking has been cancelled with a full refund.'\n        : `Your booking has been cancelled. A cancellation fee of $${penaltyAmount} was applied.`\n    };\n\n    return result;\n  } catch (error: any) {\n    console.error(`[BookingHandler] Cancellation error:`, error);\n    throw new Error(`Cancellation failed: ${error.message}`);\n  }\n}\n\n// ========================================\n// GET CANCELLATION POLICY\n// ========================================\n\ninterface GetCancellationPolicyParams {\n  bookingId: string;\n}\n\ninterface CancellationPolicyResult {\n  bookingId: string;\n  hotelName: string;\n  checkIn: string;\n  currentStatus: string;\n  policy: {\n    freeCancellationUntil?: string;\n    isWithinFreePeriod: boolean;\n    penalties: Array<{\n      fromDate: string;\n      amount: number;\n      currency: string;\n      description: string;\n    }>;\n  };\n  recommendation: string;\n}\n\nexport async function getCancellationPolicy(\n  params: GetCancellationPolicyParams,\n  context: ConversationContext\n): Promise<CancellationPolicyResult> {\n  console.log(`[BookingHandler] Getting cancellation policy:`, params);\n\n  const checkIn = new Date('2024-03-15');\n  const freeCancellationDate = new Date(checkIn.getTime() - 72 * 60 * 60 * 1000);\n  const now = new Date();\n  const isWithinFreePeriod = now < freeCancellationDate;\n\n  return {\n    bookingId: params.bookingId,\n    hotelName: 'Four Seasons Resort Dubai',\n    checkIn: '2024-03-15',\n    currentStatus: 'confirmed',\n    policy: {\n      freeCancellationUntil: freeCancellationDate.toISOString(),\n      isWithinFreePeriod,\n      penalties: [\n        {\n          fromDate: freeCancellationDate.toISOString(),\n          amount: 680,\n          currency: 'USD',\n          description: 'First night penalty (72-24 hours before check-in)'\n        },\n        {\n          fromDate: new Date(checkIn.getTime() - 24 * 60 * 60 * 1000).toISOString(),\n          amount: 2244,\n          currency: 'USD',\n          description: 'Full booking amount (less than 24 hours)'\n        }\n      ]\n    },\n    recommendation: isWithinFreePeriod\n      ? 'You can cancel now for a full refund!'\n      : 'Cancellation will incur a penalty. Consider rescheduling instead.'\n  };\n}\n\n// Export all handlers\nexport const bookingHandlers = {\n  searchHotels,\n  prebookRoom,\n  bookRoom,\n  cancelBooking,\n  getCancellationPolicy\n};\n","/**\n * Fraud Detection Handler\n * Analyze bookings for suspicious patterns and fraud risk\n */\n\n// Types\nexport interface FraudContext {\n  userId?: string\n  sessionId?: string\n  ipAddress?: string\n  userAgent?: string\n}\n\nexport interface RiskScore {\n  score: number // 0-100, higher = more risky\n  level: \"low\" | \"medium\" | \"high\" | \"critical\"\n  factors: RiskFactor[]\n  recommendation: \"approve\" | \"review\" | \"block\"\n  details: string\n}\n\nexport interface RiskFactor {\n  name: string\n  nameHe: string\n  score: number // 0-100 contribution to total\n  weight: number // 0-1\n  description: string\n  descriptionHe: string\n}\n\nexport interface FraudCheck {\n  checkType: string\n  passed: boolean\n  details: string\n  score: number\n}\n\nexport interface SuspiciousActivity {\n  id: string\n  type: \"velocity\" | \"mismatch\" | \"pattern\" | \"blacklist\" | \"geolocation\" | \"device\"\n  severity: \"low\" | \"medium\" | \"high\" | \"critical\"\n  description: string\n  bookingId?: string\n  customerId?: string\n  data: Record<string, any>\n  createdAt: Date\n}\n\n// Risk thresholds\nconst RISK_THRESHOLDS = {\n  low: 25,\n  medium: 50,\n  high: 75,\n  critical: 90,\n}\n\n// Suspicious patterns database (would be in Supabase in production)\nconst SUSPICIOUS_PATTERNS = {\n  disposableEmailDomains: [\n    \"tempmail.com\", \"throwaway.email\", \"guerrillamail.com\", \"10minutemail.com\",\n    \"mailinator.com\", \"yopmail.com\", \"trashmail.com\", \"fakeinbox.com\",\n  ],\n  highRiskCountries: [\"XX\", \"YY\"], // Placeholder - configure based on business rules\n  velocityLimits: {\n    bookingsPerHour: 3,\n    bookingsPerDay: 10,\n    totalValuePerDay: 1000000, // In cents ($10,000)\n  },\n}\n\n// In-memory velocity tracking (would use Redis/Supabase in production)\nconst velocityStore: Map<string, { count: number; total: number; timestamp: number }> = new Map()\n\n/**\n * Calculate overall risk score for a booking\n */\nexport async function analyzeBookingRisk(\n  params: {\n    bookingId: string\n    customerEmail: string\n    customerName: string\n    customerPhone?: string\n    amount: number\n    currency: string\n    hotelId: string\n    checkIn: string | Date\n    checkOut: string | Date\n    ipAddress?: string\n    userAgent?: string\n    paymentMethod?: string\n    billingCountry?: string\n  },\n  context?: FraudContext\n): Promise<RiskScore> {\n  console.log(\"[Fraud] Analyzing booking risk\", { bookingId: params.bookingId })\n\n  const factors: RiskFactor[] = []\n  let totalScore = 0\n  let totalWeight = 0\n\n  // 1. Email analysis\n  const emailFactor = analyzeEmail(params.customerEmail)\n  factors.push(emailFactor)\n  totalScore += emailFactor.score * emailFactor.weight\n  totalWeight += emailFactor.weight\n\n  // 2. Velocity check\n  const velocityFactor = await checkVelocity(params.customerEmail, params.amount)\n  factors.push(velocityFactor)\n  totalScore += velocityFactor.score * velocityFactor.weight\n  totalWeight += velocityFactor.weight\n\n  // 3. Amount analysis\n  const amountFactor = analyzeAmount(params.amount)\n  factors.push(amountFactor)\n  totalScore += amountFactor.score * amountFactor.weight\n  totalWeight += amountFactor.weight\n\n  // 4. Name/email mismatch\n  const mismatchFactor = checkNameEmailMismatch(params.customerName, params.customerEmail)\n  factors.push(mismatchFactor)\n  totalScore += mismatchFactor.score * mismatchFactor.weight\n  totalWeight += mismatchFactor.weight\n\n  // 5. Booking pattern analysis\n  const patternFactor = analyzeBookingPattern(params.checkIn, params.checkOut)\n  factors.push(patternFactor)\n  totalScore += patternFactor.score * patternFactor.weight\n  totalWeight += patternFactor.weight\n\n  // 6. IP/Geolocation (if available)\n  if (params.ipAddress || context?.ipAddress) {\n    const geoFactor = analyzeGeolocation(params.ipAddress || context?.ipAddress || \"\", params.billingCountry)\n    factors.push(geoFactor)\n    totalScore += geoFactor.score * geoFactor.weight\n    totalWeight += geoFactor.weight\n  }\n\n  // Calculate final score\n  const finalScore = Math.round(totalWeight > 0 ? totalScore / totalWeight : 0)\n\n  // Determine risk level\n  let level: RiskScore[\"level\"] = \"low\"\n  if (finalScore >= RISK_THRESHOLDS.critical) level = \"critical\"\n  else if (finalScore >= RISK_THRESHOLDS.high) level = \"high\"\n  else if (finalScore >= RISK_THRESHOLDS.medium) level = \"medium\"\n\n  // Determine recommendation\n  let recommendation: RiskScore[\"recommendation\"] = \"approve\"\n  if (level === \"critical\") recommendation = \"block\"\n  else if (level === \"high\") recommendation = \"review\"\n\n  const details = generateRiskSummary(factors, level, finalScore)\n\n  console.log(\"[Fraud] Risk analysis complete\", { \n    bookingId: params.bookingId, \n    score: finalScore, \n    level, \n    recommendation \n  })\n\n  return {\n    score: finalScore,\n    level,\n    factors,\n    recommendation,\n    details,\n  }\n}\n\n/**\n * Analyze email for suspicious patterns\n */\nfunction analyzeEmail(email: string): RiskFactor {\n  let score = 0\n  const issues: string[] = []\n\n  const domain = email.split(\"@\")[1]?.toLowerCase()\n\n  // Check disposable email\n  if (SUSPICIOUS_PATTERNS.disposableEmailDomains.includes(domain)) {\n    score += 60\n    issues.push(\"Disposable email domain\")\n  }\n\n  // Check for random-looking email\n  const localPart = email.split(\"@\")[0]\n  if (/^[a-z0-9]{10,}$/i.test(localPart) && !/[aeiou]{2,}/i.test(localPart)) {\n    score += 20\n    issues.push(\"Random-looking email address\")\n  }\n\n  // Check for numbers at end (often auto-generated)\n  if (/\\d{4,}@/.test(email)) {\n    score += 15\n    issues.push(\"Many numbers in email\")\n  }\n\n  return {\n    name: \"Email Analysis\",\n    nameHe: \"ניתוח אימייל\",\n    score: Math.min(score, 100),\n    weight: 0.2,\n    description: issues.length > 0 ? issues.join(\", \") : \"Email looks legitimate\",\n    descriptionHe: issues.length > 0 ? \"נמצאו סימנים חשודים באימייל\" : \"האימייל נראה תקין\",\n  }\n}\n\n/**\n * Check booking velocity (rate limiting)\n */\nasync function checkVelocity(email: string, amount: number): Promise<RiskFactor> {\n  const now = Date.now()\n  const hourAgo = now - 60 * 60 * 1000\n  \n  // Get or create velocity record\n  let record = velocityStore.get(email)\n  \n  if (!record || record.timestamp < hourAgo) {\n    record = { count: 0, total: 0, timestamp: now }\n  }\n  \n  // Update record\n  record.count++\n  record.total += amount\n  record.timestamp = now\n  velocityStore.set(email, record)\n\n  let score = 0\n  const issues: string[] = []\n\n  // Check bookings per hour\n  if (record.count > SUSPICIOUS_PATTERNS.velocityLimits.bookingsPerHour) {\n    score += 50\n    issues.push(`${record.count} bookings in last hour`)\n  }\n\n  // Check total value\n  if (record.total > SUSPICIOUS_PATTERNS.velocityLimits.totalValuePerDay) {\n    score += 40\n    issues.push(\"High total booking value\")\n  }\n\n  return {\n    name: \"Velocity Check\",\n    nameHe: \"בדיקת קצב הזמנות\",\n    score: Math.min(score, 100),\n    weight: 0.25,\n    description: issues.length > 0 ? issues.join(\", \") : \"Normal booking frequency\",\n    descriptionHe: issues.length > 0 ? \"קצב הזמנות חריג\" : \"קצב הזמנות תקין\",\n  }\n}\n\n/**\n * Analyze booking amount\n */\nfunction analyzeAmount(amount: number): RiskFactor {\n  let score = 0\n  const issues: string[] = []\n\n  // Very high amount\n  if (amount > 500000) { // $5,000+\n    score += 30\n    issues.push(\"Very high booking amount\")\n  } else if (amount > 200000) { // $2,000+\n    score += 15\n    issues.push(\"High booking amount\")\n  }\n\n  // Round number (often test transactions)\n  if (amount % 10000 === 0 && amount > 0) {\n    score += 10\n    issues.push(\"Suspiciously round amount\")\n  }\n\n  return {\n    name: \"Amount Analysis\",\n    nameHe: \"ניתוח סכום\",\n    score: Math.min(score, 100),\n    weight: 0.15,\n    description: issues.length > 0 ? issues.join(\", \") : \"Amount is reasonable\",\n    descriptionHe: issues.length > 0 ? \"סכום חריג\" : \"סכום סביר\",\n  }\n}\n\n/**\n * Check for name/email mismatch\n */\nfunction checkNameEmailMismatch(name: string, email: string): RiskFactor {\n  let score = 0\n  const issues: string[] = []\n\n  const nameParts = name.toLowerCase().split(/\\s+/)\n  const emailLocal = email.split(\"@\")[0].toLowerCase()\n\n  // Check if any part of name appears in email\n  const nameInEmail = nameParts.some(part => \n    part.length > 2 && emailLocal.includes(part)\n  )\n\n  if (!nameInEmail && nameParts[0]?.length > 3) {\n    score += 25\n    issues.push(\"Name doesn't match email\")\n  }\n\n  return {\n    name: \"Name/Email Match\",\n    nameHe: \"התאמת שם ואימייל\",\n    score: Math.min(score, 100),\n    weight: 0.1,\n    description: issues.length > 0 ? issues.join(\", \") : \"Name and email appear consistent\",\n    descriptionHe: issues.length > 0 ? \"חוסר התאמה בין שם ואימייל\" : \"השם והאימייל תואמים\",\n  }\n}\n\n/**\n * Analyze booking pattern\n */\nfunction analyzeBookingPattern(checkIn: string | Date, checkOut: string | Date): RiskFactor {\n  let score = 0\n  const issues: string[] = []\n\n  const checkInDate = new Date(checkIn)\n  const checkOutDate = new Date(checkOut)\n  const now = new Date()\n\n  // Same day booking for far future\n  const daysUntilCheckIn = Math.floor((checkInDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24))\n  \n  if (daysUntilCheckIn > 180) {\n    score += 20\n    issues.push(\"Booking very far in advance\")\n  }\n\n  // Very long stay\n  const nights = Math.floor((checkOutDate.getTime() - checkInDate.getTime()) / (1000 * 60 * 60 * 24))\n  if (nights > 30) {\n    score += 25\n    issues.push(`Very long stay (${nights} nights)`)\n  }\n\n  // Booking for past date (error or fraud attempt)\n  if (checkInDate < now) {\n    score += 50\n    issues.push(\"Check-in date is in the past\")\n  }\n\n  return {\n    name: \"Booking Pattern\",\n    nameHe: \"דפוס הזמנה\",\n    score: Math.min(score, 100),\n    weight: 0.15,\n    description: issues.length > 0 ? issues.join(\", \") : \"Normal booking pattern\",\n    descriptionHe: issues.length > 0 ? \"דפוס הזמנה חשוד\" : \"דפוס הזמנה תקין\",\n  }\n}\n\n/**\n * Analyze geolocation/IP\n */\nfunction analyzeGeolocation(ipAddress: string, billingCountry?: string): RiskFactor {\n  let score = 0\n  const issues: string[] = []\n\n  // Check for VPN/proxy indicators (simplified - would use IP intelligence API)\n  if (ipAddress.startsWith(\"10.\") || ipAddress.startsWith(\"192.168.\")) {\n    score += 10\n    issues.push(\"Private/local IP address\")\n  }\n\n  // In production, would check:\n  // - IP country vs billing country mismatch\n  // - Known VPN/proxy IPs\n  // - Data center IPs\n  // - High-risk countries\n\n  return {\n    name: \"Geolocation Check\",\n    nameHe: \"בדיקת מיקום\",\n    score: Math.min(score, 100),\n    weight: 0.15,\n    description: issues.length > 0 ? issues.join(\", \") : \"Location appears normal\",\n    descriptionHe: issues.length > 0 ? \"נמצאו בעיות מיקום\" : \"מיקום תקין\",\n  }\n}\n\n/**\n * Generate risk summary\n */\nfunction generateRiskSummary(factors: RiskFactor[], level: string, score: number): string {\n  const highRiskFactors = factors.filter(f => f.score > 30)\n  \n  if (highRiskFactors.length === 0) {\n    return `Low risk booking (score: ${score}). All checks passed.`\n  }\n  \n  const factorNames = highRiskFactors.map(f => f.name).join(\", \")\n  return `${level.charAt(0).toUpperCase() + level.slice(1)} risk (score: ${score}). Concerns: ${factorNames}`\n}\n\n/**\n * Flag suspicious activity for review\n */\nexport async function flagSuspiciousActivity(\n  params: {\n    type: SuspiciousActivity[\"type\"]\n    severity: SuspiciousActivity[\"severity\"]\n    description: string\n    bookingId?: string\n    customerId?: string\n    data?: Record<string, any>\n  },\n  context?: FraudContext\n): Promise<SuspiciousActivity> {\n  console.log(\"[Fraud] Flagging suspicious activity\", { type: params.type, severity: params.severity })\n\n  const activity: SuspiciousActivity = {\n    id: `fraud_${Date.now()}_${Math.random().toString(36).substring(2, 8)}`,\n    type: params.type,\n    severity: params.severity,\n    description: params.description,\n    bookingId: params.bookingId,\n    customerId: params.customerId,\n    data: params.data || {},\n    createdAt: new Date(),\n  }\n\n  // In production, would:\n  // 1. Store in Supabase\n  // 2. Send alert to fraud team\n  // 3. Potentially auto-block if severity is critical\n\n  console.log(\"[Fraud] Activity flagged\", { id: activity.id })\n\n  return activity\n}\n\n/**\n * Get risk score (simplified accessor)\n */\nexport async function getRiskScore(\n  params: { bookingId: string; customerEmail: string; amount: number },\n  context?: FraudContext\n): Promise<{ score: number; level: string; recommendation: string }> {\n  const result = await analyzeBookingRisk({\n    bookingId: params.bookingId,\n    customerEmail: params.customerEmail,\n    customerName: \"\",\n    amount: params.amount,\n    currency: \"USD\",\n    hotelId: \"\",\n    checkIn: new Date(),\n    checkOut: new Date(Date.now() + 24 * 60 * 60 * 1000),\n  }, context)\n\n  return {\n    score: result.score,\n    level: result.level,\n    recommendation: result.recommendation,\n  }\n}\n\n/**\n * Check if customer is blacklisted\n */\nexport async function checkBlacklist(\n  params: { email?: string; phone?: string; ipAddress?: string },\n  context?: FraudContext\n): Promise<{ blacklisted: boolean; reason?: string }> {\n  // In production, would check against:\n  // 1. Internal blacklist in Supabase\n  // 2. External fraud databases\n  // 3. Shared industry blacklists\n\n  console.log(\"[Fraud] Checking blacklist\", { email: params.email })\n\n  // Placeholder - always return not blacklisted\n  return { blacklisted: false }\n}\n\n/**\n * Run all fraud checks\n */\nexport async function runFraudChecks(\n  params: {\n    bookingId: string\n    customerEmail: string\n    customerName: string\n    amount: number\n    currency: string\n  },\n  context?: FraudContext\n): Promise<{\n  passed: boolean\n  riskScore: RiskScore\n  checks: FraudCheck[]\n}> {\n  const checks: FraudCheck[] = []\n\n  // Run risk analysis\n  const riskScore = await analyzeBookingRisk({\n    bookingId: params.bookingId,\n    customerEmail: params.customerEmail,\n    customerName: params.customerName,\n    amount: params.amount,\n    currency: params.currency,\n    hotelId: \"\",\n    checkIn: new Date(),\n    checkOut: new Date(Date.now() + 24 * 60 * 60 * 1000),\n  }, context)\n\n  // Add individual checks\n  for (const factor of riskScore.factors) {\n    checks.push({\n      checkType: factor.name,\n      passed: factor.score < 50,\n      details: factor.description,\n      score: factor.score,\n    })\n  }\n\n  // Check blacklist\n  const blacklistResult = await checkBlacklist({ email: params.customerEmail }, context)\n  checks.push({\n    checkType: \"Blacklist\",\n    passed: !blacklistResult.blacklisted,\n    details: blacklistResult.blacklisted ? blacklistResult.reason || \"Blacklisted\" : \"Not blacklisted\",\n    score: blacklistResult.blacklisted ? 100 : 0,\n  })\n\n  const passed = riskScore.recommendation !== \"block\"\n\n  return {\n    passed,\n    riskScore,\n    checks,\n  }\n}\n\n// Export handlers map for registry\nexport const fraudHandlers = {\n  analyzeBookingRisk,\n  flagSuspiciousActivity,\n  getRiskScore,\n  checkBlacklist,\n  runFraudChecks,\n}\n","/**\n * Reviews Handler\n * Collect, manage, and analyze guest reviews\n */\n\n// Types\nexport interface ReviewContext {\n  userId?: string\n  sessionId?: string\n  locale?: \"en\" | \"he\"\n}\n\nexport interface Review {\n  reviewId: string\n  bookingId: string\n  hotelId: string\n  hotelName: string\n  \n  // Reviewer\n  customerId: string\n  customerName: string\n  customerEmail: string\n  isVerified: boolean\n  \n  // Rating breakdown\n  overallRating: number // 1-5\n  ratings: {\n    cleanliness: number\n    location: number\n    service: number\n    value: number\n    amenities: number\n    comfort: number\n  }\n  \n  // Content\n  title: string\n  content: string\n  pros?: string\n  cons?: string\n  \n  // Trip info\n  tripType: \"business\" | \"leisure\" | \"family\" | \"couple\" | \"solo\" | \"group\"\n  stayDate: Date\n  roomType: string\n  \n  // Metadata\n  language: string\n  photos?: string[]\n  helpfulVotes: number\n  \n  // Management\n  status: \"pending\" | \"approved\" | \"rejected\" | \"flagged\"\n  response?: HotelResponse\n  createdAt: Date\n  updatedAt: Date\n}\n\nexport interface HotelResponse {\n  responseId: string\n  responderId: string\n  responderName: string\n  content: string\n  createdAt: Date\n}\n\nexport interface ReviewStats {\n  totalReviews: number\n  averageRating: number\n  ratingDistribution: { rating: number; count: number; percentage: number }[]\n  categoryAverages: {\n    cleanliness: number\n    location: number\n    service: number\n    value: number\n    amenities: number\n    comfort: number\n  }\n  recentTrend: \"improving\" | \"stable\" | \"declining\"\n  responseRate: number\n}\n\nexport interface ReviewRequest {\n  requestId: string\n  bookingId: string\n  hotelId: string\n  customerId: string\n  customerEmail: string\n  customerName: string\n  checkOutDate: Date\n  sentAt?: Date\n  reminderSentAt?: Date\n  completedAt?: Date\n  status: \"pending\" | \"sent\" | \"completed\" | \"expired\"\n}\n\n// In-memory stores\nconst reviews: Map<string, Review> = new Map()\nconst reviewRequests: Map<string, ReviewRequest> = new Map()\n\n// Demo reviews for testing\nconst DEMO_REVIEWS: Review[] = [\n  {\n    reviewId: \"demo_1\",\n    bookingId: \"booking_demo_1\",\n    hotelId: \"hotel_1\",\n    hotelName: \"Dizengoff Inn\",\n    customerId: \"cust_1\",\n    customerName: \"John D.\",\n    customerEmail: \"john@example.com\",\n    isVerified: true,\n    overallRating: 4.5,\n    ratings: { cleanliness: 5, location: 5, service: 4, value: 4, amenities: 4, comfort: 5 },\n    title: \"Great location, amazing staff!\",\n    content: \"Loved our stay at this hotel. The location is perfect for exploring Tel Aviv. Staff was incredibly helpful with restaurant recommendations.\",\n    pros: \"Location, friendly staff, clean rooms\",\n    cons: \"Breakfast could be better\",\n    tripType: \"couple\",\n    stayDate: new Date(\"2025-12-15\"),\n    roomType: \"Deluxe Room\",\n    language: \"en\",\n    helpfulVotes: 12,\n    status: \"approved\",\n    createdAt: new Date(\"2025-12-20\"),\n    updatedAt: new Date(\"2025-12-20\"),\n  },\n]\n\n// Initialize demo data\nDEMO_REVIEWS.forEach(r => reviews.set(r.reviewId, r))\n\n/**\n * Request review from guest after checkout\n */\nexport async function requestReview(\n  params: {\n    bookingId: string\n    hotelId: string\n    hotelName: string\n    customerId: string\n    customerEmail: string\n    customerName: string\n    checkOutDate: string | Date\n  },\n  context?: ReviewContext\n): Promise<{ requestId: string; scheduledFor: Date }> {\n  console.log(\"[Reviews] Requesting review\", { bookingId: params.bookingId })\n\n  const checkOut = new Date(params.checkOutDate)\n  \n  // Schedule review request for 24 hours after checkout\n  const scheduledFor = new Date(checkOut.getTime() + 24 * 60 * 60 * 1000)\n\n  const request: ReviewRequest = {\n    requestId: `req_${Date.now()}_${Math.random().toString(36).substring(2, 8)}`,\n    bookingId: params.bookingId,\n    hotelId: params.hotelId,\n    customerId: params.customerId,\n    customerEmail: params.customerEmail,\n    customerName: params.customerName,\n    checkOutDate: checkOut,\n    status: \"pending\",\n  }\n\n  reviewRequests.set(request.requestId, request)\n\n  console.log(\"[Reviews] Review request created\", { requestId: request.requestId })\n\n  return { requestId: request.requestId, scheduledFor }\n}\n\n/**\n * Submit a review\n */\nexport async function submitReview(\n  params: {\n    bookingId: string\n    hotelId: string\n    customerId: string\n    customerName: string\n    customerEmail: string\n    overallRating: number\n    ratings: Review[\"ratings\"]\n    title: string\n    content: string\n    pros?: string\n    cons?: string\n    tripType: Review[\"tripType\"]\n    roomType: string\n    photos?: string[]\n  },\n  context?: ReviewContext\n): Promise<{ reviewId: string; status: string }> {\n  console.log(\"[Reviews] Submitting review\", { bookingId: params.bookingId, rating: params.overallRating })\n\n  // Validate rating\n  if (params.overallRating < 1 || params.overallRating > 5) {\n    throw new Error(\"Rating must be between 1 and 5\")\n  }\n\n  // Check for existing review\n  const existing = Array.from(reviews.values()).find(r => r.bookingId === params.bookingId)\n  if (existing) {\n    throw new Error(\"A review already exists for this booking\")\n  }\n\n  const review: Review = {\n    reviewId: `review_${Date.now()}_${Math.random().toString(36).substring(2, 8)}`,\n    bookingId: params.bookingId,\n    hotelId: params.hotelId,\n    hotelName: \"\", // Would fetch from database\n    customerId: params.customerId,\n    customerName: params.customerName,\n    customerEmail: params.customerEmail,\n    isVerified: true, // Verified because it's linked to a booking\n    overallRating: params.overallRating,\n    ratings: params.ratings,\n    title: params.title,\n    content: params.content,\n    pros: params.pros,\n    cons: params.cons,\n    tripType: params.tripType,\n    stayDate: new Date(),\n    roomType: params.roomType,\n    language: context?.locale || \"en\",\n    photos: params.photos,\n    helpfulVotes: 0,\n    status: \"pending\", // Requires moderation\n    createdAt: new Date(),\n    updatedAt: new Date(),\n  }\n\n  reviews.set(review.reviewId, review)\n\n  // Update review request status\n  const request = Array.from(reviewRequests.values()).find(r => r.bookingId === params.bookingId)\n  if (request) {\n    request.status = \"completed\"\n    request.completedAt = new Date()\n    reviewRequests.set(request.requestId, request)\n  }\n\n  console.log(\"[Reviews] Review submitted\", { reviewId: review.reviewId })\n\n  return { reviewId: review.reviewId, status: review.status }\n}\n\n/**\n * Get reviews for a hotel\n */\nexport async function getHotelReviews(\n  params: {\n    hotelId: string\n    status?: Review[\"status\"]\n    minRating?: number\n    sortBy?: \"recent\" | \"rating\" | \"helpful\"\n    limit?: number\n    offset?: number\n  },\n  context?: ReviewContext\n): Promise<{ reviews: Review[]; total: number; stats: ReviewStats }> {\n  console.log(\"[Reviews] Getting hotel reviews\", { hotelId: params.hotelId })\n\n  let hotelReviews = Array.from(reviews.values()).filter(r => r.hotelId === params.hotelId)\n\n  // Filter by status\n  if (params.status) {\n    hotelReviews = hotelReviews.filter(r => r.status === params.status)\n  } else {\n    // Default to approved only\n    hotelReviews = hotelReviews.filter(r => r.status === \"approved\")\n  }\n\n  // Filter by rating\n  if (params.minRating) {\n    hotelReviews = hotelReviews.filter(r => r.overallRating >= params.minRating!)\n  }\n\n  // Sort\n  switch (params.sortBy) {\n    case \"rating\":\n      hotelReviews.sort((a, b) => b.overallRating - a.overallRating)\n      break\n    case \"helpful\":\n      hotelReviews.sort((a, b) => b.helpfulVotes - a.helpfulVotes)\n      break\n    case \"recent\":\n    default:\n      hotelReviews.sort((a, b) => b.createdAt.getTime() - a.createdAt.getTime())\n  }\n\n  const total = hotelReviews.length\n\n  // Pagination\n  if (params.offset) {\n    hotelReviews = hotelReviews.slice(params.offset)\n  }\n  if (params.limit) {\n    hotelReviews = hotelReviews.slice(0, params.limit)\n  }\n\n  // Calculate stats\n  const stats = calculateReviewStats(hotelReviews)\n\n  return { reviews: hotelReviews, total, stats }\n}\n\n/**\n * Calculate review statistics\n */\nfunction calculateReviewStats(reviewList: Review[]): ReviewStats {\n  if (reviewList.length === 0) {\n    return {\n      totalReviews: 0,\n      averageRating: 0,\n      ratingDistribution: [1, 2, 3, 4, 5].map(rating => ({ rating, count: 0, percentage: 0 })),\n      categoryAverages: { cleanliness: 0, location: 0, service: 0, value: 0, amenities: 0, comfort: 0 },\n      recentTrend: \"stable\",\n      responseRate: 0,\n    }\n  }\n\n  // Average rating\n  const averageRating = reviewList.reduce((sum, r) => sum + r.overallRating, 0) / reviewList.length\n\n  // Rating distribution\n  const distribution: Record<number, number> = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 }\n  reviewList.forEach(r => {\n    const rounded = Math.round(r.overallRating)\n    distribution[rounded]++\n  })\n  const ratingDistribution = [1, 2, 3, 4, 5].map(rating => ({\n    rating,\n    count: distribution[rating],\n    percentage: (distribution[rating] / reviewList.length) * 100,\n  }))\n\n  // Category averages\n  const categories = [\"cleanliness\", \"location\", \"service\", \"value\", \"amenities\", \"comfort\"] as const\n  const categoryAverages = {} as ReviewStats[\"categoryAverages\"]\n  categories.forEach(cat => {\n    categoryAverages[cat] = reviewList.reduce((sum, r) => sum + r.ratings[cat], 0) / reviewList.length\n  })\n\n  // Response rate\n  const withResponses = reviewList.filter(r => r.response).length\n  const responseRate = (withResponses / reviewList.length) * 100\n\n  // Trend (compare last 30 days vs previous 30 days)\n  const now = Date.now()\n  const thirtyDaysAgo = now - 30 * 24 * 60 * 60 * 1000\n  const sixtyDaysAgo = now - 60 * 24 * 60 * 60 * 1000\n\n  const recent = reviewList.filter(r => r.createdAt.getTime() > thirtyDaysAgo)\n  const previous = reviewList.filter(r => r.createdAt.getTime() > sixtyDaysAgo && r.createdAt.getTime() <= thirtyDaysAgo)\n\n  let recentTrend: ReviewStats[\"recentTrend\"] = \"stable\"\n  if (recent.length > 0 && previous.length > 0) {\n    const recentAvg = recent.reduce((sum, r) => sum + r.overallRating, 0) / recent.length\n    const previousAvg = previous.reduce((sum, r) => sum + r.overallRating, 0) / previous.length\n    if (recentAvg > previousAvg + 0.2) recentTrend = \"improving\"\n    else if (recentAvg < previousAvg - 0.2) recentTrend = \"declining\"\n  }\n\n  return {\n    totalReviews: reviewList.length,\n    averageRating: Math.round(averageRating * 10) / 10,\n    ratingDistribution,\n    categoryAverages,\n    recentTrend,\n    responseRate: Math.round(responseRate),\n  }\n}\n\n/**\n * Moderate a review\n */\nexport async function moderateReview(\n  params: {\n    reviewId: string\n    action: \"approve\" | \"reject\" | \"flag\"\n    reason?: string\n  },\n  context?: ReviewContext\n): Promise<{ success: boolean; status: Review[\"status\"] }> {\n  console.log(\"[Reviews] Moderating review\", { reviewId: params.reviewId, action: params.action })\n\n  const review = reviews.get(params.reviewId)\n  if (!review) {\n    throw new Error(\"Review not found\")\n  }\n\n  review.status = params.action === \"approve\" ? \"approved\" \n    : params.action === \"reject\" ? \"rejected\" \n    : \"flagged\"\n  review.updatedAt = new Date()\n\n  reviews.set(params.reviewId, review)\n\n  return { success: true, status: review.status }\n}\n\n/**\n * Respond to a review\n */\nexport async function respondToReview(\n  params: {\n    reviewId: string\n    responderId: string\n    responderName: string\n    content: string\n  },\n  context?: ReviewContext\n): Promise<{ success: boolean; responseId: string }> {\n  console.log(\"[Reviews] Responding to review\", { reviewId: params.reviewId })\n\n  const review = reviews.get(params.reviewId)\n  if (!review) {\n    throw new Error(\"Review not found\")\n  }\n\n  review.response = {\n    responseId: `resp_${Date.now()}_${Math.random().toString(36).substring(2, 8)}`,\n    responderId: params.responderId,\n    responderName: params.responderName,\n    content: params.content,\n    createdAt: new Date(),\n  }\n  review.updatedAt = new Date()\n\n  reviews.set(params.reviewId, review)\n\n  console.log(\"[Reviews] Response added\", { responseId: review.response.responseId })\n\n  return { success: true, responseId: review.response.responseId }\n}\n\n/**\n * Mark review as helpful\n */\nexport async function markReviewHelpful(\n  params: { reviewId: string; userId: string },\n  context?: ReviewContext\n): Promise<{ helpfulVotes: number }> {\n  const review = reviews.get(params.reviewId)\n  if (!review) {\n    throw new Error(\"Review not found\")\n  }\n\n  review.helpfulVotes++\n  reviews.set(params.reviewId, review)\n\n  return { helpfulVotes: review.helpfulVotes }\n}\n\n/**\n * Generate review summary using AI\n */\nexport async function generateReviewSummary(\n  params: { hotelId: string },\n  context?: ReviewContext\n): Promise<{\n  summary: string\n  summaryHe: string\n  highlights: string[]\n  concerns: string[]\n}> {\n  console.log(\"[Reviews] Generating review summary\", { hotelId: params.hotelId })\n\n  const hotelReviews = Array.from(reviews.values())\n    .filter(r => r.hotelId === params.hotelId && r.status === \"approved\")\n\n  if (hotelReviews.length === 0) {\n    return {\n      summary: \"No reviews yet.\",\n      summaryHe: \"אין עדיין ביקורות.\",\n      highlights: [],\n      concerns: [],\n    }\n  }\n\n  // Extract common themes (simplified - would use AI in production)\n  const allPros = hotelReviews.map(r => r.pros).filter(Boolean).join(\" \")\n  const allCons = hotelReviews.map(r => r.cons).filter(Boolean).join(\" \")\n\n  const highlights: string[] = []\n  const concerns: string[] = []\n\n  if (allPros.toLowerCase().includes(\"location\")) highlights.push(\"Great location\")\n  if (allPros.toLowerCase().includes(\"staff\") || allPros.toLowerCase().includes(\"service\")) highlights.push(\"Excellent service\")\n  if (allPros.toLowerCase().includes(\"clean\")) highlights.push(\"Very clean\")\n\n  if (allCons.toLowerCase().includes(\"breakfast\")) concerns.push(\"Breakfast could be improved\")\n  if (allCons.toLowerCase().includes(\"noise\") || allCons.toLowerCase().includes(\"noisy\")) concerns.push(\"Some noise issues reported\")\n\n  const avgRating = hotelReviews.reduce((sum, r) => sum + r.overallRating, 0) / hotelReviews.length\n\n  return {\n    summary: `Based on ${hotelReviews.length} reviews, this hotel has an average rating of ${avgRating.toFixed(1)}. Guests frequently praise ${highlights.join(\", \") || \"the overall experience\"}.`,\n    summaryHe: `על בסיס ${hotelReviews.length} ביקורות, למלון דירוג ממוצע של ${avgRating.toFixed(1)}. אורחים משבחים לעיתים קרובות את ${highlights.join(\", \") || \"החוויה הכללית\"}.`,\n    highlights,\n    concerns,\n  }\n}\n\n/**\n * Send review request emails (batch job)\n */\nexport async function sendReviewRequests(\n  params: { dryRun?: boolean },\n  context?: ReviewContext\n): Promise<{ sent: number; errors: string[] }> {\n  console.log(\"[Reviews] Sending review requests\", { dryRun: params.dryRun })\n\n  const now = Date.now()\n  const pendingRequests = Array.from(reviewRequests.values()).filter(r => {\n    if (r.status !== \"pending\") return false\n    // Check if 24 hours after checkout\n    const sendTime = r.checkOutDate.getTime() + 24 * 60 * 60 * 1000\n    return now >= sendTime\n  })\n\n  let sent = 0\n  const errors: string[] = []\n\n  for (const request of pendingRequests) {\n    if (!params.dryRun) {\n      // In production, would send email\n      request.status = \"sent\"\n      request.sentAt = new Date()\n      reviewRequests.set(request.requestId, request)\n    }\n    sent++\n  }\n\n  console.log(\"[Reviews] Review requests sent\", { sent })\n\n  return { sent, errors }\n}\n\n// Export handlers map for registry\nexport const reviewHandlers = {\n  requestReview,\n  submitReview,\n  getHotelReviews,\n  moderateReview,\n  respondToReview,\n  markReviewHelpful,\n  generateReviewSummary,\n  sendReviewRequests,\n}\n","/**\n * Demand Forecasting Handler\n * AI-powered demand prediction, pricing recommendations, and capacity planning\n */\n\n// Types\nexport interface ForecastContext {\n  userId?: string\n  sessionId?: string\n  locale?: \"en\" | \"he\"\n}\n\nexport interface ForecastResult {\n  success: boolean\n  data?: any\n  message?: string\n  error?: string\n}\n\ninterface ForecastDataPoint {\n  date: string\n  predictedDemand: number\n  confidence: number\n  factors: string[]\n  recommendedPrice: number\n  expectedOccupancy: number\n}\n\ninterface SeasonalPattern {\n  period: string\n  demandMultiplier: number\n  description: string\n}\n\ninterface Event {\n  name: string\n  date: string\n  type: \"holiday\" | \"conference\" | \"festival\" | \"sport\" | \"other\"\n  impactLevel: \"high\" | \"medium\" | \"low\"\n  demandIncrease: number\n}\n\n// Demand Forecasting Handler\nexport const demandForecastingHandler = {\n  skillId: \"demand-forecasting\",\n  \n  async execute(\n    tool: string,\n    params: Record<string, unknown>,\n    context: ForecastContext\n  ): Promise<ForecastResult> {\n    switch (tool) {\n      case \"get_demand_forecast\":\n        return getDemandForecast(params, context)\n      case \"get_pricing_recommendations\":\n        return getPricingRecommendations(params, context)\n      case \"analyze_seasonality\":\n        return analyzeSeasonality(params, context)\n      case \"detect_demand_anomalies\":\n        return detectDemandAnomalies(params, context)\n      default:\n        return {\n          success: false,\n          error: `Unknown tool: ${tool}`,\n        }\n    }\n  },\n}\n\n// Get Demand Forecast\nasync function getDemandForecast(\n  params: Record<string, unknown>,\n  context: ForecastContext\n): Promise<ForecastResult> {\n  const hotelId = params.hotelId as string\n  const startDate = params.startDate as string || new Date().toISOString().split(\"T\")[0]\n  const days = (params.days as number) || 30\n  const roomType = params.roomType as string\n\n  try {\n    const forecast: ForecastDataPoint[] = []\n    const start = new Date(startDate)\n    \n    for (let i = 0; i < days; i++) {\n      const date = new Date(start)\n      date.setDate(date.getDate() + i)\n      \n      const dayOfWeek = date.getDay()\n      const month = date.getMonth()\n      const isWeekend = dayOfWeek === 5 || dayOfWeek === 6 // Friday/Saturday in Israel\n      const isHoliday = checkHoliday(date)\n      \n      // Calculate demand factors\n      const factors: string[] = []\n      let baseDemand = 65 // Base occupancy %\n      \n      // Weekend factor\n      if (isWeekend) {\n        baseDemand += 15\n        factors.push(\"weekend\")\n      }\n      \n      // Seasonal factor\n      const seasonalMultiplier = getSeasonalMultiplier(month)\n      baseDemand *= seasonalMultiplier\n      if (seasonalMultiplier > 1.1) factors.push(\"high_season\")\n      if (seasonalMultiplier < 0.9) factors.push(\"low_season\")\n      \n      // Holiday factor\n      if (isHoliday) {\n        baseDemand *= 1.3\n        factors.push(\"holiday\")\n      }\n      \n      // Event factor\n      const event = checkEvents(date)\n      if (event) {\n        baseDemand *= (1 + event.demandIncrease / 100)\n        factors.push(`event:${event.name}`)\n      }\n      \n      // Add some variance\n      const variance = (Math.random() - 0.5) * 10\n      const predictedDemand = Math.min(100, Math.max(20, baseDemand + variance))\n      \n      // Calculate confidence based on how far in the future\n      const daysAhead = i\n      const confidence = Math.max(0.5, 0.95 - (daysAhead * 0.015))\n      \n      // Calculate recommended price based on demand\n      const basePrice = 180 // Base room price\n      const demandPriceMultiplier = 0.5 + (predictedDemand / 100)\n      const recommendedPrice = Math.round(basePrice * demandPriceMultiplier)\n      \n      forecast.push({\n        date: date.toISOString().split(\"T\")[0],\n        predictedDemand: Math.round(predictedDemand),\n        confidence: Math.round(confidence * 100) / 100,\n        factors,\n        recommendedPrice,\n        expectedOccupancy: Math.round(predictedDemand),\n      })\n    }\n    \n    // Calculate summary statistics\n    const avgDemand = forecast.reduce((sum, f) => sum + f.predictedDemand, 0) / forecast.length\n    const peakDays = forecast.filter(f => f.predictedDemand > 80)\n    const lowDays = forecast.filter(f => f.predictedDemand < 50)\n    \n    return {\n      success: true,\n      data: {\n        hotelId: hotelId || \"default\",\n        roomType: roomType || \"all\",\n        forecastPeriod: {\n          start: startDate,\n          end: forecast[forecast.length - 1].date,\n          days,\n        },\n        forecast,\n        summary: {\n          averageDemand: Math.round(avgDemand),\n          peakDays: peakDays.length,\n          lowDays: lowDays.length,\n          peakDates: peakDays.slice(0, 5).map(f => f.date),\n          lowDates: lowDays.slice(0, 5).map(f => f.date),\n          averageRecommendedPrice: Math.round(forecast.reduce((sum, f) => sum + f.recommendedPrice, 0) / forecast.length),\n        },\n        alerts: [\n          ...peakDays.length > 7 ? [{\n            type: \"high_demand\",\n            message: `${peakDays.length} days with high demand (>80%) in forecast period`,\n            recommendation: \"Consider increasing prices or staff\",\n          }] : [],\n          ...lowDays.length > 7 ? [{\n            type: \"low_demand\",\n            message: `${lowDays.length} days with low demand (<50%) in forecast period`,\n            recommendation: \"Consider promotions or discounts\",\n          }] : [],\n        ],\n      },\n      message: `Demand forecast generated for ${days} days. Average expected occupancy: ${Math.round(avgDemand)}%`,\n    }\n  } catch (error) {\n    return {\n      success: false,\n      error: `Failed to generate demand forecast: ${error}`,\n    }\n  }\n}\n\n// Get Pricing Recommendations\nasync function getPricingRecommendations(\n  params: Record<string, unknown>,\n  context: ForecastContext\n): Promise<ForecastResult> {\n  const hotelId = params.hotelId as string\n  const date = params.date as string || new Date().toISOString().split(\"T\")[0]\n  const roomTypes = (params.roomTypes as string[]) || [\"standard\", \"deluxe\", \"suite\", \"family\"]\n  const competitorPrices = params.competitorPrices as Record<string, number>\n\n  try {\n    const targetDate = new Date(date)\n    const dayOfWeek = targetDate.getDay()\n    const month = targetDate.getMonth()\n    const isWeekend = dayOfWeek === 5 || dayOfWeek === 6\n    const isHoliday = checkHoliday(targetDate)\n    const event = checkEvents(targetDate)\n    \n    // Base prices per room type\n    const basePrices: Record<string, number> = {\n      standard: 150,\n      deluxe: 220,\n      suite: 380,\n      family: 280,\n    }\n    \n    // Calculate demand factor\n    let demandFactor = 1.0\n    if (isWeekend) demandFactor *= 1.15\n    if (isHoliday) demandFactor *= 1.3\n    if (event) demandFactor *= (1 + event.demandIncrease / 100)\n    demandFactor *= getSeasonalMultiplier(month)\n    \n    // Generate recommendations\n    const recommendations = roomTypes.map(roomType => {\n      const basePrice = basePrices[roomType] || 180\n      const optimalPrice = Math.round(basePrice * demandFactor)\n      const minPrice = Math.round(basePrice * 0.8)\n      const maxPrice = Math.round(basePrice * 1.5 * demandFactor)\n      \n      const competitorPrice = competitorPrices?.[roomType]\n      const pricePosition = competitorPrice \n        ? optimalPrice < competitorPrice ? \"below_market\" : optimalPrice > competitorPrice ? \"above_market\" : \"at_market\"\n        : \"unknown\"\n      \n      return {\n        roomType,\n        currentBasePrice: basePrice,\n        recommendedPrice: optimalPrice,\n        priceRange: { min: minPrice, max: maxPrice },\n        demandFactor: Math.round(demandFactor * 100) / 100,\n        competitorPrice: competitorPrice || null,\n        pricePosition,\n        reasoning: generatePricingReasoning(roomType, demandFactor, isWeekend, isHoliday, event),\n        potentialRevenue: {\n          atMinPrice: Math.round(minPrice * 0.95), // High occupancy at low price\n          atOptimalPrice: Math.round(optimalPrice * 0.75), // Good balance\n          atMaxPrice: Math.round(maxPrice * 0.50), // Lower occupancy at high price\n        },\n      }\n    })\n    \n    return {\n      success: true,\n      data: {\n        date,\n        hotelId: hotelId || \"default\",\n        factors: {\n          isWeekend,\n          isHoliday,\n          event: event?.name || null,\n          seasonalMultiplier: getSeasonalMultiplier(month),\n          overallDemandFactor: demandFactor,\n        },\n        recommendations,\n        strategy: demandFactor > 1.2 \n          ? \"aggressive\" \n          : demandFactor < 0.9 \n            ? \"promotional\"\n            : \"balanced\",\n        insights: [\n          demandFactor > 1.2 \n            ? \"High demand expected - maximize revenue with premium pricing\"\n            : demandFactor < 0.9\n              ? \"Low demand expected - consider promotions to boost occupancy\"\n              : \"Normal demand - maintain competitive pricing\",\n          isWeekend ? \"Weekend premium applies\" : \"Weekday rates recommended\",\n          event ? `Event \"${event.name}\" increases demand by ${event.demandIncrease}%` : null,\n        ].filter(Boolean),\n      },\n      message: `Pricing recommendations for ${date}: Strategy \"${demandFactor > 1.2 ? \"aggressive\" : demandFactor < 0.9 ? \"promotional\" : \"balanced\"}\" with demand factor ${demandFactor.toFixed(2)}`,\n    }\n  } catch (error) {\n    return {\n      success: false,\n      error: `Failed to generate pricing recommendations: ${error}`,\n    }\n  }\n}\n\n// Analyze Seasonality\nasync function analyzeSeasonality(\n  params: Record<string, unknown>,\n  context: ForecastContext\n): Promise<ForecastResult> {\n  const hotelId = params.hotelId as string\n  const year = (params.year as number) || new Date().getFullYear()\n\n  try {\n    const monthlyPatterns: SeasonalPattern[] = [\n      { period: \"January\", demandMultiplier: 0.75, description: \"Low season - post-holiday slump\" },\n      { period: \"February\", demandMultiplier: 0.80, description: \"Low season - winter\" },\n      { period: \"March\", demandMultiplier: 0.95, description: \"Spring begins - Purim/Passover prep\" },\n      { period: \"April\", demandMultiplier: 1.25, description: \"High season - Passover holidays\" },\n      { period: \"May\", demandMultiplier: 1.10, description: \"Pleasant weather - Independence Day\" },\n      { period: \"June\", demandMultiplier: 1.15, description: \"Early summer - school holidays begin\" },\n      { period: \"July\", demandMultiplier: 1.35, description: \"Peak season - summer vacation\" },\n      { period: \"August\", demandMultiplier: 1.40, description: \"Peak season - summer vacation\" },\n      { period: \"September\", demandMultiplier: 1.30, description: \"High holidays - Rosh Hashana/Yom Kippur\" },\n      { period: \"October\", demandMultiplier: 1.20, description: \"Sukkot holidays - pleasant weather\" },\n      { period: \"November\", demandMultiplier: 0.85, description: \"Shoulder season - fall\" },\n      { period: \"December\", demandMultiplier: 0.90, description: \"Hanukkah - moderate demand\" },\n    ]\n    \n    const weeklyPatterns = [\n      { day: \"Sunday\", demandMultiplier: 0.70, description: \"Week start - business travel begins\" },\n      { day: \"Monday\", demandMultiplier: 0.75, description: \"Business travel\" },\n      { day: \"Tuesday\", demandMultiplier: 0.80, description: \"Business travel\" },\n      { day: \"Wednesday\", demandMultiplier: 0.85, description: \"Mid-week peak\" },\n      { day: \"Thursday\", demandMultiplier: 0.95, description: \"Pre-weekend arrivals\" },\n      { day: \"Friday\", demandMultiplier: 1.30, description: \"Weekend - Shabbat\" },\n      { day: \"Saturday\", demandMultiplier: 1.35, description: \"Weekend peak - Shabbat\" },\n    ]\n    \n    // Calculate annual statistics\n    const avgMultiplier = monthlyPatterns.reduce((sum, p) => sum + p.demandMultiplier, 0) / 12\n    const peakMonths = monthlyPatterns.filter(p => p.demandMultiplier > 1.2).map(p => p.period)\n    const lowMonths = monthlyPatterns.filter(p => p.demandMultiplier < 0.85).map(p => p.period)\n    \n    // Upcoming events for the year\n    const upcomingEvents: Event[] = [\n      { name: \"Purim\", date: `${year}-03-14`, type: \"holiday\", impactLevel: \"medium\", demandIncrease: 20 },\n      { name: \"Passover\", date: `${year}-04-13`, type: \"holiday\", impactLevel: \"high\", demandIncrease: 40 },\n      { name: \"Independence Day\", date: `${year}-05-14`, type: \"holiday\", impactLevel: \"high\", demandIncrease: 35 },\n      { name: \"Shavuot\", date: `${year}-06-02`, type: \"holiday\", impactLevel: \"medium\", demandIncrease: 25 },\n      { name: \"Rosh Hashana\", date: `${year}-09-16`, type: \"holiday\", impactLevel: \"high\", demandIncrease: 45 },\n      { name: \"Yom Kippur\", date: `${year}-09-25`, type: \"holiday\", impactLevel: \"medium\", demandIncrease: 15 },\n      { name: \"Sukkot\", date: `${year}-09-30`, type: \"holiday\", impactLevel: \"high\", demandIncrease: 40 },\n      { name: \"Hanukkah\", date: `${year}-12-26`, type: \"holiday\", impactLevel: \"medium\", demandIncrease: 20 },\n      { name: \"Tel Aviv Marathon\", date: `${year}-02-28`, type: \"sport\", impactLevel: \"medium\", demandIncrease: 25 },\n      { name: \"DLD Conference\", date: `${year}-09-04`, type: \"conference\", impactLevel: \"high\", demandIncrease: 30 },\n    ]\n    \n    return {\n      success: true,\n      data: {\n        year,\n        hotelId: hotelId || \"default\",\n        monthlyPatterns,\n        weeklyPatterns,\n        statistics: {\n          averageMultiplier: Math.round(avgMultiplier * 100) / 100,\n          peakMonths,\n          lowMonths,\n          peakDays: [\"Friday\", \"Saturday\"],\n          lowDays: [\"Sunday\", \"Monday\"],\n          seasonalVariation: Math.round((Math.max(...monthlyPatterns.map(p => p.demandMultiplier)) - \n                                         Math.min(...monthlyPatterns.map(p => p.demandMultiplier))) * 100) + \"%\",\n        },\n        upcomingEvents: upcomingEvents.filter(e => new Date(e.date) > new Date()),\n        recommendations: [\n          `Peak season (${peakMonths.join(\", \")}): Maximize rates, minimum 3-night stays`,\n          `Low season (${lowMonths.join(\", \")}): Run promotions, partner with tour operators`,\n          \"Friday/Saturday: Premium weekend packages\",\n          \"Sunday-Thursday: Business traveler rates, corporate deals\",\n        ],\n      },\n      message: `Seasonality analysis for ${year}: Peak months are ${peakMonths.join(\", \")}, low months are ${lowMonths.join(\", \")}`,\n    }\n  } catch (error) {\n    return {\n      success: false,\n      error: `Failed to analyze seasonality: ${error}`,\n    }\n  }\n}\n\n// Detect Demand Anomalies\nasync function detectDemandAnomalies(\n  params: Record<string, unknown>,\n  context: ForecastContext\n): Promise<ForecastResult> {\n  const hotelId = params.hotelId as string\n  const period = (params.period as string) || \"month\"\n  const threshold = (params.threshold as number) || 20 // % deviation from expected\n\n  try {\n    // Generate historical data with some anomalies\n    const anomalies: Array<{\n      date: string\n      actualDemand: number\n      expectedDemand: number\n      deviation: number\n      type: \"surge\" | \"drop\"\n      possibleCauses: string[]\n      recommendation: string\n    }> = [\n      {\n        date: \"2026-01-10\",\n        actualDemand: 92,\n        expectedDemand: 65,\n        deviation: 41.5,\n        type: \"surge\",\n        possibleCauses: [\"Unplanned event\", \"Competitor outage\", \"Viral social media\"],\n        recommendation: \"Investigate cause for future planning; consider dynamic pricing\",\n      },\n      {\n        date: \"2026-01-15\",\n        actualDemand: 35,\n        expectedDemand: 60,\n        deviation: -41.7,\n        type: \"drop\",\n        possibleCauses: [\"Bad weather\", \"Negative review impact\", \"Local emergency\"],\n        recommendation: \"Review recent feedback; check for external factors\",\n      },\n      {\n        date: \"2026-01-22\",\n        actualDemand: 88,\n        expectedDemand: 70,\n        deviation: 25.7,\n        type: \"surge\",\n        possibleCauses: [\"Local conference\", \"Sports event nearby\"],\n        recommendation: \"Add to event calendar for next year\",\n      },\n    ]\n    \n    // Pattern analysis\n    const patterns = {\n      frequentSurges: {\n        count: 8,\n        commonDays: [\"Friday\", \"Saturday\"],\n        commonMonths: [\"July\", \"August\", \"September\"],\n      },\n      frequentDrops: {\n        count: 5,\n        commonDays: [\"Sunday\", \"Monday\"],\n        commonMonths: [\"January\", \"February\"],\n      },\n    }\n    \n    return {\n      success: true,\n      data: {\n        hotelId: hotelId || \"default\",\n        period,\n        threshold: threshold + \"%\",\n        anomaliesDetected: anomalies.length,\n        anomalies,\n        patterns,\n        summary: {\n          totalAnomalies: anomalies.length,\n          surges: anomalies.filter(a => a.type === \"surge\").length,\n          drops: anomalies.filter(a => a.type === \"drop\").length,\n          averageDeviation: Math.round(anomalies.reduce((sum, a) => sum + Math.abs(a.deviation), 0) / anomalies.length) + \"%\",\n        },\n        alerts: anomalies.filter(a => Math.abs(a.deviation) > 30).map(a => ({\n          severity: \"high\",\n          date: a.date,\n          message: `${a.type === \"surge\" ? \"Unexpected surge\" : \"Unexpected drop\"}: ${a.deviation.toFixed(1)}% deviation`,\n        })),\n        recommendations: [\n          anomalies.some(a => a.type === \"surge\") \n            ? \"Monitor for recurring surge patterns - opportunity for dynamic pricing\"\n            : null,\n          anomalies.some(a => a.type === \"drop\")\n            ? \"Investigate drop causes - may indicate operational or marketing issues\"\n            : null,\n          \"Set up automated alerts for deviations > 25%\",\n          \"Review anomaly causes quarterly for forecasting improvement\",\n        ].filter(Boolean),\n      },\n      message: `Detected ${anomalies.length} demand anomalies in ${period}: ${anomalies.filter(a => a.type === \"surge\").length} surges, ${anomalies.filter(a => a.type === \"drop\").length} drops`,\n    }\n  } catch (error) {\n    return {\n      success: false,\n      error: `Failed to detect demand anomalies: ${error}`,\n    }\n  }\n}\n\n// Helper Functions\nfunction getSeasonalMultiplier(month: number): number {\n  const multipliers = [0.75, 0.80, 0.95, 1.25, 1.10, 1.15, 1.35, 1.40, 1.30, 1.20, 0.85, 0.90]\n  return multipliers[month]\n}\n\nfunction checkHoliday(date: Date): boolean {\n  // Simplified holiday check (in production, use a proper calendar API)\n  const holidays = [\n    \"2026-03-14\", // Purim\n    \"2026-04-13\", \"2026-04-14\", \"2026-04-19\", \"2026-04-20\", // Passover\n    \"2026-05-14\", // Independence Day\n    \"2026-06-02\", // Shavuot\n    \"2026-09-16\", \"2026-09-17\", // Rosh Hashana\n    \"2026-09-25\", // Yom Kippur\n    \"2026-09-30\", \"2026-10-01\", \"2026-10-07\", // Sukkot\n  ]\n  return holidays.includes(date.toISOString().split(\"T\")[0])\n}\n\nfunction checkEvents(date: Date): Event | null {\n  const events: Event[] = [\n    { name: \"DLD Tel Aviv\", date: \"2026-09-04\", type: \"conference\", impactLevel: \"high\", demandIncrease: 30 },\n    { name: \"Tel Aviv Marathon\", date: \"2026-02-28\", type: \"sport\", impactLevel: \"medium\", demandIncrease: 25 },\n    { name: \"Pride Parade\", date: \"2026-06-12\", type: \"festival\", impactLevel: \"high\", demandIncrease: 40 },\n  ]\n  \n  const dateStr = date.toISOString().split(\"T\")[0]\n  return events.find(e => {\n    const eventDate = new Date(e.date)\n    const daysBefore = 2\n    const daysAfter = 1\n    const rangeStart = new Date(eventDate)\n    rangeStart.setDate(rangeStart.getDate() - daysBefore)\n    const rangeEnd = new Date(eventDate)\n    rangeEnd.setDate(rangeEnd.getDate() + daysAfter)\n    return date >= rangeStart && date <= rangeEnd\n  }) || null\n}\n\nfunction generatePricingReasoning(\n  roomType: string,\n  demandFactor: number,\n  isWeekend: boolean,\n  isHoliday: boolean,\n  event: Event | null\n): string[] {\n  const reasons: string[] = []\n  \n  if (demandFactor > 1.2) {\n    reasons.push(\"High demand conditions justify premium pricing\")\n  } else if (demandFactor < 0.9) {\n    reasons.push(\"Low demand suggests competitive pricing needed\")\n  }\n  \n  if (isWeekend) {\n    reasons.push(\"Weekend premium applies (+15%)\")\n  }\n  \n  if (isHoliday) {\n    reasons.push(\"Holiday period increases willingness to pay (+30%)\")\n  }\n  \n  if (event) {\n    reasons.push(`${event.name} event drives additional demand (+${event.demandIncrease}%)`)\n  }\n  \n  if (roomType === \"suite\") {\n    reasons.push(\"Premium room type commands higher rates\")\n  }\n  \n  return reasons\n}\n\nexport default demandForecastingHandler\n","/**\n * Invoice Handler\n * Generate and send booking invoices/receipts\n */\n\n// Types\nexport interface InvoiceContext {\n  userId?: string\n  sessionId?: string\n  locale?: \"en\" | \"he\"\n}\n\nexport interface InvoiceData {\n  invoiceNumber: string\n  bookingId: string\n  date: Date\n  dueDate?: Date\n  \n  // Seller info\n  seller: {\n    name: string\n    address: string\n    email: string\n    phone: string\n    vatNumber?: string\n  }\n  \n  // Customer info\n  customer: {\n    name: string\n    email: string\n    phone?: string\n    address?: string\n  }\n  \n  // Booking details\n  booking: {\n    hotelName: string\n    roomType: string\n    checkIn: Date\n    checkOut: Date\n    nights: number\n    guests: number\n    confirmationNumber: string\n  }\n  \n  // Line items\n  items: InvoiceItem[]\n  \n  // Totals\n  subtotal: number\n  tax: number\n  taxRate: number\n  discount?: number\n  discountCode?: string\n  total: number\n  currency: string\n  \n  // Payment info\n  paymentMethod?: string\n  paymentStatus: \"pending\" | \"paid\" | \"refunded\" | \"partial\"\n  paidAmount?: number\n  paidAt?: Date\n  \n  // Notes\n  notes?: string\n  termsAndConditions?: string\n}\n\nexport interface InvoiceItem {\n  description: string\n  descriptionHe?: string\n  quantity: number\n  unitPrice: number\n  total: number\n}\n\nexport interface GeneratedInvoice {\n  invoiceNumber: string\n  html: string\n  pdfUrl?: string\n  createdAt: Date\n}\n\n/**\n * Generate invoice number\n */\nfunction generateInvoiceNumber(bookingId: string): string {\n  const date = new Date()\n  const year = date.getFullYear()\n  const month = String(date.getMonth() + 1).padStart(2, \"0\")\n  const random = Math.random().toString(36).substring(2, 6).toUpperCase()\n  return `INV-${year}${month}-${random}`\n}\n\n/**\n * Calculate nights between dates\n */\nfunction calculateNights(checkIn: Date, checkOut: Date): number {\n  const diffTime = checkOut.getTime() - checkIn.getTime()\n  return Math.ceil(diffTime / (1000 * 60 * 60 * 24))\n}\n\n/**\n * Format currency\n */\nfunction formatCurrency(amount: number, currency: string): string {\n  const formatter = new Intl.NumberFormat(\"en-US\", {\n    style: \"currency\",\n    currency: currency.toUpperCase(),\n  })\n  return formatter.format(amount / 100) // Convert from cents\n}\n\n/**\n * Format date\n */\nfunction formatDate(date: Date, locale: \"en\" | \"he\" = \"en\"): string {\n  return new Intl.DateTimeFormat(locale === \"he\" ? \"he-IL\" : \"en-US\", {\n    year: \"numeric\",\n    month: \"long\",\n    day: \"numeric\",\n  }).format(date)\n}\n\n/**\n * Generate invoice HTML\n */\nexport async function generateInvoice(\n  params: {\n    bookingId: string\n    hotelName: string\n    roomType: string\n    checkIn: string | Date\n    checkOut: string | Date\n    totalPrice: number\n    currency: string\n    customerName: string\n    customerEmail: string\n    customerPhone?: string\n    confirmationNumber: string\n    guests: number\n    taxRate?: number\n    discount?: number\n    discountCode?: string\n    paymentStatus?: \"pending\" | \"paid\" | \"refunded\" | \"partial\"\n    notes?: string\n  },\n  context?: InvoiceContext\n): Promise<GeneratedInvoice> {\n  console.log(\"[Invoice] Generating invoice\", { bookingId: params.bookingId })\n\n  const locale = context?.locale || \"en\"\n  const checkIn = new Date(params.checkIn)\n  const checkOut = new Date(params.checkOut)\n  const nights = calculateNights(checkIn, checkOut)\n  \n  const invoiceNumber = generateInvoiceNumber(params.bookingId)\n  const taxRate = params.taxRate || 17 // Default 17% VAT in Israel\n  const subtotal = params.totalPrice\n  const tax = Math.round(subtotal * taxRate / 100)\n  const discount = params.discount || 0\n  const total = subtotal + tax - discount\n\n  const invoiceData: InvoiceData = {\n    invoiceNumber,\n    bookingId: params.bookingId,\n    date: new Date(),\n    seller: {\n      name: \"Booking Engine Ltd\",\n      address: \"123 Tech Street, Tel Aviv, Israel\",\n      email: \"billing@bookingengine.com\",\n      phone: \"+972-3-1234567\",\n      vatNumber: \"IL-123456789\",\n    },\n    customer: {\n      name: params.customerName,\n      email: params.customerEmail,\n      phone: params.customerPhone,\n    },\n    booking: {\n      hotelName: params.hotelName,\n      roomType: params.roomType,\n      checkIn,\n      checkOut,\n      nights,\n      guests: params.guests,\n      confirmationNumber: params.confirmationNumber,\n    },\n    items: [\n      {\n        description: `${params.hotelName} - ${params.roomType}`,\n        descriptionHe: `${params.hotelName} - ${params.roomType}`,\n        quantity: nights,\n        unitPrice: Math.round(subtotal / nights),\n        total: subtotal,\n      },\n    ],\n    subtotal,\n    tax,\n    taxRate,\n    discount,\n    discountCode: params.discountCode,\n    total,\n    currency: params.currency,\n    paymentStatus: params.paymentStatus || \"pending\",\n    notes: params.notes,\n  }\n\n  // Generate HTML\n  const html = generateInvoiceHTML(invoiceData, locale)\n\n  console.log(\"[Invoice] Invoice generated\", { invoiceNumber })\n\n  return {\n    invoiceNumber,\n    html,\n    createdAt: new Date(),\n  }\n}\n\n/**\n * Generate HTML invoice template\n */\nfunction generateInvoiceHTML(data: InvoiceData, locale: \"en\" | \"he\"): string {\n  const isHebrew = locale === \"he\"\n  const dir = isHebrew ? \"rtl\" : \"ltr\"\n  \n  const labels = isHebrew ? {\n    invoice: \"חשבונית\",\n    invoiceNumber: \"מספר חשבונית\",\n    date: \"תאריך\",\n    from: \"מאת\",\n    to: \"אל\",\n    bookingDetails: \"פרטי הזמנה\",\n    hotel: \"מלון\",\n    roomType: \"סוג חדר\",\n    checkIn: \"צ'ק-אין\",\n    checkOut: \"צ'ק-אאוט\",\n    nights: \"לילות\",\n    guests: \"אורחים\",\n    confirmation: \"מספר אישור\",\n    description: \"תיאור\",\n    quantity: \"כמות\",\n    unitPrice: \"מחיר ליחידה\",\n    total: \"סה\\\"כ\",\n    subtotal: \"סכום ביניים\",\n    tax: \"מע\\\"מ\",\n    discount: \"הנחה\",\n    grandTotal: \"סה\\\"כ לתשלום\",\n    status: \"סטטוס תשלום\",\n    paid: \"שולם\",\n    pending: \"ממתין לתשלום\",\n    refunded: \"הוחזר\",\n    partial: \"שולם חלקית\",\n    notes: \"הערות\",\n    thankYou: \"תודה על הזמנתך!\",\n  } : {\n    invoice: \"Invoice\",\n    invoiceNumber: \"Invoice Number\",\n    date: \"Date\",\n    from: \"From\",\n    to: \"To\",\n    bookingDetails: \"Booking Details\",\n    hotel: \"Hotel\",\n    roomType: \"Room Type\",\n    checkIn: \"Check-in\",\n    checkOut: \"Check-out\",\n    nights: \"Nights\",\n    guests: \"Guests\",\n    confirmation: \"Confirmation #\",\n    description: \"Description\",\n    quantity: \"Quantity\",\n    unitPrice: \"Unit Price\",\n    total: \"Total\",\n    subtotal: \"Subtotal\",\n    tax: \"Tax (VAT)\",\n    discount: \"Discount\",\n    grandTotal: \"Grand Total\",\n    status: \"Payment Status\",\n    paid: \"Paid\",\n    pending: \"Pending\",\n    refunded: \"Refunded\",\n    partial: \"Partially Paid\",\n    notes: \"Notes\",\n    thankYou: \"Thank you for your booking!\",\n  }\n\n  const statusLabel = {\n    paid: labels.paid,\n    pending: labels.pending,\n    refunded: labels.refunded,\n    partial: labels.partial,\n  }[data.paymentStatus]\n\n  const statusColor = {\n    paid: \"#22c55e\",\n    pending: \"#f59e0b\",\n    refunded: \"#ef4444\",\n    partial: \"#3b82f6\",\n  }[data.paymentStatus]\n\n  return `\n<!DOCTYPE html>\n<html dir=\"${dir}\" lang=\"${isHebrew ? \"he\" : \"en\"}\">\n<head>\n  <meta charset=\"UTF-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <title>${labels.invoice} ${data.invoiceNumber}</title>\n  <style>\n    * { margin: 0; padding: 0; box-sizing: border-box; }\n    body { \n      font-family: ${isHebrew ? \"'Heebo', 'Arial', sans-serif\" : \"'Inter', 'Arial', sans-serif\"};\n      line-height: 1.6; \n      color: #1f2937;\n      background: #f9fafb;\n      padding: 20px;\n    }\n    .invoice-container {\n      max-width: 800px;\n      margin: 0 auto;\n      background: white;\n      border-radius: 12px;\n      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);\n      overflow: hidden;\n    }\n    .header {\n      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);\n      color: white;\n      padding: 30px;\n      display: flex;\n      justify-content: space-between;\n      align-items: center;\n    }\n    .header h1 { font-size: 28px; font-weight: 700; }\n    .invoice-number { \n      background: rgba(255,255,255,0.2);\n      padding: 8px 16px;\n      border-radius: 8px;\n      font-size: 14px;\n    }\n    .content { padding: 30px; }\n    .parties {\n      display: grid;\n      grid-template-columns: 1fr 1fr;\n      gap: 30px;\n      margin-bottom: 30px;\n    }\n    .party h3 { \n      color: #6366f1; \n      margin-bottom: 10px;\n      font-size: 14px;\n      text-transform: uppercase;\n      letter-spacing: 0.5px;\n    }\n    .party p { color: #4b5563; font-size: 14px; }\n    .booking-details {\n      background: #f3f4f6;\n      border-radius: 8px;\n      padding: 20px;\n      margin-bottom: 30px;\n    }\n    .booking-details h3 {\n      color: #1f2937;\n      margin-bottom: 15px;\n      font-size: 16px;\n    }\n    .booking-grid {\n      display: grid;\n      grid-template-columns: repeat(3, 1fr);\n      gap: 15px;\n    }\n    .booking-item label {\n      display: block;\n      color: #6b7280;\n      font-size: 12px;\n      margin-bottom: 4px;\n    }\n    .booking-item span {\n      font-weight: 600;\n      color: #1f2937;\n    }\n    table {\n      width: 100%;\n      border-collapse: collapse;\n      margin-bottom: 20px;\n    }\n    th {\n      text-align: ${isHebrew ? \"right\" : \"left\"};\n      padding: 12px;\n      background: #f9fafb;\n      color: #6b7280;\n      font-size: 12px;\n      text-transform: uppercase;\n      letter-spacing: 0.5px;\n      border-bottom: 2px solid #e5e7eb;\n    }\n    td {\n      padding: 12px;\n      border-bottom: 1px solid #e5e7eb;\n    }\n    .totals {\n      margin-top: 20px;\n      border-top: 2px solid #e5e7eb;\n      padding-top: 20px;\n    }\n    .total-row {\n      display: flex;\n      justify-content: space-between;\n      padding: 8px 0;\n      font-size: 14px;\n    }\n    .total-row.grand {\n      font-size: 18px;\n      font-weight: 700;\n      color: #6366f1;\n      border-top: 2px solid #6366f1;\n      margin-top: 10px;\n      padding-top: 15px;\n    }\n    .status-badge {\n      display: inline-block;\n      padding: 6px 12px;\n      border-radius: 20px;\n      font-size: 12px;\n      font-weight: 600;\n      color: white;\n      background: ${statusColor};\n    }\n    .footer {\n      text-align: center;\n      padding: 20px;\n      background: #f9fafb;\n      color: #6b7280;\n      font-size: 14px;\n    }\n    @media print {\n      body { background: white; padding: 0; }\n      .invoice-container { box-shadow: none; }\n    }\n  </style>\n</head>\n<body>\n  <div class=\"invoice-container\">\n    <div class=\"header\">\n      <div>\n        <h1>${labels.invoice}</h1>\n        <p>${labels.date}: ${formatDate(data.date, locale)}</p>\n      </div>\n      <div class=\"invoice-number\">\n        ${labels.invoiceNumber}: ${data.invoiceNumber}\n      </div>\n    </div>\n    \n    <div class=\"content\">\n      <div class=\"parties\">\n        <div class=\"party\">\n          <h3>${labels.from}</h3>\n          <p><strong>${data.seller.name}</strong></p>\n          <p>${data.seller.address}</p>\n          <p>${data.seller.email}</p>\n          <p>${data.seller.phone}</p>\n          ${data.seller.vatNumber ? `<p>VAT: ${data.seller.vatNumber}</p>` : \"\"}\n        </div>\n        <div class=\"party\">\n          <h3>${labels.to}</h3>\n          <p><strong>${data.customer.name}</strong></p>\n          <p>${data.customer.email}</p>\n          ${data.customer.phone ? `<p>${data.customer.phone}</p>` : \"\"}\n          ${data.customer.address ? `<p>${data.customer.address}</p>` : \"\"}\n        </div>\n      </div>\n      \n      <div class=\"booking-details\">\n        <h3>${labels.bookingDetails}</h3>\n        <div class=\"booking-grid\">\n          <div class=\"booking-item\">\n            <label>${labels.hotel}</label>\n            <span>${data.booking.hotelName}</span>\n          </div>\n          <div class=\"booking-item\">\n            <label>${labels.roomType}</label>\n            <span>${data.booking.roomType}</span>\n          </div>\n          <div class=\"booking-item\">\n            <label>${labels.confirmation}</label>\n            <span>${data.booking.confirmationNumber}</span>\n          </div>\n          <div class=\"booking-item\">\n            <label>${labels.checkIn}</label>\n            <span>${formatDate(data.booking.checkIn, locale)}</span>\n          </div>\n          <div class=\"booking-item\">\n            <label>${labels.checkOut}</label>\n            <span>${formatDate(data.booking.checkOut, locale)}</span>\n          </div>\n          <div class=\"booking-item\">\n            <label>${labels.nights} / ${labels.guests}</label>\n            <span>${data.booking.nights} / ${data.booking.guests}</span>\n          </div>\n        </div>\n      </div>\n      \n      <table>\n        <thead>\n          <tr>\n            <th>${labels.description}</th>\n            <th>${labels.quantity}</th>\n            <th>${labels.unitPrice}</th>\n            <th>${labels.total}</th>\n          </tr>\n        </thead>\n        <tbody>\n          ${data.items.map(item => `\n            <tr>\n              <td>${isHebrew && item.descriptionHe ? item.descriptionHe : item.description}</td>\n              <td>${item.quantity}</td>\n              <td>${formatCurrency(item.unitPrice, data.currency)}</td>\n              <td>${formatCurrency(item.total, data.currency)}</td>\n            </tr>\n          `).join(\"\")}\n        </tbody>\n      </table>\n      \n      <div class=\"totals\">\n        <div class=\"total-row\">\n          <span>${labels.subtotal}</span>\n          <span>${formatCurrency(data.subtotal, data.currency)}</span>\n        </div>\n        <div class=\"total-row\">\n          <span>${labels.tax} (${data.taxRate}%)</span>\n          <span>${formatCurrency(data.tax, data.currency)}</span>\n        </div>\n        ${data.discount ? `\n        <div class=\"total-row\">\n          <span>${labels.discount}${data.discountCode ? ` (${data.discountCode})` : \"\"}</span>\n          <span>-${formatCurrency(data.discount, data.currency)}</span>\n        </div>\n        ` : \"\"}\n        <div class=\"total-row grand\">\n          <span>${labels.grandTotal}</span>\n          <span>${formatCurrency(data.total, data.currency)}</span>\n        </div>\n      </div>\n      \n      <div style=\"margin-top: 20px;\">\n        <strong>${labels.status}:</strong>\n        <span class=\"status-badge\">${statusLabel}</span>\n      </div>\n      \n      ${data.notes ? `\n      <div style=\"margin-top: 20px; padding: 15px; background: #fef3c7; border-radius: 8px;\">\n        <strong>${labels.notes}:</strong>\n        <p>${data.notes}</p>\n      </div>\n      ` : \"\"}\n    </div>\n    \n    <div class=\"footer\">\n      <p>${labels.thankYou}</p>\n    </div>\n  </div>\n</body>\n</html>\n`\n}\n\n/**\n * Send invoice via email\n */\nexport async function sendInvoiceEmail(\n  params: {\n    to: string\n    invoiceNumber: string\n    invoiceHtml: string\n    bookingId: string\n    customerName: string\n  },\n  context?: InvoiceContext\n): Promise<{ success: boolean; messageId?: string; error?: string }> {\n  console.log(\"[Invoice] Sending invoice email\", { to: params.to, invoiceNumber: params.invoiceNumber })\n\n  try {\n    // Use Resend directly for custom HTML emails\n    const { Resend } = await import(\"resend\")\n    const resend = new Resend(process.env.RESEND_API_KEY || \"\")\n    \n    const result = await resend.emails.send({\n      from: process.env.FROM_EMAIL || \"bookings@youraitravelagent.com\",\n      to: params.to,\n      subject: `Invoice ${params.invoiceNumber} - Your Booking Confirmation`,\n      html: params.invoiceHtml,\n    })\n\n    console.log(\"[Invoice] Invoice email sent\", { messageId: result.data?.id })\n\n    return {\n      success: true,\n      messageId: result.data?.id,\n    }\n  } catch (error: any) {\n    console.error(\"[Invoice] Failed to send invoice email\", error.message)\n    return {\n      success: false,\n      error: error.message,\n    }\n  }\n}\n\n/**\n * Get invoice by booking ID\n */\nexport async function getInvoice(\n  params: { bookingId: string },\n  context?: InvoiceContext\n): Promise<GeneratedInvoice | null> {\n  // In a real implementation, this would fetch from database\n  // For now, return null as invoices are generated on-demand\n  console.log(\"[Invoice] Getting invoice for booking\", { bookingId: params.bookingId })\n  return null\n}\n\n/**\n * Generate receipt (simplified invoice for completed payments)\n */\nexport async function generateReceipt(\n  params: {\n    bookingId: string\n    paymentId: string\n    amount: number\n    currency: string\n    customerName: string\n    customerEmail: string\n    hotelName: string\n    confirmationNumber: string\n  },\n  context?: InvoiceContext\n): Promise<GeneratedInvoice> {\n  console.log(\"[Invoice] Generating receipt\", { bookingId: params.bookingId })\n\n  // Generate a simplified invoice/receipt\n  return generateInvoice({\n    bookingId: params.bookingId,\n    hotelName: params.hotelName,\n    roomType: \"Standard Room\",\n    checkIn: new Date(),\n    checkOut: new Date(Date.now() + 24 * 60 * 60 * 1000),\n    totalPrice: params.amount,\n    currency: params.currency,\n    customerName: params.customerName,\n    customerEmail: params.customerEmail,\n    confirmationNumber: params.confirmationNumber,\n    guests: 2,\n    paymentStatus: \"paid\",\n    notes: `Payment ID: ${params.paymentId}`,\n  }, context)\n}\n\n// Export handlers map for registry\nexport const invoiceHandlers = {\n  generateInvoice,\n  sendInvoiceEmail,\n  getInvoice,\n  generateReceipt,\n}\n","/**\n * Revenue Dashboard Handler\n * Financial reporting, revenue analytics, and KPI tracking\n */\n\n// Types\nexport interface RevenueContext {\n  userId?: string\n  sessionId?: string\n  locale?: \"en\" | \"he\"\n}\n\nexport interface RevenueResult {\n  success: boolean\n  data?: any\n  message?: string\n  error?: string\n}\n\ninterface RevenueData {\n  date: string\n  revenue: number\n  bookings: number\n  avgOrderValue: number\n  cancellations: number\n  refunds: number\n}\n\ninterface RevenueBreakdown {\n  category: string\n  amount: number\n  percentage: number\n  trend: \"up\" | \"down\" | \"stable\"\n  change: number\n}\n\ninterface KPI {\n  name: string\n  value: number | string\n  target: number | string\n  status: \"excellent\" | \"good\" | \"warning\" | \"critical\"\n  trend: \"up\" | \"down\" | \"stable\"\n  change: number\n}\n\n// Revenue Dashboard Handler\nexport const revenueDashboardHandler = {\n  skillId: \"revenue-dashboard\",\n  \n  async execute(\n    tool: string,\n    params: Record<string, unknown>,\n    context: RevenueContext\n  ): Promise<RevenueResult> {\n    switch (tool) {\n      case \"get_revenue_summary\":\n        return getRevenueSummary(params, context)\n      case \"get_revenue_breakdown\":\n        return getRevenueBreakdown(params, context)\n      case \"get_kpi_dashboard\":\n        return getKPIDashboard(params, context)\n      case \"generate_revenue_report\":\n        return generateRevenueReport(params, context)\n      default:\n        return {\n          success: false,\n          error: `Unknown tool: ${tool}`,\n        }\n    }\n  },\n}\n\n// Get Revenue Summary\nasync function getRevenueSummary(\n  params: Record<string, unknown>,\n  context: RevenueContext\n): Promise<RevenueResult> {\n  const period = (params.period as string) || \"month\" // day, week, month, quarter, year\n  const startDate = params.startDate as string\n  const endDate = params.endDate as string\n  const compareWithPrevious = params.compareWithPrevious !== false\n\n  try {\n    // Calculate date range\n    const now = new Date()\n    let start: Date\n    let end: Date = new Date(endDate || now)\n    \n    if (startDate) {\n      start = new Date(startDate)\n    } else {\n      start = new Date(now)\n      switch (period) {\n        case \"day\":\n          start.setDate(start.getDate() - 1)\n          break\n        case \"week\":\n          start.setDate(start.getDate() - 7)\n          break\n        case \"month\":\n          start.setMonth(start.getMonth() - 1)\n          break\n        case \"quarter\":\n          start.setMonth(start.getMonth() - 3)\n          break\n        case \"year\":\n          start.setFullYear(start.getFullYear() - 1)\n          break\n      }\n    }\n\n    // Generate revenue data (in production, fetch from database)\n    const currentPeriodData = generateRevenueData(start, end)\n    \n    // Calculate previous period for comparison\n    let previousPeriodData: typeof currentPeriodData | null = null\n    if (compareWithPrevious) {\n      const periodLength = end.getTime() - start.getTime()\n      const prevStart = new Date(start.getTime() - periodLength)\n      const prevEnd = new Date(start.getTime() - 1)\n      previousPeriodData = generateRevenueData(prevStart, prevEnd)\n    }\n\n    // Calculate totals\n    const currentTotals = calculateTotals(currentPeriodData)\n    const previousTotals = previousPeriodData ? calculateTotals(previousPeriodData) : null\n\n    // Calculate changes\n    const changes = previousTotals ? {\n      revenue: ((currentTotals.revenue - previousTotals.revenue) / previousTotals.revenue * 100),\n      bookings: ((currentTotals.bookings - previousTotals.bookings) / previousTotals.bookings * 100),\n      avgOrderValue: ((currentTotals.avgOrderValue - previousTotals.avgOrderValue) / previousTotals.avgOrderValue * 100),\n      cancellationRate: currentTotals.cancellationRate - previousTotals.cancellationRate,\n    } : null\n\n    return {\n      success: true,\n      data: {\n        period: {\n          start: start.toISOString().split(\"T\")[0],\n          end: end.toISOString().split(\"T\")[0],\n          label: period,\n        },\n        summary: {\n          totalRevenue: currentTotals.revenue,\n          totalBookings: currentTotals.bookings,\n          avgOrderValue: currentTotals.avgOrderValue,\n          cancellationRate: currentTotals.cancellationRate,\n          refundRate: currentTotals.refundRate,\n          netRevenue: currentTotals.netRevenue,\n        },\n        comparison: changes ? {\n          revenueChange: changes.revenue.toFixed(1) + \"%\",\n          bookingsChange: changes.bookings.toFixed(1) + \"%\",\n          avgOrderValueChange: changes.avgOrderValue.toFixed(1) + \"%\",\n          trend: changes.revenue > 0 ? \"up\" : changes.revenue < 0 ? \"down\" : \"stable\",\n        } : null,\n        dailyData: currentPeriodData.slice(-7), // Last 7 days\n        topMetrics: {\n          bestDay: currentPeriodData.reduce((a, b) => a.revenue > b.revenue ? a : b),\n          worstDay: currentPeriodData.reduce((a, b) => a.revenue < b.revenue ? a : b),\n          avgDailyRevenue: currentTotals.revenue / currentPeriodData.length,\n        },\n      },\n      message: `Revenue summary for ${period}: €${currentTotals.revenue.toLocaleString()} total revenue from ${currentTotals.bookings} bookings`,\n    }\n  } catch (error) {\n    return {\n      success: false,\n      error: `Failed to get revenue summary: ${error}`,\n    }\n  }\n}\n\n// Get Revenue Breakdown\nasync function getRevenueBreakdown(\n  params: Record<string, unknown>,\n  context: RevenueContext\n): Promise<RevenueResult> {\n  const breakdownBy = (params.breakdownBy as string) || \"source\" // source, hotel, room_type, channel\n  const period = (params.period as string) || \"month\"\n\n  try {\n    // Generate breakdown data based on category\n    let breakdown: RevenueBreakdown[] = []\n\n    switch (breakdownBy) {\n      case \"source\":\n        breakdown = [\n          { category: \"Direct Website\", amount: 45000, percentage: 35, trend: \"up\", change: 12 },\n          { category: \"Booking.com\", amount: 32000, percentage: 25, trend: \"stable\", change: 2 },\n          { category: \"Expedia\", amount: 25000, percentage: 19, trend: \"down\", change: -5 },\n          { category: \"AI Chat Widget\", amount: 18000, percentage: 14, trend: \"up\", change: 45 },\n          { category: \"Phone/Email\", amount: 9000, percentage: 7, trend: \"down\", change: -15 },\n        ]\n        break\n      case \"hotel\":\n        breakdown = [\n          { category: \"Scarlet Hotel Tel Aviv\", amount: 52000, percentage: 40, trend: \"up\", change: 8 },\n          { category: \"Grand Palace Jerusalem\", amount: 39000, percentage: 30, trend: \"up\", change: 15 },\n          { category: \"Beach Resort Eilat\", amount: 26000, percentage: 20, trend: \"stable\", change: 1 },\n          { category: \"Mountain Lodge Galilee\", amount: 13000, percentage: 10, trend: \"down\", change: -3 },\n        ]\n        break\n      case \"room_type\":\n        breakdown = [\n          { category: \"Deluxe Suite\", amount: 48000, percentage: 37, trend: \"up\", change: 18 },\n          { category: \"Standard Room\", amount: 35000, percentage: 27, trend: \"stable\", change: 0 },\n          { category: \"Family Room\", amount: 26000, percentage: 20, trend: \"up\", change: 22 },\n          { category: \"Executive Suite\", amount: 21000, percentage: 16, trend: \"down\", change: -8 },\n        ]\n        break\n      case \"channel\":\n        breakdown = [\n          { category: \"Online\", amount: 91000, percentage: 70, trend: \"up\", change: 15 },\n          { category: \"Mobile App\", amount: 26000, percentage: 20, trend: \"up\", change: 35 },\n          { category: \"Offline\", amount: 13000, percentage: 10, trend: \"down\", change: -20 },\n        ]\n        break\n    }\n\n    const totalRevenue = breakdown.reduce((sum, b) => sum + b.amount, 0)\n\n    return {\n      success: true,\n      data: {\n        breakdownBy,\n        period,\n        totalRevenue,\n        breakdown,\n        insights: generateBreakdownInsights(breakdown, breakdownBy),\n        recommendations: [\n          breakdown[0].trend === \"up\" \n            ? `${breakdown[0].category} is performing well (+${breakdown[0].change}%). Consider increasing investment.`\n            : `Focus on improving ${breakdown[0].category} performance.`,\n          breakdown.find(b => b.trend === \"down\")\n            ? `Attention needed: ${breakdown.find(b => b.trend === \"down\")?.category} is declining.`\n            : \"All categories showing positive or stable trends.\",\n        ],\n      },\n      message: `Revenue breakdown by ${breakdownBy}: Top performer is ${breakdown[0].category} with €${breakdown[0].amount.toLocaleString()} (${breakdown[0].percentage}%)`,\n    }\n  } catch (error) {\n    return {\n      success: false,\n      error: `Failed to get revenue breakdown: ${error}`,\n    }\n  }\n}\n\n// Get KPI Dashboard\nasync function getKPIDashboard(\n  params: Record<string, unknown>,\n  context: RevenueContext\n): Promise<RevenueResult> {\n  const period = (params.period as string) || \"month\"\n\n  try {\n    const kpis: KPI[] = [\n      {\n        name: \"Total Revenue\",\n        value: 129000,\n        target: 120000,\n        status: \"excellent\",\n        trend: \"up\",\n        change: 12.5,\n      },\n      {\n        name: \"Bookings\",\n        value: 847,\n        target: 800,\n        status: \"excellent\",\n        trend: \"up\",\n        change: 8.2,\n      },\n      {\n        name: \"Average Order Value\",\n        value: 152.30,\n        target: 150,\n        status: \"good\",\n        trend: \"up\",\n        change: 3.5,\n      },\n      {\n        name: \"Occupancy Rate\",\n        value: \"78%\",\n        target: \"75%\",\n        status: \"good\",\n        trend: \"up\",\n        change: 4.1,\n      },\n      {\n        name: \"Cancellation Rate\",\n        value: \"8.2%\",\n        target: \"10%\",\n        status: \"excellent\",\n        trend: \"down\",\n        change: -15.3,\n      },\n      {\n        name: \"Customer Satisfaction\",\n        value: 4.6,\n        target: 4.5,\n        status: \"good\",\n        trend: \"stable\",\n        change: 0.5,\n      },\n      {\n        name: \"Revenue per Available Room\",\n        value: 145,\n        target: 140,\n        status: \"good\",\n        trend: \"up\",\n        change: 5.8,\n      },\n      {\n        name: \"Direct Booking Rate\",\n        value: \"49%\",\n        target: \"50%\",\n        status: \"warning\",\n        trend: \"up\",\n        change: 8.0,\n      },\n    ]\n\n    const statusSummary = {\n      excellent: kpis.filter(k => k.status === \"excellent\").length,\n      good: kpis.filter(k => k.status === \"good\").length,\n      warning: kpis.filter(k => k.status === \"warning\").length,\n      critical: kpis.filter(k => k.status === \"critical\").length,\n    }\n\n    return {\n      success: true,\n      data: {\n        period,\n        kpis,\n        statusSummary,\n        overallHealth: statusSummary.critical === 0 && statusSummary.warning <= 1 ? \"healthy\" : \n                       statusSummary.critical > 0 ? \"critical\" : \"attention_needed\",\n        alerts: kpis\n          .filter(k => k.status === \"warning\" || k.status === \"critical\")\n          .map(k => ({\n            kpi: k.name,\n            message: `${k.name} is ${k.status}: ${k.value} (target: ${k.target})`,\n            priority: k.status === \"critical\" ? \"high\" : \"medium\",\n          })),\n        highlights: kpis\n          .filter(k => k.status === \"excellent\")\n          .map(k => `${k.name}: ${k.value} (${k.change > 0 ? \"+\" : \"\"}${k.change}%)`),\n      },\n      message: `KPI Dashboard: ${statusSummary.excellent} excellent, ${statusSummary.good} good, ${statusSummary.warning} need attention`,\n    }\n  } catch (error) {\n    return {\n      success: false,\n      error: `Failed to get KPI dashboard: ${error}`,\n    }\n  }\n}\n\n// Generate Revenue Report\nasync function generateRevenueReport(\n  params: Record<string, unknown>,\n  context: RevenueContext\n): Promise<RevenueResult> {\n  const reportType = (params.reportType as string) || \"summary\" // summary, detailed, executive\n  const period = (params.period as string) || \"month\"\n  const format = (params.format as string) || \"json\" // json, html, pdf\n\n  try {\n    // Gather all data for the report\n    const summaryResult = await getRevenueSummary({ period }, context)\n    const breakdownResult = await getRevenueBreakdown({ period, breakdownBy: \"source\" }, context)\n    const kpiResult = await getKPIDashboard({ period }, context)\n\n    if (!summaryResult.success || !breakdownResult.success || !kpiResult.success) {\n      throw new Error(\"Failed to gather report data\")\n    }\n\n    const reportData = {\n      generatedAt: new Date().toISOString(),\n      period,\n      reportType,\n      summary: summaryResult.data,\n      breakdown: breakdownResult.data,\n      kpis: kpiResult.data,\n    }\n\n    let output: string | typeof reportData = reportData\n\n    if (format === \"html\") {\n      output = generateHTMLReport(reportData)\n    }\n\n    return {\n      success: true,\n      data: {\n        report: output,\n        format,\n        downloadUrl: format === \"pdf\" ? `/api/reports/revenue/${Date.now()}.pdf` : null,\n        metadata: {\n          generatedAt: reportData.generatedAt,\n          period,\n          type: reportType,\n          dataPoints: Object.keys(reportData).length,\n        },\n      },\n      message: `Revenue report generated successfully (${reportType} format, ${period} period)`,\n    }\n  } catch (error) {\n    return {\n      success: false,\n      error: `Failed to generate revenue report: ${error}`,\n    }\n  }\n}\n\n// Helper Functions\nfunction generateRevenueData(start: Date, end: Date): RevenueData[] {\n  const data: RevenueData[] = []\n  const current = new Date(start)\n  \n  while (current <= end) {\n    const dayOfWeek = current.getDay()\n    const isWeekend = dayOfWeek === 0 || dayOfWeek === 6\n    const baseRevenue = isWeekend ? 5500 : 3800\n    const variance = (Math.random() - 0.5) * 1500\n    \n    data.push({\n      date: current.toISOString().split(\"T\")[0],\n      revenue: Math.round(baseRevenue + variance),\n      bookings: Math.round(25 + Math.random() * 15),\n      avgOrderValue: Math.round(140 + Math.random() * 30),\n      cancellations: Math.round(Math.random() * 5),\n      refunds: Math.round(Math.random() * 500),\n    })\n    \n    current.setDate(current.getDate() + 1)\n  }\n  \n  return data\n}\n\nfunction calculateTotals(data: RevenueData[]) {\n  const totalRevenue = data.reduce((sum, d) => sum + d.revenue, 0)\n  const totalBookings = data.reduce((sum, d) => sum + d.bookings, 0)\n  const totalCancellations = data.reduce((sum, d) => sum + d.cancellations, 0)\n  const totalRefunds = data.reduce((sum, d) => sum + d.refunds, 0)\n  \n  return {\n    revenue: totalRevenue,\n    bookings: totalBookings,\n    avgOrderValue: Math.round(totalRevenue / totalBookings),\n    cancellationRate: (totalCancellations / totalBookings * 100),\n    refundRate: (totalRefunds / totalRevenue * 100),\n    netRevenue: totalRevenue - totalRefunds,\n  }\n}\n\nfunction generateBreakdownInsights(breakdown: RevenueBreakdown[], breakdownBy: string): string[] {\n  const insights: string[] = []\n  \n  const topPerformer = breakdown[0]\n  insights.push(`${topPerformer.category} leads ${breakdownBy} revenue with ${topPerformer.percentage}% share`)\n  \n  const growing = breakdown.filter(b => b.trend === \"up\" && b.change > 10)\n  if (growing.length > 0) {\n    insights.push(`Fast growing: ${growing.map(g => g.category).join(\", \")}`)\n  }\n  \n  const declining = breakdown.filter(b => b.trend === \"down\")\n  if (declining.length > 0) {\n    insights.push(`Declining: ${declining.map(d => d.category).join(\", \")} - requires attention`)\n  }\n  \n  return insights\n}\n\nfunction generateHTMLReport(data: any): string {\n  return `\n<!DOCTYPE html>\n<html dir=\"rtl\" lang=\"he\">\n<head>\n  <meta charset=\"UTF-8\">\n  <title>דוח הכנסות - ${data.period}</title>\n  <style>\n    body { font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }\n    .container { max-width: 1000px; margin: 0 auto; background: white; padding: 40px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }\n    h1 { color: #1a1a2e; border-bottom: 3px solid #4a90a4; padding-bottom: 15px; }\n    h2 { color: #4a90a4; margin-top: 30px; }\n    .metric { display: inline-block; background: #f8f9fa; padding: 20px; margin: 10px; border-radius: 8px; min-width: 150px; text-align: center; }\n    .metric-value { font-size: 28px; font-weight: bold; color: #1a1a2e; }\n    .metric-label { font-size: 14px; color: #666; margin-top: 5px; }\n    .metric-change { font-size: 12px; margin-top: 5px; }\n    .up { color: #28a745; }\n    .down { color: #dc3545; }\n    table { width: 100%; border-collapse: collapse; margin: 20px 0; }\n    th, td { padding: 12px; text-align: right; border-bottom: 1px solid #ddd; }\n    th { background: #4a90a4; color: white; }\n    .kpi-excellent { background: #d4edda; }\n    .kpi-good { background: #fff3cd; }\n    .kpi-warning { background: #f8d7da; }\n    .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; color: #666; font-size: 12px; }\n  </style>\n</head>\n<body>\n  <div class=\"container\">\n    <h1>📊 דוח הכנסות - ${data.period}</h1>\n    <p>נוצר: ${new Date(data.generatedAt).toLocaleString(\"he-IL\")}</p>\n    \n    <h2>סיכום כללי</h2>\n    <div class=\"metrics\">\n      <div class=\"metric\">\n        <div class=\"metric-value\">€${data.summary?.summary?.totalRevenue?.toLocaleString() || \"N/A\"}</div>\n        <div class=\"metric-label\">הכנסות כוללות</div>\n        <div class=\"metric-change up\">${data.summary?.comparison?.revenueChange || \"\"}</div>\n      </div>\n      <div class=\"metric\">\n        <div class=\"metric-value\">${data.summary?.summary?.totalBookings || \"N/A\"}</div>\n        <div class=\"metric-label\">הזמנות</div>\n        <div class=\"metric-change up\">${data.summary?.comparison?.bookingsChange || \"\"}</div>\n      </div>\n      <div class=\"metric\">\n        <div class=\"metric-value\">€${data.summary?.summary?.avgOrderValue || \"N/A\"}</div>\n        <div class=\"metric-label\">ממוצע להזמנה</div>\n      </div>\n      <div class=\"metric\">\n        <div class=\"metric-value\">${data.summary?.summary?.cancellationRate?.toFixed(1) || \"N/A\"}%</div>\n        <div class=\"metric-label\">שיעור ביטולים</div>\n      </div>\n    </div>\n    \n    <h2>פילוח הכנסות</h2>\n    <table>\n      <tr><th>קטגוריה</th><th>סכום</th><th>אחוז</th><th>מגמה</th></tr>\n      ${data.breakdown?.breakdown?.map((b: any) => `\n        <tr>\n          <td>${b.category}</td>\n          <td>€${b.amount.toLocaleString()}</td>\n          <td>${b.percentage}%</td>\n          <td class=\"${b.trend === 'up' ? 'up' : b.trend === 'down' ? 'down' : ''}\">${b.trend === 'up' ? '↑' : b.trend === 'down' ? '↓' : '→'} ${b.change}%</td>\n        </tr>\n      `).join(\"\") || \"\"}\n    </table>\n    \n    <h2>מדדי ביצוע (KPIs)</h2>\n    <table>\n      <tr><th>מדד</th><th>ערך</th><th>יעד</th><th>סטטוס</th></tr>\n      ${data.kpis?.kpis?.slice(0, 5).map((k: any) => `\n        <tr class=\"kpi-${k.status}\">\n          <td>${k.name}</td>\n          <td>${k.value}</td>\n          <td>${k.target}</td>\n          <td>${k.status === 'excellent' ? '✅' : k.status === 'good' ? '👍' : '⚠️'}</td>\n        </tr>\n      `).join(\"\") || \"\"}\n    </table>\n    \n    <div class=\"footer\">\n      <p>דוח זה נוצר אוטומטית על ידי מערכת Revenue Dashboard</p>\n    </div>\n  </div>\n</body>\n</html>\n  `\n}\n\nexport default revenueDashboardHandler\n"],"names":["process","env","NEXT_RUNTIME","module","exports","require","__NEXT_EXPERIMENTAL_REACT","NODE_ENV","TURBOPACK","vendored","React"],"mappings":"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N,OAAQ,qBACR,YAAa,mEACb,cAAe,+CACf,SAAU,CACR,CACE,KAAM,oBACN,OAAQ,cACR,UAAW,IACX,SAAU,MACV,YAAa,uDACb,cAAe,uDACjB,EACA,CACE,KAAM,oBACN,OAAQ,cACR,UAAW,IACX,SAAU,MACV,YAAa,qCACb,cAAe,yBACjB,EACA,CACE,KAAM,eACN,OAAQ,gBACR,UAAW,IACX,SAAU,MACV,YAAa,sCACb,cAAe,+BACjB,EACD,CACD,YAAa,IACb,eAAgB,IAChB,SAAU,MACV,SAAU,cACV,MAAO,mEACP,QAAS,iEACX,EACA,CACE,GAAI,UACJ,KAAM,4BACN,OAAQ,sBACR,YAAa,wEACb,cAAe,uDACf,SAAU,CACR,CACE,KAAM,oBACN,OAAQ,cACR,UAAW,IACX,SAAU,MACV,YAAa,iDACb,cAAe,0BACjB,EACA,CACE,KAAM,oBACN,OAAQ,cACR,UAAW,KACX,SAAU,MACV,YAAa,sDACb,cAAe,6BACjB,EACA,CACE,KAAM,wBACN,OAAQ,sBACR,UAAW,IACX,SAAU,MACV,YAAa,mDACb,cAAe,sCACjB,EACA,CACE,KAAM,mBACN,OAAQ,cACR,UAAW,IACX,SAAU,MACV,YAAa,gDACb,cAAe,kCACjB,EACA,CACE,KAAM,aACN,OAAQ,cACR,UAAW,IACX,SAAU,MACV,YAAa,uCACb,cAAe,gCACjB,EACD,CACD,YAAa,KACb,eAAgB,KAChB,SAAU,MACV,SAAU,cACV,MAAO,mEACP,QAAS,gDACX,EACA,CACE,GAAI,SACJ,KAAM,2BACN,OAAQ,oBACR,YAAa,gDACb,cAAe,gCACf,SAAU,CACR,CACE,KAAM,oBACN,OAAQ,cACR,UAAW,KACX,SAAU,MACV,YAAa,+BACb,cAAe,oBACjB,EACA,CACE,KAAM,oBACN,OAAQ,cACR,UAAW,KACX,SAAU,MACV,YAAa,mDACb,cAAe,qCACjB,EACA,CACE,KAAM,aACN,OAAQ,eACR,UAAW,IACX,SAAU,MACV,YAAa,8CACb,cAAe,oCACjB,EACA,CACE,KAAM,eACN,OAAQ,gBACR,UAAW,IACX,SAAU,MACV,YAAa,0BACb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","ignoreList":[0,1,2]}